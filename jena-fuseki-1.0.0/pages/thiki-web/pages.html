<!doctype html>
<html lang="en">
<head>
   <meta charset="utf-8">
   <title>Thiki</title>
   
   <link rel="stylesheet" href="css/bootstrap.min.css">
   <link rel="stylesheet" href="css/common.css">

   <script src="js/marked.js"></script>

   <script src="js/jquery-1.10.2.js"></script>
        
   <script src="js/jquery-migrate-1.2.1.js"></script>

   <script type="text/javascript" language="javascript">
   
var sparqlQueryEndpoint = "http://localhost:3030/seki/sparql?query=";

var getPagesSparql = "	    PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> \n\
PREFIX dc: <http://purl.org/dc/terms/>  \n\
PREFIX foaf: <http://xmlns.com/foaf/0.1/>  \n\
PREFIX sioc: <http://rdfs.org/sioc/ns#>  \n\
PREFIX wiki: <http://purl.org/stuff/wiki#>  \n\
\n\
SELECT DISTINCT * WHERE { \n\
	?uri \n\
	dc:format <http://purl.org/NET/mediatypes/text/markdown> ; \n\
    dc:date ?date ; \n\
    dc:title ?title ; \n\
    a wiki:Page ; \n\
    foaf:maker [ \n\
        foaf:nick ?nick \n\
    ] . \n\
} \n\
ORDER By DESC(?date)  \n\
# LIMIT 10 \n\
";

console.log(getPagesSparql);
    
var getPagesUrl = sparqlQueryEndpoint + encodeURIComponent(getPagesSparql) + "&output=xml";
	
    $(function() {
    	var $loading = $('#spinner').hide();
    	jQuery.ajaxSetup({
    		  beforeSend: function() {
    		     $('#spinner').show();
    		  },
    		  complete: function(){
    		     $('#spinner').hide();
    		  },
    		  success: function() {}
    		});
    	
      getPages();
    });
    	
    	function getPages() {
    	//	$.get(url, function(xml) {
    			$.ajax({
    				url: getPagesUrl, 
    				accept: {
    						  xml: 'application/xml;charset=UTF-8',
    						  sparql: 'sparql-results+xml;charset=UTF-8'
    						  },
    				headers: { // belt and braces
    						        'Accept':'sparql-results+xml;charset=UTF-8'
    						     //   'Accept-Charset': 'UTF-8' unsafe
    						        }
    				
    			}).done(function(xml) {
    		
    			var xmlString = (new XMLSerializer()).serializeToString(xml);

    			// workaround for wrong interpretation of charset
    			xmlString = xmlString.replace(/[^\u0000-\u007F]/g, '');
    			// maybe force to ISO-8859-1, also known as Latin-1 instead?
    	
    				var $xml = $(xmlString);
					var rows = "";
					
    				$xml.find("result").each(function() {
    					var uri, date, title,  nick; // content,
    					
    					$(this).find("binding[name='uri']").each(function() {
    						uri = $(this).text().trim();
    					});
    					$(this).find("binding[name='date']").each(function() {
    						date = $(this).text().trim();
    					});
    					$(this).find("binding[name='title']").each(function() {
    						title = $(this).text().trim();
    					});
    				//	$(this).find("binding[name='content']").each(function() {
    				//		content = $(this).text().trim();
    				//	});
    					$(this).find("binding[name='nick']").each(function() {
    						nick = $(this).text().trim();
    					});
    					
    					rows += generatePageRow(uri, date, title, nick); // content, 
    				});
    				 $("#pages").replaceWith(rows);
    				//  $("table").colResizable();
    			});
    	}
    	
    	function generatePageRow(uri, date, title, nick) { // content, 
console.log("uri = "+uri+ ", date = "+date+" , title = "+title+", nick = "+nick); // content = "+content+", 
    		var row = "<tr>";

    		uri = "page.html?uri="+uri;
    		row += "<td><a href=\""+uri+"\">"+title+"</a></td>";
     //		row += "<td class=\"center\">"+marked(content)+"</td>";
     		row += "<td class=\"center\">"+date+"</td>";
     		row += "<td class=\"center\">"+nick+"</td>";
			return row;
    	}
</script>

</head>

<body>
<!--  div class="container" -->

<table  id="pagesTable" class="table table-bordered">
<tr><th colspan="8" class="center"><a href="/index.html">Thiki</a> Pages</th></tr>
<tr>
  <th class="center">Page</th>
  <th class="center">Date</th>
  <th class="center">Creator</th> 
</tr>
<tr id="pages"></tr>
  </table>
  
    <div id="spinner" class="spinner"></div> 
</body>
</html>
