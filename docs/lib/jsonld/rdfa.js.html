<!DOCTYPE html><html><head><title>rdfa.js</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../../index.html" class="source"><span class="file_name">README</span></a><a href="../../Authenticator.js.html" class="source "><span class="base_path">. / </span><span class="file_name">Authenticator.js</span></a><a href="../../Bootstrap.js.html" class="source "><span class="base_path">. / </span><span class="file_name">Bootstrap.js</span></a><a href="../../Dummy.js.html" class="source "><span class="base_path">. / </span><span class="file_name">Dummy.js</span></a><a href="../../FileServer.js.html" class="source "><span class="base_path">. / </span><span class="file_name">FileServer.js</span></a><a href="../../GetHandler.js.html" class="source "><span class="base_path">. / </span><span class="file_name">GetHandler.js</span></a><a href="../../Gruntfile.js.html" class="source "><span class="base_path">. / </span><span class="file_name">Gruntfile.js</span></a><a href="../../JSONHandler.js.html" class="source "><span class="base_path">. / </span><span class="file_name">JSONHandler.js</span></a><a href="../../PostHandler.js.html" class="source "><span class="base_path">. / </span><span class="file_name">PostHandler.js</span></a><a href="../../ResponseRenderer.js.html" class="source "><span class="base_path">. / </span><span class="file_name">ResponseRenderer.js</span></a><a href="../../Seki.js.html" class="source "><span class="base_path">. / </span><span class="file_name">Seki.js</span></a><a href="../../SourceHook.js.html" class="source "><span class="base_path">. / </span><span class="file_name">SourceHook.js</span></a><a href="../../SparqlUtils.js.html" class="source "><span class="base_path">. / </span><span class="file_name">SparqlUtils.js</span></a><a href="../../StoreClient.js.html" class="source "><span class="base_path">. / </span><span class="file_name">StoreClient.js</span></a><a href="../../TryJsonld.js.html" class="source "><span class="base_path">. / </span><span class="file_name">TryJsonld.js</span></a><a href="../../TurtleHandler.js.html" class="source "><span class="base_path">. / </span><span class="file_name">TurtleHandler.js</span></a><a href="../../Utils.js.html" class="source "><span class="base_path">. / </span><span class="file_name">Utils.js</span></a><a href="../../admin/FileReader.js.html" class="source "><span class="base_path">admin / </span><span class="file_name">FileReader.js</span></a><a href="../../admin/Admin.js.html" class="source "><span class="base_path">admin / </span><span class="file_name">Admin.js</span></a><a href="../../config/ConfigCustom.js.html" class="source "><span class="base_path">config / </span><span class="file_name">ConfigCustom.js</span></a><a href="../../config/Constants.js.html" class="source "><span class="base_path">config / </span><span class="file_name">Constants.js</span></a><a href="../../config/Headers.js.html" class="source "><span class="base_path">config / </span><span class="file_name">Headers.js</span></a><a href="../../config/Special.js.html" class="source "><span class="base_path">config / </span><span class="file_name">Special.js</span></a><a href="../../config/ConfigDefault.js.html" class="source "><span class="base_path">config / </span><span class="file_name">ConfigDefault.js</span></a><a href="../../config/ConfigOpenShift.js.html" class="source "><span class="base_path">config / </span><span class="file_name">ConfigOpenShift.js</span></a><a href="../../handlers/GetJsonHandler.js.html" class="source "><span class="base_path">handlers / </span><span class="file_name">GetJsonHandler.js</span></a><a href="../../handlers/VieJsonHandler.js.html" class="source "><span class="base_path">handlers / </span><span class="file_name">VieJsonHandler.js</span></a><a href="../../handlers/GetBlogHandler.js.html" class="source "><span class="base_path">handlers / </span><span class="file_name">GetBlogHandler.js</span></a><a href="../../lib/node-rdf/test/graph-TripletGraph-test.js.html" class="source "><span class="base_path">lib / node-rdf / test / </span><span class="file_name">graph-TripletGraph-test.js</span></a><a href="../../lib/node-rdf/test/builtins-String-test.js.html" class="source "><span class="base_path">lib / node-rdf / test / </span><span class="file_name">builtins-String-test.js</span></a><a href="../../lib/node-rdf/test/builtins-ref-test.js.html" class="source "><span class="base_path">lib / node-rdf / test / </span><span class="file_name">builtins-ref-test.js</span></a><a href="../../lib/node-rdf/test/parser-Turtle-test.js.html" class="source "><span class="base_path">lib / node-rdf / test / </span><span class="file_name">parser-Turtle-test.js</span></a><a href="../../lib/node-rdf/test/RDFEnvironment-test.js.html" class="source "><span class="base_path">lib / node-rdf / test / </span><span class="file_name">RDFEnvironment-test.js</span></a><a href="../../lib/node-rdf/test/IRI-test.js.html" class="source "><span class="base_path">lib / node-rdf / test / </span><span class="file_name">IRI-test.js</span></a><a href="../../lib/node-rdf/test/context-resolve-test.js.html" class="source "><span class="base_path">lib / node-rdf / test / </span><span class="file_name">context-resolve-test.js</span></a><a href="../../lib/node-rdf/test/builtins-Number-test.js.html" class="source "><span class="base_path">lib / node-rdf / test / </span><span class="file_name">builtins-Number-test.js</span></a><a href="../../lib/node-rdf/test/context-convert-test.js.html" class="source "><span class="base_path">lib / node-rdf / test / </span><span class="file_name">context-convert-test.js</span></a><a href="../../lib/node-rdf/test/graph-IndexedGraph-test.js.html" class="source "><span class="base_path">lib / node-rdf / test / </span><span class="file_name">graph-IndexedGraph-test.js</span></a><a href="../../lib/node-rdf/test/graph-test-lib.js.html" class="source "><span class="base_path">lib / node-rdf / test / </span><span class="file_name">graph-test-lib.js</span></a><a href="../../lib/node-rdf/lib/rdf.js.html" class="source "><span class="base_path">lib / node-rdf / lib / </span><span class="file_name">rdf.js</span></a><a href="../../lib/node-rdf/lib/TripletGraph.js.html" class="source "><span class="base_path">lib / node-rdf / lib / </span><span class="file_name">TripletGraph.js</span></a><a href="../../lib/node-rdf/lib/Graph.js.html" class="source "><span class="base_path">lib / node-rdf / lib / </span><span class="file_name">Graph.js</span></a><a href="../../lib/node-rdf/lib/IndexedGraph.js.html" class="source "><span class="base_path">lib / node-rdf / lib / </span><span class="file_name">IndexedGraph.js</span></a><a href="../../lib/node-rdf/lib/RDFNode.js.html" class="source "><span class="base_path">lib / node-rdf / lib / </span><span class="file_name">RDFNode.js</span></a><a href="../../lib/node-rdf/lib/Builtins.js.html" class="source "><span class="base_path">lib / node-rdf / lib / </span><span class="file_name">Builtins.js</span></a><a href="../../lib/node-rdf/lib/Profile.js.html" class="source "><span class="base_path">lib / node-rdf / lib / </span><span class="file_name">Profile.js</span></a><a href="../../lib/node-rdf/lib/Default.js.html" class="source "><span class="base_path">lib / node-rdf / lib / </span><span class="file_name">Default.js</span></a><a href="../../lib/node-rdf/lib/RDFEnvironment.js.html" class="source "><span class="base_path">lib / node-rdf / lib / </span><span class="file_name">RDFEnvironment.js</span></a><a href="../../lib/node-rdf/lib/N3Serializer.js.html" class="source "><span class="base_path">lib / node-rdf / lib / </span><span class="file_name">N3Serializer.js</span></a><a href="../../lib/node-rdf/lib/TurtleParser.js.html" class="source "><span class="base_path">lib / node-rdf / lib / </span><span class="file_name">TurtleParser.js</span></a><a href="../../lib/temp/corser.js.html" class="source "><span class="base_path">lib / temp / </span><span class="file_name">corser.js</span></a><a href="../../lib/temp/connect-cors.js.html" class="source "><span class="base_path">lib / temp / </span><span class="file_name">connect-cors.js</span></a><a href="../../lib/jsonld/jsonld.js.html" class="source "><span class="base_path">lib / jsonld / </span><span class="file_name">jsonld.js</span></a><a href="../../lib/jsonld/request.js.html" class="source "><span class="base_path">lib / jsonld / </span><span class="file_name">request.js</span></a><a href="../../lib/jsonld/Future.js.html" class="source "><span class="base_path">lib / jsonld / </span><span class="file_name">Future.js</span></a><a href="../../lib/jsonld/rdfa.js.html" class="source selected"><span class="base_path">lib / jsonld / </span><span class="file_name">rdfa.js</span></a><a href="../../misc/sr.js.html" class="source "><span class="base_path">misc / </span><span class="file_name">sr.js</span></a><a href="../../misc/biscuit.js.html" class="source "><span class="base_path">misc / </span><span class="file_name">biscuit.js</span></a><a href="../../misc/router.js.html" class="source "><span class="base_path">misc / </span><span class="file_name">router.js</span></a><a href="../../misc/cors-client-snippet.js.html" class="source "><span class="base_path">misc / </span><span class="file_name">cors-client-snippet.js</span></a><a href="../../misc/flatten-map.js.html" class="source "><span class="base_path">misc / </span><span class="file_name">flatten-map.js</span></a><a href="../../misc/mimeToJSON.js.html" class="source "><span class="base_path">misc / </span><span class="file_name">mimeToJSON.js</span></a><a href="../../misc/htmlparser.js.html" class="source "><span class="base_path">misc / </span><span class="file_name">htmlparser.js</span></a><a href="../../misc/shortener.js.html" class="source "><span class="base_path">misc / </span><span class="file_name">shortener.js</span></a><a href="../../misc/html5-boilerplate.js.html" class="source "><span class="base_path">misc / </span><span class="file_name">html5-boilerplate.js</span></a><a href="../../srx2map.js.html" class="source "><span class="base_path">. / </span><span class="file_name">srx2map.js</span></a><a href="../../srx2map_multi.js.html" class="source "><span class="base_path">. / </span><span class="file_name">srx2map_multi.js</span></a><a href="../../templates/SparqlTemplates.js.html" class="source "><span class="base_path">templates / </span><span class="file_name">SparqlTemplates.js</span></a><a href="../../templates/JsonTemplates.js.html" class="source "><span class="base_path">templates / </span><span class="file_name">JsonTemplates.js</span></a><a href="../../templates/Templater.js.html" class="source "><span class="base_path">templates / </span><span class="file_name">Templater.js</span></a><a href="../../templates/SparqlUserTemplates.js.html" class="source "><span class="base_path">templates / </span><span class="file_name">SparqlUserTemplates.js</span></a><a href="../../templates/HtmlTemplates.js.html" class="source "><span class="base_path">templates / </span><span class="file_name">HtmlTemplates.js</span></a><a href="../../templates/freemarker.js.html" class="source "><span class="base_path">templates / </span><span class="file_name">freemarker.js</span></a><a href="../../tests/run-tests.js.html" class="source "><span class="base_path">tests / </span><span class="file_name">run-tests.js</span></a><a href="../../tests/old/allTests.js.html" class="source "><span class="base_path">tests / old / </span><span class="file_name">allTests.js</span></a><a href="../../tests/old/testRdfHttp.js.html" class="source "><span class="base_path">tests / old / </span><span class="file_name">testRdfHttp.js</span></a><a href="../../tests/old/dummyServer.js.html" class="source "><span class="base_path">tests / old / </span><span class="file_name">dummyServer.js</span></a><a href="../../tests/old/testTemplater.js.html" class="source "><span class="base_path">tests / old / </span><span class="file_name">testTemplater.js</span></a><a href="../../tests/old/testHelpers.js.html" class="source "><span class="base_path">tests / old / </span><span class="file_name">testHelpers.js</span></a><a href="../../usermanager/users.js.html" class="source "><span class="base_path">usermanager / </span><span class="file_name">users.js</span></a><a href="../../wat.js.html" class="source "><span class="base_path">. / </span><span class="file_name">wat.js</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>rdfa.js</h1><div class="filepath">lib/jsonld/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Copyright (c) 2011-2012, R. Alexander Milowski <a href="&#109;a&#x69;&#x6C;&#116;&#x6F;:&#x61;&#x6C;&#101;&#x78;&#64;&#109;&#105;&#x6C;&#x6F;&#119;&#x73;&#x6B;&#x69;&#x2E;&#99;o&#x6D;">&#x61;&#x6C;&#101;&#x78;&#64;&#109;&#105;&#x6C;&#x6F;&#119;&#x73;&#x6B;&#x69;&#x2E;&#99;o&#x6D;</a><br />All rights reserved.</p></div><div class="body"><p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:</p>

<p>Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.<br />Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.<br />THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">_nodejs</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">module</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">RDFa</span><span class="p">()</span> <span class="p">{</span>
<span class="p">}</span>
<span class="nx">RDFa</span><span class="p">.</span><span class="nx">attach</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span><span class="nx">update</span><span class="p">)</span> <span class="p">{</span>

<span class="k">if</span><span class="p">(</span><span class="nx">_nodejs</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">_baseURI</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">URIResolver</span><span class="p">()</span> <span class="p">{</span>
<span class="p">}</span>
<span class="nx">URIResolver</span><span class="p">.</span><span class="nx">SCHEME</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;^[A-Za-z][A-Za-z0-9\+\-\.]*\:&quot;</span><span class="p">);</span>

<span class="nx">URIResolver</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">parseURI</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">uri</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">if</span><span class="p">(</span><span class="nx">_nodejs</span><span class="p">)</span> <span class="p">{</span>
     <span class="nx">uri</span> <span class="o">=</span> <span class="nx">uri</span> <span class="o">||</span> <span class="nx">_baseURI</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="nx">URIResolver</span><span class="p">.</span><span class="nx">SCHEME</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">uri</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">_nodejs</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Bad URI value, no scheme: &quot;</span><span class="o">+</span><span class="nx">uri</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">throw</span> <span class="s2">&quot;Bad URI value, no scheme: &quot;</span><span class="o">+</span><span class="nx">uri</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="kd">var</span> <span class="nx">parsed</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">spec</span><span class="o">:</span> <span class="nx">uri</span> <span class="p">};</span>
   <span class="nx">parsed</span><span class="p">.</span><span class="nx">scheme</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
   <span class="nx">parsed</span><span class="p">.</span><span class="nx">schemeSpecificPart</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">spec</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">schemeSpecificPart</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;/&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">schemeSpecificPart</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">parseGeneric</span><span class="p">(</span><span class="nx">parsed</span><span class="p">);</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">parsed</span><span class="p">.</span><span class="nx">isGeneric</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">parsed</span><span class="p">.</span><span class="nx">normalize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isGeneric</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">segments</span><span class="p">.</span><span class="nx">length</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>edge case of ending in "/."</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;/.&quot;</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">segments</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">segments</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">schemeSpecificPart</span> <span class="o">=</span> <span class="s2">&quot;//&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">authority</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span> <span class="o">!=</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">schemeSpecificPart</span> <span class="o">+=</span> <span class="s2">&quot;?&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">fragment</span> <span class="o">!=</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">schemeSpecificPart</span> <span class="o">+=</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">fragment</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">spec</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">scheme</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">schemeSpecificPart</span><span class="p">;</span>
         <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">end</span><span class="o">!=</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">end</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">segments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">i</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">segments</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;..&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">segments</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
            <span class="nx">i</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">segments</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">segments</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
            <span class="nx">i</span><span class="o">--</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">segments</span><span class="p">.</span><span class="nx">length</span><span class="o">==</span><span class="mi">0</span> <span class="o">?</span> <span class="s2">&quot;/&quot;</span> <span class="o">:</span> <span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">segments</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="o">+</span><span class="nx">end</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">schemeSpecificPart</span> <span class="o">=</span> <span class="s2">&quot;//&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">authority</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span> <span class="o">!=</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">schemeSpecificPart</span> <span class="o">+=</span> <span class="s2">&quot;?&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">fragment</span> <span class="o">!=</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">schemeSpecificPart</span> <span class="o">+=</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">fragment</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">spec</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">scheme</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">schemeSpecificPart</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">parsed</span><span class="p">.</span><span class="nx">resolve</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">href</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">href</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">spec</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">href</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">lastHash</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spec</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">);</span>
         <span class="k">return</span> <span class="nx">lastHash</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">spec</span><span class="o">+</span><span class="nx">href</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">spec</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">lastHash</span><span class="p">)</span><span class="o">+</span><span class="nx">href</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isGeneric</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">throw</span> <span class="s2">&quot;Cannot resolve uri against non-generic URI: &quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">spec</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">colon</span> <span class="o">=</span> <span class="nx">href</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">href</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">scheme</span><span class="o">+</span><span class="s2">&quot;://&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">authority</span><span class="o">+</span><span class="nx">href</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">href</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;.&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">href</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">scheme</span><span class="o">+</span><span class="s2">&quot;://&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">authority</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="o">+</span><span class="nx">href</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">last</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">scheme</span><span class="o">+</span><span class="s2">&quot;://&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">authority</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">last</span><span class="p">)</span><span class="o">+</span><span class="nx">href</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">URIResolver</span><span class="p">.</span><span class="nx">SCHEME</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">href</span><span class="p">))</span> <span class="p">{</span>
         <span class="k">return</span> <span class="nx">href</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">href</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;?&quot;</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">scheme</span><span class="o">+</span><span class="s2">&quot;://&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">authority</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="o">+</span><span class="nx">href</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">scheme</span><span class="o">+</span><span class="s2">&quot;://&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">authority</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="o">+</span><span class="nx">href</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">last</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">scheme</span><span class="o">+</span><span class="s2">&quot;://&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">authority</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">last</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="nx">href</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">};</span>
   <span class="nx">parsed</span><span class="p">.</span><span class="nx">relativeTo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">otherURI</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">otherURI</span><span class="p">.</span><span class="nx">scheme</span><span class="o">!=</span><span class="k">this</span><span class="p">.</span><span class="nx">scheme</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">spec</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isGeneric</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">throw</span> <span class="s2">&quot;A non generic URI cannot be made relative: &quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">spec</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">otherURI</span><span class="p">.</span><span class="nx">isGeneric</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">throw</span> <span class="s2">&quot;Cannot make a relative URI against a non-generic URI: &quot;</span><span class="o">+</span><span class="nx">otherURI</span><span class="p">.</span><span class="nx">spec</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">otherURI</span><span class="p">.</span><span class="nx">authority</span><span class="o">!=</span><span class="k">this</span><span class="p">.</span><span class="nx">authority</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">spec</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">segments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">otherURI</span><span class="p">.</span><span class="nx">segments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">segments</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">!=</span><span class="nx">otherURI</span><span class="p">.</span><span class="nx">segments</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>alert(this.path+" different from "+otherURI.path+" at '"+this.segments[i]+"' vs '"+otherURI.segments[i]+"'");</p>
</td><td class="code"><div class="highlight"><pre>            <span class="kd">var</span> <span class="nx">relative</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span><span class="o">=</span><span class="nx">i</span><span class="p">;</span> <span class="nx">j</span><span class="o">&lt;</span><span class="nx">otherURI</span><span class="p">.</span><span class="nx">segments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">relative</span> <span class="o">+=</span> <span class="s2">&quot;../&quot;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span><span class="o">=</span><span class="nx">i</span><span class="p">;</span> <span class="nx">j</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">segments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">relative</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">segments</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
               <span class="k">if</span> <span class="p">((</span><span class="nx">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">segments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">relative</span> <span class="o">+=</span> <span class="s2">&quot;/&quot;</span><span class="p">;</span>
               <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">relative</span> <span class="o">+=</span> <span class="s2">&quot;/&quot;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">relative</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">segments</span><span class="p">.</span><span class="nx">length</span><span class="o">==</span><span class="nx">otherURI</span><span class="p">.</span><span class="nx">segments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">hash</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">hash</span> <span class="o">:</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">query</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">segments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">relative</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
         <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span><span class="o">=</span><span class="nx">i</span><span class="p">;</span> <span class="nx">j</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">segments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">relative</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">segments</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">((</span><span class="nx">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">segments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">relative</span> <span class="o">+=</span> <span class="s2">&quot;/&quot;</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">relative</span> <span class="o">+=</span> <span class="s2">&quot;/&quot;</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="k">return</span> <span class="nx">relative</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">throw</span> <span class="s2">&quot;Cannot calculate a relative URI for &quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">spec</span><span class="o">+</span><span class="s2">&quot; against &quot;</span><span class="o">+</span><span class="nx">otherURI</span><span class="p">.</span><span class="nx">spec</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">};</span>
   <span class="k">return</span> <span class="nx">parsed</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">URIResolver</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">parseGeneric</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">parsed</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">schemeSpecificPart</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">!=</span><span class="s1">&#39;/&#39;</span> <span class="o">||</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">schemeSpecificPart</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">!=</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="s2">&quot;Generic URI values should start with &#39;//&#39;:&quot;</span><span class="o">+</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">spec</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="kd">var</span> <span class="nx">work</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">schemeSpecificPart</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
   <span class="kd">var</span> <span class="nx">pathStart</span> <span class="o">=</span> <span class="nx">work</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">);</span>
   <span class="nx">parsed</span><span class="p">.</span><span class="nx">authority</span> <span class="o">=</span> <span class="nx">pathStart</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">?</span> <span class="nx">work</span> <span class="o">:</span> <span class="nx">work</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">pathStart</span><span class="p">);</span>
   <span class="nx">parsed</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">pathStart</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">?</span> <span class="s2">&quot;&quot;</span> <span class="o">:</span> <span class="nx">work</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">pathStart</span><span class="p">);</span>
   <span class="kd">var</span> <span class="nx">hash</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">hash</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">parsed</span><span class="p">.</span><span class="nx">fragment</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">hash</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
      <span class="nx">parsed</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">hash</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="kd">var</span> <span class="nx">questionMark</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">questionMark</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">parsed</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">questionMark</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
      <span class="nx">parsed</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">questionMark</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">path</span><span class="o">==</span><span class="s2">&quot;/&quot;</span> <span class="o">||</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">path</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">parsed</span><span class="p">.</span><span class="nx">segments</span> <span class="o">=</span> <span class="p">[];</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">parsed</span><span class="p">.</span><span class="nx">segments</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\//</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">segments</span><span class="p">.</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">segments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">!=</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><p>empty segment at the start, remove it</p>
</td><td class="code"><div class="highlight"><pre>         <span class="nx">parsed</span><span class="p">.</span><span class="nx">segments</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">segments</span><span class="p">.</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;/&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">segments</span><span class="p">[</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">segments</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>we may have an empty the end
check to see if it is legimate</p>
</td><td class="code"><div class="highlight"><pre>         <span class="k">if</span> <span class="p">(</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">!=</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">parsed</span><span class="p">.</span><span class="nx">segments</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">parsed</span><span class="p">.</span><span class="nx">isGeneric</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="nb">Object</span><span class="p">.</span><span class="nx">size</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
         <span class="nx">size</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="nx">size</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URIResolver</span><span class="p">();</span>
<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span><span class="o">=</span><span class="nx">RDFaProcessor</span><span class="p">;</span>
<span class="kd">function</span> <span class="nx">RDFaProcessor</span><span class="p">(</span><span class="nx">targetObject</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span> <span class="o">=</span> <span class="nx">targetObject</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">tripleCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">triplesGraph</span> <span class="o">=</span> <span class="p">{};</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span> <span class="o">=</span> <span class="p">{};</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span> <span class="o">=</span> <span class="p">{};</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">language</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">vocabulary</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">typeURI</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#type&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">objectURI</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#object&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">XMLLiteralURI</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#XMLLiteral&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">PlainLiteralURI</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#PlainLiteral&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">blankCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">langAttributes</span> <span class="o">=</span> <span class="p">[</span> <span class="p">{</span> <span class="nx">namespaceURI</span><span class="o">:</span> <span class="s2">&quot;http://www.w3.org/XML/1998/namespace&quot;</span><span class="p">,</span> <span class="nx">localName</span><span class="o">:</span> <span class="s2">&quot;lang&quot;</span> <span class="p">}</span> <span class="p">];</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">contentAttributes</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;content&quot;</span> <span class="p">];</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">inXHTMLMode</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">absURIRE</span> <span class="o">=</span> <span class="sr">/[\w\_\-]+:\S+/</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">newBlankNode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">blankCounter</span><span class="o">++</span><span class="p">;</span>
   <span class="k">return</span> <span class="s2">&quot;_:&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">blankCounter</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">nameChar</span> <span class="o">=</span> <span class="s1">&#39;[-A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u10000-\uEFFFF\.0-9\u00B7\u0300-\u036F\u203F-\u2040]&#39;</span><span class="p">;</span>
<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">nameStartChar</span> <span class="o">=</span> <span class="s1">&#39;[\u0041-\u005A\u0061-\u007A\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u00FF\u0100-\u0131\u0134-\u013E\u0141-\u0148\u014A-\u017E\u0180-\u01C3\u01CD-\u01F0\u01F4-\u01F5\u01FA-\u0217\u0250-\u02A8\u02BB-\u02C1\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03CE\u03D0-\u03D6\u03DA\u03DC\u03DE\u03E0\u03E2-\u03F3\u0401-\u040C\u040E-\u044F\u0451-\u045C\u045E-\u0481\u0490-\u04C4\u04C7-\u04C8\u04CB-\u04CC\u04D0-\u04EB\u04EE-\u04F5\u04F8-\u04F9\u0531-\u0556\u0559\u0561-\u0586\u05D0-\u05EA\u05F0-\u05F2\u0621-\u063A\u0641-\u064A\u0671-\u06B7\u06BA-\u06BE\u06C0-\u06CE\u06D0-\u06D3\u06D5\u06E5-\u06E6\u0905-\u0939\u093D\u0958-\u0961\u0985-\u098C\u098F-\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09DC-\u09DD\u09DF-\u09E1\u09F0-\u09F1\u0A05-\u0A0A\u0A0F-\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32-\u0A33\u0A35-\u0A36\u0A38-\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8B\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2-\u0AB3\u0AB5-\u0AB9\u0ABD\u0AE0\u0B05-\u0B0C\u0B0F-\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32-\u0B33\u0B36-\u0B39\u0B3D\u0B5C-\u0B5D\u0B5F-\u0B61\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99-\u0B9A\u0B9C\u0B9E-\u0B9F\u0BA3-\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB5\u0BB7-\u0BB9\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C33\u0C35-\u0C39\u0C60-\u0C61\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CDE\u0CE0-\u0CE1\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D28\u0D2A-\u0D39\u0D60-\u0D61\u0E01-\u0E2E\u0E30\u0E32-\u0E33\u0E40-\u0E45\u0E81-\u0E82\u0E84\u0E87-\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA-\u0EAB\u0EAD-\u0EAE\u0EB0\u0EB2-\u0EB3\u0EBD\u0EC0-\u0EC4\u0F40-\u0F47\u0F49-\u0F69\u10A0-\u10C5\u10D0-\u10F6\u1100\u1102-\u1103\u1105-\u1107\u1109\u110B-\u110C\u110E-\u1112\u113C\u113E\u1140\u114C\u114E\u1150\u1154-\u1155\u1159\u115F-\u1161\u1163\u1165\u1167\u1169\u116D-\u116E\u1172-\u1173\u1175\u119E\u11A8\u11AB\u11AE-\u11AF\u11B7-\u11B8\u11BA\u11BC-\u11C2\u11EB\u11F0\u11F9\u1E00-\u1E9B\u1EA0-\u1EF9\u1F00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u2126\u212A-\u212B\u212E\u2180-\u2182\u3041-\u3094\u30A1-\u30FA\u3105-\u312C\uAC00-\uD7A3\u4E00-\u9FA5\u3007\u3021-\u3029_]&#39;</span><span class="p">;</span>
<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">NCNAME</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">nameStartChar</span> <span class="o">+</span> <span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">nameChar</span> <span class="o">+</span> <span class="s1">&#39;*$&#39;</span><span class="p">);</span>

<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">trim</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\s\s*/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s\s*$/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">tokenize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span><span class="nx">str</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">);</span>
<span class="p">}</span>


<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">parseSafeCURIEOrCURIEOrURI</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">)</span> <span class="p">{</span>
   <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;[&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;]&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
      <span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">parseCURIE</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">);</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">parseCURIEOrURI</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">parseCURIE</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">colon</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">colon</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">prefix</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">colon</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">prefix</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>default prefix</p>
</td><td class="code"><div class="highlight"><pre>         <span class="kd">var</span> <span class="nx">uri</span> <span class="o">=</span> <span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">];</span>
         <span class="k">return</span> <span class="nx">uri</span> <span class="o">?</span> <span class="nx">uri</span><span class="o">+</span><span class="nx">value</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">colon</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">prefix</span><span class="o">==</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>blank node</p>
</td><td class="code"><div class="highlight"><pre>         <span class="k">return</span> <span class="s2">&quot;_:&quot;</span><span class="o">+</span><span class="nx">value</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">colon</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">NCNAME</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">prefix</span><span class="p">))</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">uri</span> <span class="o">=</span> <span class="nx">prefixes</span><span class="p">[</span><span class="nx">prefix</span><span class="p">];</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">uri</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">uri</span><span class="o">+</span><span class="nx">value</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">colon</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">parseCURIEOrURI</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">curie</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parseCURIE</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">curie</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">curie</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">resolveAndNormalize</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span><span class="nx">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">parsePredicate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="nx">defaultVocabulary</span><span class="p">,</span><span class="nx">terms</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">predicate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parseTermOrCURIEOrAbsURI</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="nx">defaultVocabulary</span><span class="p">,</span><span class="nx">terms</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">predicate</span> <span class="o">&amp;&amp;</span> <span class="nx">predicate</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;_:&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="nx">predicate</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">parseTermOrCURIEOrURI</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="nx">defaultVocabulary</span><span class="p">,</span><span class="nx">terms</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>alert("Parsing "+value+" with default vocab "+defaultVocabulary);</p>
</td><td class="code"><div class="highlight"><pre>   <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
   <span class="kd">var</span> <span class="nx">curie</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parseCURIE</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">curie</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">curie</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
       <span class="kd">var</span> <span class="nx">term</span> <span class="o">=</span> <span class="nx">terms</span><span class="p">[</span><span class="nx">value</span><span class="p">];</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">term</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">term</span><span class="p">;</span>
       <span class="p">}</span>
       <span class="kd">var</span> <span class="nx">lcvalue</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
       <span class="nx">term</span> <span class="o">=</span> <span class="nx">terms</span><span class="p">[</span><span class="nx">lcvalue</span><span class="p">];</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">term</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">term</span><span class="p">;</span>
       <span class="p">}</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">defaultVocabulary</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">absURIRE</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">defaultVocabulary</span><span class="o">+</span><span class="nx">value</span>
       <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">resolveAndNormalize</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span><span class="nx">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">parseTermOrCURIEOrAbsURI</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="nx">defaultVocabulary</span><span class="p">,</span><span class="nx">terms</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>alert("Parsing "+value+" with default vocab "+defaultVocabulary);</p>
</td><td class="code"><div class="highlight"><pre>   <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
   <span class="kd">var</span> <span class="nx">curie</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parseCURIE</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">curie</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">curie</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">defaultVocabulary</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">absURIRE</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">defaultVocabulary</span><span class="o">+</span><span class="nx">value</span>
       <span class="p">}</span>
       <span class="kd">var</span> <span class="nx">term</span> <span class="o">=</span> <span class="nx">terms</span><span class="p">[</span><span class="nx">value</span><span class="p">];</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">term</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">term</span><span class="p">;</span>
       <span class="p">}</span>
       <span class="kd">var</span> <span class="nx">lcvalue</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
       <span class="nx">term</span> <span class="o">=</span> <span class="nx">terms</span><span class="p">[</span><span class="nx">lcvalue</span><span class="p">];</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">term</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">term</span><span class="p">;</span>
       <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">absURIRE</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">resolveAndNormalize</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span><span class="nx">value</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">resolveAndNormalize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span><span class="nx">href</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">u</span> <span class="o">=</span> <span class="nx">base</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">href</span><span class="p">);</span>
   <span class="kd">var</span> <span class="nx">parsed</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parseURI</span><span class="p">(</span><span class="nx">u</span><span class="p">);</span>
   <span class="nx">parsed</span><span class="p">.</span><span class="nx">normalize</span><span class="p">();</span>
   <span class="k">return</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">spec</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">parsePrefixMappings</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tokenize</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
   <span class="kd">var</span> <span class="nx">prefix</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="kd">var</span> <span class="nx">uri</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">prefix</span> <span class="o">=</span> <span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">prefix</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">target</span><span class="p">[</span><span class="nx">prefix</span><span class="p">]</span> <span class="o">=</span> <span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
         <span class="nx">prefix</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">copyMappings</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">mappings</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">newMappings</span> <span class="o">=</span> <span class="p">{};</span>
   <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">k</span> <span class="k">in</span> <span class="nx">mappings</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">newMappings</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">mappings</span><span class="p">[</span><span class="nx">k</span><span class="p">];</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="nx">newMappings</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">ancestorPath</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
   <span class="k">while</span> <span class="p">(</span><span class="nx">node</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeType</span><span class="o">!=</span><span class="nx">Node</span><span class="p">.</span><span class="nx">DOCUMENT_NODE</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">path</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="nx">node</span><span class="p">.</span><span class="nx">localName</span><span class="o">+</span><span class="nx">path</span><span class="p">;</span>
      <span class="nx">node</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="nx">path</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setContext</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>We only recognized XHTML+RDFa 1.1 if the version is set propertyly</p>
</td><td class="code"><div class="highlight"><pre>   <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">localName</span><span class="o">==</span><span class="s2">&quot;html&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;XHTML+RDFa 1.1&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setXHTMLContext</span><span class="p">();</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">localName</span><span class="o">==</span><span class="s2">&quot;html&quot;</span> <span class="o">||</span> <span class="nx">node</span><span class="p">.</span><span class="nx">namespaceURI</span><span class="o">==</span><span class="s2">&quot;http://www.w3.org/1999/xhtml&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setHTMLContext</span><span class="p">();</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setXMLContext</span><span class="p">();</span>
   <span class="p">}</span>

<span class="p">}</span>

<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setInitialContext</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">vocabulary</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span> <span class="o">=</span> <span class="p">{};</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span> <span class="o">=</span> <span class="p">{};</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">langAttributes</span> <span class="o">=</span> <span class="p">[</span> <span class="p">{</span> <span class="nx">namespaceURI</span><span class="o">:</span> <span class="s2">&quot;http://www.w3.org/XML/1998/namespace&quot;</span><span class="p">,</span> <span class="nx">localName</span><span class="o">:</span> <span class="s2">&quot;lang&quot;</span> <span class="p">}</span> <span class="p">];</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">contentAttributes</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;content&quot;</span> <span class="p">];</span>

   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#&quot;</span><span class="p">;</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>w3c</p>
</td><td class="code"><div class="highlight"><pre>   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;grddl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/2003/g/data-view#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;ma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/ns/ma-ont#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;owl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/2002/07/owl#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;rdf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;rdfa&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/ns/rdfa#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;rdfs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/2000/01/rdf-schema#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;rif&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/2007/rif#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;skos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/2004/02/skos/core#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;skosxl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/2008/05/skos-xl#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;wdr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/2007/05/powder#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;void&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://rdfs.org/ns/void#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;wdrs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/2007/05/powder-s#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;xhv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;xml&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/XML/1998/namespace&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;xsd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/2001/XMLSchema#&quot;</span><span class="p">;</span></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>non-rec w3c</p>
</td><td class="code"><div class="highlight"><pre>   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;sd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/ns/sparql-service-description#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;org&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/ns/org#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;gldp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/ns/people#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;cnt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/2008/content#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;dcat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/ns/dcat#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;earl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/ns/earl#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;ht&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/2006/http#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;ptr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/2009/pointers#&quot;</span><span class="p">;</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>widely used</p>
</td><td class="code"><div class="highlight"><pre>   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;cc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://creativecommons.org/ns#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;ctag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://commontag.org/ns#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;dc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://purl.org/dc/terms/&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;dcterms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://purl.org/dc/terms/&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;foaf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://xmlns.com/foaf/0.1/&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;gr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://purl.org/goodrelations/v1#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;ical&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/2002/12/cal/icaltzd#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;og&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://ogp.me/ns#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;rev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://purl.org/stuff/rev#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;sioc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://rdfs.org/sioc/ns#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://rdf.data-vocabulary.org/#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;vcard&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/2006/vcard/ns#&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://schema.org/&quot;</span><span class="p">;</span></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><p>terms</p>
</td><td class="code"><div class="highlight"><pre>   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;describedby&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/2007/05/powder-s#describedby&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;license&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#license&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#role&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setXMLContext</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">setInitialContext</span><span class="p">();</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">inXHTMLMode</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setHTMLContext</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">setInitialContext</span><span class="p">();</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">langAttributes</span> <span class="o">=</span> <span class="p">[</span> <span class="p">{</span> <span class="nx">namespaceURI</span><span class="o">:</span> <span class="s2">&quot;http://www.w3.org/XML/1998/namespace&quot;</span><span class="p">,</span> <span class="nx">localName</span><span class="o">:</span> <span class="s2">&quot;lang&quot;</span> <span class="p">},</span>
                           <span class="p">{</span> <span class="nx">namespaceURI</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">localName</span><span class="o">:</span> <span class="s2">&quot;lang&quot;</span> <span class="p">}];</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">contentAttributes</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span> <span class="p">];</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">inXHTMLMode</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setXHTMLContext</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

   <span class="k">this</span><span class="p">.</span><span class="nx">setInitialContext</span><span class="p">();</span>

   <span class="k">this</span><span class="p">.</span><span class="nx">inXHTMLMode</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

   <span class="k">this</span><span class="p">.</span><span class="nx">langAttributes</span> <span class="o">=</span> <span class="p">[</span> <span class="p">{</span> <span class="nx">namespaceURI</span><span class="o">:</span> <span class="s2">&quot;http://www.w3.org/XML/1998/namespace&quot;</span><span class="p">,</span> <span class="nx">localName</span><span class="o">:</span> <span class="s2">&quot;lang&quot;</span> <span class="p">}</span> <span class="p">];</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">contentAttributes</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;content&quot;</span> <span class="p">];</span></pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><p>From http://www.w3.org/2011/rdfa-context/xhtml-rdfa-1.1</p>
</td><td class="code"><div class="highlight"><pre>   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;alternate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#alternate&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;appendix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#appendix&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;bookmark&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#bookmark&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;cite&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#cite&quot;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;chapter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#chapter&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;contents&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#contents&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;copyright&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#copyright&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;first&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#first&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;glossary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#glossary&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;help&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#help&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;icon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#icon&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#index&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;last&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#last&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;license&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#license&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#meta&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;next&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#next&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;prev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#prev&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;previous&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#previous&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;section&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#section&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;stylesheet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#stylesheet&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;subsection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#subsection&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#start&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#top&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;up&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#up&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;p3pv1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#p3pv1&quot;</span><span class="p">;</span></pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a href="#section-16" class="pilcrow">&#182;</a></div><p>other</p>
</td><td class="code"><div class="highlight"><pre>   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;related&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#related&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#role&quot;</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">[</span><span class="s2">&quot;transformation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml/vocab#transformation&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getTransferGraph</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">graph</span> <span class="o">=</span> <span class="p">{};</span>
   <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">subject</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">snode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">[</span><span class="nx">subject</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">tsnode</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">subject</span><span class="o">:</span> <span class="nx">subject</span><span class="p">,</span> <span class="nx">predicates</span><span class="o">:</span> <span class="p">{}</span> <span class="p">};</span>
      <span class="nx">graph</span><span class="p">[</span><span class="nx">subject</span><span class="p">]</span> <span class="o">=</span> <span class="nx">tsnode</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">predicate</span> <span class="k">in</span> <span class="nx">snode</span><span class="p">.</span><span class="nx">predicates</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">pnode</span> <span class="o">=</span> <span class="nx">snode</span><span class="p">.</span><span class="nx">predicates</span><span class="p">[</span><span class="nx">predicate</span><span class="p">];</span>
         <span class="kd">var</span> <span class="nx">tpnode</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">predicate</span><span class="o">:</span> <span class="nx">predicate</span><span class="p">,</span> <span class="nx">objects</span><span class="o">:</span> <span class="p">[]</span> <span class="p">};</span>
         <span class="nx">tsnode</span><span class="p">.</span><span class="nx">predicates</span><span class="p">[</span><span class="nx">predicate</span><span class="p">]</span> <span class="o">=</span> <span class="nx">tpnode</span><span class="p">;</span>
         <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">XMLLiteralURI</span><span class="p">)</span> <span class="p">{</span>
               <span class="kd">var</span> <span class="nx">serializer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLSerializer</span><span class="p">();</span>
               <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
               <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">x</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">x</span><span class="o">&lt;</span><span class="nx">object</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="nx">x</span><span class="p">].</span><span class="nx">nodeType</span><span class="o">==</span><span class="nx">Node</span><span class="p">.</span><span class="nx">ELEMENT_NODE</span><span class="p">)</span> <span class="p">{</span>
                     <span class="nx">value</span> <span class="o">+=</span> <span class="nx">serializer</span><span class="p">.</span><span class="nx">serializeToString</span><span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="nx">x</span><span class="p">]);</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="nx">x</span><span class="p">].</span><span class="nx">nodeType</span><span class="o">==</span><span class="nx">Node</span><span class="p">.</span><span class="nx">TEXT_NODE</span><span class="p">)</span> <span class="p">{</span>
                     <span class="nx">value</span> <span class="o">+=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="nx">x</span><span class="p">].</span><span class="nx">nodeValue</span><span class="p">;</span>
                  <span class="p">}</span>
               <span class="p">}</span>
               <span class="nx">tpnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">value</span><span class="p">});</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="nx">tpnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">object</span><span class="p">.</span><span class="nx">value</span><span class="p">});</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="nx">graph</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">newSubject</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="nx">origin</span><span class="p">,</span><span class="nx">subject</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">snode</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">[</span><span class="nx">subject</span><span class="p">];</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">snode</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">snode</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">subject</span><span class="o">:</span> <span class="nx">subject</span><span class="p">,</span> <span class="nx">predicates</span><span class="o">:</span> <span class="p">{},</span> <span class="nx">origins</span><span class="o">:</span> <span class="p">[]</span> <span class="p">};</span>
      <span class="nx">data</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">[</span><span class="nx">subject</span><span class="p">]</span> <span class="o">=</span> <span class="nx">snode</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">snode</span><span class="p">.</span><span class="nx">origins</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">snode</span><span class="p">.</span><span class="nx">origins</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">==</span><span class="nx">origin</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">return</span> <span class="nx">snode</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">snode</span><span class="p">.</span><span class="nx">origins</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">origin</span><span class="p">);</span>
   <span class="k">return</span> <span class="nx">snode</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addTriple</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="nx">origin</span><span class="p">,</span><span class="nx">subject</span><span class="p">,</span><span class="nx">predicate</span><span class="p">,</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">graph</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">;</span>
   <span class="kd">var</span> <span class="nx">snode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">newSubject</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="nx">origin</span><span class="p">,</span><span class="nx">subject</span><span class="p">);</span>
   <span class="kd">var</span> <span class="nx">pnode</span> <span class="o">=</span> <span class="nx">snode</span><span class="p">.</span><span class="nx">predicates</span><span class="p">[</span><span class="nx">predicate</span><span class="p">];</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">pnode</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">pnode</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">predicate</span><span class="o">:</span> <span class="nx">predicate</span><span class="p">,</span> <span class="nx">objects</span><span class="o">:</span> <span class="p">[]</span> <span class="p">};</span>
      <span class="nx">snode</span><span class="p">.</span><span class="nx">predicates</span><span class="p">[</span><span class="nx">predicate</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pnode</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">type</span><span class="o">==</span><span class="nx">object</span><span class="p">.</span><span class="nx">type</span> <span class="o">&amp;&amp;</span> <span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">value</span><span class="o">==</span><span class="nx">object</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">data</span><span class="p">.</span><span class="nx">tripleCount</span><span class="o">++</span><span class="p">;</span>
   <span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
   <span class="nx">object</span><span class="p">.</span><span class="nx">origin</span> <span class="o">=</span> <span class="nx">origin</span><span class="p">;</span></pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a href="#section-17" class="pilcrow">&#182;</a></div><p>console.log("Added triple.");</p>
</td><td class="code"><div class="highlight"><pre><span class="p">}</span>

<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">process</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-18"><td class="docs"><div class="pilwrap"><a href="#section-18" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>if (!window.console) {<br />      window.console = { log: function() {} };<br />   }</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>   <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">nodeType</span><span class="o">==</span><span class="nx">Node</span><span class="p">.</span><span class="nx">DOCUMENT_NODE</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setContext</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="kd">var</span> <span class="nx">queue</span> <span class="o">=</span> <span class="p">[];</span>
   <span class="nx">queue</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="nx">current</span><span class="o">:</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">context</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">node</span><span class="p">.</span><span class="nx">baseURI</span><span class="p">)});</span>
   <span class="k">while</span> <span class="p">(</span><span class="nx">queue</span><span class="p">.</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-19"><td class="docs"><div class="pilwrap"><a href="#section-19" class="pilcrow">&#182;</a></div><p>Sequence Step 14: list triple generation</p>
</td><td class="code"><div class="highlight"><pre>         <span class="k">if</span> <span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">parent</span> <span class="o">&amp;&amp;</span> <span class="nx">item</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">listMapping</span><span class="o">==</span><span class="nx">item</span><span class="p">.</span><span class="nx">listMapping</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-20"><td class="docs"><div class="pilwrap"><a href="#section-20" class="pilcrow">&#182;</a></div><p>Skip a child context with exactly the same mapping</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">continue</span><span class="p">;</span>
         <span class="p">}</span></pre></div></td></tr><tr id="section-21"><td class="docs"><div class="pilwrap"><a href="#section-21" class="pilcrow">&#182;</a></div><p>console.log("Generating lists for "+item.subject+", tag "+item.parent.localName);</p>
</td><td class="code"><div class="highlight"><pre>         <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">predicate</span> <span class="k">in</span> <span class="nx">item</span><span class="p">.</span><span class="nx">listMapping</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">listMapping</span><span class="p">[</span><span class="nx">predicate</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">list</span><span class="p">.</span><span class="nx">length</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">this</span><span class="p">.</span><span class="nx">addTriple</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span><span class="nx">item</span><span class="p">.</span><span class="nx">parent</span><span class="p">,</span><span class="nx">item</span><span class="p">.</span><span class="nx">subject</span><span class="p">,</span><span class="nx">predicate</span><span class="p">,{</span> <span class="nx">type</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">objectURI</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s2">&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#nil&quot;</span> <span class="p">});</span>
               <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="kd">var</span> <span class="nx">bnodes</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">list</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">bnodes</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">newBlankNode</span><span class="p">());</span>
               <span class="k">this</span><span class="p">.</span><span class="nx">newSubject</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span><span class="nx">item</span><span class="p">.</span><span class="nx">parent</span><span class="p">,</span><span class="nx">bnodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">bnodes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">this</span><span class="p">.</span><span class="nx">addTriple</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span><span class="nx">item</span><span class="p">.</span><span class="nx">parent</span><span class="p">,</span><span class="nx">bnodes</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="s2">&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#first&quot;</span><span class="p">,</span><span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
               <span class="k">this</span><span class="p">.</span><span class="nx">addTriple</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span><span class="nx">item</span><span class="p">.</span><span class="nx">parent</span><span class="p">,</span><span class="nx">bnodes</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="s2">&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#rest&quot;</span><span class="p">,{</span> <span class="nx">type</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">objectURI</span> <span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;</span><span class="nx">bnodes</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">bnodes</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="s2">&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#nil&quot;</span> <span class="p">});</span>
            <span class="p">}</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">addTriple</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span><span class="nx">item</span><span class="p">.</span><span class="nx">parent</span><span class="p">,</span><span class="nx">item</span><span class="p">.</span><span class="nx">subject</span><span class="p">,</span><span class="nx">predicate</span><span class="p">,{</span> <span class="nx">type</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">objectURI</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">bnodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">});</span>
         <span class="p">}</span>
         <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">current</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">context</span><span class="p">;</span></pre></div></td></tr><tr id="section-22"><td class="docs"><div class="pilwrap"><a href="#section-22" class="pilcrow">&#182;</a></div><p>console.log("Tag: "+current.localName+", listMapping="+JSON.stringify(context.listMapping));</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-23"><td class="docs"><div class="pilwrap"><a href="#section-23" class="pilcrow">&#182;</a></div><p>Sequence Step 1</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">skip</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">newSubject</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">currentObjectResource</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">typedResource</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">prefixes</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">prefixesCopied</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">incomplete</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="kd">var</span> <span class="nx">listMapping</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">listMapping</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">listMappingDifferent</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">parent</span> <span class="o">?</span> <span class="kc">false</span> <span class="o">:</span> <span class="kc">true</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">language</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">language</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">vocabulary</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">vocabulary</span><span class="p">;</span></pre></div></td></tr><tr id="section-24"><td class="docs"><div class="pilwrap"><a href="#section-24" class="pilcrow">&#182;</a></div><p>TODO: the "base" element may be used for HTML+RDFa 1.1</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">base</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parseURI</span><span class="p">(</span><span class="nx">current</span><span class="p">.</span><span class="nx">baseURI</span><span class="p">);</span>
      <span class="nx">current</span><span class="p">.</span><span class="nx">subject</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div></td></tr><tr id="section-25"><td class="docs"><div class="pilwrap"><a href="#section-25" class="pilcrow">&#182;</a></div><p>Sequence Step 2: set the default vocabulary</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">vocabAtt</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">getAttributeNode</span><span class="p">(</span><span class="s2">&quot;vocab&quot;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">vocabAtt</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span><span class="nx">vocabAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">vocabulary</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">baseSubject</span> <span class="o">=</span> <span class="nx">base</span><span class="p">.</span><span class="nx">spec</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">newSubject</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span><span class="nx">current</span><span class="p">,</span><span class="nx">baseSubject</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">addTriple</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span><span class="nx">current</span><span class="p">,</span><span class="nx">baseSubject</span><span class="p">,</span><span class="s2">&quot;http://www.w3.org/ns/rdfa#usesVocabulary&quot;</span><span class="p">,{</span> <span class="nx">type</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">objectURI</span> <span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">vocabulary</span><span class="p">});</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">vocabulary</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">vocabulary</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-26"><td class="docs"><div class="pilwrap"><a href="#section-26" class="pilcrow">&#182;</a></div><p>Sequence Step 3: IRI mappings
handle xmlns attributes</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">current</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">att</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span></pre></div></td></tr><tr id="section-27"><td class="docs"><div class="pilwrap"><a href="#section-27" class="pilcrow">&#182;</a></div><p>if (att.namespaceURI=="http://www.w3.org/2000/xmlns/") {</p>
</td><td class="code"><div class="highlight"><pre>         <span class="k">if</span> <span class="p">(</span><span class="nx">att</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;x&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">att</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;xmlns:&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">prefixesCopied</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">prefixes</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">copyMappings</span><span class="p">(</span><span class="nx">prefixes</span><span class="p">);</span>
               <span class="nx">prefixesCopied</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="kd">var</span> <span class="nx">prefix</span> <span class="o">=</span> <span class="nx">att</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span></pre></div></td></tr><tr id="section-28"><td class="docs"><div class="pilwrap"><a href="#section-28" class="pilcrow">&#182;</a></div><p>TODO: resolve relative?</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">prefixes</span><span class="p">[</span><span class="nx">prefix</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span><span class="nx">att</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-29"><td class="docs"><div class="pilwrap"><a href="#section-29" class="pilcrow">&#182;</a></div><p>Handle prefix mappings (@prefix)</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">prefixAtt</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">getAttributeNode</span><span class="p">(</span><span class="s2">&quot;prefix&quot;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">prefixAtt</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">prefixesCopied</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">prefixes</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">copyMappings</span><span class="p">(</span><span class="nx">prefixes</span><span class="p">);</span>
            <span class="nx">prefixesCopied</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">parsePrefixMappings</span><span class="p">(</span><span class="nx">prefixAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">);</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-30"><td class="docs"><div class="pilwrap"><a href="#section-30" class="pilcrow">&#182;</a></div><p>Sequence Step 4: language</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">xmlLangAtt</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="nx">xmlLangAtt</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">langAttributes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">xmlLangAtt</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">getAttributeNodeNS</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">langAttributes</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">namespaceURI</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">langAttributes</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">localName</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">xmlLangAtt</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span><span class="nx">xmlLangAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">language</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">relAtt</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">getAttributeNode</span><span class="p">(</span><span class="s2">&quot;rel&quot;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">revAtt</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">getAttributeNode</span><span class="p">(</span><span class="s2">&quot;rev&quot;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">typeofAtt</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">getAttributeNode</span><span class="p">(</span><span class="s2">&quot;typeof&quot;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">propertyAtt</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">getAttributeNode</span><span class="p">(</span><span class="s2">&quot;property&quot;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">datatypeAtt</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">getAttributeNode</span><span class="p">(</span><span class="s2">&quot;datatype&quot;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">contentAtt</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="nx">contentAtt</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">contentAttributes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">contentAtt</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">getAttributeNode</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">contentAttributes</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">aboutAtt</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">getAttributeNode</span><span class="p">(</span><span class="s2">&quot;about&quot;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">srcAtt</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">getAttributeNode</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">resourceAtt</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">getAttributeNode</span><span class="p">(</span><span class="s2">&quot;resource&quot;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">hrefAtt</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">getAttributeNode</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">inlistAtt</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">getAttributeNode</span><span class="p">(</span><span class="s2">&quot;inlist&quot;</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">relAtt</span> <span class="o">||</span> <span class="nx">revAtt</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-31"><td class="docs"><div class="pilwrap"><a href="#section-31" class="pilcrow">&#182;</a></div><p>Sequence Step 6: establish new subject and value</p>
</td><td class="code"><div class="highlight"><pre>         <span class="k">if</span> <span class="p">(</span><span class="nx">aboutAtt</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">newSubject</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parseSafeCURIEOrCURIEOrURI</span><span class="p">(</span><span class="nx">aboutAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">typeofAtt</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">typedResource</span> <span class="o">=</span> <span class="nx">newSubject</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">newSubject</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">current</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">nodeType</span><span class="o">==</span><span class="nx">Node</span><span class="p">.</span><span class="nx">DOCUMENT_NODE</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">newSubject</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">baseURI</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">parentObject</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-32"><td class="docs"><div class="pilwrap"><a href="#section-32" class="pilcrow">&#182;</a></div><p>TODO: Verify: If the xml:base has been set and the parentObject is the baseURI of the parent, then the subject needs to be the new base URI</p>
</td><td class="code"><div class="highlight"><pre>               <span class="nx">newSubject</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">baseURI</span><span class="o">==</span><span class="nx">context</span><span class="p">.</span><span class="nx">parentObject</span> <span class="o">?</span> <span class="nx">current</span><span class="p">.</span><span class="nx">baseURI</span> <span class="o">:</span> <span class="nx">context</span><span class="p">.</span><span class="nx">parentObject</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">resourceAtt</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">currentObjectResource</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parseSafeCURIEOrCURIEOrURI</span><span class="p">(</span><span class="nx">resourceAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">);</span>
         <span class="p">}</span>

         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">currentObjectResource</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">hrefAtt</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">currentObjectResource</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">resolveAndNormalize</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span><span class="nx">hrefAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">srcAtt</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">currentObjectResource</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">resolveAndNormalize</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span><span class="nx">srcAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">typeofAtt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">aboutAtt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">inXHTMLMode</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">current</span><span class="p">.</span><span class="nx">localName</span><span class="o">==</span><span class="s2">&quot;head&quot;</span> <span class="o">||</span> <span class="nx">current</span><span class="p">.</span><span class="nx">localName</span><span class="o">==</span><span class="s2">&quot;body&quot;</span><span class="p">)))</span> <span class="p">{</span>
               <span class="nx">currentObjectResource</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">newBlankNode</span><span class="p">();</span>
            <span class="p">}</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">typeofAtt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">aboutAtt</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">inXHTMLMode</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">current</span><span class="p">.</span><span class="nx">localName</span><span class="o">==</span><span class="s2">&quot;head&quot;</span> <span class="o">||</span> <span class="nx">current</span><span class="p">.</span><span class="nx">localName</span><span class="o">==</span><span class="s2">&quot;body&quot;</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">typedResource</span> <span class="o">=</span> <span class="nx">newSubject</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">typeofAtt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">aboutAtt</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">typedResource</span> <span class="o">=</span> <span class="nx">currentObjectResource</span><span class="p">;</span>
         <span class="p">}</span>

      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">propertyAtt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">contentAtt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">datatypeAtt</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-33"><td class="docs"><div class="pilwrap"><a href="#section-33" class="pilcrow">&#182;</a></div><p>Sequence Step 5.1: establish a new subject</p>
</td><td class="code"><div class="highlight"><pre>         <span class="k">if</span> <span class="p">(</span><span class="nx">aboutAtt</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">newSubject</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parseSafeCURIEOrCURIEOrURI</span><span class="p">(</span><span class="nx">aboutAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">typeofAtt</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">typedResource</span> <span class="o">=</span> <span class="nx">newSubject</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">newSubject</span> <span class="o">&amp;&amp;</span> <span class="nx">current</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">nodeType</span><span class="o">==</span><span class="nx">Node</span><span class="p">.</span><span class="nx">DOCUMENT_NODE</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">newSubject</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">baseURI</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">typeofAtt</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">typedResource</span> <span class="o">=</span> <span class="nx">newSubject</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">newSubject</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">parentObject</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-34"><td class="docs"><div class="pilwrap"><a href="#section-34" class="pilcrow">&#182;</a></div><p>TODO: Verify: If the xml:base has been set and the parentObject is the baseURI of the parent, then the subject needs to be the new base URI</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">newSubject</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">baseURI</span><span class="o">==</span><span class="nx">context</span><span class="p">.</span><span class="nx">parentObject</span> <span class="o">?</span> <span class="nx">current</span><span class="p">.</span><span class="nx">baseURI</span> <span class="o">:</span> <span class="nx">context</span><span class="p">.</span><span class="nx">parentObject</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">typeofAtt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">typedResource</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">resourceAtt</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">typedResource</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parseSafeCURIEOrCURIEOrURI</span><span class="p">(</span><span class="nx">resourceAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">typedResource</span> <span class="o">&amp;&amp;</span><span class="nx">hrefAtt</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">typedResource</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">resolveAndNormalize</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span><span class="nx">hrefAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">typedResource</span> <span class="o">&amp;&amp;</span> <span class="nx">srcAtt</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">typedResource</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">resolveAndNormalize</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span><span class="nx">srcAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">typedResource</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">inXHTMLMode</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">current</span><span class="p">.</span><span class="nx">localName</span><span class="o">==</span><span class="s2">&quot;head&quot;</span> <span class="o">||</span> <span class="nx">current</span><span class="p">.</span><span class="nx">localName</span><span class="o">==</span><span class="s2">&quot;body&quot;</span><span class="p">))</span> <span class="p">{</span>
               <span class="nx">typedResource</span> <span class="o">=</span> <span class="nx">newSubject</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">typedResource</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">typedResource</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">newBlankNode</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="nx">currentObjectResource</span> <span class="o">=</span> <span class="nx">typedResource</span><span class="p">;</span>
         <span class="p">}</span></pre></div></td></tr><tr id="section-35"><td class="docs"><div class="pilwrap"><a href="#section-35" class="pilcrow">&#182;</a></div><p>console.log(current.localName+", newSubject="+newSubject+", typedResource="+typedResource+", currentObjectResource="+currentObjectResource);</p>
</td><td class="code"><div class="highlight"><pre>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-36"><td class="docs"><div class="pilwrap"><a href="#section-36" class="pilcrow">&#182;</a></div><p>Sequence Step 5.2: establish a new subject</p>
</td><td class="code"><div class="highlight"><pre>         <span class="k">if</span> <span class="p">(</span><span class="nx">aboutAtt</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">newSubject</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parseSafeCURIEOrCURIEOrURI</span><span class="p">(</span><span class="nx">aboutAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">newSubject</span> <span class="o">&amp;&amp;</span> <span class="nx">resourceAtt</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">newSubject</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parseSafeCURIEOrCURIEOrURI</span><span class="p">(</span><span class="nx">resourceAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">newSubject</span> <span class="o">&amp;&amp;</span> <span class="nx">hrefAtt</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">newSubject</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">resolveAndNormalize</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span><span class="nx">hrefAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">typedResource</span> <span class="o">&amp;&amp;</span> <span class="nx">srcAtt</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">newSubject</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">resolveAndNormalize</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span><span class="nx">srcAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">newSubject</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">current</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">nodeType</span><span class="o">==</span><span class="nx">Node</span><span class="p">.</span><span class="nx">DOCUMENT_NODE</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">newSubject</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">baseURI</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">inXHTMLMode</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">current</span><span class="p">.</span><span class="nx">localName</span><span class="o">==</span><span class="s2">&quot;head&quot;</span> <span class="o">||</span> <span class="nx">current</span><span class="p">.</span><span class="nx">localName</span><span class="o">==</span><span class="s2">&quot;body&quot;</span><span class="p">))</span> <span class="p">{</span>
               <span class="nx">newSubject</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">baseURI</span><span class="o">==</span><span class="nx">context</span><span class="p">.</span><span class="nx">parentObject</span> <span class="o">?</span> <span class="nx">current</span><span class="p">.</span><span class="nx">baseURI</span> <span class="o">:</span> <span class="nx">context</span><span class="p">.</span><span class="nx">parentObject</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">typeofAtt</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">newSubject</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">newBlankNode</span><span class="p">();</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">parentObject</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-37"><td class="docs"><div class="pilwrap"><a href="#section-37" class="pilcrow">&#182;</a></div><p>TODO: Verify: If the xml:base has been set and the parentObject is the baseURI of the parent, then the subject needs to be the new base URI</p>
</td><td class="code"><div class="highlight"><pre>               <span class="nx">newSubject</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">baseURI</span><span class="o">==</span><span class="nx">context</span><span class="p">.</span><span class="nx">parentObject</span> <span class="o">?</span> <span class="nx">current</span><span class="p">.</span><span class="nx">baseURI</span> <span class="o">:</span> <span class="nx">context</span><span class="p">.</span><span class="nx">parentObject</span><span class="p">;</span>
               <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">propertyAtt</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">skip</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">typeofAtt</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">typedResource</span> <span class="o">=</span> <span class="nx">newSubject</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-38"><td class="docs"><div class="pilwrap"><a href="#section-38" class="pilcrow">&#182;</a></div><p>console.log(current.tagName+": newSubject="+newSubject+", currentObjectResource="+currentObjectResource+", skip="+skip);</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">newSubject</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">newSubject</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span><span class="nx">current</span><span class="p">,</span><span class="nx">newSubject</span><span class="p">);</span>
         <span class="nx">current</span><span class="p">.</span><span class="nx">subject</span> <span class="o">=</span> <span class="nx">newSubject</span><span class="p">;</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-39"><td class="docs"><div class="pilwrap"><a href="#section-39" class="pilcrow">&#182;</a></div><p>Sequence Step 7: generate type triple</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">typedResource</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tokenize</span><span class="p">(</span><span class="nx">typeofAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
         <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parseTermOrCURIEOrAbsURI</span><span class="p">(</span><span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">vocabulary</span><span class="p">,</span><span class="nx">context</span><span class="p">.</span><span class="nx">terms</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">this</span><span class="p">.</span><span class="nx">addTriple</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span><span class="nx">current</span><span class="p">,</span><span class="nx">typedResource</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">typeURI</span><span class="p">,{</span> <span class="nx">type</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">objectURI</span> <span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">object</span><span class="p">});</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-40"><td class="docs"><div class="pilwrap"><a href="#section-40" class="pilcrow">&#182;</a></div><p>Sequence Step 8: new list mappings if there is a new subject
console.log("Step 8: newSubject="+newSubject+", context.parentObject="+context.parentObject);</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">newSubject</span> <span class="o">&amp;&amp;</span> <span class="nx">newSubject</span><span class="o">!=</span><span class="nx">context</span><span class="p">.</span><span class="nx">parentObject</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-41"><td class="docs"><div class="pilwrap"><a href="#section-41" class="pilcrow">&#182;</a></div><p>console.log("Generating new list mapping for "+newSubject);</p>
</td><td class="code"><div class="highlight"><pre>         <span class="nx">listMapping</span> <span class="o">=</span> <span class="p">{};</span>
         <span class="nx">listMappingDifferent</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-42"><td class="docs"><div class="pilwrap"><a href="#section-42" class="pilcrow">&#182;</a></div><p>Sequence Step 9: generate object triple</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">currentObjectResource</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">relAtt</span> <span class="o">&amp;&amp;</span> <span class="nx">inlistAtt</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tokenize</span><span class="p">(</span><span class="nx">relAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
               <span class="kd">var</span> <span class="nx">predicate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parsePredicate</span><span class="p">(</span><span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">vocabulary</span><span class="p">,</span><span class="nx">context</span><span class="p">.</span><span class="nx">terms</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">);</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">predicate</span><span class="p">)</span> <span class="p">{</span>
                  <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">listMapping</span><span class="p">[</span><span class="nx">predicate</span><span class="p">];</span>
                  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
                     <span class="nx">list</span> <span class="o">=</span> <span class="p">[];</span>
                     <span class="nx">listMapping</span><span class="p">[</span><span class="nx">predicate</span><span class="p">]</span> <span class="o">=</span> <span class="nx">list</span><span class="p">;</span>
                  <span class="p">}</span>
                  <span class="nx">list</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">objectURI</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">currentObjectResource</span> <span class="p">});</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">relAtt</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tokenize</span><span class="p">(</span><span class="nx">relAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span></pre></div></td></tr><tr id="section-43"><td class="docs"><div class="pilwrap"><a href="#section-43" class="pilcrow">&#182;</a></div><p>alert(newSubject+" "+relAtt.value+" "+currentObjectResource+" "+values.length);</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
               <span class="kd">var</span> <span class="nx">predicate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parsePredicate</span><span class="p">(</span><span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">vocabulary</span><span class="p">,</span><span class="nx">context</span><span class="p">.</span><span class="nx">terms</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">);</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">predicate</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">this</span><span class="p">.</span><span class="nx">addTriple</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span><span class="nx">current</span><span class="p">,</span><span class="nx">newSubject</span><span class="p">,</span><span class="nx">predicate</span><span class="p">,{</span> <span class="nx">type</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">objectURI</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">currentObjectResource</span><span class="p">});</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">revAtt</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tokenize</span><span class="p">(</span><span class="nx">revAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
               <span class="kd">var</span> <span class="nx">predicate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parsePredicate</span><span class="p">(</span><span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">vocabulary</span><span class="p">,</span><span class="nx">context</span><span class="p">.</span><span class="nx">terms</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">);</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">predicate</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">this</span><span class="p">.</span><span class="nx">addTriple</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span><span class="nx">current</span><span class="p">,</span><span class="nx">currentObjectResource</span><span class="p">,</span> <span class="nx">predicate</span><span class="p">,</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">objectURI</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">newSubject</span><span class="p">});</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-44"><td class="docs"><div class="pilwrap"><a href="#section-44" class="pilcrow">&#182;</a></div><p>Sequence Step 10: incomplete triples</p>
</td><td class="code"><div class="highlight"><pre>         <span class="k">if</span> <span class="p">(</span><span class="nx">newSubject</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">currentObjectResource</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">relAtt</span> <span class="o">||</span> <span class="nx">revAtt</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">currentObjectResource</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">newBlankNode</span><span class="p">();</span></pre></div></td></tr><tr id="section-45"><td class="docs"><div class="pilwrap"><a href="#section-45" class="pilcrow">&#182;</a></div><p>alert(current.tagName+": generated blank node, newSubject="+newSubject+" currentObjectResource="+currentObjectResource);</p>
</td><td class="code"><div class="highlight"><pre>         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">relAtt</span> <span class="o">&amp;&amp;</span> <span class="nx">inlistAtt</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tokenize</span><span class="p">(</span><span class="nx">relAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
               <span class="kd">var</span> <span class="nx">predicate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parsePredicate</span><span class="p">(</span><span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">vocabulary</span><span class="p">,</span><span class="nx">context</span><span class="p">.</span><span class="nx">terms</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">);</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">predicate</span><span class="p">)</span> <span class="p">{</span>
                  <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">listMapping</span><span class="p">[</span><span class="nx">predicate</span><span class="p">];</span>
                  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
                     <span class="nx">list</span> <span class="o">=</span> <span class="p">[];</span>
                     <span class="nx">listMapping</span><span class="p">[</span><span class="nx">predicate</span><span class="p">]</span> <span class="o">=</span> <span class="nx">list</span><span class="p">;</span>
                  <span class="p">}</span></pre></div></td></tr><tr id="section-46"><td class="docs"><div class="pilwrap"><a href="#section-46" class="pilcrow">&#182;</a></div><p>console.log("Adding incomplete list for "+predicate);</p>
</td><td class="code"><div class="highlight"><pre>                  <span class="nx">incomplete</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="nx">predicate</span><span class="o">:</span> <span class="nx">predicate</span><span class="p">,</span> <span class="nx">list</span><span class="o">:</span> <span class="nx">list</span> <span class="p">});</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">relAtt</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tokenize</span><span class="p">(</span><span class="nx">relAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
               <span class="kd">var</span> <span class="nx">predicate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parsePredicate</span><span class="p">(</span><span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">vocabulary</span><span class="p">,</span><span class="nx">context</span><span class="p">.</span><span class="nx">terms</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">);</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">predicate</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">incomplete</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="nx">predicate</span><span class="o">:</span> <span class="nx">predicate</span><span class="p">,</span> <span class="nx">forward</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
               <span class="p">}</span>

            <span class="p">}</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">revAtt</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tokenize</span><span class="p">(</span><span class="nx">revAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
               <span class="kd">var</span> <span class="nx">predicate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parsePredicate</span><span class="p">(</span><span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">vocabulary</span><span class="p">,</span><span class="nx">context</span><span class="p">.</span><span class="nx">terms</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">);</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">predicate</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">incomplete</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="nx">predicate</span><span class="o">:</span> <span class="nx">predicate</span><span class="p">,</span> <span class="nx">forward</span><span class="o">:</span> <span class="kc">false</span> <span class="p">});</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-47"><td class="docs"><div class="pilwrap"><a href="#section-47" class="pilcrow">&#182;</a></div><p>Step 11: Current property values</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">propertyAtt</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-48"><td class="docs"><div class="pilwrap"><a href="#section-48" class="pilcrow">&#182;</a></div><p>TODO: for HTML+RDFa 1.1, the datatype must be set if the content comes from the datetime attribute
alert(current.baseURI+" "+newSubject+" "+propertyAtt.value);</p>
</td><td class="code"><div class="highlight"><pre>         <span class="kd">var</span> <span class="nx">datatype</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
         <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">datatypeAtt</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">datatype</span> <span class="o">=</span> <span class="nx">datatypeAtt</span><span class="p">.</span><span class="nx">value</span><span class="o">==</span><span class="s2">&quot;&quot;</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">PlainLiteralURI</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">parseTermOrCURIEOrAbsURI</span><span class="p">(</span><span class="nx">datatypeAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span><span class="nx">vocabulary</span><span class="p">,</span><span class="nx">context</span><span class="p">.</span><span class="nx">terms</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">);</span>
            <span class="nx">content</span> <span class="o">=</span> <span class="nx">datatype</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">XMLLiteralURI</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="p">(</span><span class="nx">contentAtt</span> <span class="o">?</span> <span class="nx">contentAtt</span><span class="p">.</span><span class="nx">value</span> <span class="o">:</span> <span class="nx">current</span><span class="p">.</span><span class="nx">textContent</span><span class="p">);</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">contentAtt</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">datatype</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">PlainLiteralURI</span><span class="p">;</span>
            <span class="nx">content</span> <span class="o">=</span> <span class="nx">contentAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">relAtt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">revAtt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">contentAtt</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">resourceAtt</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">content</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parseSafeCURIEOrCURIEOrURI</span><span class="p">(</span><span class="nx">resourceAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">content</span> <span class="o">&amp;&amp;</span> <span class="nx">hrefAtt</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">content</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">resolveAndNormalize</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span><span class="nx">hrefAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">content</span> <span class="o">&amp;&amp;</span> <span class="nx">srcAtt</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">content</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">resolveAndNormalize</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span><span class="nx">srcAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">datatype</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">objectURI</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">datatype</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">typeofAtt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">aboutAtt</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">datatype</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">objectURI</span><span class="p">;</span>
               <span class="nx">content</span> <span class="o">=</span> <span class="nx">typedResource</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="nx">datatype</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">PlainLiteralURI</span><span class="p">;</span>
               <span class="nx">content</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">textContent</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">}</span>
         <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tokenize</span><span class="p">(</span><span class="nx">propertyAtt</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
         <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">predicate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parsePredicate</span><span class="p">(</span><span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">vocabulary</span><span class="p">,</span><span class="nx">context</span><span class="p">.</span><span class="nx">terms</span><span class="p">,</span><span class="nx">prefixes</span><span class="p">,</span><span class="nx">base</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">predicate</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">inlistAtt</span><span class="p">)</span> <span class="p">{</span>
                  <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">listMapping</span><span class="p">[</span><span class="nx">predicate</span><span class="p">];</span>
                  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
                     <span class="nx">list</span> <span class="o">=</span> <span class="p">[];</span>
                     <span class="nx">listMapping</span><span class="p">[</span><span class="nx">predicate</span><span class="p">]</span> <span class="o">=</span> <span class="nx">list</span><span class="p">;</span>
                  <span class="p">}</span>
                  <span class="nx">list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">datatype</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">XMLLiteralURI</span> <span class="o">?</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">XMLLiteralURI</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">current</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">}</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">datatype</span> <span class="o">?</span> <span class="nx">datatype</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">PlainLiteralURI</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">language</span><span class="o">:</span> <span class="nx">language</span><span class="p">});</span>
               <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">datatype</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">XMLLiteralURI</span><span class="p">)</span> <span class="p">{</span>
                     <span class="k">this</span><span class="p">.</span><span class="nx">addTriple</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span><span class="nx">current</span><span class="p">,</span><span class="nx">newSubject</span><span class="p">,</span><span class="nx">predicate</span><span class="p">,{</span> <span class="nx">type</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">XMLLiteralURI</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">current</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">});</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                     <span class="k">this</span><span class="p">.</span><span class="nx">addTriple</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span><span class="nx">current</span><span class="p">,</span><span class="nx">newSubject</span><span class="p">,</span><span class="nx">predicate</span><span class="p">,{</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">datatype</span> <span class="o">?</span> <span class="nx">datatype</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">PlainLiteralURI</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">language</span><span class="o">:</span> <span class="nx">language</span><span class="p">});</span></pre></div></td></tr><tr id="section-49"><td class="docs"><div class="pilwrap"><a href="#section-49" class="pilcrow">&#182;</a></div><p>console.log(newSubject+" "+predicate+"="+content);</p>
</td><td class="code"><div class="highlight"><pre>                  <span class="p">}</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-50"><td class="docs"><div class="pilwrap"><a href="#section-50" class="pilcrow">&#182;</a></div><p>Sequence Step 12: complete incomplete triples with new subject</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">newSubject</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">skip</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">context</span><span class="p">.</span><span class="nx">incomplete</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">incomplete</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">list</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-51"><td class="docs"><div class="pilwrap"><a href="#section-51" class="pilcrow">&#182;</a></div><p>console.log("Adding subject "+newSubject+" to list for "+context.incomplete[i].predicate);
TODO: it is unclear what to do here</p>
</td><td class="code"><div class="highlight"><pre>               <span class="nx">context</span><span class="p">.</span><span class="nx">incomplete</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">list</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">objectURI</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">newSubject</span> <span class="p">});</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">incomplete</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">forward</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-52"><td class="docs"><div class="pilwrap"><a href="#section-52" class="pilcrow">&#182;</a></div><p>console.log(current.tagName+": completing forward triple "+context.incomplete[i].predicate+" with object="+newSubject);</p>
</td><td class="code"><div class="highlight"><pre>               <span class="k">this</span><span class="p">.</span><span class="nx">addTriple</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span><span class="nx">current</span><span class="p">,</span><span class="nx">context</span><span class="p">.</span><span class="nx">subject</span><span class="p">,</span><span class="nx">context</span><span class="p">.</span><span class="nx">incomplete</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">predicate</span><span class="p">,</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">objectURI</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">newSubject</span><span class="p">});</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-53"><td class="docs"><div class="pilwrap"><a href="#section-53" class="pilcrow">&#182;</a></div><p>console.log(current.tagName+": completing reverse triple with object="+context.subject);</p>
</td><td class="code"><div class="highlight"><pre>               <span class="k">this</span><span class="p">.</span><span class="nx">addTriple</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span><span class="nx">current</span><span class="p">,</span><span class="nx">newSubject</span><span class="p">,</span><span class="nx">context</span><span class="p">.</span><span class="nx">incomplete</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">predicate</span><span class="p">,{</span> <span class="nx">type</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">objectURI</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">context</span><span class="p">.</span><span class="nx">subject</span><span class="p">});</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">childContext</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">listSubject</span> <span class="o">=</span> <span class="nx">newSubject</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">skip</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-54"><td class="docs"><div class="pilwrap"><a href="#section-54" class="pilcrow">&#182;</a></div><p>TODO: should subject be null?</p>
</td><td class="code"><div class="highlight"><pre>         <span class="nx">childContext</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span><span class="nx">context</span><span class="p">.</span><span class="nx">subject</span><span class="p">);</span></pre></div></td></tr><tr id="section-55"><td class="docs"><div class="pilwrap"><a href="#section-55" class="pilcrow">&#182;</a></div><p>TODO: should the entObject be passed along?  If not, then intermediary children will keep properties from being associated with incomplete triples.
TODO: Verify: if the current baseURI has changed and the parentObject is the parent's base URI, then the baseURI should change</p>
</td><td class="code"><div class="highlight"><pre>         <span class="nx">childContext</span><span class="p">.</span><span class="nx">parentObject</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">baseURI</span><span class="o">==</span><span class="nx">context</span><span class="p">.</span><span class="nx">parentObject</span> <span class="o">?</span> <span class="nx">current</span><span class="p">.</span><span class="nx">baseURI</span> <span class="o">:</span> <span class="nx">context</span><span class="p">.</span><span class="nx">parentObject</span><span class="p">;</span>
         <span class="nx">childContext</span><span class="p">.</span><span class="nx">incomplete</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">incomplete</span><span class="p">;</span>
         <span class="nx">childContext</span><span class="p">.</span><span class="nx">language</span> <span class="o">=</span> <span class="nx">language</span><span class="p">;</span>
         <span class="nx">childContext</span><span class="p">.</span><span class="nx">prefixes</span> <span class="o">=</span> <span class="nx">prefixes</span><span class="p">;</span>
         <span class="nx">childContext</span><span class="p">.</span><span class="nx">vocabulary</span> <span class="o">=</span> <span class="nx">vocabulary</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">childContext</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span><span class="nx">newSubject</span><span class="p">);</span>
         <span class="nx">childContext</span><span class="p">.</span><span class="nx">parentObject</span> <span class="o">=</span> <span class="nx">currentObjectResource</span> <span class="o">?</span> <span class="nx">currentObjectResource</span> <span class="o">:</span> <span class="p">(</span><span class="nx">newSubject</span> <span class="o">?</span> <span class="nx">newSubject</span> <span class="o">:</span> <span class="nx">context</span><span class="p">.</span><span class="nx">subject</span><span class="p">);</span>
         <span class="nx">childContext</span><span class="p">.</span><span class="nx">prefixes</span> <span class="o">=</span> <span class="nx">prefixes</span><span class="p">;</span>
         <span class="nx">childContext</span><span class="p">.</span><span class="nx">incomplete</span> <span class="o">=</span> <span class="nx">incomplete</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">currentObjectResource</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-56"><td class="docs"><div class="pilwrap"><a href="#section-56" class="pilcrow">&#182;</a></div><p>console.log("Generating new list mapping for "+currentObjectResource);</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">listSubject</span> <span class="o">=</span> <span class="nx">currentObjectResource</span><span class="p">;</span>
            <span class="nx">listMapping</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="nx">listMappingDifferent</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="nx">childContext</span><span class="p">.</span><span class="nx">listMapping</span> <span class="o">=</span> <span class="nx">listMapping</span><span class="p">;</span>
         <span class="nx">childContext</span><span class="p">.</span><span class="nx">language</span> <span class="o">=</span> <span class="nx">language</span><span class="p">;</span>
         <span class="nx">childContext</span><span class="p">.</span><span class="nx">vocabulary</span> <span class="o">=</span> <span class="nx">vocabulary</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">listMappingDifferent</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-57"><td class="docs"><div class="pilwrap"><a href="#section-57" class="pilcrow">&#182;</a></div><p>console.log("Pushing list parent "+current.localName);</p>
</td><td class="code"><div class="highlight"><pre>         <span class="nx">queue</span><span class="p">.</span><span class="nx">unshift</span><span class="p">({</span> <span class="nx">parent</span><span class="o">:</span> <span class="nx">current</span><span class="p">,</span> <span class="nx">context</span><span class="o">:</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">subject</span><span class="o">:</span> <span class="nx">listSubject</span><span class="p">,</span> <span class="nx">listMapping</span><span class="o">:</span> <span class="nx">listMapping</span><span class="p">});</span>
      <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">child</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">lastChild</span><span class="p">;</span> <span class="nx">child</span><span class="p">;</span> <span class="nx">child</span> <span class="o">=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">previousSibling</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">nodeType</span><span class="o">==</span><span class="nx">Node</span><span class="p">.</span><span class="nx">ELEMENT_NODE</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-58"><td class="docs"><div class="pilwrap"><a href="#section-58" class="pilcrow">&#182;</a></div><p>console.log("Pushing child "+child.localName);</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">queue</span><span class="p">.</span><span class="nx">unshift</span><span class="p">({</span> <span class="nx">current</span><span class="o">:</span> <span class="nx">child</span><span class="p">,</span> <span class="nx">context</span><span class="o">:</span> <span class="nx">childContext</span><span class="p">});</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">subject</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">snode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">[</span><span class="nx">subject</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">size</span><span class="p">(</span><span class="nx">snode</span><span class="p">.</span><span class="nx">predicates</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">[</span><span class="nx">subject</span><span class="p">];</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>


<span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span><span class="nx">subject</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="p">{</span>
      <span class="nx">parent</span><span class="o">:</span> <span class="nx">parent</span><span class="p">,</span>
      <span class="nx">subject</span><span class="o">:</span> <span class="nx">subject</span> <span class="o">?</span> <span class="nx">subject</span> <span class="o">:</span> <span class="p">(</span><span class="nx">parent</span> <span class="o">?</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">subject</span> <span class="o">:</span> <span class="kc">null</span><span class="p">),</span>
      <span class="nx">parentObject</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">incomplete</span><span class="o">:</span> <span class="p">[],</span>
      <span class="nx">listMapping</span><span class="o">:</span> <span class="nx">parent</span> <span class="o">?</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">listMapping</span> <span class="o">:</span> <span class="p">{},</span>
      <span class="nx">language</span><span class="o">:</span> <span class="nx">parent</span> <span class="o">?</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">language</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">language</span><span class="p">,</span>
      <span class="nx">prefixes</span><span class="o">:</span> <span class="nx">parent</span> <span class="o">?</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prefixes</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">,</span>
      <span class="nx">terms</span><span class="o">:</span> <span class="nx">parent</span> <span class="o">?</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">terms</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">terms</span><span class="p">,</span>
      <span class="nx">vocabulary</span><span class="o">:</span> <span class="nx">parent</span> <span class="o">?</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">voabulary</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">vocabulary</span>
   <span class="p">};</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">RDFaEnvironment</span><span class="p">(</span><span class="nx">owner</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span><span class="nx">template</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">query</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">return</span> <span class="nx">owner</span><span class="p">.</span><span class="nx">getProjections</span><span class="p">(</span><span class="nx">template</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">projections</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">subject</span> <span class="k">in</span> <span class="nx">owner</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">snode</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">[</span><span class="nx">subject</span><span class="p">];</span>
         <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">query</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">predicate</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">curieParser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">pnode</span> <span class="o">=</span> <span class="nx">snode</span><span class="p">.</span><span class="nx">predicates</span><span class="p">[</span><span class="nx">predicate</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">pnode</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">snode</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
               <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">curieParser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">query</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span><span class="kc">false</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="nx">object</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">value</span><span class="o">==</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">object</span> <span class="o">=</span> <span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
               <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">snode</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
               <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">snode</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">projections</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">DocumentData</span><span class="p">.</span><span class="nx">toProjection</span><span class="p">(</span><span class="nx">owner</span><span class="p">,</span><span class="nx">snode</span><span class="p">,</span><span class="nx">template</span><span class="p">));</span>
         <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">projections</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">Projection</span><span class="p">(</span><span class="nx">owner</span><span class="p">,</span><span class="nx">subject</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">owner</span><span class="o">:</span> <span class="nx">owner</span><span class="p">,</span>
      <span class="nx">subject</span><span class="o">:</span> <span class="nx">subject</span><span class="p">,</span>
      <span class="nx">properties</span><span class="o">:</span> <span class="p">{}</span>
   <span class="p">};</span>
<span class="p">}</span>

<span class="nx">Projection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getProperties</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">propertyNames</span> <span class="o">=</span> <span class="p">[];</span>
   <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">property</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">properties</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">propertyNames</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">property</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="nx">propertyNames</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">Projection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getSubject</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
   <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">subject</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">Projection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">uriOrCurie</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">property</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">owner</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">curieParser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">uriOrCurie</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
   <span class="kd">var</span> <span class="nx">objects</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
   <span class="k">return</span> <span class="nx">objects</span> <span class="o">?</span> <span class="nx">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">Projection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getAll</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">uriOrCurie</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">property</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">owner</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">curieParser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">uriOrCurie</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
   <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
<span class="p">}</span>

<span class="nx">DocumentData</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URIResolver</span><span class="p">();</span>
<span class="nx">DocumentData</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">DocumentData</span><span class="p">;</span>
<span class="kd">function</span> <span class="nx">DocumentData</span> <span class="p">(</span><span class="nx">uri</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">tripleCount</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">triplesGraph</span><span class="o">:</span> <span class="p">{},</span>
      <span class="nx">prefixes</span><span class="o">:</span> <span class="p">{},</span>
      <span class="nx">terms</span><span class="o">:</span> <span class="p">{},</span>
      <span class="nx">baseURI</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">parseURI</span><span class="p">(</span><span class="nx">uri</span><span class="p">)</span>
   <span class="p">};</span>
   <span class="kd">var</span> <span class="nx">dataContext</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">curieParser</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">trim</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">return</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\s\s*/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s\s*$/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
      <span class="p">},</span>
      <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;[&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;]&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="kd">var</span> <span class="nx">colon</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">colon</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">prefix</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">colon</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">prefix</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-59"><td class="docs"><div class="pilwrap"><a href="#section-59" class="pilcrow">&#182;</a></div><p>default prefix</p>
</td><td class="code"><div class="highlight"><pre>               <span class="kd">var</span> <span class="nx">uri</span> <span class="o">=</span> <span class="nx">dataContext</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">];</span>
               <span class="k">return</span> <span class="nx">uri</span> <span class="o">?</span> <span class="nx">uri</span><span class="o">+</span><span class="nx">value</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">colon</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">prefix</span><span class="o">==</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-60"><td class="docs"><div class="pilwrap"><a href="#section-60" class="pilcrow">&#182;</a></div><p>blank node</p>
</td><td class="code"><div class="highlight"><pre>               <span class="k">return</span> <span class="s2">&quot;_:&quot;</span><span class="o">+</span><span class="nx">value</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">colon</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">DocumentData</span><span class="p">.</span><span class="nx">NCNAME</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">prefix</span><span class="p">))</span> <span class="p">{</span>
               <span class="kd">var</span> <span class="nx">uri</span> <span class="o">=</span> <span class="nx">dataContext</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="nx">prefix</span><span class="p">];</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">uri</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="nx">uri</span><span class="o">+</span><span class="nx">value</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">colon</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>

         <span class="k">return</span> <span class="nx">resolve</span> <span class="o">?</span> <span class="nx">dataContext</span><span class="p">.</span><span class="nx">baseURI</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">:</span> <span class="nx">value</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">};</span>
   <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="s2">&quot;rdfa&quot;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">value</span><span class="o">:</span> <span class="k">new</span> <span class="nx">RDFaEnvironment</span><span class="p">(</span><span class="k">this</span><span class="p">),</span>
      <span class="nx">writable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">configurable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
   <span class="p">});</span>
<span class="p">}</span>

<span class="nx">DocumentData</span><span class="p">.</span><span class="nx">nameChar</span> <span class="o">=</span> <span class="s1">&#39;[-A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u10000-\uEFFFF\.0-9\u00B7\u0300-\u036F\u203F-\u2040]&#39;</span><span class="p">;</span>
<span class="nx">DocumentData</span><span class="p">.</span><span class="nx">nameStartChar</span> <span class="o">=</span> <span class="s1">&#39;[\u0041-\u005A\u0061-\u007A\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u00FF\u0100-\u0131\u0134-\u013E\u0141-\u0148\u014A-\u017E\u0180-\u01C3\u01CD-\u01F0\u01F4-\u01F5\u01FA-\u0217\u0250-\u02A8\u02BB-\u02C1\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03CE\u03D0-\u03D6\u03DA\u03DC\u03DE\u03E0\u03E2-\u03F3\u0401-\u040C\u040E-\u044F\u0451-\u045C\u045E-\u0481\u0490-\u04C4\u04C7-\u04C8\u04CB-\u04CC\u04D0-\u04EB\u04EE-\u04F5\u04F8-\u04F9\u0531-\u0556\u0559\u0561-\u0586\u05D0-\u05EA\u05F0-\u05F2\u0621-\u063A\u0641-\u064A\u0671-\u06B7\u06BA-\u06BE\u06C0-\u06CE\u06D0-\u06D3\u06D5\u06E5-\u06E6\u0905-\u0939\u093D\u0958-\u0961\u0985-\u098C\u098F-\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09DC-\u09DD\u09DF-\u09E1\u09F0-\u09F1\u0A05-\u0A0A\u0A0F-\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32-\u0A33\u0A35-\u0A36\u0A38-\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8B\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2-\u0AB3\u0AB5-\u0AB9\u0ABD\u0AE0\u0B05-\u0B0C\u0B0F-\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32-\u0B33\u0B36-\u0B39\u0B3D\u0B5C-\u0B5D\u0B5F-\u0B61\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99-\u0B9A\u0B9C\u0B9E-\u0B9F\u0BA3-\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB5\u0BB7-\u0BB9\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C33\u0C35-\u0C39\u0C60-\u0C61\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CDE\u0CE0-\u0CE1\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D28\u0D2A-\u0D39\u0D60-\u0D61\u0E01-\u0E2E\u0E30\u0E32-\u0E33\u0E40-\u0E45\u0E81-\u0E82\u0E84\u0E87-\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA-\u0EAB\u0EAD-\u0EAE\u0EB0\u0EB2-\u0EB3\u0EBD\u0EC0-\u0EC4\u0F40-\u0F47\u0F49-\u0F69\u10A0-\u10C5\u10D0-\u10F6\u1100\u1102-\u1103\u1105-\u1107\u1109\u110B-\u110C\u110E-\u1112\u113C\u113E\u1140\u114C\u114E\u1150\u1154-\u1155\u1159\u115F-\u1161\u1163\u1165\u1167\u1169\u116D-\u116E\u1172-\u1173\u1175\u119E\u11A8\u11AB\u11AE-\u11AF\u11B7-\u11B8\u11BA\u11BC-\u11C2\u11EB\u11F0\u11F9\u1E00-\u1E9B\u1EA0-\u1EF9\u1F00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u2126\u212A-\u212B\u212E\u2180-\u2182\u3041-\u3094\u30A1-\u30FA\u3105-\u312C\uAC00-\uD7A3\u4E00-\u9FA5\u3007\u3021-\u3029_]&#39;</span><span class="p">;</span>
<span class="nx">DocumentData</span><span class="p">.</span><span class="nx">NCNAME</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">nameStartChar</span> <span class="o">+</span> <span class="nx">RDFaProcessor</span><span class="p">.</span><span class="nx">nameChar</span> <span class="o">+</span> <span class="s1">&#39;*$&#39;</span><span class="p">);</span>

<span class="nx">DocumentData</span><span class="p">.</span><span class="nx">toProjection</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">owner</span><span class="p">,</span><span class="nx">snode</span><span class="p">,</span><span class="nx">template</span><span class="p">)</span> <span class="p">{</span>

   <span class="kd">var</span> <span class="nx">projection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Projection</span><span class="p">(</span><span class="nx">owner</span><span class="p">,</span><span class="nx">snode</span><span class="p">.</span><span class="nx">subject</span><span class="p">);</span>
   <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">predicate</span> <span class="k">in</span> <span class="nx">snode</span><span class="p">.</span><span class="nx">predicates</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">pnode</span> <span class="o">=</span> <span class="nx">snode</span><span class="p">.</span><span class="nx">predicates</span><span class="p">[</span><span class="nx">predicate</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="nx">projection</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="nx">predicate</span><span class="p">]</span> <span class="o">=</span> <span class="nx">values</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">values</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">value</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">template</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">template</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">predicate</span> <span class="o">=</span> <span class="nx">template</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
         <span class="nx">predicate</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">curieParser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">predicate</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
         <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="nx">projection</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="nx">predicate</span><span class="p">];</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">values</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-61"><td class="docs"><div class="pilwrap"><a href="#section-61" class="pilcrow">&#182;</a></div><p>TODO: API issue: is this the first value or all values?</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">projection</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="o">==</span><span class="mi">1</span> <span class="o">?</span> <span class="nx">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="nx">values</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="nx">projection</span><span class="p">;</span>
<span class="p">};</span>


<span class="nx">DocumentData</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getProperties</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">subject</span><span class="p">)</span> <span class="p">{</span>

   <span class="kd">var</span> <span class="nx">properties</span> <span class="o">=</span> <span class="p">[];</span>

   <span class="k">if</span> <span class="p">(</span><span class="nx">subject</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">subject</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">curieParser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">subject</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
      <span class="nx">snode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">[</span><span class="nx">subject</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">snode</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">predicate</span> <span class="k">in</span> <span class="nx">snode</span><span class="p">.</span><span class="nx">predicates</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">properties</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">predicate</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">uniqueProperties</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">subject</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">snode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">[</span><span class="nx">subject</span><span class="p">];</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">snode</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">predicate</span> <span class="k">in</span> <span class="nx">snode</span><span class="p">.</span><span class="nx">predicates</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">uniqueProperties</span><span class="p">[</span><span class="nx">predicate</span><span class="p">])</span> <span class="p">{</span>
                  <span class="nx">uniqueProperties</span><span class="p">[</span><span class="nx">predicate</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                  <span class="nx">properties</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">predicate</span><span class="p">);</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="nx">properties</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">DocumentData</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getSubjects</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">subjects</span> <span class="o">=</span> <span class="p">[];</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">property</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">curieParser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">property</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">expanded</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">curieParser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">subject</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">snode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">[</span><span class="nx">subject</span><span class="p">];</span>
         <span class="kd">var</span> <span class="nx">pnode</span> <span class="o">=</span> <span class="nx">snode</span><span class="p">.</span><span class="nx">predicates</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">pnode</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">value</span><span class="o">==</span><span class="nx">value</span> <span class="o">||</span> <span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">value</span><span class="o">==</span><span class="nx">expanded</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">subjects</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">subject</span><span class="p">);</span>
                  <span class="k">break</span><span class="p">;</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">subject</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">snode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">[</span><span class="nx">subject</span><span class="p">];</span>
         <span class="kd">var</span> <span class="nx">pnode</span> <span class="o">=</span> <span class="nx">snode</span><span class="p">.</span><span class="nx">predicates</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">pnode</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">subjects</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">subject</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">expanded</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">curieParser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">subject</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">snode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">[</span><span class="nx">subject</span><span class="p">];</span>
         <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">predicate</span> <span class="k">in</span> <span class="nx">snode</span><span class="p">.</span><span class="nx">predicates</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">pnode</span> <span class="o">=</span> <span class="nx">subject</span><span class="p">.</span><span class="nx">predicates</span><span class="p">[</span><span class="nx">predicate</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">pnode</span><span class="p">)</span> <span class="p">{</span>
               <span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
               <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="nx">object</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">value</span><span class="o">==</span><span class="nx">value</span> <span class="o">||</span> <span class="nx">node</span><span class="p">.</span><span class="nx">objects</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">value</span><span class="o">==</span><span class="nx">expanded</span><span class="p">)</span> <span class="p">{</span>
                     <span class="nx">object</span> <span class="o">=</span> <span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                  <span class="p">}</span>
               <span class="p">}</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">subjects</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">subject</span><span class="p">);</span>
                  <span class="k">break</span><span class="p">;</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">subject</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">subjects</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">subject</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="nx">subjects</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">DocumentData</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getValues</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">subject</span><span class="p">,</span><span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="p">[];</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">property</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">curieParser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">subject</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">subject</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">curieParser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">subject</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">snode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">[</span><span class="nx">subject</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">snode</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">pnode</span> <span class="o">=</span> <span class="nx">snode</span><span class="p">.</span><span class="nx">predicates</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">pnode</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">values</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">value</span><span class="p">);</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">predicate</span> <span class="k">in</span> <span class="nx">snode</span><span class="p">.</span><span class="nx">predicates</span><span class="p">)</span> <span class="p">{</span>
               <span class="kd">var</span> <span class="nx">pnode</span> <span class="o">=</span> <span class="nx">snode</span><span class="p">.</span><span class="nx">predicates</span><span class="p">[</span><span class="nx">predicate</span><span class="p">];</span>
               <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">values</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">value</span><span class="p">);</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">subject</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">snode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">[</span><span class="nx">subject</span><span class="p">];</span>
         <span class="kd">var</span> <span class="nx">pnode</span> <span class="o">=</span> <span class="nx">snode</span><span class="p">.</span><span class="nx">predicates</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">pnode</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">values</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">value</span><span class="p">);</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">subject</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">snode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">[</span><span class="nx">subject</span><span class="p">];</span>
         <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">predicate</span> <span class="k">in</span> <span class="nx">snode</span><span class="p">.</span><span class="nx">predicates</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">pnode</span> <span class="o">=</span> <span class="nx">snode</span><span class="p">.</span><span class="nx">predicates</span><span class="p">[</span><span class="nx">predicate</span><span class="p">];</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">values</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">value</span><span class="p">);</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="nx">values</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">DocumentData</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setMapping</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">prefix</span><span class="p">,</span><span class="nx">uri</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">prefixes</span><span class="p">[</span><span class="nx">prefix</span><span class="p">]</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">DocumentData</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getSubjectTriples</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">subject</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">subject</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}</span>
   <span class="nx">subject</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">curieParser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">subject</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
   <span class="kd">var</span> <span class="nx">triples</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">subject</span><span class="o">:</span> <span class="nx">subject</span><span class="p">,</span> <span class="nx">predicates</span><span class="o">:</span> <span class="p">{}</span> <span class="p">};</span>

   <span class="kd">var</span> <span class="nx">snode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">[</span><span class="nx">subject</span><span class="p">];</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">snode</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">predicate</span> <span class="k">in</span> <span class="nx">snode</span><span class="p">.</span><span class="nx">predicates</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">pnode</span> <span class="o">=</span> <span class="nx">snode</span><span class="p">.</span><span class="nx">predicates</span><span class="p">[</span><span class="nx">predicate</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">objects</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="nx">triples</span><span class="p">.</span><span class="nx">predicates</span><span class="p">[</span><span class="nx">predicate</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">predicate</span><span class="o">:</span> <span class="nx">predicate</span><span class="p">,</span> <span class="nx">objects</span><span class="o">:</span> <span class="nx">objects</span> <span class="p">};</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">XMLLiteralURI</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">serializer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLSerializer</span><span class="p">();</span>
            <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">x</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">x</span><span class="o">&lt;</span><span class="nx">object</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="nx">x</span><span class="p">].</span><span class="nx">nodeType</span><span class="o">==</span><span class="nx">Node</span><span class="p">.</span><span class="nx">ELEMENT_NODE</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">value</span> <span class="o">+=</span> <span class="nx">serializer</span><span class="p">.</span><span class="nx">serializeToString</span><span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="nx">x</span><span class="p">]);</span>
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="nx">x</span><span class="p">].</span><span class="nx">nodeType</span><span class="o">==</span><span class="nx">Node</span><span class="p">.</span><span class="nx">TEXT_NODE</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">value</span> <span class="o">+=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="nx">x</span><span class="p">].</span><span class="nx">nodeValue</span><span class="p">;</span>
               <span class="p">}</span>
            <span class="p">}</span>
            <span class="nx">objects</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">value</span> <span class="p">});</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">objects</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">object</span><span class="p">.</span><span class="nx">value</span> <span class="p">});</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="nx">triples</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">DocumentData</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getProjection</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">subject</span><span class="p">,</span> <span class="nx">template</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">subject</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">null</span> <span class="p">}</span>

   <span class="nx">subject</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">curieParser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">subject</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>

   <span class="kd">var</span> <span class="nx">snode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">[</span><span class="nx">subject</span><span class="p">];</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">snode</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="nx">DocumentData</span><span class="p">.</span><span class="nx">toProjection</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">snode</span><span class="p">,</span><span class="nx">template</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">DocumentData</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getProjections</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">template</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">property</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">curieParser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="kd">var</span> <span class="nx">projections</span> <span class="o">=</span> <span class="p">[];</span>
   <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">template</span> <span class="o">==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">template</span> <span class="o">=</span> <span class="nx">property</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">property</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">expanded</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">curieParser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">subject</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">snode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">[</span><span class="nx">subject</span><span class="p">];</span>
         <span class="kd">var</span> <span class="nx">pnode</span> <span class="o">=</span> <span class="nx">snode</span><span class="p">.</span><span class="nx">predicates</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">pnode</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">value</span><span class="o">==</span><span class="nx">value</span> <span class="o">||</span> <span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">value</span><span class="o">==</span><span class="nx">expanded</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">projections</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">DocumentData</span><span class="p">.</span><span class="nx">toProjection</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">snode</span><span class="p">,</span><span class="nx">template</span><span class="p">));</span>
                  <span class="k">break</span><span class="p">;</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">subject</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">snode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">[</span><span class="nx">subject</span><span class="p">];</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">snode</span><span class="p">.</span><span class="nx">predicates</span><span class="p">[</span><span class="nx">property</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">projections</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">DocumentData</span><span class="p">.</span><span class="nx">toProjection</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">snode</span><span class="p">,</span><span class="nx">template</span><span class="p">));</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">subject</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">snode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">[</span><span class="nx">subject</span><span class="p">];</span>
         <span class="nx">projections</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">DocumentData</span><span class="p">.</span><span class="nx">toProjection</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">snode</span><span class="p">,</span><span class="nx">template</span><span class="p">));</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="nx">projections</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">DocumentData</span><span class="p">.</span><span class="nx">attach</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>

   <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">value</span><span class="o">:</span> <span class="k">new</span> <span class="nx">DocumentData</span><span class="p">(</span><span class="nx">target</span><span class="p">.</span><span class="nx">baseURI</span> <span class="o">||</span> <span class="nx">target</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">),</span>
      <span class="nx">writable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">configurable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
   <span class="p">});</span>

   <span class="nx">target</span><span class="p">.</span><span class="nx">getElementsByType</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-62"><td class="docs"><div class="pilwrap"><a href="#section-62" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>TODO: should this return all the subject origins or just that which had the typeof on it?<br />      var nodes = [];<br />      nodes.item = function(index) {<br />         return this[index];<br />      };<br />      type = this.data.<em>data</em>.curieParser.parse(type,true);<br />      for (var subject in this.data.<em>data</em>.triplesGraph) {<br />         var snode = this.data.<em>data</em>.triplesGraph[subject];<br />         var pnode = snode.predicates["<a href='http://www.w3.org/1999/02/22-rdf-syntax-ns#type'>http://www.w3.org/1999/02/22-rdf-syntax-ns#type</a>"];<br />         if (pnode &amp;&amp; pnode.objects.length>0 &amp;&amp; pnode.objects[0].value==type) {<br />            for (var i=0; i<snode.origins.length; i++) {<br />               nodes.push(snode.origins[i]);<br />            }<br />         }<br />      }<br />      return nodes;</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getElementsByProperty</span><span class="p">(</span><span class="s2">&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#type&quot;</span><span class="p">,</span><span class="nx">type</span><span class="p">);</span>
   <span class="p">};</span>

   <span class="nx">target</span><span class="p">.</span><span class="nx">getElementsBySubject</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">subject</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">nodes</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="nx">nodes</span><span class="p">.</span><span class="nx">item</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">return</span> <span class="k">this</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span>
      <span class="p">};</span>
      <span class="nx">subject</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">curieParser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">subject</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">snode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">[</span><span class="nx">subject</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">snode</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">snode</span><span class="p">.</span><span class="nx">origins</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">nodes</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">snode</span><span class="p">.</span><span class="nx">origins</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
         <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">nodes</span><span class="p">;</span>
   <span class="p">};</span>

   <span class="nx">target</span><span class="p">.</span><span class="nx">getElementsByProperty</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">nodes</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="nx">nodes</span><span class="p">.</span><span class="nx">item</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">return</span> <span class="k">this</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span>
      <span class="p">};</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">curieParser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="kc">false</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">noValue</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">;</span>
      <span class="nx">property</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">curieParser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">subject</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">snode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">[</span><span class="nx">subject</span><span class="p">];</span>
         <span class="kd">var</span> <span class="nx">pnode</span> <span class="o">=</span> <span class="nx">snode</span><span class="p">.</span><span class="nx">predicates</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">pnode</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">noValue</span> <span class="o">||</span> <span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">value</span><span class="o">==</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">nodes</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">origin</span><span class="p">);</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">nodes</span><span class="p">;</span>
   <span class="p">};</span>

   <span class="nx">target</span><span class="p">.</span><span class="nx">getElementSubject</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">subject</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">snode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">triplesGraph</span><span class="p">[</span><span class="nx">subject</span><span class="p">];</span>
         <span class="k">for</span> <span class="p">(</span><span class="nx">predicate</span> <span class="k">in</span> <span class="nx">snode</span><span class="p">.</span><span class="nx">predicates</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">pnode</span> <span class="o">=</span> <span class="nx">snode</span><span class="p">.</span><span class="nx">predicates</span><span class="p">[</span><span class="nx">predicate</span><span class="p">];</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">pnode</span><span class="p">.</span><span class="nx">objects</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">origin</span><span class="o">==</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="nx">subject</span><span class="p">;</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
   <span class="p">};</span>
<span class="p">}</span>


<span class="kd">var</span> <span class="nx">hasFeature</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">implementation</span><span class="p">.</span><span class="nx">hasFeature</span><span class="p">;</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">implementation</span><span class="p">.</span><span class="nx">hasFeature</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">feature</span><span class="p">,</span><span class="nx">version</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">feature</span><span class="o">==</span><span class="s2">&quot;RDFaAPI&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">version</span><span class="o">==</span><span class="s2">&quot;1.1&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
   <span class="k">return</span> <span class="nx">hasFeature</span><span class="p">(</span><span class="nx">feature</span><span class="p">,</span><span class="nx">version</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">loaded</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">data</span> <span class="o">?</span> <span class="kc">true</span> <span class="o">:</span> <span class="kc">false</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">head</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_nodejs</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">meta</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;meta&quot;</span><span class="p">);</span>
   <span class="nx">meta</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="s2">&quot;green-turtle-rdfa-message&quot;</span><span class="p">);</span>
   <span class="nb">document</span><span class="p">.</span><span class="nx">head</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">meta</span><span class="p">);</span>
   <span class="kd">var</span> <span class="nx">makeEvent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">event</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createEvent</span><span class="p">(</span><span class="s2">&quot;Event&quot;</span><span class="p">);</span>
      <span class="nx">event</span><span class="p">.</span><span class="nx">initEvent</span><span class="p">(</span><span class="s2">&quot;green-turtle-rdfa-extension&quot;</span><span class="p">,</span><span class="kc">true</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">event</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">meta</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;green-turtle-rdfa-document&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">meta</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">type</span><span class="o">==</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">doneEvent</span> <span class="o">=</span> <span class="nx">makeEvent</span><span class="p">();</span>
         <span class="nx">meta</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span><span class="s1">&#39;{ &quot;type&quot;: &quot;status&quot;, &quot;loaded&quot;: &#39;</span><span class="o">+</span><span class="nx">loaded</span><span class="o">+</span><span class="s1">&#39;, &quot;count&quot;: &#39;</span><span class="o">+</span><span class="nb">document</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">_data_</span><span class="p">.</span><span class="nx">tripleCount</span><span class="o">+</span><span class="s1">&#39; }&#39;</span><span class="p">);</span>
         <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="nx">doneEvent</span><span class="p">);</span> <span class="p">},</span><span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">type</span><span class="o">==</span><span class="s2">&quot;get-subjects&quot;</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">subjects</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">getSubjects</span><span class="p">();</span>
         <span class="nx">meta</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span><span class="s1">&#39;{ &quot;type&quot;: &quot;subjects&quot;, &quot;subjects&quot;: &#39;</span><span class="o">+</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">subjects</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; }&#39;</span><span class="p">);</span>
         <span class="kd">var</span> <span class="nx">event</span> <span class="o">=</span> <span class="nx">makeEvent</span><span class="p">();</span>
         <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span> <span class="p">},</span><span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">type</span><span class="o">==</span><span class="s2">&quot;get-subject&quot;</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">triples</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">getSubjectTriples</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-63"><td class="docs"><div class="pilwrap"><a href="#section-63" class="pilcrow">&#182;</a></div><p>Use the Green Turtle triples extension</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">triples</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">getSubjectTriples</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">subject</span><span class="p">);</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-64"><td class="docs"><div class="pilwrap"><a href="#section-64" class="pilcrow">&#182;</a></div><p>Do it the hard way!</p>
</td><td class="code"><div class="highlight"><pre>            <span class="kd">var</span> <span class="nx">subjects</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="kd">var</span> <span class="nx">subjectList</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">getSubjects</span><span class="p">();</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">subjectList</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">subjects</span><span class="p">[</span><span class="nx">subjectList</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">triples</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">subject</span><span class="o">:</span> <span class="nx">message</span><span class="p">.</span><span class="nx">subject</span><span class="p">,</span> <span class="nx">predicates</span><span class="o">:</span> <span class="p">{}</span> <span class="p">};</span>
            <span class="kd">var</span> <span class="nx">projection</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">getProjection</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">subject</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">properties</span> <span class="o">=</span> <span class="nx">projection</span><span class="p">.</span><span class="nx">getProperties</span><span class="p">();</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">properties</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
               <span class="kd">var</span> <span class="nx">objects</span> <span class="o">=</span> <span class="p">[];</span>
               <span class="nx">triples</span><span class="p">.</span><span class="nx">predicates</span><span class="p">[</span><span class="nx">properties</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">predicate</span><span class="o">:</span> <span class="nx">predicate</span><span class="p">,</span> <span class="nx">objects</span><span class="o">:</span> <span class="nx">objects</span> <span class="p">};</span>
               <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="nx">projection</span><span class="p">.</span><span class="nx">getAll</span><span class="p">(</span><span class="nx">properties</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
               <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">j</span><span class="o">&lt;</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">subjects</span><span class="p">[</span><span class="nx">values</span><span class="p">[</span><span class="nx">j</span><span class="p">]])</span> <span class="p">{</span>
                     <span class="nx">objects</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#object&quot;</span><span class="p">,</span><span class="nx">value</span><span class="o">:</span> <span class="nx">values</span><span class="p">[</span><span class="nx">j</span><span class="p">]});</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                     <span class="nx">objects</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span>  <span class="s2">&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#PlainLiteral&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">values</span><span class="p">[</span><span class="nx">j</span><span class="p">]});</span>
                  <span class="p">}</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
         <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;subject&quot;</span><span class="p">,</span> <span class="nx">subject</span><span class="o">:</span> <span class="nx">message</span><span class="p">.</span><span class="nx">subject</span><span class="p">,</span> <span class="nx">triples</span><span class="o">:</span> <span class="nx">triples</span> <span class="p">};</span>
         <span class="nx">meta</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">response</span><span class="p">));</span>
         <span class="kd">var</span> <span class="nx">event</span> <span class="o">=</span> <span class="nx">makeEvent</span><span class="p">();</span>
         <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span> <span class="p">},</span><span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">},</span><span class="kc">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">update</span> <span class="o">||</span> <span class="o">!</span><span class="nb">document</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">update</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">DocumentData</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nb">document</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="kd">var</span> <span class="nx">processor</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RDFaProcessor</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">_data_</span><span class="p">);</span>
   <span class="nx">processor</span><span class="p">.</span><span class="nx">process</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">);</span>
   <span class="nx">loaded</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">};</span></pre></div></td></tr><tr id="section-65"><td class="docs"><div class="pilwrap"><a href="#section-65" class="pilcrow">&#182;</a></div><p>using node.js</p>
</td><td class="code"><div class="highlight"><pre><span class="k">if</span><span class="p">(</span><span class="nx">_nodejs</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">RDFa</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">Node</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">Node</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">ELEMENT_NODE</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nx">TEXT_NODE</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
      <span class="nx">DOCUMENT_NODE</span><span class="o">:</span> <span class="mi">9</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-66"><td class="docs"><div class="pilwrap"><a href="#section-66" class="pilcrow">&#182;</a></div><p>using browser</p>
</td><td class="code"><div class="highlight"><pre><span class="k">else</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">readyState</span><span class="o">==</span><span class="s2">&quot;loading&quot;</span><span class="p">)</span> <span class="p">{</span>
     <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;load&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">RDFa</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nb">document</span><span class="p">);</span>
     <span class="p">},</span><span class="kc">false</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
     <span class="nx">RDFa</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nb">document</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Sun Oct 06 2013 18:12:30 GMT+0200 (CEST)  </div><div id="projectname"><a href="../../index.html">Seki</a></div></div></body></html>