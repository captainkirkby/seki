<!DOCTYPE html><html><head><title>jsonld.js</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../../index.html" class="source"><span class="file_name">README</span></a><a href="../../Authenticator.js.html" class="source "><span class="base_path">. / </span><span class="file_name">Authenticator.js</span></a><a href="../../Bootstrap.js.html" class="source "><span class="base_path">. / </span><span class="file_name">Bootstrap.js</span></a><a href="../../Dummy.js.html" class="source "><span class="base_path">. / </span><span class="file_name">Dummy.js</span></a><a href="../../FileServer.js.html" class="source "><span class="base_path">. / </span><span class="file_name">FileServer.js</span></a><a href="../../GetHandler.js.html" class="source "><span class="base_path">. / </span><span class="file_name">GetHandler.js</span></a><a href="../../Gruntfile.js.html" class="source "><span class="base_path">. / </span><span class="file_name">Gruntfile.js</span></a><a href="../../JSONHandler.js.html" class="source "><span class="base_path">. / </span><span class="file_name">JSONHandler.js</span></a><a href="../../PostHandler.js.html" class="source "><span class="base_path">. / </span><span class="file_name">PostHandler.js</span></a><a href="../../ResponseRenderer.js.html" class="source "><span class="base_path">. / </span><span class="file_name">ResponseRenderer.js</span></a><a href="../../Seki.js.html" class="source "><span class="base_path">. / </span><span class="file_name">Seki.js</span></a><a href="../../SourceHook.js.html" class="source "><span class="base_path">. / </span><span class="file_name">SourceHook.js</span></a><a href="../../SparqlUtils.js.html" class="source "><span class="base_path">. / </span><span class="file_name">SparqlUtils.js</span></a><a href="../../StoreClient.js.html" class="source "><span class="base_path">. / </span><span class="file_name">StoreClient.js</span></a><a href="../../TryJsonld.js.html" class="source "><span class="base_path">. / </span><span class="file_name">TryJsonld.js</span></a><a href="../../TurtleHandler.js.html" class="source "><span class="base_path">. / </span><span class="file_name">TurtleHandler.js</span></a><a href="../../Utils.js.html" class="source "><span class="base_path">. / </span><span class="file_name">Utils.js</span></a><a href="../../admin/FileReader.js.html" class="source "><span class="base_path">admin / </span><span class="file_name">FileReader.js</span></a><a href="../../admin/Admin.js.html" class="source "><span class="base_path">admin / </span><span class="file_name">Admin.js</span></a><a href="../../config/ConfigCustom.js.html" class="source "><span class="base_path">config / </span><span class="file_name">ConfigCustom.js</span></a><a href="../../config/Constants.js.html" class="source "><span class="base_path">config / </span><span class="file_name">Constants.js</span></a><a href="../../config/Headers.js.html" class="source "><span class="base_path">config / </span><span class="file_name">Headers.js</span></a><a href="../../config/Special.js.html" class="source "><span class="base_path">config / </span><span class="file_name">Special.js</span></a><a href="../../config/ConfigDefault.js.html" class="source "><span class="base_path">config / </span><span class="file_name">ConfigDefault.js</span></a><a href="../../config/ConfigOpenShift.js.html" class="source "><span class="base_path">config / </span><span class="file_name">ConfigOpenShift.js</span></a><a href="../../handlers/GetJsonHandler.js.html" class="source "><span class="base_path">handlers / </span><span class="file_name">GetJsonHandler.js</span></a><a href="../../handlers/VieJsonHandler.js.html" class="source "><span class="base_path">handlers / </span><span class="file_name">VieJsonHandler.js</span></a><a href="../../handlers/GetBlogHandler.js.html" class="source "><span class="base_path">handlers / </span><span class="file_name">GetBlogHandler.js</span></a><a href="../../lib/node-rdf/test/graph-TripletGraph-test.js.html" class="source "><span class="base_path">lib / node-rdf / test / </span><span class="file_name">graph-TripletGraph-test.js</span></a><a href="../../lib/node-rdf/test/builtins-String-test.js.html" class="source "><span class="base_path">lib / node-rdf / test / </span><span class="file_name">builtins-String-test.js</span></a><a href="../../lib/node-rdf/test/builtins-ref-test.js.html" class="source "><span class="base_path">lib / node-rdf / test / </span><span class="file_name">builtins-ref-test.js</span></a><a href="../../lib/node-rdf/test/parser-Turtle-test.js.html" class="source "><span class="base_path">lib / node-rdf / test / </span><span class="file_name">parser-Turtle-test.js</span></a><a href="../../lib/node-rdf/test/RDFEnvironment-test.js.html" class="source "><span class="base_path">lib / node-rdf / test / </span><span class="file_name">RDFEnvironment-test.js</span></a><a href="../../lib/node-rdf/test/IRI-test.js.html" class="source "><span class="base_path">lib / node-rdf / test / </span><span class="file_name">IRI-test.js</span></a><a href="../../lib/node-rdf/test/context-resolve-test.js.html" class="source "><span class="base_path">lib / node-rdf / test / </span><span class="file_name">context-resolve-test.js</span></a><a href="../../lib/node-rdf/test/builtins-Number-test.js.html" class="source "><span class="base_path">lib / node-rdf / test / </span><span class="file_name">builtins-Number-test.js</span></a><a href="../../lib/node-rdf/test/context-convert-test.js.html" class="source "><span class="base_path">lib / node-rdf / test / </span><span class="file_name">context-convert-test.js</span></a><a href="../../lib/node-rdf/test/graph-IndexedGraph-test.js.html" class="source "><span class="base_path">lib / node-rdf / test / </span><span class="file_name">graph-IndexedGraph-test.js</span></a><a href="../../lib/node-rdf/test/graph-test-lib.js.html" class="source "><span class="base_path">lib / node-rdf / test / </span><span class="file_name">graph-test-lib.js</span></a><a href="../../lib/node-rdf/lib/rdf.js.html" class="source "><span class="base_path">lib / node-rdf / lib / </span><span class="file_name">rdf.js</span></a><a href="../../lib/node-rdf/lib/TripletGraph.js.html" class="source "><span class="base_path">lib / node-rdf / lib / </span><span class="file_name">TripletGraph.js</span></a><a href="../../lib/node-rdf/lib/Graph.js.html" class="source "><span class="base_path">lib / node-rdf / lib / </span><span class="file_name">Graph.js</span></a><a href="../../lib/node-rdf/lib/IndexedGraph.js.html" class="source "><span class="base_path">lib / node-rdf / lib / </span><span class="file_name">IndexedGraph.js</span></a><a href="../../lib/node-rdf/lib/RDFNode.js.html" class="source "><span class="base_path">lib / node-rdf / lib / </span><span class="file_name">RDFNode.js</span></a><a href="../../lib/node-rdf/lib/Builtins.js.html" class="source "><span class="base_path">lib / node-rdf / lib / </span><span class="file_name">Builtins.js</span></a><a href="../../lib/node-rdf/lib/Profile.js.html" class="source "><span class="base_path">lib / node-rdf / lib / </span><span class="file_name">Profile.js</span></a><a href="../../lib/node-rdf/lib/Default.js.html" class="source "><span class="base_path">lib / node-rdf / lib / </span><span class="file_name">Default.js</span></a><a href="../../lib/node-rdf/lib/RDFEnvironment.js.html" class="source "><span class="base_path">lib / node-rdf / lib / </span><span class="file_name">RDFEnvironment.js</span></a><a href="../../lib/node-rdf/lib/N3Serializer.js.html" class="source "><span class="base_path">lib / node-rdf / lib / </span><span class="file_name">N3Serializer.js</span></a><a href="../../lib/node-rdf/lib/TurtleParser.js.html" class="source "><span class="base_path">lib / node-rdf / lib / </span><span class="file_name">TurtleParser.js</span></a><a href="../../lib/temp/corser.js.html" class="source "><span class="base_path">lib / temp / </span><span class="file_name">corser.js</span></a><a href="../../lib/temp/connect-cors.js.html" class="source "><span class="base_path">lib / temp / </span><span class="file_name">connect-cors.js</span></a><a href="../../lib/jsonld/jsonld.js.html" class="source selected"><span class="base_path">lib / jsonld / </span><span class="file_name">jsonld.js</span></a><a href="../../lib/jsonld/request.js.html" class="source "><span class="base_path">lib / jsonld / </span><span class="file_name">request.js</span></a><a href="../../lib/jsonld/Future.js.html" class="source "><span class="base_path">lib / jsonld / </span><span class="file_name">Future.js</span></a><a href="../../lib/jsonld/rdfa.js.html" class="source "><span class="base_path">lib / jsonld / </span><span class="file_name">rdfa.js</span></a><a href="../../misc/sr.js.html" class="source "><span class="base_path">misc / </span><span class="file_name">sr.js</span></a><a href="../../misc/biscuit.js.html" class="source "><span class="base_path">misc / </span><span class="file_name">biscuit.js</span></a><a href="../../misc/router.js.html" class="source "><span class="base_path">misc / </span><span class="file_name">router.js</span></a><a href="../../misc/cors-client-snippet.js.html" class="source "><span class="base_path">misc / </span><span class="file_name">cors-client-snippet.js</span></a><a href="../../misc/flatten-map.js.html" class="source "><span class="base_path">misc / </span><span class="file_name">flatten-map.js</span></a><a href="../../misc/mimeToJSON.js.html" class="source "><span class="base_path">misc / </span><span class="file_name">mimeToJSON.js</span></a><a href="../../misc/htmlparser.js.html" class="source "><span class="base_path">misc / </span><span class="file_name">htmlparser.js</span></a><a href="../../misc/shortener.js.html" class="source "><span class="base_path">misc / </span><span class="file_name">shortener.js</span></a><a href="../../misc/html5-boilerplate.js.html" class="source "><span class="base_path">misc / </span><span class="file_name">html5-boilerplate.js</span></a><a href="../../srx2map.js.html" class="source "><span class="base_path">. / </span><span class="file_name">srx2map.js</span></a><a href="../../srx2map_multi.js.html" class="source "><span class="base_path">. / </span><span class="file_name">srx2map_multi.js</span></a><a href="../../templates/SparqlTemplates.js.html" class="source "><span class="base_path">templates / </span><span class="file_name">SparqlTemplates.js</span></a><a href="../../templates/JsonTemplates.js.html" class="source "><span class="base_path">templates / </span><span class="file_name">JsonTemplates.js</span></a><a href="../../templates/Templater.js.html" class="source "><span class="base_path">templates / </span><span class="file_name">Templater.js</span></a><a href="../../templates/SparqlUserTemplates.js.html" class="source "><span class="base_path">templates / </span><span class="file_name">SparqlUserTemplates.js</span></a><a href="../../templates/HtmlTemplates.js.html" class="source "><span class="base_path">templates / </span><span class="file_name">HtmlTemplates.js</span></a><a href="../../templates/freemarker.js.html" class="source "><span class="base_path">templates / </span><span class="file_name">freemarker.js</span></a><a href="../../tests/run-tests.js.html" class="source "><span class="base_path">tests / </span><span class="file_name">run-tests.js</span></a><a href="../../tests/old/allTests.js.html" class="source "><span class="base_path">tests / old / </span><span class="file_name">allTests.js</span></a><a href="../../tests/old/testRdfHttp.js.html" class="source "><span class="base_path">tests / old / </span><span class="file_name">testRdfHttp.js</span></a><a href="../../tests/old/dummyServer.js.html" class="source "><span class="base_path">tests / old / </span><span class="file_name">dummyServer.js</span></a><a href="../../tests/old/testTemplater.js.html" class="source "><span class="base_path">tests / old / </span><span class="file_name">testTemplater.js</span></a><a href="../../tests/old/testHelpers.js.html" class="source "><span class="base_path">tests / old / </span><span class="file_name">testHelpers.js</span></a><a href="../../usermanager/users.js.html" class="source "><span class="base_path">usermanager / </span><span class="file_name">users.js</span></a><a href="../../wat.js.html" class="source "><span class="base_path">. / </span><span class="file_name">wat.js</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>jsonld.js</h1><div class="filepath">lib/jsonld/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>A JavaScript implementation of the JSON-LD API.</p></div><div class="details"></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>determine if in-browser or using node.js</p>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">_nodejs</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">module</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">_browser</span> <span class="o">=</span> <span class="o">!</span><span class="nx">_nodejs</span> <span class="o">&amp;&amp;</span>
  <span class="p">(</span><span class="k">typeof</span> <span class="nb">window</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">self</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="nx">_browser</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">global</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nb">window</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">global</span> <span class="o">=</span> <span class="nb">window</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">self</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">global</span> <span class="o">=</span> <span class="nx">self</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">$</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">global</span> <span class="o">=</span> <span class="nx">$</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>attaches jsonld API to the given object</p>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">wrapper</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">jsonld</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Core API</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Performs JSON-LD compaction.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">input</span><span>- JSON-LD input to compact.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">ctx</span><span>- context to compact with.</span></div><div class="dox_tag_detail"><span>options </span><span class="dox_type">[options]</span><span>- to use:</span></div><div class="dox_tag_detail"><span>compacted, </span><span class="dox_type">callback(err</span><span class="dox_type"></span><span>- ctx) called once the operation completes.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">compact</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Could not compact, too few arguments.&#39;</span><span class="p">));</span>
    <span class="p">});</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>get arguments</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
    <span class="nx">options</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="p">}</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
      <span class="s1">&#39;The compaction context must not be null.&#39;</span><span class="p">,</span>
      <span class="s1">&#39;jsonld.CompactError&#39;</span><span class="p">));</span>
    <span class="p">});</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>nothing to compact</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">input</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>set default options</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;base&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">base</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;strict&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">strict</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;compactArrays&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">compactArrays</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;graph&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">graph</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;skipExpansion&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">skipExpansion</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;loadContext&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">loadContext</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">loadContext</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">expand</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">jsonld</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">skipExpansion</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">input</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">jsonld</span><span class="p">.</span><span class="nx">expand</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">};</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>expand input then do compaction</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">expand</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">expanded</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
        <span class="s1">&#39;Could not expand input before compaction.&#39;</span><span class="p">,</span>
        <span class="s1">&#39;jsonld.CompactError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">cause</span><span class="o">:</span> <span class="nx">err</span><span class="p">}));</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>process context</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">activeCtx</span> <span class="o">=</span> <span class="nx">_getInitialContext</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="nx">jsonld</span><span class="p">.</span><span class="nx">processContext</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">activeCtx</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
          <span class="s1">&#39;Could not process context before compaction.&#39;</span><span class="p">,</span>
          <span class="s1">&#39;jsonld.CompactError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">cause</span><span class="o">:</span> <span class="nx">err</span><span class="p">}));</span>
      <span class="p">}</span>

      <span class="k">try</span> <span class="p">{</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>do compaction</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">compacted</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Processor</span><span class="p">().</span><span class="nx">compact</span><span class="p">(</span>
          <span class="nx">activeCtx</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">expanded</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
        <span class="nx">cleanup</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">compacted</span><span class="p">,</span> <span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">catch</span><span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">ex</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>performs clean up after compaction</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">cleanup</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">compacted</span><span class="p">,</span> <span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">compactArrays</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">graph</span> <span class="o">&amp;&amp;</span> <span class="nx">_isArray</span><span class="p">(</span><span class="nx">compacted</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>simplify to a single item</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">compacted</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">compacted</span> <span class="o">=</span> <span class="nx">compacted</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><p>simplify to an empty object</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">compacted</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">compacted</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><p>always use array if graph option is on</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">graph</span> <span class="o">&amp;&amp;</span> <span class="nx">_isObject</span><span class="p">(</span><span class="nx">compacted</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">compacted</span> <span class="o">=</span> <span class="p">[</span><span class="nx">compacted</span><span class="p">];</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a href="#section-16" class="pilcrow">&#182;</a></div><p>follow @context key</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;@context&#39;</span> <span class="k">in</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">[</span><span class="s1">&#39;@context&#39;</span><span class="p">];</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a href="#section-17" class="pilcrow">&#182;</a></div><p>build output context</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">_clone</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">ctx</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">ctx</span> <span class="o">=</span> <span class="p">[</span><span class="nx">ctx</span><span class="p">];</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-18"><td class="docs"><div class="pilwrap"><a href="#section-18" class="pilcrow">&#182;</a></div><p>remove empty contexts</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">;</span>
    <span class="nx">ctx</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">tmp</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">tmp</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">||</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">tmp</span><span class="p">[</span><span class="nx">i</span><span class="p">]).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tmp</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-19"><td class="docs"><div class="pilwrap"><a href="#section-19" class="pilcrow">&#182;</a></div><p>remove array if only one context</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">hasContext</span> <span class="o">=</span> <span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-20"><td class="docs"><div class="pilwrap"><a href="#section-20" class="pilcrow">&#182;</a></div><p>add context and/or @graph</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">compacted</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-21"><td class="docs"><div class="pilwrap"><a href="#section-21" class="pilcrow">&#182;</a></div><p>use '@graph' keyword</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">kwgraph</span> <span class="o">=</span> <span class="nx">_compactIri</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="s1">&#39;@graph&#39;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">graph</span> <span class="o">=</span> <span class="nx">compacted</span><span class="p">;</span>
      <span class="nx">compacted</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">hasContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">compacted</span><span class="p">[</span><span class="s1">&#39;@context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">compacted</span><span class="p">[</span><span class="nx">kwgraph</span><span class="p">]</span> <span class="o">=</span> <span class="nx">graph</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">compacted</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">hasContext</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-22"><td class="docs"><div class="pilwrap"><a href="#section-22" class="pilcrow">&#182;</a></div><p>reorder keys so @context is first</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">graph</span> <span class="o">=</span> <span class="nx">compacted</span><span class="p">;</span>
      <span class="nx">compacted</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@context&#39;</span><span class="o">:</span> <span class="nx">ctx</span><span class="p">};</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">graph</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">compacted</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">graph</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">compacted</span><span class="p">,</span> <span class="nx">activeCtx</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-23"><td class="docs"><div class="pilwrap"><a href="#section-23" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Performs JSON-LD expansion.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">input</span><span>- JSON-LD input to expand.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">[options]</span><span>- options to use:</span></div><div class="dox_tag_detail"><span>expanded) </span><span class="dox_type">callback(err</span><span class="dox_type"></span><span>- called once the operation completes.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">expand</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Could not expand, too few arguments.&#39;</span><span class="p">));</span>
    <span class="p">});</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-24"><td class="docs"><div class="pilwrap"><a href="#section-24" class="pilcrow">&#182;</a></div><p>get arguments</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
    <span class="nx">options</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="p">}</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-25"><td class="docs"><div class="pilwrap"><a href="#section-25" class="pilcrow">&#182;</a></div><p>set default options</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;base&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">base</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;loadContext&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">loadContext</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">loadContext</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;keepFreeFloatingNodes&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">keepFreeFloatingNodes</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">jsonld</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div></td></tr><tr id="section-26"><td class="docs"><div class="pilwrap"><a href="#section-26" class="pilcrow">&#182;</a></div><p>retrieve all @context URLs in the input</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">input</span> <span class="o">=</span> <span class="nx">_clone</span><span class="p">(</span><span class="nx">input</span><span class="p">);</span>
    <span class="nx">_retrieveContextUrls</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">try</span> <span class="p">{</span></pre></div></td></tr><tr id="section-27"><td class="docs"><div class="pilwrap"><a href="#section-27" class="pilcrow">&#182;</a></div><p>do expansion</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">activeCtx</span> <span class="o">=</span> <span class="nx">_getInitialContext</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">expanded</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Processor</span><span class="p">().</span><span class="nx">expand</span><span class="p">(</span>
          <span class="nx">activeCtx</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">input</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span></pre></div></td></tr><tr id="section-28"><td class="docs"><div class="pilwrap"><a href="#section-28" class="pilcrow">&#182;</a></div><p>optimize away @graph with no other properties</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">expanded</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="s1">&#39;@graph&#39;</span> <span class="k">in</span> <span class="nx">expanded</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
          <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">expanded</span><span class="p">).</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">expanded</span> <span class="o">=</span> <span class="nx">expanded</span><span class="p">[</span><span class="s1">&#39;@graph&#39;</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">expanded</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">expanded</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-29"><td class="docs"><div class="pilwrap"><a href="#section-29" class="pilcrow">&#182;</a></div><p>normalize to an array</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">expanded</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">expanded</span> <span class="o">=</span> <span class="p">[</span><span class="nx">expanded</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">expanded</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">catch</span><span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">ex</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-30"><td class="docs"><div class="pilwrap"><a href="#section-30" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Performs JSON-LD flattening.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">input</span><span>- JSON-LD to flatten.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">ctx</span><span>- context to use to compact the flattened output, or null.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">[options]</span><span>- options to use:</span></div><div class="dox_tag_detail"><span>flattened) </span><span class="dox_type">callback(err</span><span class="dox_type"></span><span>- called once the operation completes.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">flatten</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Could not flatten, too few arguments.&#39;</span><span class="p">));</span>
    <span class="p">});</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-31"><td class="docs"><div class="pilwrap"><a href="#section-31" class="pilcrow">&#182;</a></div><p>get arguments</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
    <span class="nx">options</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="p">}</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-32"><td class="docs"><div class="pilwrap"><a href="#section-32" class="pilcrow">&#182;</a></div><p>set default options</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;base&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">base</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;loadContext&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">loadContext</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">loadContext</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-33"><td class="docs"><div class="pilwrap"><a href="#section-33" class="pilcrow">&#182;</a></div><p>expand input</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">jsonld</span><span class="p">.</span><span class="nx">expand</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">_input</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
        <span class="s1">&#39;Could not expand input before flattening.&#39;</span><span class="p">,</span>
        <span class="s1">&#39;jsonld.FlattenError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">cause</span><span class="o">:</span> <span class="nx">err</span><span class="p">}));</span>
    <span class="p">}</span>

    <span class="k">try</span> <span class="p">{</span></pre></div></td></tr><tr id="section-34"><td class="docs"><div class="pilwrap"><a href="#section-34" class="pilcrow">&#182;</a></div><p>do flattening</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">flattened</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Processor</span><span class="p">().</span><span class="nx">flatten</span><span class="p">(</span><span class="nx">_input</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">ex</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">flattened</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-35"><td class="docs"><div class="pilwrap"><a href="#section-35" class="pilcrow">&#182;</a></div><p>compact result (force @graph option to true, skip expansion)</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">options</span><span class="p">.</span><span class="nx">graph</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">skipExpansion</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">jsonld</span><span class="p">.</span><span class="nx">compact</span><span class="p">(</span><span class="nx">flattened</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">compacted</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
          <span class="s1">&#39;Could not compact flattened output.&#39;</span><span class="p">,</span>
          <span class="s1">&#39;jsonld.FlattenError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">cause</span><span class="o">:</span> <span class="nx">err</span><span class="p">}));</span>
      <span class="p">}</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">compacted</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-36"><td class="docs"><div class="pilwrap"><a href="#section-36" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Performs JSON-LD framing.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">input</span><span>- JSON-LD input to frame.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">frame</span><span>- JSON-LD frame to use.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">[options]</span><span>- framing options.</span></div><div class="dox_tag_detail"><span>framed) </span><span class="dox_type">callback(err</span><span class="dox_type"></span><span>- called once the operation completes.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">frame</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">frame</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Could not frame, too few arguments.&#39;</span><span class="p">));</span>
    <span class="p">});</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-37"><td class="docs"><div class="pilwrap"><a href="#section-37" class="pilcrow">&#182;</a></div><p>get arguments</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
    <span class="nx">options</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="p">}</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-38"><td class="docs"><div class="pilwrap"><a href="#section-38" class="pilcrow">&#182;</a></div><p>set default options</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;base&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">base</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;loadContext&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">loadContext</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">loadContext</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;embed&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">embed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">explicit</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">explicit</span> <span class="o">||</span> <span class="kc">false</span><span class="p">;</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">omitDefault</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">omitDefault</span> <span class="o">||</span> <span class="kc">false</span><span class="p">;</span></pre></div></td></tr><tr id="section-39"><td class="docs"><div class="pilwrap"><a href="#section-39" class="pilcrow">&#182;</a></div><p>preserve frame context</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">frame</span><span class="p">[</span><span class="s1">&#39;@context&#39;</span><span class="p">]</span> <span class="o">||</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-40"><td class="docs"><div class="pilwrap"><a href="#section-40" class="pilcrow">&#182;</a></div><p>expand input</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">jsonld</span><span class="p">.</span><span class="nx">expand</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">expanded</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
        <span class="s1">&#39;Could not expand input before framing.&#39;</span><span class="p">,</span>
        <span class="s1">&#39;jsonld.FrameError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">cause</span><span class="o">:</span> <span class="nx">err</span><span class="p">}));</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-41"><td class="docs"><div class="pilwrap"><a href="#section-41" class="pilcrow">&#182;</a></div><p>expand frame</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">opts</span> <span class="o">=</span> <span class="nx">_clone</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="nx">opts</span><span class="p">.</span><span class="nx">keepFreeFloatingNodes</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">jsonld</span><span class="p">.</span><span class="nx">expand</span><span class="p">(</span><span class="nx">frame</span><span class="p">,</span> <span class="nx">opts</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">expandedFrame</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
          <span class="s1">&#39;Could not expand frame before framing.&#39;</span><span class="p">,</span>
          <span class="s1">&#39;jsonld.FrameError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">cause</span><span class="o">:</span> <span class="nx">err</span><span class="p">}));</span>
      <span class="p">}</span>

      <span class="k">try</span> <span class="p">{</span></pre></div></td></tr><tr id="section-42"><td class="docs"><div class="pilwrap"><a href="#section-42" class="pilcrow">&#182;</a></div><p>do framing</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">framed</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Processor</span><span class="p">().</span><span class="nx">frame</span><span class="p">(</span><span class="nx">expanded</span><span class="p">,</span> <span class="nx">expandedFrame</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">catch</span><span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">ex</span><span class="p">);</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-43"><td class="docs"><div class="pilwrap"><a href="#section-43" class="pilcrow">&#182;</a></div><p>compact result (force @graph option to true, skip expansion)</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">opts</span><span class="p">.</span><span class="nx">graph</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">opts</span><span class="p">.</span><span class="nx">skipExpansion</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">jsonld</span><span class="p">.</span><span class="nx">compact</span><span class="p">(</span><span class="nx">framed</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">opts</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">compacted</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
            <span class="s1">&#39;Could not compact framed output.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;jsonld.FrameError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">cause</span><span class="o">:</span> <span class="nx">err</span><span class="p">}));</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-44"><td class="docs"><div class="pilwrap"><a href="#section-44" class="pilcrow">&#182;</a></div><p>get graph alias</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">graph</span> <span class="o">=</span> <span class="nx">_compactIri</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s1">&#39;@graph&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-45"><td class="docs"><div class="pilwrap"><a href="#section-45" class="pilcrow">&#182;</a></div><p>remove @preserve from results</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">compacted</span><span class="p">[</span><span class="nx">graph</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_removePreserve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">compacted</span><span class="p">[</span><span class="nx">graph</span><span class="p">],</span> <span class="nx">opts</span><span class="p">);</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">compacted</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-46"><td class="docs"><div class="pilwrap"><a href="#section-46" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Performs JSON-LD objectification.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">input</span><span>- JSON-LD input to objectify.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">ctx</span><span>- JSON-LD context to apply.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">[options]</span><span>- framing options.</span></div><div class="dox_tag_detail"><span>objectified) </span><span class="dox_type">callback(err</span><span class="dox_type"></span><span>- called once the operation completes.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">objectify</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-47"><td class="docs"><div class="pilwrap"><a href="#section-47" class="pilcrow">&#182;</a></div><p>get arguments</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
    <span class="nx">options</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="p">}</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-48"><td class="docs"><div class="pilwrap"><a href="#section-48" class="pilcrow">&#182;</a></div><p>set default options</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;base&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">base</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;loadContext&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">loadContext</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">loadContext</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-49"><td class="docs"><div class="pilwrap"><a href="#section-49" class="pilcrow">&#182;</a></div><p>expand input</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">jsonld</span><span class="p">.</span><span class="nx">expand</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">_input</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
        <span class="s1">&#39;Could not expand input before framing.&#39;</span><span class="p">,</span>
        <span class="s1">&#39;jsonld.FrameError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">cause</span><span class="o">:</span> <span class="nx">err</span><span class="p">}));</span>
    <span class="p">}</span>

    <span class="k">try</span> <span class="p">{</span></pre></div></td></tr><tr id="section-50"><td class="docs"><div class="pilwrap"><a href="#section-50" class="pilcrow">&#182;</a></div><p>flatten the graph</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">flattened</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Processor</span><span class="p">().</span><span class="nx">flatten</span><span class="p">(</span><span class="nx">_input</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">ex</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-51"><td class="docs"><div class="pilwrap"><a href="#section-51" class="pilcrow">&#182;</a></div><p>compact result (force @graph option to true, skip expansion)</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">options</span><span class="p">.</span><span class="nx">graph</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">skipExpansion</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">jsonld</span><span class="p">.</span><span class="nx">compact</span><span class="p">(</span><span class="nx">flattened</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">compacted</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
          <span class="s1">&#39;Could not compact flattened output.&#39;</span><span class="p">,</span>
          <span class="s1">&#39;jsonld.FrameError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">cause</span><span class="o">:</span> <span class="nx">err</span><span class="p">}));</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-52"><td class="docs"><div class="pilwrap"><a href="#section-52" class="pilcrow">&#182;</a></div><p>get graph alias</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">graph</span> <span class="o">=</span> <span class="nx">_compactIri</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s1">&#39;@graph&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-53"><td class="docs"><div class="pilwrap"><a href="#section-53" class="pilcrow">&#182;</a></div><p>remove @preserve from results (named graphs?)</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">compacted</span><span class="p">[</span><span class="nx">graph</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_removePreserve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">compacted</span><span class="p">[</span><span class="nx">graph</span><span class="p">],</span> <span class="nx">options</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">top</span> <span class="o">=</span> <span class="nx">compacted</span><span class="p">[</span><span class="nx">graph</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>

      <span class="kd">var</span> <span class="nx">recurse</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">subject</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-54"><td class="docs"><div class="pilwrap"><a href="#section-54" class="pilcrow">&#182;</a></div><p>can't replace just a string</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">subject</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">subject</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-55"><td class="docs"><div class="pilwrap"><a href="#section-55" class="pilcrow">&#182;</a></div><p>bottom out recursion on re-visit</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">subject</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">recurse</span><span class="p">.</span><span class="nx">visited</span><span class="p">[</span><span class="nx">subject</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">]])</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">recurse</span><span class="p">.</span><span class="nx">visited</span><span class="p">[</span><span class="nx">subject</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-56"><td class="docs"><div class="pilwrap"><a href="#section-56" class="pilcrow">&#182;</a></div><p>each array element <em>or</em> object key</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">k</span> <span class="k">in</span> <span class="nx">subject</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">subject</span><span class="p">[</span><span class="nx">k</span><span class="p">];</span>
          <span class="kd">var</span> <span class="nx">isid</span> <span class="o">=</span> <span class="p">(</span><span class="nx">jsonld</span><span class="p">.</span><span class="nx">getContextValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="s1">&#39;@type&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;@id&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-57"><td class="docs"><div class="pilwrap"><a href="#section-57" class="pilcrow">&#182;</a></div><p>can't replace a non-object or non-array unless it's an @id</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isid</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="k">if</span><span class="p">(</span><span class="nx">_isString</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">isid</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">subject</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">top</span><span class="p">[</span><span class="nx">obj</span><span class="p">];</span>
            <span class="nx">recurse</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">obj</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span><span class="p">(</span><span class="nx">_isString</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">isid</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">top</span><span class="p">[</span><span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span>
              <span class="p">}</span>
              <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;@id&#39;</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
                <span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">top</span><span class="p">[</span><span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s1">&#39;@id&#39;</span><span class="p">]];</span>
              <span class="p">}</span>
              <span class="nx">recurse</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">sid</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">];</span>
            <span class="nx">subject</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">top</span><span class="p">[</span><span class="nx">sid</span><span class="p">];</span>
            <span class="nx">recurse</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">};</span>
      <span class="nx">recurse</span><span class="p">.</span><span class="nx">visited</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="nx">recurse</span><span class="p">(</span><span class="nx">top</span><span class="p">);</span>

      <span class="nx">compacted</span><span class="p">.</span><span class="nx">of_type</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">s</span> <span class="k">in</span> <span class="nx">top</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;@type&#39;</span> <span class="k">in</span> <span class="nx">top</span><span class="p">[</span><span class="nx">s</span><span class="p">]))</span> <span class="p">{</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">types</span> <span class="o">=</span> <span class="nx">top</span><span class="p">[</span><span class="nx">s</span><span class="p">][</span><span class="s1">&#39;@type&#39;</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">types</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">types</span> <span class="o">=</span> <span class="p">[</span><span class="nx">types</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">t</span> <span class="k">in</span> <span class="nx">types</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">types</span><span class="p">[</span><span class="nx">t</span><span class="p">]</span> <span class="k">in</span> <span class="nx">compacted</span><span class="p">.</span><span class="nx">of_type</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">compacted</span><span class="p">.</span><span class="nx">of_type</span><span class="p">[</span><span class="nx">types</span><span class="p">[</span><span class="nx">t</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="p">}</span>
          <span class="nx">compacted</span><span class="p">.</span><span class="nx">of_type</span><span class="p">[</span><span class="nx">types</span><span class="p">[</span><span class="nx">t</span><span class="p">]].</span><span class="nx">push</span><span class="p">(</span><span class="nx">top</span><span class="p">[</span><span class="nx">s</span><span class="p">]);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">compacted</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-58"><td class="docs"><div class="pilwrap"><a href="#section-58" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Performs RDF dataset normalization on the given JSON-LD input. The output<br />is an RDF dataset unless the 'format' option is used.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">input</span><span>- JSON-LD input to normalize.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">[options]</span><span>- options to use:</span></div><div class="dox_tag_detail"><span>normalized) </span><span class="dox_type">callback(err</span><span class="dox_type"></span><span>- called once the operation completes.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">normalize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Could not normalize, too few arguments.&#39;</span><span class="p">));</span>
    <span class="p">});</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-59"><td class="docs"><div class="pilwrap"><a href="#section-59" class="pilcrow">&#182;</a></div><p>get arguments</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
    <span class="nx">options</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="p">}</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-60"><td class="docs"><div class="pilwrap"><a href="#section-60" class="pilcrow">&#182;</a></div><p>set default options</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;base&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">base</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;loadContext&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">loadContext</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">loadContext</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-61"><td class="docs"><div class="pilwrap"><a href="#section-61" class="pilcrow">&#182;</a></div><p>convert to RDF dataset then do normalization</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">opts</span> <span class="o">=</span> <span class="nx">_clone</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
  <span class="k">delete</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">format</span><span class="p">;</span>
  <span class="nx">jsonld</span><span class="p">.</span><span class="nx">toRDF</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">opts</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">dataset</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
        <span class="s1">&#39;Could not convert input to RDF dataset before normalization.&#39;</span><span class="p">,</span>
        <span class="s1">&#39;jsonld.NormalizeError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">cause</span><span class="o">:</span> <span class="nx">err</span><span class="p">}));</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-62"><td class="docs"><div class="pilwrap"><a href="#section-62" class="pilcrow">&#182;</a></div><p>do normalization</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">new</span> <span class="nx">Processor</span><span class="p">().</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">dataset</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-63"><td class="docs"><div class="pilwrap"><a href="#section-63" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Converts an RDF dataset to JSON-LD.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>a </span><span class="dox_type">dataset</span><span>- serialized string of RDF in a format specified by the</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">[options]</span><span>- options to use:</span></div><div class="dox_tag_detail"><span>output) </span><span class="dox_type">callback(err</span><span class="dox_type"></span><span>- called once the operation completes.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">fromRDF</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dataset</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Could not convert from RDF, too few arguments.&#39;</span><span class="p">));</span>
    <span class="p">});</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-64"><td class="docs"><div class="pilwrap"><a href="#section-64" class="pilcrow">&#182;</a></div><p>get arguments</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
    <span class="nx">options</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="p">}</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-65"><td class="docs"><div class="pilwrap"><a href="#section-65" class="pilcrow">&#182;</a></div><p>set default options</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;useRdfType&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">useRdfType</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;useNativeTypes&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">useNativeTypes</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;format&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">_isString</span><span class="p">(</span><span class="nx">dataset</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-66"><td class="docs"><div class="pilwrap"><a href="#section-66" class="pilcrow">&#182;</a></div><p>set default format to nquads</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;format&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">format</span> <span class="o">=</span> <span class="s1">&#39;application/nquads&#39;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">jsonld</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div></td></tr><tr id="section-67"><td class="docs"><div class="pilwrap"><a href="#section-67" class="pilcrow">&#182;</a></div><p>handle special format</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">format</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-68"><td class="docs"><div class="pilwrap"><a href="#section-68" class="pilcrow">&#182;</a></div><p>supported formats</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">format</span> <span class="k">in</span> <span class="nx">_rdfParsers</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">dataset</span> <span class="o">=</span> <span class="nx">_rdfParsers</span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">format</span><span class="p">](</span><span class="nx">dataset</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
          <span class="s1">&#39;Unknown input format.&#39;</span><span class="p">,</span>
          <span class="s1">&#39;jsonld.UnknownFormat&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">format</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">format</span><span class="p">});</span>
      <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-69"><td class="docs"><div class="pilwrap"><a href="#section-69" class="pilcrow">&#182;</a></div><p>convert from RDF</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">new</span> <span class="nx">Processor</span><span class="p">().</span><span class="nx">fromRDF</span><span class="p">(</span><span class="nx">dataset</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-70"><td class="docs"><div class="pilwrap"><a href="#section-70" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Outputs the RDF dataset found in the given JSON-LD object.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">input</span><span>- JSON-LD input.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">[options]</span><span>- options to use:</span></div><div class="dox_tag_detail"><span>dataset) </span><span class="dox_type">callback(err</span><span class="dox_type"></span><span>- called once the operation completes.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">toRDF</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Could not convert to RDF, too few arguments.&#39;</span><span class="p">));</span>
    <span class="p">});</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-71"><td class="docs"><div class="pilwrap"><a href="#section-71" class="pilcrow">&#182;</a></div><p>get arguments</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
    <span class="nx">options</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="p">}</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-72"><td class="docs"><div class="pilwrap"><a href="#section-72" class="pilcrow">&#182;</a></div><p>set default options</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;base&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">base</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;loadContext&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">loadContext</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">loadContext</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-73"><td class="docs"><div class="pilwrap"><a href="#section-73" class="pilcrow">&#182;</a></div><p>expand input</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">jsonld</span><span class="p">.</span><span class="nx">expand</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">expanded</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
        <span class="s1">&#39;Could not expand input before conversion to RDF.&#39;</span><span class="p">,</span>
        <span class="s1">&#39;jsonld.RdfError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">cause</span><span class="o">:</span> <span class="nx">err</span><span class="p">}));</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-74"><td class="docs"><div class="pilwrap"><a href="#section-74" class="pilcrow">&#182;</a></div><p>create node map for default graph (and any named graphs)</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">namer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UniqueNamer</span><span class="p">(</span><span class="s1">&#39;_:b&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">nodeMap</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@default&#39;</span><span class="o">:</span> <span class="p">{}};</span>
    <span class="nx">_createNodeMap</span><span class="p">(</span><span class="nx">expanded</span><span class="p">,</span> <span class="nx">nodeMap</span><span class="p">,</span> <span class="s1">&#39;@default&#39;</span><span class="p">,</span> <span class="nx">namer</span><span class="p">);</span>

    <span class="k">try</span> <span class="p">{</span></pre></div></td></tr><tr id="section-75"><td class="docs"><div class="pilwrap"><a href="#section-75" class="pilcrow">&#182;</a></div><p>output RDF dataset</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">dataset</span> <span class="o">=</span> <span class="nx">Processor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toRDF</span><span class="p">(</span><span class="nx">nodeMap</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">format</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">format</span> <span class="o">===</span> <span class="s1">&#39;application/nquads&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">_toNQuads</span><span class="p">(</span><span class="nx">dataset</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
          <span class="s1">&#39;Unknown output format.&#39;</span><span class="p">,</span>
          <span class="s1">&#39;jsonld.UnknownFormat&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">format</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">format</span><span class="p">});</span>
      <span class="p">}</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">dataset</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="nx">ex</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-76"><td class="docs"><div class="pilwrap"><a href="#section-76" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Relabels all blank nodes in the given JSON-LD input.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">input</span><span>- JSON-LD input.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">relabelBlankNodes</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">_labelBlankNodes</span><span class="p">(</span><span class="k">new</span> <span class="nx">UniqueNamer</span><span class="p">(</span><span class="s1">&#39;_:b&#39;</span><span class="p">,</span> <span class="nx">input</span><span class="p">));</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-77"><td class="docs"><div class="pilwrap"><a href="#section-77" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>The default context loader for external @context URLs.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>callback(err, </span><span class="dox_type">loadContext(url</span><span class="dox_type"></span><span>- url, result)) the context loader.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">loadContext</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
    <span class="s1">&#39;Could not retrieve @context URL. URL derefencing not implemented.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;jsonld.ContextUrlError&#39;</span><span class="p">),</span> <span class="nx">url</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-78"><td class="docs"><div class="pilwrap"><a href="#section-78" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Futures/Promises API</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">futures</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">promises</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">Future</span> <span class="o">=</span> <span class="nx">_nodejs</span> <span class="o">?</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./Future&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="nx">global</span><span class="p">.</span><span class="nx">Future</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">slice</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">;</span></pre></div></td></tr><tr id="section-79"><td class="docs"><div class="pilwrap"><a href="#section-79" class="pilcrow">&#182;</a></div><p>converts a node.js async op into a future w/boxed resolved value(s)</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">futurize</span><span class="p">(</span><span class="nx">op</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Future</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolver</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">op</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">resolver</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">resolver</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}));</span>
    <span class="p">});</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-80"><td class="docs"><div class="pilwrap"><a href="#section-80" class="pilcrow">&#182;</a></div><p>converts a load context promise callback to a node-style callback</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">createContextLoader</span><span class="p">(</span><span class="nx">promise</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">promise</span><span class="p">(</span><span class="nx">url</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span></pre></div></td></tr><tr id="section-81"><td class="docs"><div class="pilwrap"><a href="#section-81" class="pilcrow">&#182;</a></div><p>success</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">function</span><span class="p">(</span><span class="nx">remoteContext</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">remoteContext</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">remoteContext</span><span class="p">.</span><span class="nx">context</span><span class="p">);</span>
        <span class="p">},</span></pre></div></td></tr><tr id="section-82"><td class="docs"><div class="pilwrap"><a href="#section-82" class="pilcrow">&#182;</a></div><p>failure</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">callback</span>
      <span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">api</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="nx">api</span><span class="p">.</span><span class="nx">expand</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Could not expand, too few arguments.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="p">{};</span>
    <span class="k">if</span><span class="p">(</span><span class="s1">&#39;loadContext&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">loadContext</span> <span class="o">=</span> <span class="nx">createContextLoader</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">loadContext</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">futurize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">[</span><span class="nx">jsonld</span><span class="p">.</span><span class="nx">expand</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">)));</span>
  <span class="p">};</span>
  <span class="nx">api</span><span class="p">.</span><span class="nx">compact</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Could not compact, too few arguments.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:</span> <span class="p">{};</span>
    <span class="k">if</span><span class="p">(</span><span class="s1">&#39;loadContext&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">loadContext</span> <span class="o">=</span> <span class="nx">createContextLoader</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">loadContext</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">compact</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-83"><td class="docs"><div class="pilwrap"><a href="#section-83" class="pilcrow">&#182;</a></div><p>ensure only one value is returned in callback</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">jsonld</span><span class="p">.</span><span class="nx">compact</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">compacted</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">compacted</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="nx">futurize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">[</span><span class="nx">compact</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">)));</span>
  <span class="p">};</span>
  <span class="nx">api</span><span class="p">.</span><span class="nx">flatten</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Could not flatten, too few arguments.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:</span> <span class="p">{};</span>
    <span class="k">if</span><span class="p">(</span><span class="s1">&#39;loadContext&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">loadContext</span> <span class="o">=</span> <span class="nx">createContextLoader</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">loadContext</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">futurize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">[</span><span class="nx">jsonld</span><span class="p">.</span><span class="nx">flatten</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">)));</span>
  <span class="p">};</span>
  <span class="nx">api</span><span class="p">.</span><span class="nx">frame</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">frame</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Could not frame, too few arguments.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:</span> <span class="p">{};</span>
    <span class="k">if</span><span class="p">(</span><span class="s1">&#39;loadContext&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">loadContext</span> <span class="o">=</span> <span class="nx">createContextLoader</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">loadContext</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">futurize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">[</span><span class="nx">jsonld</span><span class="p">.</span><span class="nx">frame</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">)));</span>
  <span class="p">};</span>
  <span class="nx">api</span><span class="p">.</span><span class="nx">fromRDF</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dataset</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Could not convert from RDF, too few arguments.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">futurize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">[</span><span class="nx">jsonld</span><span class="p">.</span><span class="nx">fromRDF</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">)));</span>
  <span class="p">};</span>
  <span class="nx">api</span><span class="p">.</span><span class="nx">toRDF</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Could not convert to RDF, too few arguments.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="p">{};</span>
    <span class="k">if</span><span class="p">(</span><span class="s1">&#39;loadContext&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">loadContext</span> <span class="o">=</span> <span class="nx">createContextLoader</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">loadContext</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">futurize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">[</span><span class="nx">jsonld</span><span class="p">.</span><span class="nx">toRDF</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">)));</span>
  <span class="p">};</span>
  <span class="nx">api</span><span class="p">.</span><span class="nx">normalize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Could not normalize, too few arguments.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="p">{};</span>
    <span class="k">if</span><span class="p">(</span><span class="s1">&#39;loadContext&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">loadContext</span> <span class="o">=</span> <span class="nx">createContextLoader</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">loadContext</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">futurize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span>
      <span class="kc">null</span><span class="p">,</span> <span class="p">[</span><span class="nx">jsonld</span><span class="p">.</span><span class="nx">normalize</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">)));</span>
  <span class="p">};</span>
  <span class="k">return</span> <span class="nx">api</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-84"><td class="docs"><div class="pilwrap"><a href="#section-84" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>WebIDL API</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">JsonLdProcessor</span><span class="p">()</span> <span class="p">{}</span>
<span class="nx">JsonLdProcessor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">futures</span><span class="p">();</span>
<span class="nx">JsonLdProcessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">JsonLdProcessor</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">&#39;[object JsonLdProcessor]&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="s1">&#39;[object JsonLdProcessorPrototype]&#39;</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">jsonld</span><span class="p">.</span><span class="nx">JsonLdProcessor</span> <span class="o">=</span> <span class="nx">JsonLdProcessor</span><span class="p">;</span>
<span class="k">if</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">JsonLdProcessor</span><span class="p">,</span> <span class="s1">&#39;prototype&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">writable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">false</span>
  <span class="p">});</span>
  <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">JsonLdProcessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="s1">&#39;constructor&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">writable</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">configurable</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nx">value</span><span class="o">:</span> <span class="nx">JsonLdProcessor</span>
  <span class="p">});</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-85"><td class="docs"><div class="pilwrap"><a href="#section-85" class="pilcrow">&#182;</a></div><p>setup browser global JsonLdProcessor</p>
</td><td class="code"><div class="highlight"><pre><span class="k">if</span><span class="p">(</span><span class="nx">_browser</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">global</span><span class="p">.</span><span class="nx">JsonLdProcessor</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">global</span><span class="p">,</span> <span class="s1">&#39;JsonLdProcessor&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">writable</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">configurable</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">value</span><span class="o">:</span> <span class="nx">JsonLdProcessor</span>
    <span class="p">});</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">global</span><span class="p">.</span><span class="nx">JsonLdProcessor</span> <span class="o">=</span> <span class="nx">JsonLdProcessor</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-86"><td class="docs"><div class="pilwrap"><a href="#section-86" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Utility API</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-87"><td class="docs"><div class="pilwrap"><a href="#section-87" class="pilcrow">&#182;</a></div><p>define setImmediate and nextTick</p>
</td><td class="code"><div class="highlight"><pre><span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">process</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">||</span> <span class="o">!</span><span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">setImmediate</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">jsonld</span><span class="p">.</span><span class="nx">setImmediate</span> <span class="o">=</span> <span class="nx">setImmediate</span><span class="p">;</span>
    <span class="nx">jsonld</span><span class="p">.</span><span class="nx">nextTick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">setImmediate</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">jsonld</span><span class="p">.</span><span class="nx">setImmediate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="nx">jsonld</span><span class="p">.</span><span class="nx">nextTick</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">setImmediate</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
  <span class="nx">jsonld</span><span class="p">.</span><span class="nx">nextTick</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">setImmediate</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">jsonld</span><span class="p">.</span><span class="nx">setImmediate</span> <span class="o">=</span> <span class="nx">setImmediate</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">jsonld</span><span class="p">.</span><span class="nx">setImmediate</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-88"><td class="docs"><div class="pilwrap"><a href="#section-88" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Creates a simple context cache.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">size</span><span>- maximum size of the cache.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">ContextCache</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">order</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cache</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">size</span> <span class="o">=</span> <span class="nx">size</span> <span class="o">||</span> <span class="mi">50</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">expires</span> <span class="o">=</span> <span class="mi">30</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">jsonld</span><span class="p">.</span><span class="nx">ContextCache</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">url</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">entry</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">url</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">entry</span><span class="p">.</span><span class="nx">expires</span> <span class="o">&gt;=</span> <span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">ctx</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">url</span><span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">order</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">order</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">url</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">jsonld</span><span class="p">.</span><span class="nx">ContextCache</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">set</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">order</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">order</span><span class="p">.</span><span class="nx">shift</span><span class="p">()];</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">order</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">url</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nx">ctx</span><span class="o">:</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">expires</span><span class="o">:</span> <span class="p">(</span><span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">expires</span><span class="p">)};</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-89"><td class="docs"><div class="pilwrap"><a href="#section-89" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Creates an active context cache.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">size</span><span>- maximum size of the cache.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">ActiveContextCache</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">order</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cache</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">size</span> <span class="o">=</span> <span class="nx">size</span> <span class="o">||</span> <span class="mi">100</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">jsonld</span><span class="p">.</span><span class="nx">ActiveContextCache</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">localCtx</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">key1</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">key2</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">localCtx</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">level1</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">key1</span><span class="p">];</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">level1</span> <span class="o">&amp;&amp;</span> <span class="nx">key2</span> <span class="k">in</span> <span class="nx">level1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">level1</span><span class="p">[</span><span class="nx">key2</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">jsonld</span><span class="p">.</span><span class="nx">ActiveContextCache</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">set</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span>
  <span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">localCtx</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">order</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">entry</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">order</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
    <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">entry</span><span class="p">.</span><span class="nx">activeCtx</span><span class="p">][</span><span class="nx">entry</span><span class="p">.</span><span class="nx">localCtx</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">key1</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">key2</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">localCtx</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">order</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">activeCtx</span><span class="o">:</span> <span class="nx">key1</span><span class="p">,</span> <span class="nx">localCtx</span><span class="o">:</span> <span class="nx">key2</span><span class="p">});</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">key1</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">key1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">key1</span><span class="p">][</span><span class="nx">key2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-90"><td class="docs"><div class="pilwrap"><a href="#section-90" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Default JSON-LD cache.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">cache</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">activeCtx</span><span class="o">:</span> <span class="k">new</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">ActiveContextCache</span><span class="p">()</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-91"><td class="docs"><div class="pilwrap"><a href="#section-91" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Context loaders.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">contextLoaders</span> <span class="o">=</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-92"><td class="docs"><div class="pilwrap"><a href="#section-92" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>The built-in jquery context loader.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">$</span><span>- jquery instance to use.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">options</span><span>- options to use:</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>jquery context loader.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">contextLoaders</span><span class="p">[</span><span class="s1">&#39;jquery&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="kd">var</span> <span class="nx">cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">ContextCache</span><span class="p">();</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">secure</span> <span class="o">&amp;&amp;</span> <span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;https&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
        <span class="s1">&#39;URL could not be dereferenced; secure mode is enabled and &#39;</span> <span class="o">+</span>
        <span class="s1">&#39;the URL\&#39;s scheme is not &quot;https&quot;.&#39;</span><span class="p">,</span>
        <span class="s1">&#39;jsonld.InvalidUrl&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">url</span><span class="o">:</span> <span class="nx">url</span><span class="p">}),</span> <span class="nx">url</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
      <span class="nx">url</span><span class="o">:</span> <span class="nx">url</span><span class="p">,</span>
      <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
      <span class="nx">crossDomain</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">textStatus</span><span class="p">,</span> <span class="nx">jqXHR</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">cache</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
      <span class="p">},</span>
      <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">jqXHR</span><span class="p">,</span> <span class="nx">textStatus</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
          <span class="s1">&#39;URL could not be dereferenced, an error occurred.&#39;</span><span class="p">,</span>
          <span class="s1">&#39;jsonld.LoadContextError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">url</span><span class="o">:</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">cause</span><span class="o">:</span> <span class="nx">err</span><span class="p">}),</span> <span class="nx">url</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">};</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-93"><td class="docs"><div class="pilwrap"><a href="#section-93" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>The built-in node context loader.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">options</span><span>- options to use:</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>node context loader.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">contextLoaders</span><span class="p">[</span><span class="s1">&#39;node&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="kd">var</span> <span class="nx">maxRedirects</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;maxRedirects&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">)</span> <span class="o">?</span> <span class="nx">options</span><span class="p">.</span><span class="nx">maxRedirects</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">ContextCache</span><span class="p">();</span>
  <span class="kd">function</span> <span class="nx">loadContext</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">redirects</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">secure</span> <span class="o">&amp;&amp;</span> <span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;https&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
        <span class="s1">&#39;URL could not be dereferenced; secure mode is enabled and &#39;</span> <span class="o">+</span>
        <span class="s1">&#39;the URL\&#39;s scheme is not &quot;https&quot;.&#39;</span><span class="p">,</span>
        <span class="s1">&#39;jsonld.InvalidUrl&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">url</span><span class="o">:</span> <span class="nx">url</span><span class="p">}),</span> <span class="nx">url</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">request</span><span class="p">({</span>
      <span class="nx">url</span><span class="o">:</span> <span class="nx">url</span><span class="p">,</span>
      <span class="nx">strictSSL</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">followRedirect</span><span class="o">:</span> <span class="kc">false</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-94"><td class="docs"><div class="pilwrap"><a href="#section-94" class="pilcrow">&#182;</a></div><p>handle error</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
          <span class="s1">&#39;URL could not be dereferenced, an error occurred.&#39;</span><span class="p">,</span>
          <span class="s1">&#39;jsonld.LoadContextError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">url</span><span class="o">:</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">cause</span><span class="o">:</span> <span class="nx">err</span><span class="p">}),</span> <span class="nx">url</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">statusText</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">STATUS_CODES</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
          <span class="s1">&#39;URL could not be dereferenced: &#39;</span> <span class="o">+</span> <span class="nx">statusText</span><span class="p">,</span>
          <span class="s1">&#39;jsonld.InvalidUrl&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">url</span><span class="o">:</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">httpStatusCode</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">}),</span>
          <span class="nx">url</span><span class="p">);</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-95"><td class="docs"><div class="pilwrap"><a href="#section-95" class="pilcrow">&#182;</a></div><p>handle redirect</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">&gt;=</span> <span class="mi">300</span> <span class="o">&amp;&amp;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">&lt;</span> <span class="mi">400</span> <span class="o">&amp;&amp;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">location</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">redirects</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="nx">maxRedirects</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
            <span class="s1">&#39;URL could not be dereferenced; there were too many redirects.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;jsonld.TooManyRedirects&#39;</span><span class="p">,</span>
            <span class="p">{</span><span class="nx">url</span><span class="o">:</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">httpStatusCode</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">,</span> <span class="nx">redirects</span><span class="o">:</span> <span class="nx">redirects</span><span class="p">}),</span>
            <span class="nx">url</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">redirects</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
            <span class="s1">&#39;URL could not be dereferenced; infinite redirection was detected.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;jsonld.InfiniteRedirectDetected&#39;</span><span class="p">,</span>
            <span class="p">{</span><span class="nx">url</span><span class="o">:</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">httpStatusCode</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">,</span> <span class="nx">redirects</span><span class="o">:</span> <span class="nx">redirects</span><span class="p">}),</span>
            <span class="nx">url</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">redirects</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">loadContext</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">location</span><span class="p">,</span> <span class="nx">redirects</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-96"><td class="docs"><div class="pilwrap"><a href="#section-96" class="pilcrow">&#182;</a></div><p>cache for each redirected URL</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">redirects</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">redirects</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">cache</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">redirects</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">body</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">body</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">loadContext</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="p">[],</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-97"><td class="docs"><div class="pilwrap"><a href="#section-97" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Assigns the default context loader for external @context URLs to a built-in<br />default. Supported types currently include: 'jquery' and 'node'.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">type</span><span>- type to set.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">[params]</span><span>- parameters required to use the context loader.</span></div></div><div class="body"><p>To use the jquery context loader, the 'data' parameter must be a reference<br />to the main jquery object.</p></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">useContextLoader</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">type</span> <span class="k">in</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">contextLoaders</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
      <span class="s1">&#39;Unknown @context loader type: &quot;&#39;</span> <span class="o">+</span> <span class="nx">type</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span>
      <span class="s1">&#39;jsonld.UnknownContextLoader&#39;</span><span class="p">,</span>
      <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="nx">type</span><span class="p">});</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-98"><td class="docs"><div class="pilwrap"><a href="#section-98" class="pilcrow">&#182;</a></div><p>set context loader</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">jsonld</span><span class="p">.</span><span class="nx">loadContext</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">contextLoaders</span><span class="p">[</span><span class="nx">type</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span>
    <span class="nx">jsonld</span><span class="p">,</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-99"><td class="docs"><div class="pilwrap"><a href="#section-99" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Processes a local context, resolving any URLs as necessary, and returns a<br />new active context in its callback.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">activeCtx</span><span>- current active context.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">localCtx</span><span>- local context to process.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">[options]</span><span>- options to use:</span></div><div class="dox_tag_detail"><span>ctx) </span><span class="dox_type">callback(err</span><span class="dox_type"></span><span>- called once the operation completes.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">processContext</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">localCtx</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-100"><td class="docs"><div class="pilwrap"><a href="#section-100" class="pilcrow">&#182;</a></div><p>get arguments</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="kd">var</span> <span class="nx">callbackArg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">options</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="nx">callbackArg</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">callbackArg</span><span class="p">];</span></pre></div></td></tr><tr id="section-101"><td class="docs"><div class="pilwrap"><a href="#section-101" class="pilcrow">&#182;</a></div><p>set default options</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;base&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">base</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;loadContext&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">loadContext</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">loadContext</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-102"><td class="docs"><div class="pilwrap"><a href="#section-102" class="pilcrow">&#182;</a></div><p>return initial context early for null context</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">localCtx</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">_getInitialContext</span><span class="p">(</span><span class="nx">options</span><span class="p">));</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-103"><td class="docs"><div class="pilwrap"><a href="#section-103" class="pilcrow">&#182;</a></div><p>retrieve URLs in localCtx</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">localCtx</span> <span class="o">=</span> <span class="nx">_clone</span><span class="p">(</span><span class="nx">localCtx</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">_isString</span><span class="p">(</span><span class="nx">localCtx</span><span class="p">)</span> <span class="o">||</span>
    <span class="p">(</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">localCtx</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="s1">&#39;@context&#39;</span> <span class="k">in</span> <span class="nx">localCtx</span><span class="p">)))</span> <span class="p">{</span>
    <span class="nx">localCtx</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@context&#39;</span><span class="o">:</span> <span class="nx">localCtx</span><span class="p">};</span>
  <span class="p">}</span>
  <span class="nx">_retrieveContextUrls</span><span class="p">(</span><span class="nx">localCtx</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">try</span> <span class="p">{</span></pre></div></td></tr><tr id="section-104"><td class="docs"><div class="pilwrap"><a href="#section-104" class="pilcrow">&#182;</a></div><p>process context</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">ctx</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Processor</span><span class="p">().</span><span class="nx">processContext</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="nx">ex</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-105"><td class="docs"><div class="pilwrap"><a href="#section-105" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Returns true if the given subject has the given property.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">subject</span><span>- subject to check.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">property</span><span>- property to look for.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">true</span><span>if the subject has the given property, false if not.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">hasProperty</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">subject</span><span class="p">,</span> <span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">property</span> <span class="k">in</span> <span class="nx">subject</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">subject</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
    <span class="nx">rval</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">||</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-106"><td class="docs"><div class="pilwrap"><a href="#section-106" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Determines if the given value is a property of the given subject.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">subject</span><span>- subject to check.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">property</span><span>- property to check.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">value</span><span>- value to check.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">true</span><span>if the value exists, false if not.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">hasValue</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">subject</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">jsonld</span><span class="p">.</span><span class="nx">hasProperty</span><span class="p">(</span><span class="nx">subject</span><span class="p">,</span> <span class="nx">property</span><span class="p">))</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">subject</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">isList</span> <span class="o">=</span> <span class="nx">_isList</span><span class="p">(</span><span class="nx">val</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="o">||</span> <span class="nx">isList</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">isList</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">val</span> <span class="o">=</span> <span class="nx">val</span><span class="p">[</span><span class="s1">&#39;@list&#39;</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">jsonld</span><span class="p">.</span><span class="nx">compareValues</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">val</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span> <span class="p">{</span>
          <span class="nx">rval</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-107"><td class="docs"><div class="pilwrap"><a href="#section-107" class="pilcrow">&#182;</a></div><p>avoid matching the set of values with an array value parameter</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">rval</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">compareValues</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">val</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-108"><td class="docs"><div class="pilwrap"><a href="#section-108" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Adds a value to a subject. If the value is an array, all values in the<br />array will be added.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">subject</span><span>- subject to add the value to.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">property</span><span>- property that relates the value to the subject.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">value</span><span>- value to add.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">[options]</span><span>- options to use:</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">addValue</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">subject</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;propertyIsArray&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">propertyIsArray</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;allowDuplicate&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">allowDuplicate</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">propertyIsArray</span> <span class="o">&amp;&amp;</span>
      <span class="o">!</span><span class="p">(</span><span class="nx">property</span> <span class="k">in</span> <span class="nx">subject</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">subject</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="p">}</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">jsonld</span><span class="p">.</span><span class="nx">addValue</span><span class="p">(</span><span class="nx">subject</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">value</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">options</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">property</span> <span class="k">in</span> <span class="nx">subject</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-109"><td class="docs"><div class="pilwrap"><a href="#section-109" class="pilcrow">&#182;</a></div><p>check if subject already has value if duplicates not allowed</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">hasValue</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">allowDuplicate</span> <span class="o">&amp;&amp;</span>
      <span class="nx">jsonld</span><span class="p">.</span><span class="nx">hasValue</span><span class="p">(</span><span class="nx">subject</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">value</span><span class="p">));</span></pre></div></td></tr><tr id="section-110"><td class="docs"><div class="pilwrap"><a href="#section-110" class="pilcrow">&#182;</a></div><p>make property an array if value not present or always an array</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">subject</span><span class="p">[</span><span class="nx">property</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
      <span class="p">(</span><span class="o">!</span><span class="nx">hasValue</span> <span class="o">||</span> <span class="nx">options</span><span class="p">.</span><span class="nx">propertyIsArray</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">subject</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">subject</span><span class="p">[</span><span class="nx">property</span><span class="p">]];</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-111"><td class="docs"><div class="pilwrap"><a href="#section-111" class="pilcrow">&#182;</a></div><p>add new value</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">hasValue</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">subject</span><span class="p">[</span><span class="nx">property</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-112"><td class="docs"><div class="pilwrap"><a href="#section-112" class="pilcrow">&#182;</a></div><p>add new value as set or single value</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">subject</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">propertyIsArray</span> <span class="o">?</span> <span class="p">[</span><span class="nx">value</span><span class="p">]</span> <span class="o">:</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-113"><td class="docs"><div class="pilwrap"><a href="#section-113" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Gets all of the values for a subject's property as an array.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">subject</span><span>- subject.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">property</span><span>- property.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">all</span><span>of the values for a subject's property as an array.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">getValues</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">subject</span><span class="p">,</span> <span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="nx">subject</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">||</span> <span class="p">[];</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">rval</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">rval</span> <span class="o">=</span> <span class="p">[</span><span class="nx">rval</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-114"><td class="docs"><div class="pilwrap"><a href="#section-114" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Removes a property from a subject.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">subject</span><span>- subject.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">property</span><span>- property.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">removeProperty</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">subject</span><span class="p">,</span> <span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">delete</span> <span class="nx">subject</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-115"><td class="docs"><div class="pilwrap"><a href="#section-115" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Removes a value from a subject.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">subject</span><span>- subject.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">property</span><span>- property that relates the value to the subject.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">value</span><span>- value to remove.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">[options]</span><span>- options to use:</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">removeValue</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">subject</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;propertyIsArray&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">propertyIsArray</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-116"><td class="docs"><div class="pilwrap"><a href="#section-116" class="pilcrow">&#182;</a></div><p>filter out value</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">getValues</span><span class="p">(</span><span class="nx">subject</span><span class="p">,</span> <span class="nx">property</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">!</span><span class="nx">jsonld</span><span class="p">.</span><span class="nx">compareValues</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">jsonld</span><span class="p">.</span><span class="nx">removeProperty</span><span class="p">(</span><span class="nx">subject</span><span class="p">,</span> <span class="nx">property</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">propertyIsArray</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">subject</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">=</span> <span class="nx">values</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">subject</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">=</span> <span class="nx">values</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-117"><td class="docs"><div class="pilwrap"><a href="#section-117" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Compares two JSON-LD values for equality. Two JSON-LD values will be</p>

<h2>considered equal if</h2></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">v1</span><span>- first value.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">v2</span><span>- second value.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">true</span><span>if v1 and v2 are considered equal, false if not.</span></div></div><div class="body"><ol>
<li>They are both primitives of the same type and value.</li>
<li>They are both @values with the same @value, @type, @language,
and @index, OR</li>
<li>They both have @ids they are the same.</li>
</ol></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">compareValues</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v1</span><span class="p">,</span> <span class="nx">v2</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-118"><td class="docs"><div class="pilwrap"><a href="#section-118" class="pilcrow">&#182;</a></div><ol>
<li>equal primitives</li>
</ol>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">v1</span> <span class="o">===</span> <span class="nx">v2</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-119"><td class="docs"><div class="pilwrap"><a href="#section-119" class="pilcrow">&#182;</a></div><ol>
<li>equal @values</li>
</ol>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">_isValue</span><span class="p">(</span><span class="nx">v1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">_isValue</span><span class="p">(</span><span class="nx">v2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
    <span class="nx">v1</span><span class="p">[</span><span class="s1">&#39;@value&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="nx">v2</span><span class="p">[</span><span class="s1">&#39;@value&#39;</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
    <span class="nx">v1</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="nx">v2</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
    <span class="nx">v1</span><span class="p">[</span><span class="s1">&#39;@language&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="nx">v2</span><span class="p">[</span><span class="s1">&#39;@language&#39;</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
    <span class="nx">v1</span><span class="p">[</span><span class="s1">&#39;@index&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="nx">v2</span><span class="p">[</span><span class="s1">&#39;@index&#39;</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-120"><td class="docs"><div class="pilwrap"><a href="#section-120" class="pilcrow">&#182;</a></div><ol>
<li>equal @ids</li>
</ol>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">v1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="s1">&#39;@id&#39;</span> <span class="k">in</span> <span class="nx">v1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">_isObject</span><span class="p">(</span><span class="nx">v2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="s1">&#39;@id&#39;</span> <span class="k">in</span> <span class="nx">v2</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">v1</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="nx">v2</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-121"><td class="docs"><div class="pilwrap"><a href="#section-121" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Gets the value for the given active context key and type, null if none is<br />set.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">ctx</span><span>- active context.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">key</span><span>- context key.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">[type]</span><span>- type of value to get (eg: '@id', '@type'), if not</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>value.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">getContextValue</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div></td></tr><tr id="section-122"><td class="docs"><div class="pilwrap"><a href="#section-122" class="pilcrow">&#182;</a></div><p>return null for invalid key</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">key</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-123"><td class="docs"><div class="pilwrap"><a href="#section-123" class="pilcrow">&#182;</a></div><p>get default language</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;@language&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">type</span> <span class="k">in</span> <span class="nx">ctx</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">rval</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">[</span><span class="nx">type</span><span class="p">];</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-124"><td class="docs"><div class="pilwrap"><a href="#section-124" class="pilcrow">&#182;</a></div><p>get specific entry information</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">mappings</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">entry</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">mappings</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span></pre></div></td></tr><tr id="section-125"><td class="docs"><div class="pilwrap"><a href="#section-125" class="pilcrow">&#182;</a></div><p>return whole entry</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">_isUndefined</span><span class="p">(</span><span class="nx">type</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">rval</span> <span class="o">=</span> <span class="nx">entry</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-126"><td class="docs"><div class="pilwrap"><a href="#section-126" class="pilcrow">&#182;</a></div><p>return entry value for type</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">type</span> <span class="k">in</span> <span class="nx">entry</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">rval</span> <span class="o">=</span> <span class="nx">entry</span><span class="p">[</span><span class="nx">type</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-127"><td class="docs"><div class="pilwrap"><a href="#section-127" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Registered RDF dataset parsers hashed by content-type.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">_rdfParsers</span> <span class="o">=</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-128"><td class="docs"><div class="pilwrap"><a href="#section-128" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Registers an RDF dataset parser by content-type, for use with<br />jsonld.fromRDF.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">contentType</span><span>- content-type for the parser.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">parser(input)</span><span>- parser function (takes a string as a parameter</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">registerRDFParser</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">contentType</span><span class="p">,</span> <span class="nx">parser</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">_rdfParsers</span><span class="p">[</span><span class="nx">contentType</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parser</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-129"><td class="docs"><div class="pilwrap"><a href="#section-129" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Unregisters an RDF dataset parser by content-type.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">contentType</span><span>- content-type for the parser.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">unregisterRDFParser</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">contentType</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">delete</span> <span class="nx">_rdfParsers</span><span class="p">[</span><span class="nx">contentType</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">if</span><span class="p">(</span><span class="nx">_nodejs</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-130"><td class="docs"><div class="pilwrap"><a href="#section-130" class="pilcrow">&#182;</a></div><p>needed for serialization of XML literals</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">XMLSerializer</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">XMLSerializer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">Node</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">Node</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">ELEMENT_NODE</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nx">ATTRIBUTE_NODE</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="nx">TEXT_NODE</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
      <span class="nx">CDATA_SECTION_NODE</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
      <span class="nx">ENTITY_REFERENCE_NODE</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
      <span class="nx">ENTITY_NODE</span><span class="o">:</span> <span class="mi">6</span><span class="p">,</span>
      <span class="nx">PROCESSING_INSTRUCTION_NODE</span><span class="o">:</span> <span class="mi">7</span><span class="p">,</span>
      <span class="nx">COMMENT_NODE</span><span class="o">:</span> <span class="mi">8</span><span class="p">,</span>
      <span class="nx">DOCUMENT_NODE</span><span class="o">:</span> <span class="mi">9</span><span class="p">,</span>
      <span class="nx">DOCUMENT_TYPE_NODE</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
      <span class="nx">DOCUMENT_FRAGMENT_NODE</span><span class="o">:</span> <span class="mi">11</span><span class="p">,</span>
      <span class="nx">NOTATION_NODE</span><span class="o">:</span><span class="mi">12</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-131"><td class="docs"><div class="pilwrap"><a href="#section-131" class="pilcrow">&#182;</a></div><p>constants</p>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">XSD_BOOLEAN</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/XMLSchema#boolean&#39;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">XSD_DOUBLE</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/XMLSchema#double&#39;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">XSD_INTEGER</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/XMLSchema#integer&#39;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">XSD_STRING</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/XMLSchema#string&#39;</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">RDF</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/1999/02/22-rdf-syntax-ns#&#39;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">RDF_FIRST</span> <span class="o">=</span> <span class="nx">RDF</span> <span class="o">+</span> <span class="s1">&#39;first&#39;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">RDF_REST</span> <span class="o">=</span> <span class="nx">RDF</span> <span class="o">+</span> <span class="s1">&#39;rest&#39;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">RDF_NIL</span> <span class="o">=</span> <span class="nx">RDF</span> <span class="o">+</span> <span class="s1">&#39;nil&#39;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">RDF_TYPE</span> <span class="o">=</span> <span class="nx">RDF</span> <span class="o">+</span> <span class="s1">&#39;type&#39;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">RDF_PLAIN_LITERAL</span> <span class="o">=</span> <span class="nx">RDF</span> <span class="o">+</span> <span class="s1">&#39;PlainLiteral&#39;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">RDF_XML_LITERAL</span> <span class="o">=</span> <span class="nx">RDF</span> <span class="o">+</span> <span class="s1">&#39;XMLLiteral&#39;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">RDF_OBJECT</span> <span class="o">=</span> <span class="nx">RDF</span> <span class="o">+</span> <span class="s1">&#39;object&#39;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">RDF_LANGSTRING</span> <span class="o">=</span> <span class="nx">RDF</span> <span class="o">+</span> <span class="s1">&#39;langString&#39;</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">MAX_CONTEXT_URLS</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span></pre></div></td></tr><tr id="section-132"><td class="docs"><div class="pilwrap"><a href="#section-132" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>A JSON-LD Error.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">msg</span><span>- error message.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">type</span><span>- error type.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">details</span><span>- error details.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">JsonLdError</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">details</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">_nodejs</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">Error</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="nb">Error</span><span class="p">.</span><span class="nx">captureStackTrace</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">type</span> <span class="o">||</span> <span class="s1">&#39;jsonld.Error&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="nx">msg</span> <span class="o">||</span> <span class="s1">&#39;An unspecified JSON-LD error occurred.&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">details</span> <span class="o">=</span> <span class="nx">details</span> <span class="o">||</span> <span class="p">{};</span>
<span class="p">};</span>
<span class="k">if</span><span class="p">(</span><span class="nx">_nodejs</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">).</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">JsonLdError</span><span class="p">,</span> <span class="nb">Error</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-133"><td class="docs"><div class="pilwrap"><a href="#section-133" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Constructs a new JSON-LD Processor.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">Processor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-134"><td class="docs"><div class="pilwrap"><a href="#section-134" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Recursively compacts an element using the given active context. All values<br />must be in expanded form before this method is called.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">activeCtx</span><span>- active context to use.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">activeProperty</span><span>- compacted property associated with the element</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">element</span><span>- element to compact.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">options</span><span>- compaction options.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>compacted value.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Processor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">compact</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span>
  <span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">activeProperty</span><span class="p">,</span> <span class="nx">element</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-135"><td class="docs"><div class="pilwrap"><a href="#section-135" class="pilcrow">&#182;</a></div><p>recursively compact array</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">element</span><span class="p">))</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">element</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-136"><td class="docs"><div class="pilwrap"><a href="#section-136" class="pilcrow">&#182;</a></div><p>compact, dropping any null values</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">compacted</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">compact</span><span class="p">(</span>
        <span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">activeProperty</span><span class="p">,</span> <span class="nx">element</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">options</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">compacted</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">rval</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">compacted</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">compactArrays</span> <span class="o">&amp;&amp;</span> <span class="nx">rval</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-137"><td class="docs"><div class="pilwrap"><a href="#section-137" class="pilcrow">&#182;</a></div><p>use single element if no container is specified</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">container</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">getContextValue</span><span class="p">(</span>
        <span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">activeProperty</span><span class="p">,</span> <span class="s1">&#39;@container&#39;</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">container</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">rval</span> <span class="o">=</span> <span class="nx">rval</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-138"><td class="docs"><div class="pilwrap"><a href="#section-138" class="pilcrow">&#182;</a></div><p>recursively compact object</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">element</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-139"><td class="docs"><div class="pilwrap"><a href="#section-139" class="pilcrow">&#182;</a></div><p>do value compaction on @values and subject references</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">_isValue</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="o">||</span> <span class="nx">_isSubjectReference</span><span class="p">(</span><span class="nx">element</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">_compactValue</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">activeProperty</span><span class="p">,</span> <span class="nx">element</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-140"><td class="docs"><div class="pilwrap"><a href="#section-140" class="pilcrow">&#182;</a></div><p>FIXME: avoid misuse of active property as an expanded property?</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">insideReverse</span> <span class="o">=</span> <span class="p">(</span><span class="nx">activeProperty</span> <span class="o">===</span> <span class="s1">&#39;@reverse&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-141"><td class="docs"><div class="pilwrap"><a href="#section-141" class="pilcrow">&#182;</a></div><p>process element keys in order</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">sort</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">ki</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ki</span> <span class="o">&lt;</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">ki</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">expandedProperty</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">[</span><span class="nx">ki</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">expandedValue</span> <span class="o">=</span> <span class="nx">element</span><span class="p">[</span><span class="nx">expandedProperty</span><span class="p">];</span></pre></div></td></tr><tr id="section-142"><td class="docs"><div class="pilwrap"><a href="#section-142" class="pilcrow">&#182;</a></div><p>compact @id and @type(s)</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">expandedProperty</span> <span class="o">===</span> <span class="s1">&#39;@id&#39;</span> <span class="o">||</span> <span class="nx">expandedProperty</span> <span class="o">===</span> <span class="s1">&#39;@type&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">compactedValue</span><span class="p">;</span></pre></div></td></tr><tr id="section-143"><td class="docs"><div class="pilwrap"><a href="#section-143" class="pilcrow">&#182;</a></div><p>compact single @id</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">_isString</span><span class="p">(</span><span class="nx">expandedValue</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">compactedValue</span> <span class="o">=</span> <span class="nx">_compactIri</span><span class="p">(</span>
            <span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">expandedValue</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span>
            <span class="p">{</span><span class="nx">vocab</span><span class="o">:</span> <span class="p">(</span><span class="nx">expandedProperty</span> <span class="o">===</span> <span class="s1">&#39;@type&#39;</span><span class="p">)});</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-144"><td class="docs"><div class="pilwrap"><a href="#section-144" class="pilcrow">&#182;</a></div><p>expanded value must be a @type array</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">compactedValue</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">vi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">vi</span> <span class="o">&lt;</span> <span class="nx">expandedValue</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">vi</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">compactedValue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">_compactIri</span><span class="p">(</span>
              <span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">expandedValue</span><span class="p">[</span><span class="nx">vi</span><span class="p">],</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span><span class="nx">vocab</span><span class="o">:</span> <span class="kc">true</span><span class="p">}));</span>
          <span class="p">}</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-145"><td class="docs"><div class="pilwrap"><a href="#section-145" class="pilcrow">&#182;</a></div><p>use keyword alias and add value</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">alias</span> <span class="o">=</span> <span class="nx">_compactIri</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">expandedProperty</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">isArray</span> <span class="o">=</span> <span class="p">(</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">compactedValue</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">expandedValue</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">);</span>
        <span class="nx">jsonld</span><span class="p">.</span><span class="nx">addValue</span><span class="p">(</span>
          <span class="nx">rval</span><span class="p">,</span> <span class="nx">alias</span><span class="p">,</span> <span class="nx">compactedValue</span><span class="p">,</span> <span class="p">{</span><span class="nx">propertyIsArray</span><span class="o">:</span> <span class="nx">isArray</span><span class="p">});</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-146"><td class="docs"><div class="pilwrap"><a href="#section-146" class="pilcrow">&#182;</a></div><p>handle @reverse</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">expandedProperty</span> <span class="o">===</span> <span class="s1">&#39;@reverse&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-147"><td class="docs"><div class="pilwrap"><a href="#section-147" class="pilcrow">&#182;</a></div><p>recursively compact expanded value</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">compactedValue</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">compact</span><span class="p">(</span>
          <span class="nx">activeCtx</span><span class="p">,</span> <span class="s1">&#39;@reverse&#39;</span><span class="p">,</span> <span class="nx">expandedValue</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span></pre></div></td></tr><tr id="section-148"><td class="docs"><div class="pilwrap"><a href="#section-148" class="pilcrow">&#182;</a></div><p>handle double-reversed properties</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">compactedProperty</span> <span class="k">in</span> <span class="nx">compactedValue</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">.</span><span class="nx">mappings</span><span class="p">[</span><span class="nx">compactedProperty</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
            <span class="nx">activeCtx</span><span class="p">.</span><span class="nx">mappings</span><span class="p">[</span><span class="nx">compactedProperty</span><span class="p">].</span><span class="nx">reverse</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">compactedProperty</span> <span class="k">in</span> <span class="nx">rval</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">compactArrays</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">rval</span><span class="p">[</span><span class="nx">compactedProperty</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="p">}</span>
            <span class="nx">jsonld</span><span class="p">.</span><span class="nx">addValue</span><span class="p">(</span>
              <span class="nx">rval</span><span class="p">,</span> <span class="nx">compactedProperty</span><span class="p">,</span> <span class="nx">compactedValue</span><span class="p">[</span><span class="nx">compactedProperty</span><span class="p">]);</span>
            <span class="k">delete</span> <span class="nx">compactedValue</span><span class="p">[</span><span class="nx">compactedProperty</span><span class="p">];</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">compactedValue</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-149"><td class="docs"><div class="pilwrap"><a href="#section-149" class="pilcrow">&#182;</a></div><p>use keyword alias and add value</p>
</td><td class="code"><div class="highlight"><pre>          <span class="kd">var</span> <span class="nx">alias</span> <span class="o">=</span> <span class="nx">_compactIri</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">expandedProperty</span><span class="p">);</span>
          <span class="nx">jsonld</span><span class="p">.</span><span class="nx">addValue</span><span class="p">(</span><span class="nx">rval</span><span class="p">,</span> <span class="nx">alias</span><span class="p">,</span> <span class="nx">compactedValue</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-150"><td class="docs"><div class="pilwrap"><a href="#section-150" class="pilcrow">&#182;</a></div><p>handle @index property</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">expandedProperty</span> <span class="o">===</span> <span class="s1">&#39;@index&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-151"><td class="docs"><div class="pilwrap"><a href="#section-151" class="pilcrow">&#182;</a></div><p>drop @index if inside an @index container</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">container</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">getContextValue</span><span class="p">(</span>
          <span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">activeProperty</span><span class="p">,</span> <span class="s1">&#39;@container&#39;</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">container</span> <span class="o">===</span> <span class="s1">&#39;@index&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-152"><td class="docs"><div class="pilwrap"><a href="#section-152" class="pilcrow">&#182;</a></div><p>use keyword alias and add value</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">alias</span> <span class="o">=</span> <span class="nx">_compactIri</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">expandedProperty</span><span class="p">);</span>
        <span class="nx">jsonld</span><span class="p">.</span><span class="nx">addValue</span><span class="p">(</span><span class="nx">rval</span><span class="p">,</span> <span class="nx">alias</span><span class="p">,</span> <span class="nx">expandedValue</span><span class="p">);</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-153"><td class="docs"><div class="pilwrap"><a href="#section-153" class="pilcrow">&#182;</a></div><p>Note: expanded value must be an array due to expansion algorithm.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-154"><td class="docs"><div class="pilwrap"><a href="#section-154" class="pilcrow">&#182;</a></div><p>preserve empty arrays</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">expandedValue</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">itemActiveProperty</span> <span class="o">=</span> <span class="nx">_compactIri</span><span class="p">(</span>
          <span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">expandedProperty</span><span class="p">,</span> <span class="nx">expandedValue</span><span class="p">,</span> <span class="p">{</span><span class="nx">vocab</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span>
          <span class="nx">insideReverse</span><span class="p">);</span>
        <span class="nx">jsonld</span><span class="p">.</span><span class="nx">addValue</span><span class="p">(</span>
          <span class="nx">rval</span><span class="p">,</span> <span class="nx">itemActiveProperty</span><span class="p">,</span> <span class="nx">expandedValue</span><span class="p">,</span> <span class="p">{</span><span class="nx">propertyIsArray</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-155"><td class="docs"><div class="pilwrap"><a href="#section-155" class="pilcrow">&#182;</a></div><p>recusively process array values</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">vi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">vi</span> <span class="o">&lt;</span> <span class="nx">expandedValue</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">vi</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">expandedItem</span> <span class="o">=</span> <span class="nx">expandedValue</span><span class="p">[</span><span class="nx">vi</span><span class="p">];</span></pre></div></td></tr><tr id="section-156"><td class="docs"><div class="pilwrap"><a href="#section-156" class="pilcrow">&#182;</a></div><p>compact property and get container type</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">itemActiveProperty</span> <span class="o">=</span> <span class="nx">_compactIri</span><span class="p">(</span>
          <span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">expandedProperty</span><span class="p">,</span> <span class="nx">expandedItem</span><span class="p">,</span> <span class="p">{</span><span class="nx">vocab</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span>
          <span class="nx">insideReverse</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">container</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">getContextValue</span><span class="p">(</span>
          <span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">itemActiveProperty</span><span class="p">,</span> <span class="s1">&#39;@container&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-157"><td class="docs"><div class="pilwrap"><a href="#section-157" class="pilcrow">&#182;</a></div><p>get @list value if appropriate</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">isList</span> <span class="o">=</span> <span class="nx">_isList</span><span class="p">(</span><span class="nx">expandedItem</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">isList</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">list</span> <span class="o">=</span> <span class="nx">expandedItem</span><span class="p">[</span><span class="s1">&#39;@list&#39;</span><span class="p">];</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-158"><td class="docs"><div class="pilwrap"><a href="#section-158" class="pilcrow">&#182;</a></div><p>recursively compact expanded item</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">compactedItem</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">compact</span><span class="p">(</span>
          <span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">itemActiveProperty</span><span class="p">,</span> <span class="nx">isList</span> <span class="o">?</span> <span class="nx">list</span> <span class="o">:</span> <span class="nx">expandedItem</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span></pre></div></td></tr><tr id="section-159"><td class="docs"><div class="pilwrap"><a href="#section-159" class="pilcrow">&#182;</a></div><p>handle @list</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">isList</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-160"><td class="docs"><div class="pilwrap"><a href="#section-160" class="pilcrow">&#182;</a></div><p>ensure @list value is an array</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">compactedItem</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">compactedItem</span> <span class="o">=</span> <span class="p">[</span><span class="nx">compactedItem</span><span class="p">];</span>
          <span class="p">}</span>

          <span class="k">if</span><span class="p">(</span><span class="nx">container</span> <span class="o">!==</span> <span class="s1">&#39;@list&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-161"><td class="docs"><div class="pilwrap"><a href="#section-161" class="pilcrow">&#182;</a></div><p>wrap using @list alias</p>
</td><td class="code"><div class="highlight"><pre>            <span class="kd">var</span> <span class="nx">wrapper</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="nx">wrapper</span><span class="p">[</span><span class="nx">_compactIri</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="s1">&#39;@list&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">compactedItem</span><span class="p">;</span>
            <span class="nx">compactedItem</span> <span class="o">=</span> <span class="nx">wrapper</span><span class="p">;</span></pre></div></td></tr><tr id="section-162"><td class="docs"><div class="pilwrap"><a href="#section-162" class="pilcrow">&#182;</a></div><p>include @index from expanded @list, if any</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@index&#39;</span> <span class="k">in</span> <span class="nx">expandedItem</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">compactedItem</span><span class="p">[</span><span class="nx">_compactIri</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="s1">&#39;@index&#39;</span><span class="p">)]</span> <span class="o">=</span>
                <span class="nx">expandedItem</span><span class="p">[</span><span class="s1">&#39;@index&#39;</span><span class="p">];</span>
            <span class="p">}</span>
          <span class="p">}</span></pre></div></td></tr><tr id="section-163"><td class="docs"><div class="pilwrap"><a href="#section-163" class="pilcrow">&#182;</a></div><p>can't use @list container for more than 1 list</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">itemActiveProperty</span> <span class="k">in</span> <span class="nx">rval</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
              <span class="s1">&#39;JSON-LD compact error; property has a &quot;@list&quot; @container &#39;</span> <span class="o">+</span>
              <span class="s1">&#39;rule but there is more than a single @list that matches &#39;</span> <span class="o">+</span>
              <span class="s1">&#39;the compacted term in the document. Compaction might mix &#39;</span> <span class="o">+</span>
              <span class="s1">&#39;unwanted items into the list.&#39;</span><span class="p">,</span>
              <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-164"><td class="docs"><div class="pilwrap"><a href="#section-164" class="pilcrow">&#182;</a></div><p>handle language and index maps</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">container</span> <span class="o">===</span> <span class="s1">&#39;@language&#39;</span> <span class="o">||</span> <span class="nx">container</span> <span class="o">===</span> <span class="s1">&#39;@index&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-165"><td class="docs"><div class="pilwrap"><a href="#section-165" class="pilcrow">&#182;</a></div><p>get or create the map object</p>
</td><td class="code"><div class="highlight"><pre>          <span class="kd">var</span> <span class="nx">mapObject</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">itemActiveProperty</span> <span class="k">in</span> <span class="nx">rval</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">mapObject</span> <span class="o">=</span> <span class="nx">rval</span><span class="p">[</span><span class="nx">itemActiveProperty</span><span class="p">];</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span>
            <span class="nx">rval</span><span class="p">[</span><span class="nx">itemActiveProperty</span><span class="p">]</span> <span class="o">=</span> <span class="nx">mapObject</span> <span class="o">=</span> <span class="p">{};</span>
          <span class="p">}</span></pre></div></td></tr><tr id="section-166"><td class="docs"><div class="pilwrap"><a href="#section-166" class="pilcrow">&#182;</a></div><p>if container is a language map, simplify compacted value to
a simple string</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">if</span><span class="p">(</span><span class="nx">container</span> <span class="o">===</span> <span class="s1">&#39;@language&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">_isValue</span><span class="p">(</span><span class="nx">compactedItem</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">compactedItem</span> <span class="o">=</span> <span class="nx">compactedItem</span><span class="p">[</span><span class="s1">&#39;@value&#39;</span><span class="p">];</span>
          <span class="p">}</span></pre></div></td></tr><tr id="section-167"><td class="docs"><div class="pilwrap"><a href="#section-167" class="pilcrow">&#182;</a></div><p>add compact value to map object using key from expanded value
based on the container type</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">jsonld</span><span class="p">.</span><span class="nx">addValue</span><span class="p">(</span><span class="nx">mapObject</span><span class="p">,</span> <span class="nx">expandedItem</span><span class="p">[</span><span class="nx">container</span><span class="p">],</span> <span class="nx">compactedItem</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-168"><td class="docs"><div class="pilwrap"><a href="#section-168" class="pilcrow">&#182;</a></div><p>use an array if: compactArrays flag is false,
@container is @set or @list , value is an empty
array, or key is @graph</p>
</td><td class="code"><div class="highlight"><pre>          <span class="kd">var</span> <span class="nx">isArray</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">compactArrays</span> <span class="o">||</span> <span class="nx">container</span> <span class="o">===</span> <span class="s1">&#39;@set&#39;</span> <span class="o">||</span>
            <span class="nx">container</span> <span class="o">===</span> <span class="s1">&#39;@list&#39;</span> <span class="o">||</span>
            <span class="p">(</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">compactedItem</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">compactedItem</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
            <span class="nx">expandedProperty</span> <span class="o">===</span> <span class="s1">&#39;@list&#39;</span> <span class="o">||</span> <span class="nx">expandedProperty</span> <span class="o">===</span> <span class="s1">&#39;@graph&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-169"><td class="docs"><div class="pilwrap"><a href="#section-169" class="pilcrow">&#182;</a></div><p>add compact value</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">jsonld</span><span class="p">.</span><span class="nx">addValue</span><span class="p">(</span>
            <span class="nx">rval</span><span class="p">,</span> <span class="nx">itemActiveProperty</span><span class="p">,</span> <span class="nx">compactedItem</span><span class="p">,</span>
            <span class="p">{</span><span class="nx">propertyIsArray</span><span class="o">:</span> <span class="nx">isArray</span><span class="p">});</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-170"><td class="docs"><div class="pilwrap"><a href="#section-170" class="pilcrow">&#182;</a></div><p>only primitives remain which are already compact</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-171"><td class="docs"><div class="pilwrap"><a href="#section-171" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Recursively expands an element using the given context. Any context in<br />the element will be removed. All context URLs must have been retrieved<br />before calling this method.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">activeCtx</span><span>- context to use.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">activeProperty</span><span>- property for the element, null for none.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">element</span><span>- element to expand.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">options</span><span>- expansion options.</span></div><div class="dox_tag_detail"><span>true </span><span class="dox_type">insideList</span><span>- if the element is a list, false if not.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>expanded value.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Processor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">expand</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span>
  <span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">activeProperty</span><span class="p">,</span> <span class="nx">element</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">insideList</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">element</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
      <span class="s1">&#39;Invalid JSON-LD syntax; undefined element.&#39;</span><span class="p">,</span>
      <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">);</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-172"><td class="docs"><div class="pilwrap"><a href="#section-172" class="pilcrow">&#182;</a></div><p>nothing to expand</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">element</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-173"><td class="docs"><div class="pilwrap"><a href="#section-173" class="pilcrow">&#182;</a></div><p>recursively expand array</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">element</span><span class="p">))</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">element</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-174"><td class="docs"><div class="pilwrap"><a href="#section-174" class="pilcrow">&#182;</a></div><p>expand element</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">expand</span><span class="p">(</span>
        <span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">activeProperty</span><span class="p">,</span> <span class="nx">element</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">insideList</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">insideList</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">||</span> <span class="nx">_isList</span><span class="p">(</span><span class="nx">e</span><span class="p">)))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-175"><td class="docs"><div class="pilwrap"><a href="#section-175" class="pilcrow">&#182;</a></div><p>lists of lists are illegal</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
          <span class="s1">&#39;Invalid JSON-LD syntax; lists of lists are not permitted.&#39;</span><span class="p">,</span>
          <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">);</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-176"><td class="docs"><div class="pilwrap"><a href="#section-176" class="pilcrow">&#182;</a></div><p>drop null values</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">e</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">e</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">rval</span> <span class="o">=</span> <span class="nx">rval</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">rval</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-177"><td class="docs"><div class="pilwrap"><a href="#section-177" class="pilcrow">&#182;</a></div><p>recursively expand object</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">element</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-178"><td class="docs"><div class="pilwrap"><a href="#section-178" class="pilcrow">&#182;</a></div><p>if element has a context, process it</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@context&#39;</span> <span class="k">in</span> <span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">activeCtx</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">processContext</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">element</span><span class="p">[</span><span class="s1">&#39;@context&#39;</span><span class="p">],</span> <span class="nx">options</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-179"><td class="docs"><div class="pilwrap"><a href="#section-179" class="pilcrow">&#182;</a></div><p>expand the active property</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">expandedActiveProperty</span> <span class="o">=</span> <span class="nx">_expandIri</span><span class="p">(</span>
      <span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">activeProperty</span><span class="p">,</span> <span class="p">{</span><span class="nx">vocab</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>

    <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">sort</span><span class="p">();</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">ki</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ki</span> <span class="o">&lt;</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">ki</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">[</span><span class="nx">ki</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">element</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">expandedValue</span><span class="p">;</span></pre></div></td></tr><tr id="section-180"><td class="docs"><div class="pilwrap"><a href="#section-180" class="pilcrow">&#182;</a></div><p>skip @context</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">key</span> <span class="o">===</span> <span class="s1">&#39;@context&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-181"><td class="docs"><div class="pilwrap"><a href="#section-181" class="pilcrow">&#182;</a></div><p>expand key to IRI</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">expandedProperty</span> <span class="o">=</span> <span class="nx">_expandIri</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="p">{</span><span class="nx">vocab</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span></pre></div></td></tr><tr id="section-182"><td class="docs"><div class="pilwrap"><a href="#section-182" class="pilcrow">&#182;</a></div><p>drop non-absolute IRI keys that aren't keywords</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">expandedProperty</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span>
        <span class="o">!</span><span class="p">(</span><span class="nx">_isAbsoluteIri</span><span class="p">(</span><span class="nx">expandedProperty</span><span class="p">)</span> <span class="o">||</span> <span class="nx">_isKeyword</span><span class="p">(</span><span class="nx">expandedProperty</span><span class="p">)))</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">_isKeyword</span><span class="p">(</span><span class="nx">expandedProperty</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="nx">expandedActiveProperty</span> <span class="o">===</span> <span class="s1">&#39;@reverse&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
          <span class="s1">&#39;Invalid JSON-LD syntax; a keyword cannot be used as a @reverse &#39;</span> <span class="o">+</span>
          <span class="s1">&#39;property.&#39;</span><span class="p">,</span>
          <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="nx">value</span><span class="p">});</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-183"><td class="docs"><div class="pilwrap"><a href="#section-183" class="pilcrow">&#182;</a></div><p>syntax error if @id is not a string</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">expandedProperty</span> <span class="o">===</span> <span class="s1">&#39;@id&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_isString</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
          <span class="s1">&#39;Invalid JSON-LD syntax; &quot;@id&quot; value must a string.&#39;</span><span class="p">,</span>
          <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="nx">value</span><span class="p">});</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-184"><td class="docs"><div class="pilwrap"><a href="#section-184" class="pilcrow">&#182;</a></div><p>validate @type value</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">expandedProperty</span> <span class="o">===</span> <span class="s1">&#39;@type&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_validateTypeValue</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-185"><td class="docs"><div class="pilwrap"><a href="#section-185" class="pilcrow">&#182;</a></div><p>@graph must be an array or an object</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">expandedProperty</span> <span class="o">===</span> <span class="s1">&#39;@graph&#39;</span> <span class="o">&amp;&amp;</span>
        <span class="o">!</span><span class="p">(</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">||</span> <span class="nx">_isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">)))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
          <span class="s1">&#39;Invalid JSON-LD syntax; &quot;@value&quot; value must not be an &#39;</span> <span class="o">+</span>
          <span class="s1">&#39;object or an array.&#39;</span><span class="p">,</span>
          <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="nx">value</span><span class="p">});</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-186"><td class="docs"><div class="pilwrap"><a href="#section-186" class="pilcrow">&#182;</a></div><p>@value must not be an object or an array</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">expandedProperty</span> <span class="o">===</span> <span class="s1">&#39;@value&#39;</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">||</span> <span class="nx">_isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">)))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
          <span class="s1">&#39;Invalid JSON-LD syntax; &quot;@value&quot; value must not be an &#39;</span> <span class="o">+</span>
          <span class="s1">&#39;object or an array.&#39;</span><span class="p">,</span>
          <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="nx">value</span><span class="p">});</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-187"><td class="docs"><div class="pilwrap"><a href="#section-187" class="pilcrow">&#182;</a></div><p>@language must be a string</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">expandedProperty</span> <span class="o">===</span> <span class="s1">&#39;@language&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isString</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
            <span class="s1">&#39;Invalid JSON-LD syntax; &quot;@language&quot; value must be a string.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="nx">value</span><span class="p">});</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-188"><td class="docs"><div class="pilwrap"><a href="#section-188" class="pilcrow">&#182;</a></div><p>ensure language value is lowercase</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-189"><td class="docs"><div class="pilwrap"><a href="#section-189" class="pilcrow">&#182;</a></div><p>@index must be a string</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">expandedProperty</span> <span class="o">===</span> <span class="s1">&#39;@index&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isString</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
            <span class="s1">&#39;Invalid JSON-LD syntax; &quot;@index&quot; value must be a string.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="nx">value</span><span class="p">});</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-190"><td class="docs"><div class="pilwrap"><a href="#section-190" class="pilcrow">&#182;</a></div><p>@reverse must be an object</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">expandedProperty</span> <span class="o">===</span> <span class="s1">&#39;@reverse&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
            <span class="s1">&#39;Invalid JSON-LD syntax; &quot;@reverse&quot; value must be an object.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="nx">value</span><span class="p">});</span>
        <span class="p">}</span>

        <span class="nx">expandedValue</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">expand</span><span class="p">(</span>
          <span class="nx">activeCtx</span><span class="p">,</span> <span class="s1">&#39;@reverse&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">insideList</span><span class="p">);</span></pre></div></td></tr><tr id="section-191"><td class="docs"><div class="pilwrap"><a href="#section-191" class="pilcrow">&#182;</a></div><p>properties double-reversed</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@reverse&#39;</span> <span class="k">in</span> <span class="nx">expandedValue</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">property</span> <span class="k">in</span> <span class="nx">expandedValue</span><span class="p">[</span><span class="s1">&#39;@reverse&#39;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">jsonld</span><span class="p">.</span><span class="nx">addValue</span><span class="p">(</span>
              <span class="nx">rval</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">expandedValue</span><span class="p">[</span><span class="s1">&#39;@reverse&#39;</span><span class="p">][</span><span class="nx">property</span><span class="p">],</span>
              <span class="p">{</span><span class="nx">propertyIsArray</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
          <span class="p">}</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-192"><td class="docs"><div class="pilwrap"><a href="#section-192" class="pilcrow">&#182;</a></div><p>FIXME: can this be merged with code below to simplify?
merge in all reversed properties</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">reverseMap</span> <span class="o">=</span> <span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@reverse&#39;</span><span class="p">]</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">property</span> <span class="k">in</span> <span class="nx">expandedValue</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">property</span> <span class="o">===</span> <span class="s1">&#39;@reverse&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">reverseMap</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">reverseMap</span> <span class="o">=</span> <span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@reverse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
          <span class="p">}</span>
          <span class="nx">jsonld</span><span class="p">.</span><span class="nx">addValue</span><span class="p">(</span><span class="nx">reverseMap</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="p">[],</span> <span class="p">{</span><span class="nx">propertyIsArray</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
          <span class="kd">var</span> <span class="nx">items</span> <span class="o">=</span> <span class="nx">expandedValue</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
          <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ii</span> <span class="o">&lt;</span> <span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">ii</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">items</span><span class="p">[</span><span class="nx">ii</span><span class="p">];</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">_isValue</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="o">||</span> <span class="nx">_isList</span><span class="p">(</span><span class="nx">item</span><span class="p">))</span> <span class="p">{</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid JSON-LD syntax; &quot;@reverse&quot; value must not be a &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;@value or an @list.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="nx">expandedValue</span><span class="p">});</span>
            <span class="p">}</span>
            <span class="nx">jsonld</span><span class="p">.</span><span class="nx">addValue</span><span class="p">(</span>
              <span class="nx">reverseMap</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="p">{</span><span class="nx">propertyIsArray</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">container</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">getContextValue</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="s1">&#39;@container&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-193"><td class="docs"><div class="pilwrap"><a href="#section-193" class="pilcrow">&#182;</a></div><p>handle language map container (skip if value is not an object)</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">container</span> <span class="o">===</span> <span class="s1">&#39;@language&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">_isObject</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">expandedValue</span> <span class="o">=</span> <span class="nx">_expandLanguageMap</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-194"><td class="docs"><div class="pilwrap"><a href="#section-194" class="pilcrow">&#182;</a></div><p>handle index container (skip if value is not an object)</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">container</span> <span class="o">===</span> <span class="s1">&#39;@index&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">_isObject</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">expandedValue</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="nx">_expandIndexMap</span><span class="p">(</span><span class="nx">activeProperty</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">value</span><span class="p">).</span><span class="nx">sort</span><span class="p">();</span>
          <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">ki</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ki</span> <span class="o">&lt;</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">ki</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">[</span><span class="nx">ki</span><span class="p">];</span>
            <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">val</span><span class="p">))</span> <span class="p">{</span>
              <span class="nx">val</span> <span class="o">=</span> <span class="p">[</span><span class="nx">val</span><span class="p">];</span>
            <span class="p">}</span>
            <span class="nx">val</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">expand</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">activeProperty</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
            <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">vi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">vi</span> <span class="o">&lt;</span> <span class="nx">val</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">vi</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">val</span><span class="p">[</span><span class="nx">vi</span><span class="p">];</span>
              <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;@index&#39;</span> <span class="k">in</span> <span class="nx">item</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">item</span><span class="p">[</span><span class="s1">&#39;@index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
              <span class="p">}</span>
              <span class="nx">rval</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
        <span class="p">})(</span><span class="nx">key</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-195"><td class="docs"><div class="pilwrap"><a href="#section-195" class="pilcrow">&#182;</a></div><p>recurse into @list or @set</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">isList</span> <span class="o">=</span> <span class="p">(</span><span class="nx">expandedProperty</span> <span class="o">===</span> <span class="s1">&#39;@list&#39;</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">isList</span> <span class="o">||</span> <span class="nx">expandedProperty</span> <span class="o">===</span> <span class="s1">&#39;@set&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">nextActiveProperty</span> <span class="o">=</span> <span class="nx">activeProperty</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">isList</span> <span class="o">&amp;&amp;</span> <span class="nx">expandedActiveProperty</span> <span class="o">===</span> <span class="s1">&#39;@graph&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">nextActiveProperty</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">expandedValue</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">expand</span><span class="p">(</span>
            <span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">nextActiveProperty</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">isList</span><span class="p">);</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">isList</span> <span class="o">&amp;&amp;</span> <span class="nx">_isList</span><span class="p">(</span><span class="nx">expandedValue</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
              <span class="s1">&#39;Invalid JSON-LD syntax; lists of lists are not permitted.&#39;</span><span class="p">,</span>
              <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-196"><td class="docs"><div class="pilwrap"><a href="#section-196" class="pilcrow">&#182;</a></div><p>recursively expand value with key as new active property</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">expandedValue</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">expand</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-197"><td class="docs"><div class="pilwrap"><a href="#section-197" class="pilcrow">&#182;</a></div><p>drop null values if property is not @value</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">expandedValue</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">expandedProperty</span> <span class="o">!==</span> <span class="s1">&#39;@value&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-198"><td class="docs"><div class="pilwrap"><a href="#section-198" class="pilcrow">&#182;</a></div><p>convert expanded value to @list if container specifies it</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">expandedProperty</span> <span class="o">!==</span> <span class="s1">&#39;@list&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_isList</span><span class="p">(</span><span class="nx">expandedValue</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="nx">container</span> <span class="o">===</span> <span class="s1">&#39;@list&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-199"><td class="docs"><div class="pilwrap"><a href="#section-199" class="pilcrow">&#182;</a></div><p>ensure expanded value is an array</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">expandedValue</span> <span class="o">=</span> <span class="p">(</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">expandedValue</span><span class="p">)</span> <span class="o">?</span>
          <span class="nx">expandedValue</span> <span class="o">:</span> <span class="p">[</span><span class="nx">expandedValue</span><span class="p">]);</span>
        <span class="nx">expandedValue</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@list&#39;</span><span class="o">:</span> <span class="nx">expandedValue</span><span class="p">};</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-200"><td class="docs"><div class="pilwrap"><a href="#section-200" class="pilcrow">&#182;</a></div><p>FIXME: can this be merged with code above to simplify?
merge in reverse properties</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">.</span><span class="nx">mappings</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">activeCtx</span><span class="p">.</span><span class="nx">mappings</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">reverse</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">reverseMap</span> <span class="o">=</span> <span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@reverse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">expandedValue</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">expandedValue</span> <span class="o">=</span> <span class="p">[</span><span class="nx">expandedValue</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ii</span> <span class="o">&lt;</span> <span class="nx">expandedValue</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">ii</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">expandedValue</span><span class="p">[</span><span class="nx">ii</span><span class="p">];</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">_isValue</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="o">||</span> <span class="nx">_isList</span><span class="p">(</span><span class="nx">item</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
              <span class="s1">&#39;Invalid JSON-LD syntax; &quot;@reverse&quot; value must not be a &#39;</span> <span class="o">+</span>
              <span class="s1">&#39;@value or an @list.&#39;</span><span class="p">,</span>
              <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="nx">expandedValue</span><span class="p">});</span>
          <span class="p">}</span>
          <span class="nx">jsonld</span><span class="p">.</span><span class="nx">addValue</span><span class="p">(</span>
            <span class="nx">reverseMap</span><span class="p">,</span> <span class="nx">expandedProperty</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="p">{</span><span class="nx">propertyIsArray</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
        <span class="p">}</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-201"><td class="docs"><div class="pilwrap"><a href="#section-201" class="pilcrow">&#182;</a></div><p>add value for property
use an array except for certain keywords</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">useArray</span> <span class="o">=</span>
        <span class="p">[</span><span class="s1">&#39;@index&#39;</span><span class="p">,</span> <span class="s1">&#39;@id&#39;</span><span class="p">,</span> <span class="s1">&#39;@type&#39;</span><span class="p">,</span> <span class="s1">&#39;@value&#39;</span><span class="p">,</span> <span class="s1">&#39;@language&#39;</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span>
          <span class="nx">expandedProperty</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="nx">jsonld</span><span class="p">.</span><span class="nx">addValue</span><span class="p">(</span>
        <span class="nx">rval</span><span class="p">,</span> <span class="nx">expandedProperty</span><span class="p">,</span> <span class="nx">expandedValue</span><span class="p">,</span> <span class="p">{</span><span class="nx">propertyIsArray</span><span class="o">:</span> <span class="nx">useArray</span><span class="p">});</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-202"><td class="docs"><div class="pilwrap"><a href="#section-202" class="pilcrow">&#182;</a></div><p>get property count on expanded output</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">rval</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@value&#39;</span> <span class="k">in</span> <span class="nx">rval</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-203"><td class="docs"><div class="pilwrap"><a href="#section-203" class="pilcrow">&#182;</a></div><p>@value must only have @language or @type</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@type&#39;</span> <span class="k">in</span> <span class="nx">rval</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;@language&#39;</span> <span class="k">in</span> <span class="nx">rval</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
          <span class="s1">&#39;Invalid JSON-LD syntax; an element containing &quot;@value&quot; may not &#39;</span> <span class="o">+</span>
          <span class="s1">&#39;contain both &quot;@type&quot; and &quot;@language&quot;.&#39;</span><span class="p">,</span>
          <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">element</span><span class="o">:</span> <span class="nx">rval</span><span class="p">});</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">validCount</span> <span class="o">=</span> <span class="nx">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@type&#39;</span> <span class="k">in</span> <span class="nx">rval</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">validCount</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@index&#39;</span> <span class="k">in</span> <span class="nx">rval</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">validCount</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@language&#39;</span> <span class="k">in</span> <span class="nx">rval</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">validCount</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">validCount</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
          <span class="s1">&#39;Invalid JSON-LD syntax; an element containing &quot;@value&quot; may only &#39;</span> <span class="o">+</span>
          <span class="s1">&#39;have an &quot;@index&quot; property and at most one other property &#39;</span> <span class="o">+</span>
          <span class="s1">&#39;which can be &quot;@type&quot; or &quot;@language&quot;.&#39;</span><span class="p">,</span>
          <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">element</span><span class="o">:</span> <span class="nx">rval</span><span class="p">});</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-204"><td class="docs"><div class="pilwrap"><a href="#section-204" class="pilcrow">&#182;</a></div><p>drop null @values</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@value&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">rval</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-205"><td class="docs"><div class="pilwrap"><a href="#section-205" class="pilcrow">&#182;</a></div><p>drop @language if @value isn't a string</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@language&#39;</span> <span class="k">in</span> <span class="nx">rval</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_isString</span><span class="p">(</span><span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@value&#39;</span><span class="p">]))</span> <span class="p">{</span>
        <span class="k">delete</span> <span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@language&#39;</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-206"><td class="docs"><div class="pilwrap"><a href="#section-206" class="pilcrow">&#182;</a></div><p>convert @type to an array</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@type&#39;</span> <span class="k">in</span> <span class="nx">rval</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">]))</span> <span class="p">{</span>
      <span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">]];</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-207"><td class="docs"><div class="pilwrap"><a href="#section-207" class="pilcrow">&#182;</a></div><p>handle @set and @list</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@set&#39;</span> <span class="k">in</span> <span class="nx">rval</span> <span class="o">||</span> <span class="s1">&#39;@list&#39;</span> <span class="k">in</span> <span class="nx">rval</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">count</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">count</span> <span class="o">!==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;@index&#39;</span> <span class="k">in</span> <span class="nx">rval</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
          <span class="s1">&#39;Invalid JSON-LD syntax; if an element has the property &quot;@set&quot; &#39;</span> <span class="o">+</span>
          <span class="s1">&#39;or &quot;@list&quot;, then it can have at most one other property that is &#39;</span> <span class="o">+</span>
          <span class="s1">&#39;&quot;@index&quot;.&#39;</span><span class="p">,</span>
          <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">element</span><span class="o">:</span> <span class="nx">rval</span><span class="p">});</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-208"><td class="docs"><div class="pilwrap"><a href="#section-208" class="pilcrow">&#182;</a></div><p>optimize away @set</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@set&#39;</span> <span class="k">in</span> <span class="nx">rval</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">rval</span> <span class="o">=</span> <span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@set&#39;</span><span class="p">];</span>
        <span class="nx">keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">rval</span><span class="p">);</span>
        <span class="nx">count</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-209"><td class="docs"><div class="pilwrap"><a href="#section-209" class="pilcrow">&#182;</a></div><p>drop objects with only @language</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">count</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;@language&#39;</span> <span class="k">in</span> <span class="nx">rval</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">rval</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-210"><td class="docs"><div class="pilwrap"><a href="#section-210" class="pilcrow">&#182;</a></div><p>drop certain top-level objects that do not occur in lists</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">rval</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">keepFreeFloatingNodes</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">insideList</span> <span class="o">&amp;&amp;</span>
      <span class="p">(</span><span class="nx">activeProperty</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">expandedActiveProperty</span> <span class="o">===</span> <span class="s1">&#39;@graph&#39;</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-211"><td class="docs"><div class="pilwrap"><a href="#section-211" class="pilcrow">&#182;</a></div><p>drop empty object or top-level @value</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">count</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="s1">&#39;@value&#39;</span> <span class="k">in</span> <span class="nx">rval</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">rval</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-212"><td class="docs"><div class="pilwrap"><a href="#section-212" class="pilcrow">&#182;</a></div><p>drop nodes that generate no triples</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">hasTriples</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">ignore</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;@graph&#39;</span><span class="p">,</span> <span class="s1">&#39;@type&#39;</span><span class="p">];</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">ki</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="nx">hasTriples</span> <span class="o">&amp;&amp;</span> <span class="nx">ki</span> <span class="o">&lt;</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">ki</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isKeyword</span><span class="p">(</span><span class="nx">keys</span><span class="p">[</span><span class="nx">ki</span><span class="p">])</span> <span class="o">||</span> <span class="nx">ignore</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">keys</span><span class="p">[</span><span class="nx">ki</span><span class="p">])</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">hasTriples</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">hasTriples</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">rval</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-213"><td class="docs"><div class="pilwrap"><a href="#section-213" class="pilcrow">&#182;</a></div><p>drop top-level scalars that are not in lists</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">insideList</span> <span class="o">&amp;&amp;</span>
    <span class="p">(</span><span class="nx">activeProperty</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span>
    <span class="nx">_expandIri</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">activeProperty</span><span class="p">,</span> <span class="p">{</span><span class="nx">vocab</span><span class="o">:</span> <span class="kc">true</span><span class="p">})</span> <span class="o">===</span> <span class="s1">&#39;@graph&#39;</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-214"><td class="docs"><div class="pilwrap"><a href="#section-214" class="pilcrow">&#182;</a></div><p>expand element according to value expansion rules</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">return</span> <span class="nx">_expandValue</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">activeProperty</span><span class="p">,</span> <span class="nx">element</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-215"><td class="docs"><div class="pilwrap"><a href="#section-215" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Performs JSON-LD flattening.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">input</span><span>- expanded JSON-LD to flatten.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>flattened output.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Processor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">flatten</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-216"><td class="docs"><div class="pilwrap"><a href="#section-216" class="pilcrow">&#182;</a></div><p>produce a map of all subjects and name each bnode</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">namer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UniqueNamer</span><span class="p">(</span><span class="s1">&#39;_:b&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">graphs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@default&#39;</span><span class="o">:</span> <span class="p">{}};</span>
  <span class="nx">_createNodeMap</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">graphs</span><span class="p">,</span> <span class="s1">&#39;@default&#39;</span><span class="p">,</span> <span class="nx">namer</span><span class="p">);</span></pre></div></td></tr><tr id="section-217"><td class="docs"><div class="pilwrap"><a href="#section-217" class="pilcrow">&#182;</a></div><p>add all non-default graphs to default graph</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">defaultGraph</span> <span class="o">=</span> <span class="nx">graphs</span><span class="p">[</span><span class="s1">&#39;@default&#39;</span><span class="p">];</span>
  <span class="kd">var</span> <span class="nx">graphNames</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">graphs</span><span class="p">).</span><span class="nx">sort</span><span class="p">();</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">graphNames</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">graphName</span> <span class="o">=</span> <span class="nx">graphNames</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">graphName</span> <span class="o">===</span> <span class="s1">&#39;@default&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">nodeMap</span> <span class="o">=</span> <span class="nx">graphs</span><span class="p">[</span><span class="nx">graphName</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">subject</span> <span class="o">=</span> <span class="nx">defaultGraph</span><span class="p">[</span><span class="nx">graphName</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">subject</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">defaultGraph</span><span class="p">[</span><span class="nx">graphName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">subject</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;@id&#39;</span><span class="o">:</span> <span class="nx">graphName</span><span class="p">,</span>
        <span class="s1">&#39;@graph&#39;</span><span class="o">:</span> <span class="p">[]</span>
      <span class="p">};</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;@graph&#39;</span> <span class="k">in</span> <span class="nx">subject</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">subject</span><span class="p">[</span><span class="s1">&#39;@graph&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">graph</span> <span class="o">=</span> <span class="nx">subject</span><span class="p">[</span><span class="s1">&#39;@graph&#39;</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">ids</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">nodeMap</span><span class="p">).</span><span class="nx">sort</span><span class="p">();</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ii</span> <span class="o">&lt;</span> <span class="nx">ids</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">ii</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">ids</span><span class="p">[</span><span class="nx">ii</span><span class="p">];</span>
      <span class="nx">graph</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">nodeMap</span><span class="p">[</span><span class="nx">id</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-218"><td class="docs"><div class="pilwrap"><a href="#section-218" class="pilcrow">&#182;</a></div><p>produce flattened output</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">flattened</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">defaultGraph</span><span class="p">).</span><span class="nx">sort</span><span class="p">();</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">ki</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ki</span> <span class="o">&lt;</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">ki</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">[</span><span class="nx">ki</span><span class="p">];</span>
    <span class="nx">flattened</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">defaultGraph</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">flattened</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-219"><td class="docs"><div class="pilwrap"><a href="#section-219" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Performs JSON-LD framing.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">input</span><span>- expanded JSON-LD to frame.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">frame</span><span>- expanded JSON-LD frame to use.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">options</span><span>- framing options.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>framed output.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Processor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">frame</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">frame</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-220"><td class="docs"><div class="pilwrap"><a href="#section-220" class="pilcrow">&#182;</a></div><p>create framing state</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">options</span><span class="o">:</span> <span class="nx">options</span><span class="p">,</span>
    <span class="nx">graphs</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;@default&#39;</span><span class="o">:</span> <span class="p">{},</span> <span class="s1">&#39;@merged&#39;</span><span class="o">:</span> <span class="p">{}}</span>
  <span class="p">};</span></pre></div></td></tr><tr id="section-221"><td class="docs"><div class="pilwrap"><a href="#section-221" class="pilcrow">&#182;</a></div><p>produce a map of all graphs and name each bnode
FIXME: currently uses subjects from @merged graph only</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">namer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UniqueNamer</span><span class="p">(</span><span class="s1">&#39;_:b&#39;</span><span class="p">);</span>
  <span class="nx">_createNodeMap</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">graphs</span><span class="p">,</span> <span class="s1">&#39;@merged&#39;</span><span class="p">,</span> <span class="nx">namer</span><span class="p">);</span>
  <span class="nx">state</span><span class="p">.</span><span class="nx">subjects</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">graphs</span><span class="p">[</span><span class="s1">&#39;@merged&#39;</span><span class="p">];</span></pre></div></td></tr><tr id="section-222"><td class="docs"><div class="pilwrap"><a href="#section-222" class="pilcrow">&#182;</a></div><p>frame the subjects</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">framed</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="nx">_frame</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">subjects</span><span class="p">).</span><span class="nx">sort</span><span class="p">(),</span> <span class="nx">frame</span><span class="p">,</span> <span class="nx">framed</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">framed</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-223"><td class="docs"><div class="pilwrap"><a href="#section-223" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Performs normalization on the given RDF dataset.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">dataset</span><span>- RDF dataset to normalize.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">options</span><span>- normalization options.</span></div><div class="dox_tag_detail"><span>normalized) </span><span class="dox_type">callback(err</span><span class="dox_type"></span><span>- called once the operation completes.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Processor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">normalize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dataset</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-224"><td class="docs"><div class="pilwrap"><a href="#section-224" class="pilcrow">&#182;</a></div><p>create quads and map bnodes to their associated quads</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">quads</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">var</span> <span class="nx">bnodes</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">graphName</span> <span class="k">in</span> <span class="nx">dataset</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">triples</span> <span class="o">=</span> <span class="nx">dataset</span><span class="p">[</span><span class="nx">graphName</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">graphName</span> <span class="o">===</span> <span class="s1">&#39;@default&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">graphName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">ti</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ti</span> <span class="o">&lt;</span> <span class="nx">triples</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">ti</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">quad</span> <span class="o">=</span> <span class="nx">triples</span><span class="p">[</span><span class="nx">ti</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">graphName</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">graphName</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;_:&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">quad</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;blank node&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">graphName</span><span class="p">};</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">quad</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;IRI&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">graphName</span><span class="p">};</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">quads</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">quad</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="s1">&#39;object&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">];</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">ai</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ai</span> <span class="o">&lt;</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">ai</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">attr</span> <span class="o">=</span> <span class="nx">attrs</span><span class="p">[</span><span class="nx">ai</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">quad</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">quad</span><span class="p">[</span><span class="nx">attr</span><span class="p">].</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;blank node&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">quad</span><span class="p">[</span><span class="nx">attr</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">id</span> <span class="k">in</span> <span class="nx">bnodes</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">bnodes</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">quads</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">quad</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span>
            <span class="nx">bnodes</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nx">quads</span><span class="o">:</span> <span class="p">[</span><span class="nx">quad</span><span class="p">]};</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-225"><td class="docs"><div class="pilwrap"><a href="#section-225" class="pilcrow">&#182;</a></div><p>mapping complete, start canonical naming</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">namer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UniqueNamer</span><span class="p">(</span><span class="s1">&#39;_:c14n&#39;</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">hashBlankNodes</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">bnodes</span><span class="p">));</span></pre></div></td></tr><tr id="section-226"><td class="docs"><div class="pilwrap"><a href="#section-226" class="pilcrow">&#182;</a></div><p>generates unique and duplicate hashes for bnodes</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">hashBlankNodes</span><span class="p">(</span><span class="nx">unnamed</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">nextUnnamed</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">duplicates</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">unique</span> <span class="o">=</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-227"><td class="docs"><div class="pilwrap"><a href="#section-227" class="pilcrow">&#182;</a></div><p>hash quads for each unnamed bnode</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">jsonld</span><span class="p">.</span><span class="nx">setImmediate</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">hashUnnamed</span><span class="p">(</span><span class="mi">0</span><span class="p">);});</span>
    <span class="kd">function</span> <span class="nx">hashUnnamed</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="nx">unnamed</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-228"><td class="docs"><div class="pilwrap"><a href="#section-228" class="pilcrow">&#182;</a></div><p>done, name blank nodes</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">return</span> <span class="nx">nameBlankNodes</span><span class="p">(</span><span class="nx">unique</span><span class="p">,</span> <span class="nx">duplicates</span><span class="p">,</span> <span class="nx">nextUnnamed</span><span class="p">);</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-229"><td class="docs"><div class="pilwrap"><a href="#section-229" class="pilcrow">&#182;</a></div><p>hash unnamed bnode</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">bnode</span> <span class="o">=</span> <span class="nx">unnamed</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">hash</span> <span class="o">=</span> <span class="nx">_hashQuads</span><span class="p">(</span><span class="nx">bnode</span><span class="p">,</span> <span class="nx">bnodes</span><span class="p">,</span> <span class="nx">namer</span><span class="p">);</span></pre></div></td></tr><tr id="section-230"><td class="docs"><div class="pilwrap"><a href="#section-230" class="pilcrow">&#182;</a></div><p>store hash as unique or a duplicate</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">hash</span> <span class="k">in</span> <span class="nx">duplicates</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">duplicates</span><span class="p">[</span><span class="nx">hash</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">bnode</span><span class="p">);</span>
        <span class="nx">nextUnnamed</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">bnode</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">hash</span> <span class="k">in</span> <span class="nx">unique</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">duplicates</span><span class="p">[</span><span class="nx">hash</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">unique</span><span class="p">[</span><span class="nx">hash</span><span class="p">],</span> <span class="nx">bnode</span><span class="p">];</span>
        <span class="nx">nextUnnamed</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">unique</span><span class="p">[</span><span class="nx">hash</span><span class="p">]);</span>
        <span class="nx">nextUnnamed</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">bnode</span><span class="p">);</span>
        <span class="k">delete</span> <span class="nx">unique</span><span class="p">[</span><span class="nx">hash</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">unique</span><span class="p">[</span><span class="nx">hash</span><span class="p">]</span> <span class="o">=</span> <span class="nx">bnode</span><span class="p">;</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-231"><td class="docs"><div class="pilwrap"><a href="#section-231" class="pilcrow">&#182;</a></div><p>hash next unnamed bnode</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">jsonld</span><span class="p">.</span><span class="nx">setImmediate</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">hashUnnamed</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);});</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-232"><td class="docs"><div class="pilwrap"><a href="#section-232" class="pilcrow">&#182;</a></div><p>names unique hash bnodes</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">nameBlankNodes</span><span class="p">(</span><span class="nx">unique</span><span class="p">,</span> <span class="nx">duplicates</span><span class="p">,</span> <span class="nx">unnamed</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-233"><td class="docs"><div class="pilwrap"><a href="#section-233" class="pilcrow">&#182;</a></div><p>name unique bnodes in sorted hash order</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">named</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">hashes</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">unique</span><span class="p">).</span><span class="nx">sort</span><span class="p">();</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">hashes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">bnode</span> <span class="o">=</span> <span class="nx">unique</span><span class="p">[</span><span class="nx">hashes</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span>
      <span class="nx">namer</span><span class="p">.</span><span class="nx">getName</span><span class="p">(</span><span class="nx">bnode</span><span class="p">);</span>
      <span class="nx">named</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-234"><td class="docs"><div class="pilwrap"><a href="#section-234" class="pilcrow">&#182;</a></div><p>continue to hash bnodes if a bnode was assigned a name</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">named</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">hashBlankNodes</span><span class="p">(</span><span class="nx">unnamed</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-235"><td class="docs"><div class="pilwrap"><a href="#section-235" class="pilcrow">&#182;</a></div><p>name the duplicate hash bnodes</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">nameDuplicates</span><span class="p">(</span><span class="nx">duplicates</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-236"><td class="docs"><div class="pilwrap"><a href="#section-236" class="pilcrow">&#182;</a></div><p>names duplicate hash bnodes</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">nameDuplicates</span><span class="p">(</span><span class="nx">duplicates</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-237"><td class="docs"><div class="pilwrap"><a href="#section-237" class="pilcrow">&#182;</a></div><p>enumerate duplicate hash groups in sorted order</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">hashes</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">duplicates</span><span class="p">).</span><span class="nx">sort</span><span class="p">();</span></pre></div></td></tr><tr id="section-238"><td class="docs"><div class="pilwrap"><a href="#section-238" class="pilcrow">&#182;</a></div><p>process each group</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">processGroup</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nx">processGroup</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="nx">hashes</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-239"><td class="docs"><div class="pilwrap"><a href="#section-239" class="pilcrow">&#182;</a></div><p>done, create JSON-LD array</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">return</span> <span class="nx">createArray</span><span class="p">();</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-240"><td class="docs"><div class="pilwrap"><a href="#section-240" class="pilcrow">&#182;</a></div><p>name each group member</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">group</span> <span class="o">=</span> <span class="nx">duplicates</span><span class="p">[</span><span class="nx">hashes</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span>
      <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="nx">nameGroupMember</span><span class="p">(</span><span class="nx">group</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="kd">function</span> <span class="nx">nameGroupMember</span><span class="p">(</span><span class="nx">group</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">n</span> <span class="o">===</span> <span class="nx">group</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-241"><td class="docs"><div class="pilwrap"><a href="#section-241" class="pilcrow">&#182;</a></div><p>name bnodes in hash order</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">results</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">a</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">hash</span><span class="p">;</span>
            <span class="nx">b</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">hash</span><span class="p">;</span>
            <span class="k">return</span> <span class="p">(</span><span class="nx">a</span> <span class="o">&lt;</span> <span class="nx">b</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="p">((</span><span class="nx">a</span> <span class="o">&gt;</span> <span class="nx">b</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
          <span class="p">});</span>
          <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">r</span> <span class="k">in</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-242"><td class="docs"><div class="pilwrap"><a href="#section-242" class="pilcrow">&#182;</a></div><p>name all bnodes in path namer in key-entry order
Note: key-order is preserved in javascript</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">results</span><span class="p">[</span><span class="nx">r</span><span class="p">].</span><span class="nx">pathNamer</span><span class="p">.</span><span class="nx">existing</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">namer</span><span class="p">.</span><span class="nx">getName</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">processGroup</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-243"><td class="docs"><div class="pilwrap"><a href="#section-243" class="pilcrow">&#182;</a></div><p>skip already-named bnodes</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">bnode</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">n</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">namer</span><span class="p">.</span><span class="nx">isNamed</span><span class="p">(</span><span class="nx">bnode</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">nameGroupMember</span><span class="p">(</span><span class="nx">group</span><span class="p">,</span> <span class="nx">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-244"><td class="docs"><div class="pilwrap"><a href="#section-244" class="pilcrow">&#182;</a></div><p>hash bnode paths</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">pathNamer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UniqueNamer</span><span class="p">(</span><span class="s1">&#39;_:b&#39;</span><span class="p">);</span>
        <span class="nx">pathNamer</span><span class="p">.</span><span class="nx">getName</span><span class="p">(</span><span class="nx">bnode</span><span class="p">);</span>
        <span class="nx">_hashPaths</span><span class="p">(</span><span class="nx">bnode</span><span class="p">,</span> <span class="nx">bnodes</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="nx">pathNamer</span><span class="p">,</span>
          <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
            <span class="nx">nameGroupMember</span><span class="p">(</span><span class="nx">group</span><span class="p">,</span> <span class="nx">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
          <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-245"><td class="docs"><div class="pilwrap"><a href="#section-245" class="pilcrow">&#182;</a></div><p>creates the sorted array of RDF quads</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">createArray</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">normalized</span> <span class="o">=</span> <span class="p">[];</span></pre></div></td></tr><tr id="section-246"><td class="docs"><div class="pilwrap"><a href="#section-246" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Note: At this point all bnodes in the set of RDF quads have been<br />     assigned canonical names, which have been stored in the 'namer' object.<br />     Here each quad is updated by assigning each of its bnodes its new name<br />     via the 'namer' object.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-247"><td class="docs"><div class="pilwrap"><a href="#section-247" class="pilcrow">&#182;</a></div><p>update bnode names in each quad and serialize</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">quads</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">quad</span> <span class="o">=</span> <span class="nx">quads</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="s1">&#39;object&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">];</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">ai</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ai</span> <span class="o">&lt;</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">ai</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">attr</span> <span class="o">=</span> <span class="nx">attrs</span><span class="p">[</span><span class="nx">ai</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">quad</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">quad</span><span class="p">[</span><span class="nx">attr</span><span class="p">].</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;blank node&#39;</span> <span class="o">&amp;&amp;</span>
          <span class="nx">quad</span><span class="p">[</span><span class="nx">attr</span><span class="p">].</span><span class="nx">value</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;_:c14n&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">quad</span><span class="p">[</span><span class="nx">attr</span><span class="p">].</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">namer</span><span class="p">.</span><span class="nx">getName</span><span class="p">(</span><span class="nx">quad</span><span class="p">[</span><span class="nx">attr</span><span class="p">].</span><span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">normalized</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">_toNQuad</span><span class="p">(</span><span class="nx">quad</span><span class="p">,</span> <span class="nx">quad</span><span class="p">.</span><span class="nx">name</span> <span class="o">?</span> <span class="nx">quad</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">value</span> <span class="o">:</span> <span class="kc">null</span><span class="p">));</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-248"><td class="docs"><div class="pilwrap"><a href="#section-248" class="pilcrow">&#182;</a></div><p>sort normalized output</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">normalized</span><span class="p">.</span><span class="nx">sort</span><span class="p">();</span></pre></div></td></tr><tr id="section-249"><td class="docs"><div class="pilwrap"><a href="#section-249" class="pilcrow">&#182;</a></div><p>handle output format</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">format</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">format</span> <span class="o">===</span> <span class="s1">&#39;application/nquads&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">normalized</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
        <span class="s1">&#39;Unknown output format.&#39;</span><span class="p">,</span>
        <span class="s1">&#39;jsonld.UnknownFormat&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">format</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">format</span><span class="p">}));</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-250"><td class="docs"><div class="pilwrap"><a href="#section-250" class="pilcrow">&#182;</a></div><p>output RDF dataset</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">_parseNQuads</span><span class="p">(</span><span class="nx">normalized</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)));</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-251"><td class="docs"><div class="pilwrap"><a href="#section-251" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Converts an RDF dataset to JSON-LD.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">dataset</span><span>- RDF dataset.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">options</span><span>- RDF conversion options.</span></div><div class="dox_tag_detail"><span>output) </span><span class="dox_type">callback(err</span><span class="dox_type"></span><span>- called once the operation completes.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Processor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">fromRDF</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dataset</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">defaultGraph</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="kd">var</span> <span class="nx">graphMap</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@default&#39;</span><span class="o">:</span> <span class="nx">defaultGraph</span><span class="p">};</span>

  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">dataset</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">graph</span> <span class="o">=</span> <span class="nx">dataset</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">name</span> <span class="k">in</span> <span class="nx">graphMap</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">graphMap</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">name</span> <span class="o">!==</span> <span class="s1">&#39;@default&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">name</span> <span class="k">in</span> <span class="nx">defaultGraph</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">defaultGraph</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@id&#39;</span><span class="o">:</span> <span class="nx">name</span><span class="p">};</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">nodeMap</span> <span class="o">=</span> <span class="nx">graphMap</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">ti</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ti</span> <span class="o">&lt;</span> <span class="nx">graph</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">ti</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">triple</span> <span class="o">=</span> <span class="nx">graph</span><span class="p">[</span><span class="nx">ti</span><span class="p">];</span></pre></div></td></tr><tr id="section-252"><td class="docs"><div class="pilwrap"><a href="#section-252" class="pilcrow">&#182;</a></div><p>get subject, predicate, object</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">triple</span><span class="p">.</span><span class="nx">subject</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">triple</span><span class="p">.</span><span class="nx">predicate</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="nx">triple</span><span class="p">.</span><span class="nx">object</span><span class="p">;</span>

      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">s</span> <span class="k">in</span> <span class="nx">nodeMap</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">nodeMap</span><span class="p">[</span><span class="nx">s</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@id&#39;</span><span class="o">:</span> <span class="nx">s</span><span class="p">};</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">nodeMap</span><span class="p">[</span><span class="nx">s</span><span class="p">];</span>

      <span class="kd">var</span> <span class="nx">objectIsId</span> <span class="o">=</span> <span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;IRI&#39;</span> <span class="o">||</span> <span class="nx">o</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;blank node&#39;</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">objectIsId</span> <span class="o">&amp;&amp;</span> <span class="nx">o</span><span class="p">.</span><span class="nx">value</span> <span class="o">!==</span> <span class="nx">RDF_NIL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">value</span> <span class="k">in</span> <span class="nx">nodeMap</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">nodeMap</span><span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">value</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@id&#39;</span><span class="o">:</span> <span class="nx">o</span><span class="p">.</span><span class="nx">value</span><span class="p">};</span>
      <span class="p">}</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">p</span> <span class="o">===</span> <span class="nx">RDF_TYPE</span> <span class="o">&amp;&amp;</span> <span class="nx">objectIsId</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">jsonld</span><span class="p">.</span><span class="nx">addValue</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;@type&#39;</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="p">{</span><span class="nx">propertyIsArray</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">value</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">objectIsId</span> <span class="o">&amp;&amp;</span> <span class="nx">o</span><span class="p">.</span><span class="nx">value</span> <span class="o">===</span> <span class="nx">RDF_NIL</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span> <span class="o">!==</span> <span class="nx">RDF_REST</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-253"><td class="docs"><div class="pilwrap"><a href="#section-253" class="pilcrow">&#182;</a></div><p>empty list detected</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">value</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@list&#39;</span><span class="o">:</span> <span class="p">[]};</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">value</span> <span class="o">=</span> <span class="nx">_RDFToObject</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">useNativeTypes</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">jsonld</span><span class="p">.</span><span class="nx">addValue</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="p">{</span><span class="nx">propertyIsArray</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span></pre></div></td></tr><tr id="section-254"><td class="docs"><div class="pilwrap"><a href="#section-254" class="pilcrow">&#182;</a></div><p>object may be the head of an RDF list but we can't know easily
until all triples are read</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;blank node&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">p</span> <span class="o">===</span> <span class="nx">RDF_FIRST</span> <span class="o">||</span> <span class="nx">p</span> <span class="o">===</span> <span class="nx">RDF_REST</span><span class="p">))</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="nx">nodeMap</span><span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">value</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;listHeadFor&#39;</span> <span class="k">in</span> <span class="nx">object</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">object</span><span class="p">.</span><span class="nx">listHeadFor</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-255"><td class="docs"><div class="pilwrap"><a href="#section-255" class="pilcrow">&#182;</a></div><p>can't be a list head if referenced more than once</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">object</span><span class="p">.</span><span class="nx">listHeadFor</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-256"><td class="docs"><div class="pilwrap"><a href="#section-256" class="pilcrow">&#182;</a></div><p>convert linked lists to @list arrays</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">graphMap</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">graphObject</span> <span class="o">=</span> <span class="nx">graphMap</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">subjects</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">graphObject</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">subjects</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">subject</span> <span class="o">=</span> <span class="nx">subjects</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span></pre></div></td></tr><tr id="section-257"><td class="docs"><div class="pilwrap"><a href="#section-257" class="pilcrow">&#182;</a></div><p>if subject not in graphObject, it has been removed as it was
part of an RDF list, continue on</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">subject</span> <span class="k">in</span> <span class="nx">graphObject</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">graphObject</span><span class="p">[</span><span class="nx">subject</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">listHeadFor</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">listHeadFor</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="kd">var</span> <span class="nx">eliminatedNodes</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="k">while</span><span class="p">(</span><span class="nx">subject</span> <span class="o">!==</span> <span class="nx">RDF_NIL</span> <span class="o">&amp;&amp;</span> <span class="nx">list</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-258"><td class="docs"><div class="pilwrap"><a href="#section-258" class="pilcrow">&#182;</a></div><p>ensure node is a valid list node; node must:
1. Be a blank node
2. Have no keys other than: @id, listHeadFor, rdf:first, rdf:rest.
3. Have an array for rdf:first that has 1 item.
4. Have an array for rdf:rest that has 1 object with @id.
5. Not already be in a list (it is in the eliminated nodes map).</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">nodeKeyCount</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">node</span> <span class="o">||</span> <span class="p">{}).</span><span class="nx">length</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;_:&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
          <span class="p">(</span><span class="nx">nodeKeyCount</span> <span class="o">===</span> <span class="mi">3</span> <span class="o">||</span>
          <span class="p">(</span><span class="nx">nodeKeyCount</span> <span class="o">===</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;listHeadFor&#39;</span> <span class="k">in</span> <span class="nx">node</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
          <span class="nx">_isArray</span><span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="nx">RDF_FIRST</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">[</span><span class="nx">RDF_FIRST</span><span class="p">].</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
          <span class="nx">_isArray</span><span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="nx">RDF_REST</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">[</span><span class="nx">RDF_REST</span><span class="p">].</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
          <span class="nx">_isObject</span><span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="nx">RDF_REST</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="s1">&#39;@id&#39;</span> <span class="k">in</span> <span class="nx">node</span><span class="p">[</span><span class="nx">RDF_REST</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
          <span class="o">!</span><span class="p">(</span><span class="nx">subject</span> <span class="k">in</span> <span class="nx">eliminatedNodes</span><span class="p">)))</span> <span class="p">{</span>
          <span class="nx">list</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="nx">RDF_FIRST</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
        <span class="nx">eliminatedNodes</span><span class="p">[</span><span class="nx">node</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">subject</span> <span class="o">=</span> <span class="nx">node</span><span class="p">[</span><span class="nx">RDF_REST</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;@id&#39;</span><span class="p">];</span>
        <span class="nx">node</span> <span class="o">=</span> <span class="nx">graphObject</span><span class="p">[</span><span class="nx">subject</span><span class="p">]</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-259"><td class="docs"><div class="pilwrap"><a href="#section-259" class="pilcrow">&#182;</a></div><p>bad list detected, skip it</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">list</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">delete</span> <span class="nx">value</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">];</span>
      <span class="nx">value</span><span class="p">[</span><span class="s1">&#39;@list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">list</span><span class="p">;</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">id</span> <span class="k">in</span> <span class="nx">eliminatedNodes</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">delete</span> <span class="nx">graphObject</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">var</span> <span class="nx">subjects</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">defaultGraph</span><span class="p">).</span><span class="nx">sort</span><span class="p">();</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">subjects</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">subject</span> <span class="o">=</span> <span class="nx">subjects</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">defaultGraph</span><span class="p">[</span><span class="nx">subject</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">subject</span> <span class="k">in</span> <span class="nx">graphMap</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">graph</span> <span class="o">=</span> <span class="nx">node</span><span class="p">[</span><span class="s1">&#39;@graph&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="kd">var</span> <span class="nx">graphObject</span> <span class="o">=</span> <span class="nx">graphMap</span><span class="p">[</span><span class="nx">subject</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">subjects_</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">graphObject</span><span class="p">).</span><span class="nx">sort</span><span class="p">();</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">si</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">si</span> <span class="o">&lt;</span> <span class="nx">subjects_</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">si</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">node_</span> <span class="o">=</span> <span class="nx">graphObject</span><span class="p">[</span><span class="nx">subjects_</span><span class="p">[</span><span class="nx">si</span><span class="p">]];</span>
        <span class="k">delete</span> <span class="nx">node_</span><span class="p">.</span><span class="nx">listHeadFor</span><span class="p">;</span>
        <span class="nx">graph</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node_</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">delete</span> <span class="nx">node</span><span class="p">.</span><span class="nx">listHeadFor</span><span class="p">;</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-260"><td class="docs"><div class="pilwrap"><a href="#section-260" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Adds RDF triples for each graph in the given node map to an RDF dataset.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">nodeMap</span><span>- node map.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>RDF dataset.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Processor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toRDF</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">nodeMap</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">namer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UniqueNamer</span><span class="p">(</span><span class="s1">&#39;_:b&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">dataset</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">graphName</span> <span class="k">in</span> <span class="nx">nodeMap</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">graph</span> <span class="o">=</span> <span class="nx">nodeMap</span><span class="p">[</span><span class="nx">graphName</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">graphName</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;_:&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">graphName</span> <span class="o">=</span> <span class="nx">namer</span><span class="p">.</span><span class="nx">getName</span><span class="p">(</span><span class="nx">graphName</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">dataset</span><span class="p">[</span><span class="nx">graphName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_graphToRDF</span><span class="p">(</span><span class="nx">graph</span><span class="p">,</span> <span class="nx">namer</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">dataset</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-261"><td class="docs"><div class="pilwrap"><a href="#section-261" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Processes a local context and returns a new active context.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">activeCtx</span><span>- current active context.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">localCtx</span><span>- local context to process.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">options</span><span>- context processing options.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>new active context.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Processor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">processContext</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">localCtx</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div></td></tr><tr id="section-262"><td class="docs"><div class="pilwrap"><a href="#section-262" class="pilcrow">&#182;</a></div><p>get context from cache if available</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">jsonld</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">activeCtx</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">rval</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">activeCtx</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">localCtx</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">rval</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-263"><td class="docs"><div class="pilwrap"><a href="#section-263" class="pilcrow">&#182;</a></div><p>initialize the resulting context</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">rval</span> <span class="o">=</span> <span class="nx">activeCtx</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span></pre></div></td></tr><tr id="section-264"><td class="docs"><div class="pilwrap"><a href="#section-264" class="pilcrow">&#182;</a></div><p>normalize local context to an array of @context objects</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">localCtx</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;@context&#39;</span> <span class="k">in</span> <span class="nx">localCtx</span> <span class="o">&amp;&amp;</span>
    <span class="nx">_isArray</span><span class="p">(</span><span class="nx">localCtx</span><span class="p">[</span><span class="s1">&#39;@context&#39;</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nx">localCtx</span> <span class="o">=</span> <span class="nx">localCtx</span><span class="p">[</span><span class="s1">&#39;@context&#39;</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">ctxs</span> <span class="o">=</span> <span class="nx">_isArray</span><span class="p">(</span><span class="nx">localCtx</span><span class="p">)</span> <span class="o">?</span> <span class="nx">localCtx</span> <span class="o">:</span> <span class="p">[</span><span class="nx">localCtx</span><span class="p">];</span></pre></div></td></tr><tr id="section-265"><td class="docs"><div class="pilwrap"><a href="#section-265" class="pilcrow">&#182;</a></div><p>process each context in order</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">ctxs</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">ctxs</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span></pre></div></td></tr><tr id="section-266"><td class="docs"><div class="pilwrap"><a href="#section-266" class="pilcrow">&#182;</a></div><p>reset to initial context, keeping namer</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">rval</span> <span class="o">=</span> <span class="nx">_getInitialContext</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-267"><td class="docs"><div class="pilwrap"><a href="#section-267" class="pilcrow">&#182;</a></div><p>dereference @context key if present</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;@context&#39;</span> <span class="k">in</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">[</span><span class="s1">&#39;@context&#39;</span><span class="p">];</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-268"><td class="docs"><div class="pilwrap"><a href="#section-268" class="pilcrow">&#182;</a></div><p>context must be an object by now, all URLs retrieved before this call</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">ctx</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
        <span class="s1">&#39;Invalid JSON-LD syntax; @context must be an object.&#39;</span><span class="p">,</span>
        <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">context</span><span class="o">:</span> <span class="nx">ctx</span><span class="p">});</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-269"><td class="docs"><div class="pilwrap"><a href="#section-269" class="pilcrow">&#182;</a></div><p>define context mappings for keys in local context</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">defined</span> <span class="o">=</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-270"><td class="docs"><div class="pilwrap"><a href="#section-270" class="pilcrow">&#182;</a></div><p>handle @base</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@base&#39;</span> <span class="k">in</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">base</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">[</span><span class="s1">&#39;@base&#39;</span><span class="p">];</span></pre></div></td></tr><tr id="section-271"><td class="docs"><div class="pilwrap"><a href="#section-271" class="pilcrow">&#182;</a></div><p>reset base</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">base</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">base</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">base</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isString</span><span class="p">(</span><span class="nx">base</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
          <span class="s1">&#39;Invalid JSON-LD syntax; the value of &quot;@base&quot; in a &#39;</span> <span class="o">+</span>
          <span class="s1">&#39;@context must be a string or null.&#39;</span><span class="p">,</span>
          <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">context</span><span class="o">:</span> <span class="nx">ctx</span><span class="p">});</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">base</span> <span class="o">!==</span> <span class="s1">&#39;&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_isAbsoluteIri</span><span class="p">(</span><span class="nx">base</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
          <span class="s1">&#39;Invalid JSON-LD syntax; the value of &quot;@base&quot; in a &#39;</span> <span class="o">+</span>
          <span class="s1">&#39;@context must be an absolute IRI or the empty string.&#39;</span><span class="p">,</span>
          <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">context</span><span class="o">:</span> <span class="nx">ctx</span><span class="p">});</span>
      <span class="p">}</span>

      <span class="nx">base</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">base</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
      <span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@base&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">base</span><span class="p">;</span>
      <span class="nx">defined</span><span class="p">[</span><span class="s1">&#39;@base&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-272"><td class="docs"><div class="pilwrap"><a href="#section-272" class="pilcrow">&#182;</a></div><p>handle @vocab</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@vocab&#39;</span> <span class="k">in</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">[</span><span class="s1">&#39;@vocab&#39;</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">delete</span> <span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@vocab&#39;</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isString</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
          <span class="s1">&#39;Invalid JSON-LD syntax; the value of &quot;@vocab&quot; in a &#39;</span> <span class="o">+</span>
          <span class="s1">&#39;@context must be a string or null.&#39;</span><span class="p">,</span>
          <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">context</span><span class="o">:</span> <span class="nx">ctx</span><span class="p">});</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isAbsoluteIri</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
          <span class="s1">&#39;Invalid JSON-LD syntax; the value of &quot;@vocab&quot; in a &#39;</span> <span class="o">+</span>
          <span class="s1">&#39;@context must be an absolute IRI.&#39;</span><span class="p">,</span>
          <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">context</span><span class="o">:</span> <span class="nx">ctx</span><span class="p">});</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@vocab&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">defined</span><span class="p">[</span><span class="s1">&#39;@vocab&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-273"><td class="docs"><div class="pilwrap"><a href="#section-273" class="pilcrow">&#182;</a></div><p>handle @language</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@language&#39;</span> <span class="k">in</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">[</span><span class="s1">&#39;@language&#39;</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">delete</span> <span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@language&#39;</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isString</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
          <span class="s1">&#39;Invalid JSON-LD syntax; the value of &quot;@language&quot; in a &#39;</span> <span class="o">+</span>
          <span class="s1">&#39;@context must be a string or null.&#39;</span><span class="p">,</span>
          <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">context</span><span class="o">:</span> <span class="nx">ctx</span><span class="p">});</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@language&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="nx">defined</span><span class="p">[</span><span class="s1">&#39;@language&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-274"><td class="docs"><div class="pilwrap"><a href="#section-274" class="pilcrow">&#182;</a></div><p>process all other keys</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_createTermDefinition</span><span class="p">(</span><span class="nx">rval</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">defined</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-275"><td class="docs"><div class="pilwrap"><a href="#section-275" class="pilcrow">&#182;</a></div><p>cache result</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">jsonld</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">activeCtx</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">jsonld</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">activeCtx</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">localCtx</span><span class="p">,</span> <span class="nx">rval</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-276"><td class="docs"><div class="pilwrap"><a href="#section-276" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Expands a language map.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">languageMap</span><span>- language map to expand.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>expanded language map.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_expandLanguageMap</span><span class="p">(</span><span class="nx">languageMap</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">languageMap</span><span class="p">).</span><span class="nx">sort</span><span class="p">();</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">ki</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ki</span> <span class="o">&lt;</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">ki</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">[</span><span class="nx">ki</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">languageMap</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">val</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">val</span> <span class="o">=</span> <span class="p">[</span><span class="nx">val</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">vi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">vi</span> <span class="o">&lt;</span> <span class="nx">val</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">vi</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">val</span><span class="p">[</span><span class="nx">vi</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isString</span><span class="p">(</span><span class="nx">item</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
          <span class="s1">&#39;Invalid JSON-LD syntax; language map values must be strings.&#39;</span><span class="p">,</span>
          <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">languageMap</span><span class="o">:</span> <span class="nx">languageMap</span><span class="p">});</span>
      <span class="p">}</span>
      <span class="nx">rval</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
        <span class="s1">&#39;@value&#39;</span><span class="o">:</span> <span class="nx">item</span><span class="p">,</span>
        <span class="s1">&#39;@language&#39;</span><span class="o">:</span> <span class="nx">key</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-277"><td class="docs"><div class="pilwrap"><a href="#section-277" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Labels the blank nodes in the given value using the given UniqueNamer.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">namer</span><span>- UniqueNamer to use.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">element</span><span>- element with blank nodes to rename.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>element.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_labelBlankNodes</span><span class="p">(</span><span class="nx">namer</span><span class="p">,</span> <span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">element</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">element</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">element</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_labelBlankNodes</span><span class="p">(</span><span class="nx">namer</span><span class="p">,</span> <span class="nx">element</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">_isList</span><span class="p">(</span><span class="nx">element</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">element</span><span class="p">[</span><span class="s1">&#39;@list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_labelBlankNodes</span><span class="p">(</span><span class="nx">namer</span><span class="p">,</span> <span class="nx">element</span><span class="p">[</span><span class="s1">&#39;@list&#39;</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">element</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-278"><td class="docs"><div class="pilwrap"><a href="#section-278" class="pilcrow">&#182;</a></div><p>rename blank node</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">_isBlankNode</span><span class="p">(</span><span class="nx">element</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">element</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">namer</span><span class="p">.</span><span class="nx">getName</span><span class="p">(</span><span class="nx">element</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">]);</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-279"><td class="docs"><div class="pilwrap"><a href="#section-279" class="pilcrow">&#182;</a></div><p>recursively apply to all keys</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">sort</span><span class="p">();</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">ki</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ki</span> <span class="o">&lt;</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">ki</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">[</span><span class="nx">ki</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">key</span> <span class="o">!==</span> <span class="s1">&#39;@id&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">element</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_labelBlankNodes</span><span class="p">(</span><span class="nx">namer</span><span class="p">,</span> <span class="nx">element</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">element</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-280"><td class="docs"><div class="pilwrap"><a href="#section-280" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Expands the given value by using the coercion and keyword rules in the<br />given context.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">activeCtx</span><span>- active context to use.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">activeProperty</span><span>- active property the value is associated with.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">value</span><span>- value to expand.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>expanded value.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_expandValue</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">activeProperty</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-281"><td class="docs"><div class="pilwrap"><a href="#section-281" class="pilcrow">&#182;</a></div><p>nothing to expand</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-282"><td class="docs"><div class="pilwrap"><a href="#section-282" class="pilcrow">&#182;</a></div><p>special-case expand @id and @type (skips '@id' expansion)</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">expandedProperty</span> <span class="o">=</span> <span class="nx">_expandIri</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">activeProperty</span><span class="p">,</span> <span class="p">{</span><span class="nx">vocab</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">expandedProperty</span> <span class="o">===</span> <span class="s1">&#39;@id&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">_expandIri</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="p">{</span><span class="nx">base</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">expandedProperty</span> <span class="o">===</span> <span class="s1">&#39;@type&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">_expandIri</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="p">{</span><span class="nx">vocab</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">base</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-283"><td class="docs"><div class="pilwrap"><a href="#section-283" class="pilcrow">&#182;</a></div><p>get type definition from context</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">getContextValue</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">activeProperty</span><span class="p">,</span> <span class="s1">&#39;@type&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-284"><td class="docs"><div class="pilwrap"><a href="#section-284" class="pilcrow">&#182;</a></div><p>do @id expansion (automatic for @graph)</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;@id&#39;</span> <span class="o">||</span> <span class="p">(</span><span class="nx">expandedProperty</span> <span class="o">===</span> <span class="s1">&#39;@graph&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">_isString</span><span class="p">(</span><span class="nx">value</span><span class="p">)))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;@id&#39;</span><span class="o">:</span> <span class="nx">_expandIri</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="p">{</span><span class="nx">base</span><span class="o">:</span> <span class="kc">true</span><span class="p">})};</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-285"><td class="docs"><div class="pilwrap"><a href="#section-285" class="pilcrow">&#182;</a></div><p>do @id expansion w/vocab</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;@vocab&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;@id&#39;</span><span class="o">:</span> <span class="nx">_expandIri</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="p">{</span><span class="nx">vocab</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">base</span><span class="o">:</span> <span class="kc">true</span><span class="p">})};</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-286"><td class="docs"><div class="pilwrap"><a href="#section-286" class="pilcrow">&#182;</a></div><p>do not expand keyword values</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">_isKeyword</span><span class="p">(</span><span class="nx">expandedProperty</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">rval</span> <span class="o">=</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-287"><td class="docs"><div class="pilwrap"><a href="#section-287" class="pilcrow">&#182;</a></div><p>other type</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">type</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-288"><td class="docs"><div class="pilwrap"><a href="#section-288" class="pilcrow">&#182;</a></div><p>check for language tagging for strings</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">_isString</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">language</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">getContextValue</span><span class="p">(</span>
      <span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">activeProperty</span><span class="p">,</span> <span class="s1">&#39;@language&#39;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">language</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@language&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">language</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>

  <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-289"><td class="docs"><div class="pilwrap"><a href="#section-289" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Creates an array of RDF triples for the given graph.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">graph</span><span>- graph to create RDF triples for.</span></div><div class="dox_tag_detail"><span>a </span><span class="dox_type">namer</span><span>- UniqueNamer for assigning blank node names.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>array of RDF triples for the given graph.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_graphToRDF</span><span class="p">(</span><span class="nx">graph</span><span class="p">,</span> <span class="nx">namer</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="p">[];</span>

  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">id</span> <span class="k">in</span> <span class="nx">graph</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">graph</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">property</span> <span class="k">in</span> <span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">items</span> <span class="o">=</span> <span class="nx">node</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">property</span> <span class="o">===</span> <span class="s1">&#39;@type&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">property</span> <span class="o">=</span> <span class="nx">RDF_TYPE</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">_isKeyword</span><span class="p">(</span><span class="nx">property</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span></pre></div></td></tr><tr id="section-290"><td class="docs"><div class="pilwrap"><a href="#section-290" class="pilcrow">&#182;</a></div><p>RDF subject</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">subject</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">id</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;_:&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">subject</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;blank node&#39;</span><span class="p">;</span>
          <span class="nx">subject</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">namer</span><span class="p">.</span><span class="nx">getName</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">subject</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;IRI&#39;</span><span class="p">;</span>
          <span class="nx">subject</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-291"><td class="docs"><div class="pilwrap"><a href="#section-291" class="pilcrow">&#182;</a></div><p>RDF predicate</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">predicate</span> <span class="o">=</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;IRI&#39;</span><span class="p">};</span>
        <span class="nx">predicate</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">property</span><span class="p">;</span></pre></div></td></tr><tr id="section-292"><td class="docs"><div class="pilwrap"><a href="#section-292" class="pilcrow">&#182;</a></div><p>convert @list to triples</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">_isList</span><span class="p">(</span><span class="nx">item</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">_listToRDF</span><span class="p">(</span><span class="nx">item</span><span class="p">[</span><span class="s1">&#39;@list&#39;</span><span class="p">],</span> <span class="nx">namer</span><span class="p">,</span> <span class="nx">subject</span><span class="p">,</span> <span class="nx">predicate</span><span class="p">,</span> <span class="nx">rval</span><span class="p">);</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-293"><td class="docs"><div class="pilwrap"><a href="#section-293" class="pilcrow">&#182;</a></div><p>convert value or node object to triple</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">else</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="nx">_objectToRDF</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">namer</span><span class="p">);</span>
          <span class="nx">rval</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">subject</span><span class="o">:</span> <span class="nx">subject</span><span class="p">,</span> <span class="nx">predicate</span><span class="o">:</span> <span class="nx">predicate</span><span class="p">,</span> <span class="nx">object</span><span class="o">:</span> <span class="nx">object</span><span class="p">});</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-294"><td class="docs"><div class="pilwrap"><a href="#section-294" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Converts a @list value into linked list of blank node RDF triples<br />(an RDF collection).</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">list</span><span>- @list value.</span></div><div class="dox_tag_detail"><span>a </span><span class="dox_type">namer</span><span>- UniqueNamer for assigning blank node names.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">subject</span><span>- subject for the head of the list.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">predicate</span><span>- predicate for the head of the list.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">triples</span><span>- array of triples to append to.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_listToRDF</span><span class="p">(</span><span class="nx">list</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="nx">subject</span><span class="p">,</span> <span class="nx">predicate</span><span class="p">,</span> <span class="nx">triples</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">first</span> <span class="o">=</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;IRI&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">RDF_FIRST</span><span class="p">};</span>
  <span class="kd">var</span> <span class="nx">rest</span> <span class="o">=</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;IRI&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">RDF_REST</span><span class="p">};</span>
  <span class="kd">var</span> <span class="nx">nil</span> <span class="o">=</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;IRI&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">RDF_NIL</span><span class="p">};</span>

  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

    <span class="kd">var</span> <span class="nx">blankNode</span> <span class="o">=</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;blank node&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">namer</span><span class="p">.</span><span class="nx">getName</span><span class="p">()};</span>
    <span class="nx">triples</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">subject</span><span class="o">:</span> <span class="nx">subject</span><span class="p">,</span> <span class="nx">predicate</span><span class="o">:</span> <span class="nx">predicate</span><span class="p">,</span> <span class="nx">object</span><span class="o">:</span> <span class="nx">blankNode</span><span class="p">});</span>

    <span class="nx">subject</span> <span class="o">=</span> <span class="nx">blankNode</span><span class="p">;</span>
    <span class="nx">predicate</span> <span class="o">=</span> <span class="nx">first</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="nx">_objectToRDF</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">namer</span><span class="p">);</span>
    <span class="nx">triples</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">subject</span><span class="o">:</span> <span class="nx">subject</span><span class="p">,</span> <span class="nx">predicate</span><span class="o">:</span> <span class="nx">predicate</span><span class="p">,</span> <span class="nx">object</span><span class="o">:</span> <span class="nx">object</span><span class="p">});</span>

    <span class="nx">predicate</span> <span class="o">=</span> <span class="nx">rest</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">triples</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">subject</span><span class="o">:</span> <span class="nx">subject</span><span class="p">,</span> <span class="nx">predicate</span><span class="o">:</span> <span class="nx">predicate</span><span class="p">,</span> <span class="nx">object</span><span class="o">:</span> <span class="nx">nil</span><span class="p">});</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-295"><td class="docs"><div class="pilwrap"><a href="#section-295" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Converts a JSON-LD value object to an RDF literal or a JSON-LD string or<br />node object to an RDF resource.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">item</span><span>- JSON-LD value or node object.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">namer</span><span>- UniqueNamer to use to assign blank node names.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>RDF literal or RDF resource.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_objectToRDF</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">namer</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-296"><td class="docs"><div class="pilwrap"><a href="#section-296" class="pilcrow">&#182;</a></div><p>convert value object to RDF</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">_isValue</span><span class="p">(</span><span class="nx">item</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">object</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;literal&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">item</span><span class="p">[</span><span class="s1">&#39;@value&#39;</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">datatype</span> <span class="o">=</span> <span class="nx">item</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">]</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span></pre></div></td></tr><tr id="section-297"><td class="docs"><div class="pilwrap"><a href="#section-297" class="pilcrow">&#182;</a></div><p>convert to XSD datatypes as appropriate</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">_isBoolean</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">object</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
      <span class="nx">object</span><span class="p">.</span><span class="nx">datatype</span> <span class="o">=</span> <span class="nx">datatype</span> <span class="o">||</span> <span class="nx">XSD_BOOLEAN</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">_isDouble</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-298"><td class="docs"><div class="pilwrap"><a href="#section-298" class="pilcrow">&#182;</a></div><p>canonical double representation</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">object</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toExponential</span><span class="p">(</span><span class="mi">15</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(\d)0*e\+?/</span><span class="p">,</span> <span class="s1">&#39;$1E&#39;</span><span class="p">);</span>
      <span class="nx">object</span><span class="p">.</span><span class="nx">datatype</span> <span class="o">=</span> <span class="nx">datatype</span> <span class="o">||</span> <span class="nx">XSD_DOUBLE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">_isNumber</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">object</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="nx">object</span><span class="p">.</span><span class="nx">datatype</span> <span class="o">=</span> <span class="nx">datatype</span> <span class="o">||</span> <span class="nx">XSD_INTEGER</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@language&#39;</span> <span class="k">in</span> <span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">object</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="nx">object</span><span class="p">.</span><span class="nx">datatype</span> <span class="o">=</span> <span class="nx">datatype</span> <span class="o">||</span> <span class="nx">RDF_LANGSTRING</span><span class="p">;</span>
      <span class="nx">object</span><span class="p">.</span><span class="nx">language</span> <span class="o">=</span> <span class="nx">item</span><span class="p">[</span><span class="s1">&#39;@language&#39;</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">object</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="nx">object</span><span class="p">.</span><span class="nx">datatype</span> <span class="o">=</span> <span class="nx">datatype</span> <span class="o">||</span> <span class="nx">XSD_STRING</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-299"><td class="docs"><div class="pilwrap"><a href="#section-299" class="pilcrow">&#182;</a></div><p>convert string/node object to RDF</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">else</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">_isObject</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="o">?</span> <span class="nx">item</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="nx">item</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">id</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;_:&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">object</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;blank node&#39;</span><span class="p">;</span>
      <span class="nx">object</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">namer</span><span class="p">.</span><span class="nx">getName</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">object</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;IRI&#39;</span><span class="p">;</span>
      <span class="nx">object</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">object</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-300"><td class="docs"><div class="pilwrap"><a href="#section-300" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Converts an RDF triple object to a JSON-LD object.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">o</span><span>- RDF triple object to convert.</span></div><div class="dox_tag_detail"><span>true </span><span class="dox_type">useNativeTypes</span><span>- to output native types, false not to.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>JSON-LD object.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_RDFToObject</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">useNativeTypes</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-301"><td class="docs"><div class="pilwrap"><a href="#section-301" class="pilcrow">&#182;</a></div><p>convert IRI/blank node object to JSON-LD</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;IRI&#39;</span> <span class="o">||</span> <span class="nx">o</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;blank node&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;@id&#39;</span><span class="o">:</span> <span class="nx">o</span><span class="p">.</span><span class="nx">value</span><span class="p">};</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-302"><td class="docs"><div class="pilwrap"><a href="#section-302" class="pilcrow">&#182;</a></div><p>convert literal to JSON-LD</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@value&#39;</span><span class="o">:</span> <span class="nx">o</span><span class="p">.</span><span class="nx">value</span><span class="p">};</span></pre></div></td></tr><tr id="section-303"><td class="docs"><div class="pilwrap"><a href="#section-303" class="pilcrow">&#182;</a></div><p>add language</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="s1">&#39;language&#39;</span> <span class="k">in</span> <span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@language&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">language</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-304"><td class="docs"><div class="pilwrap"><a href="#section-304" class="pilcrow">&#182;</a></div><p>add datatype</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">else</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">datatype</span><span class="p">;</span></pre></div></td></tr><tr id="section-305"><td class="docs"><div class="pilwrap"><a href="#section-305" class="pilcrow">&#182;</a></div><p>use native types for certain xsd types</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">useNativeTypes</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">XSD_BOOLEAN</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@value&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;true&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@value&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">_isNumeric</span><span class="p">(</span><span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@value&#39;</span><span class="p">]))</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">XSD_INTEGER</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@value&#39;</span><span class="p">]);</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">i</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@value&#39;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">XSD_DOUBLE</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@value&#39;</span><span class="p">]);</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-306"><td class="docs"><div class="pilwrap"><a href="#section-306" class="pilcrow">&#182;</a></div><p>do not add native type</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">([</span><span class="nx">XSD_BOOLEAN</span><span class="p">,</span> <span class="nx">XSD_INTEGER</span><span class="p">,</span> <span class="nx">XSD_DOUBLE</span><span class="p">,</span> <span class="nx">XSD_STRING</span><span class="p">]</span>
        <span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">rval</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-307"><td class="docs"><div class="pilwrap"><a href="#section-307" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Compares two RDF triples for equality.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">t1</span><span>- first triple.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">t2</span><span>- second triple.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">true</span><span>if the triples are the same, false if not.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_compareRDFTriples</span><span class="p">(</span><span class="nx">t1</span><span class="p">,</span> <span class="nx">t2</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="s1">&#39;predicate&#39;</span><span class="p">,</span> <span class="s1">&#39;object&#39;</span><span class="p">];</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">attr</span> <span class="o">=</span> <span class="nx">attrs</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">t1</span><span class="p">[</span><span class="nx">attr</span><span class="p">].</span><span class="nx">type</span> <span class="o">!==</span> <span class="nx">t2</span><span class="p">[</span><span class="nx">attr</span><span class="p">].</span><span class="nx">type</span> <span class="o">||</span> <span class="nx">t1</span><span class="p">[</span><span class="nx">attr</span><span class="p">].</span><span class="nx">value</span> <span class="o">!==</span> <span class="nx">t2</span><span class="p">[</span><span class="nx">attr</span><span class="p">].</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">t1</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">language</span> <span class="o">!==</span> <span class="nx">t2</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">language</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">t1</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">datatype</span> <span class="o">!==</span> <span class="nx">t2</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">datatype</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-308"><td class="docs"><div class="pilwrap"><a href="#section-308" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Hashes all of the quads about a blank node.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">id</span><span>- ID of the bnode to hash quads for.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">bnodes</span><span>- mapping of bnodes to quads.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">namer</span><span>- canonical bnode namer.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>new hash.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_hashQuads</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">bnodes</span><span class="p">,</span> <span class="nx">namer</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-309"><td class="docs"><div class="pilwrap"><a href="#section-309" class="pilcrow">&#182;</a></div><p>return cached hash</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="s1">&#39;hash&#39;</span> <span class="k">in</span> <span class="nx">bnodes</span><span class="p">[</span><span class="nx">id</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">bnodes</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">hash</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-310"><td class="docs"><div class="pilwrap"><a href="#section-310" class="pilcrow">&#182;</a></div><p>serialize all of bnode's quads</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">quads</span> <span class="o">=</span> <span class="nx">bnodes</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">quads</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">nquads</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">quads</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">nquads</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">_toNQuad</span><span class="p">(</span>
      <span class="nx">quads</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">quads</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">name</span> <span class="o">?</span> <span class="nx">quads</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">name</span><span class="p">.</span><span class="nx">value</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">id</span><span class="p">));</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-311"><td class="docs"><div class="pilwrap"><a href="#section-311" class="pilcrow">&#182;</a></div><p>sort serialized quads</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">nquads</span><span class="p">.</span><span class="nx">sort</span><span class="p">();</span></pre></div></td></tr><tr id="section-312"><td class="docs"><div class="pilwrap"><a href="#section-312" class="pilcrow">&#182;</a></div><p>return hashed quads</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">hash</span> <span class="o">=</span> <span class="nx">bnodes</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">hash</span> <span class="o">=</span> <span class="nx">sha1</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">nquads</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">hash</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-313"><td class="docs"><div class="pilwrap"><a href="#section-313" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Produces a hash for the paths of adjacent bnodes for a bnode,<br />incorporating all information about its subgraph of bnodes. This<br />method will recursively pick adjacent bnode permutations that produce the<br />lexicographically-least 'path' serializations.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">id</span><span>- ID of the bnode to hash paths for.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">bnodes</span><span>- map of bnode quads.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">namer</span><span>- canonical bnode namer.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">pathNamer</span><span>- namer used to assign names to adjacent bnodes.</span></div><div class="dox_tag_detail"><span>result) </span><span class="dox_type">callback(err</span><span class="dox_type"></span><span>- called once the operation completes.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_hashPaths</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">bnodes</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="nx">pathNamer</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-314"><td class="docs"><div class="pilwrap"><a href="#section-314" class="pilcrow">&#182;</a></div><p>create SHA-1 digest</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">md</span> <span class="o">=</span> <span class="nx">sha1</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span></pre></div></td></tr><tr id="section-315"><td class="docs"><div class="pilwrap"><a href="#section-315" class="pilcrow">&#182;</a></div><p>group adjacent bnodes by hash, keep properties and references separate</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">groups</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="kd">var</span> <span class="nx">groupHashes</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">quads</span> <span class="o">=</span> <span class="nx">bnodes</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">quads</span><span class="p">;</span>
  <span class="nx">jsonld</span><span class="p">.</span><span class="nx">setImmediate</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">groupNodes</span><span class="p">(</span><span class="mi">0</span><span class="p">);});</span>
  <span class="kd">function</span> <span class="nx">groupNodes</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="nx">quads</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-316"><td class="docs"><div class="pilwrap"><a href="#section-316" class="pilcrow">&#182;</a></div><p>done, hash groups</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">groupHashes</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">groups</span><span class="p">).</span><span class="nx">sort</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">hashGroup</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-317"><td class="docs"><div class="pilwrap"><a href="#section-317" class="pilcrow">&#182;</a></div><p>get adjacent bnode</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">quad</span> <span class="o">=</span> <span class="nx">quads</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">bnode</span> <span class="o">=</span> <span class="nx">_getAdjacentBlankNodeName</span><span class="p">(</span><span class="nx">quad</span><span class="p">.</span><span class="nx">subject</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">direction</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">bnode</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-318"><td class="docs"><div class="pilwrap"><a href="#section-318" class="pilcrow">&#182;</a></div><p>normal property</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">direction</span> <span class="o">=</span> <span class="s1">&#39;p&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">bnode</span> <span class="o">=</span> <span class="nx">_getAdjacentBlankNodeName</span><span class="p">(</span><span class="nx">quad</span><span class="p">.</span><span class="nx">object</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">bnode</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-319"><td class="docs"><div class="pilwrap"><a href="#section-319" class="pilcrow">&#182;</a></div><p>reverse property</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">direction</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">bnode</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-320"><td class="docs"><div class="pilwrap"><a href="#section-320" class="pilcrow">&#182;</a></div><p>get bnode name (try canonical, path, then hash)</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">name</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">namer</span><span class="p">.</span><span class="nx">isNamed</span><span class="p">(</span><span class="nx">bnode</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">name</span> <span class="o">=</span> <span class="nx">namer</span><span class="p">.</span><span class="nx">getName</span><span class="p">(</span><span class="nx">bnode</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">pathNamer</span><span class="p">.</span><span class="nx">isNamed</span><span class="p">(</span><span class="nx">bnode</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">name</span> <span class="o">=</span> <span class="nx">pathNamer</span><span class="p">.</span><span class="nx">getName</span><span class="p">(</span><span class="nx">bnode</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">name</span> <span class="o">=</span> <span class="nx">_hashQuads</span><span class="p">(</span><span class="nx">bnode</span><span class="p">,</span> <span class="nx">bnodes</span><span class="p">,</span> <span class="nx">namer</span><span class="p">);</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-321"><td class="docs"><div class="pilwrap"><a href="#section-321" class="pilcrow">&#182;</a></div><p>hash direction, property, and bnode name/hash</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">md</span> <span class="o">=</span> <span class="nx">sha1</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>
      <span class="nx">md</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">direction</span><span class="p">);</span>
      <span class="nx">md</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">quad</span><span class="p">.</span><span class="nx">predicate</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
      <span class="nx">md</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">groupHash</span> <span class="o">=</span> <span class="nx">md</span><span class="p">.</span><span class="nx">digest</span><span class="p">();</span></pre></div></td></tr><tr id="section-322"><td class="docs"><div class="pilwrap"><a href="#section-322" class="pilcrow">&#182;</a></div><p>add bnode to hash group</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">groupHash</span> <span class="k">in</span> <span class="nx">groups</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">groups</span><span class="p">[</span><span class="nx">groupHash</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">bnode</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">groups</span><span class="p">[</span><span class="nx">groupHash</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">bnode</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">jsonld</span><span class="p">.</span><span class="nx">setImmediate</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">groupNodes</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);});</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-323"><td class="docs"><div class="pilwrap"><a href="#section-323" class="pilcrow">&#182;</a></div><p>hashes a group of adjacent bnodes</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">hashGroup</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="nx">groupHashes</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-324"><td class="docs"><div class="pilwrap"><a href="#section-324" class="pilcrow">&#182;</a></div><p>done, return SHA-1 digest and path namer</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span><span class="nx">hash</span><span class="o">:</span> <span class="nx">md</span><span class="p">.</span><span class="nx">digest</span><span class="p">(),</span> <span class="nx">pathNamer</span><span class="o">:</span> <span class="nx">pathNamer</span><span class="p">});</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-325"><td class="docs"><div class="pilwrap"><a href="#section-325" class="pilcrow">&#182;</a></div><p>digest group hash</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">groupHash</span> <span class="o">=</span> <span class="nx">groupHashes</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="nx">md</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">groupHash</span><span class="p">);</span></pre></div></td></tr><tr id="section-326"><td class="docs"><div class="pilwrap"><a href="#section-326" class="pilcrow">&#182;</a></div><p>choose a path and namer from the permutations</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">chosenPath</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">chosenNamer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">permutator</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Permutator</span><span class="p">(</span><span class="nx">groups</span><span class="p">[</span><span class="nx">groupHash</span><span class="p">]);</span>
    <span class="nx">jsonld</span><span class="p">.</span><span class="nx">setImmediate</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">permutate</span><span class="p">();});</span>
    <span class="kd">function</span> <span class="nx">permutate</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">permutation</span> <span class="o">=</span> <span class="nx">permutator</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">pathNamerCopy</span> <span class="o">=</span> <span class="nx">pathNamer</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span></pre></div></td></tr><tr id="section-327"><td class="docs"><div class="pilwrap"><a href="#section-327" class="pilcrow">&#182;</a></div><p>build adjacent path</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">recurse</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">n</span> <span class="k">in</span> <span class="nx">permutation</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">bnode</span> <span class="o">=</span> <span class="nx">permutation</span><span class="p">[</span><span class="nx">n</span><span class="p">];</span></pre></div></td></tr><tr id="section-328"><td class="docs"><div class="pilwrap"><a href="#section-328" class="pilcrow">&#182;</a></div><p>use canonical name if available</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">namer</span><span class="p">.</span><span class="nx">isNamed</span><span class="p">(</span><span class="nx">bnode</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">path</span> <span class="o">+=</span> <span class="nx">namer</span><span class="p">.</span><span class="nx">getName</span><span class="p">(</span><span class="nx">bnode</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-329"><td class="docs"><div class="pilwrap"><a href="#section-329" class="pilcrow">&#182;</a></div><p>recurse if bnode isn't named in the path yet</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">pathNamerCopy</span><span class="p">.</span><span class="nx">isNamed</span><span class="p">(</span><span class="nx">bnode</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">recurse</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">bnode</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="nx">path</span> <span class="o">+=</span> <span class="nx">pathNamerCopy</span><span class="p">.</span><span class="nx">getName</span><span class="p">(</span><span class="nx">bnode</span><span class="p">);</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-330"><td class="docs"><div class="pilwrap"><a href="#section-330" class="pilcrow">&#182;</a></div><p>skip permutation if path is already >= chosen path</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">chosenPath</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">path</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="nx">chosenPath</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span>
          <span class="nx">path</span> <span class="o">&gt;</span> <span class="nx">chosenPath</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">nextPermutation</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-331"><td class="docs"><div class="pilwrap"><a href="#section-331" class="pilcrow">&#182;</a></div><p>does the next recursion</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">nextRecursion</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="kd">function</span> <span class="nx">nextRecursion</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">n</span> <span class="o">===</span> <span class="nx">recurse</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-332"><td class="docs"><div class="pilwrap"><a href="#section-332" class="pilcrow">&#182;</a></div><p>done, do next permutation</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">return</span> <span class="nx">nextPermutation</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-333"><td class="docs"><div class="pilwrap"><a href="#section-333" class="pilcrow">&#182;</a></div><p>do recursion</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">bnode</span> <span class="o">=</span> <span class="nx">recurse</span><span class="p">[</span><span class="nx">n</span><span class="p">];</span>
        <span class="nx">_hashPaths</span><span class="p">(</span><span class="nx">bnode</span><span class="p">,</span> <span class="nx">bnodes</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="nx">pathNamerCopy</span><span class="p">,</span>
          <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">path</span> <span class="o">+=</span> <span class="nx">pathNamerCopy</span><span class="p">.</span><span class="nx">getName</span><span class="p">(</span><span class="nx">bnode</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;&#39;</span> <span class="o">+</span> <span class="nx">result</span><span class="p">.</span><span class="nx">hash</span> <span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">;</span>
            <span class="nx">pathNamerCopy</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">pathNamer</span><span class="p">;</span></pre></div></td></tr><tr id="section-334"><td class="docs"><div class="pilwrap"><a href="#section-334" class="pilcrow">&#182;</a></div><p>skip permutation if path is already >= chosen path</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span><span class="p">(</span><span class="nx">chosenPath</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">path</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="nx">chosenPath</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span>
              <span class="nx">path</span> <span class="o">&gt;</span> <span class="nx">chosenPath</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">nextPermutation</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
            <span class="p">}</span></pre></div></td></tr><tr id="section-335"><td class="docs"><div class="pilwrap"><a href="#section-335" class="pilcrow">&#182;</a></div><p>do next recursion</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">nextRecursion</span><span class="p">(</span><span class="nx">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
          <span class="p">});</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-336"><td class="docs"><div class="pilwrap"><a href="#section-336" class="pilcrow">&#182;</a></div><p>stores the results of this permutation and runs the next</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">function</span> <span class="nx">nextPermutation</span><span class="p">(</span><span class="nx">skipped</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">skipped</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">chosenPath</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">path</span> <span class="o">&lt;</span> <span class="nx">chosenPath</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">chosenPath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">;</span>
          <span class="nx">chosenNamer</span> <span class="o">=</span> <span class="nx">pathNamerCopy</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-337"><td class="docs"><div class="pilwrap"><a href="#section-337" class="pilcrow">&#182;</a></div><p>do next permutation</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">permutator</span><span class="p">.</span><span class="nx">hasNext</span><span class="p">())</span> <span class="p">{</span>
          <span class="nx">jsonld</span><span class="p">.</span><span class="nx">setImmediate</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">permutate</span><span class="p">();});</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-338"><td class="docs"><div class="pilwrap"><a href="#section-338" class="pilcrow">&#182;</a></div><p>digest chosen path and update namer</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">md</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">chosenPath</span><span class="p">);</span>
          <span class="nx">pathNamer</span> <span class="o">=</span> <span class="nx">chosenNamer</span><span class="p">;</span></pre></div></td></tr><tr id="section-339"><td class="docs"><div class="pilwrap"><a href="#section-339" class="pilcrow">&#182;</a></div><p>hash the next group</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">hashGroup</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-340"><td class="docs"><div class="pilwrap"><a href="#section-340" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>A helper function that gets the blank node name from an RDF quad node<br />(subject or object). If the node is a blank node and its value<br />does not match the given blank node ID, it will be returned.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">node</span><span>- RDF quad node.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">id</span><span>- ID of the blank node to look next to.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>adjacent blank node name or null if none was found.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_getAdjacentBlankNodeName</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;blank node&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">value</span> <span class="o">!==</span> <span class="nx">id</span> <span class="o">?</span> <span class="nx">node</span><span class="p">.</span><span class="nx">value</span> <span class="o">:</span> <span class="kc">null</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-341"><td class="docs"><div class="pilwrap"><a href="#section-341" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Recursively flattens the subjects in the given JSON-LD expanded input<br />into a node map.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">input</span><span>- JSON-LD expanded input.</span></div><div class="dox_tag_detail"><span>a </span><span class="dox_type">graphs</span><span>- map of graph name to subject map.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">graph</span><span>- name of the current graph.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">namer</span><span>- blank node namer.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">name</span><span>- name assigned to the current input if it is a bnode.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">list</span><span>- list to append to, null for none.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_createNodeMap</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">graphs</span><span class="p">,</span> <span class="nx">graph</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">list</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-342"><td class="docs"><div class="pilwrap"><a href="#section-342" class="pilcrow">&#182;</a></div><p>recurse through array</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">input</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_createNodeMap</span><span class="p">(</span><span class="nx">input</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">graphs</span><span class="p">,</span> <span class="nx">graph</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">list</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-343"><td class="docs"><div class="pilwrap"><a href="#section-343" class="pilcrow">&#182;</a></div><p>add non-object to list</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">input</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">input</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-344"><td class="docs"><div class="pilwrap"><a href="#section-344" class="pilcrow">&#182;</a></div><p>add values to list</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">_isValue</span><span class="p">(</span><span class="nx">input</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@type&#39;</span> <span class="k">in</span> <span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">input</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">];</span></pre></div></td></tr><tr id="section-345"><td class="docs"><div class="pilwrap"><a href="#section-345" class="pilcrow">&#182;</a></div><p>rename @type blank node</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">type</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;_:&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">input</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">namer</span><span class="p">.</span><span class="nx">getName</span><span class="p">(</span><span class="nx">type</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">type</span> <span class="k">in</span> <span class="nx">graphs</span><span class="p">[</span><span class="nx">graph</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nx">graphs</span><span class="p">[</span><span class="nx">graph</span><span class="p">][</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@id&#39;</span><span class="o">:</span> <span class="nx">type</span><span class="p">};</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">input</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-346"><td class="docs"><div class="pilwrap"><a href="#section-346" class="pilcrow">&#182;</a></div><p>Note: At this point, input must be a subject.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-347"><td class="docs"><div class="pilwrap"><a href="#section-347" class="pilcrow">&#182;</a></div><p>get name for subject</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">_isUndefined</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="nx">_isBlankNode</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span> <span class="o">?</span> <span class="nx">namer</span><span class="p">.</span><span class="nx">getName</span><span class="p">(</span><span class="nx">input</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">])</span> <span class="o">:</span> <span class="nx">input</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">];</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-348"><td class="docs"><div class="pilwrap"><a href="#section-348" class="pilcrow">&#182;</a></div><p>add subject reference to list</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">list</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="s1">&#39;@id&#39;</span><span class="o">:</span> <span class="nx">name</span><span class="p">});</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-349"><td class="docs"><div class="pilwrap"><a href="#section-349" class="pilcrow">&#182;</a></div><p>create new subject or merge into existing one</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">subjects</span> <span class="o">=</span> <span class="nx">graphs</span><span class="p">[</span><span class="nx">graph</span><span class="p">];</span>
  <span class="kd">var</span> <span class="nx">subject</span> <span class="o">=</span> <span class="nx">subjects</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">subjects</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="nx">subject</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">properties</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">input</span><span class="p">).</span><span class="nx">sort</span><span class="p">();</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">pi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">pi</span> <span class="o">&lt;</span> <span class="nx">properties</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">pi</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">property</span> <span class="o">=</span> <span class="nx">properties</span><span class="p">[</span><span class="nx">pi</span><span class="p">];</span></pre></div></td></tr><tr id="section-350"><td class="docs"><div class="pilwrap"><a href="#section-350" class="pilcrow">&#182;</a></div><p>skip @id</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">property</span> <span class="o">===</span> <span class="s1">&#39;@id&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-351"><td class="docs"><div class="pilwrap"><a href="#section-351" class="pilcrow">&#182;</a></div><p>handle reverse properties</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">property</span> <span class="o">===</span> <span class="s1">&#39;@reverse&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">referencedNode</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@id&#39;</span><span class="o">:</span> <span class="nx">name</span><span class="p">};</span>
      <span class="kd">var</span> <span class="nx">reverseMap</span> <span class="o">=</span> <span class="nx">input</span><span class="p">[</span><span class="s1">&#39;@reverse&#39;</span><span class="p">];</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">reverseProperty</span> <span class="k">in</span> <span class="nx">reverseMap</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">items</span> <span class="o">=</span> <span class="nx">reverseMap</span><span class="p">[</span><span class="nx">reverseProperty</span><span class="p">];</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ii</span> <span class="o">&lt;</span> <span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">ii</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">items</span><span class="p">[</span><span class="nx">ii</span><span class="p">];</span>
          <span class="nx">jsonld</span><span class="p">.</span><span class="nx">addValue</span><span class="p">(</span>
            <span class="nx">item</span><span class="p">,</span> <span class="nx">reverseProperty</span><span class="p">,</span> <span class="nx">referencedNode</span><span class="p">,</span>
            <span class="p">{</span><span class="nx">propertyIsArray</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">allowDuplicate</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
          <span class="nx">_createNodeMap</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">graphs</span><span class="p">,</span> <span class="nx">graph</span><span class="p">,</span> <span class="nx">namer</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-352"><td class="docs"><div class="pilwrap"><a href="#section-352" class="pilcrow">&#182;</a></div><p>recurse into graph</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">property</span> <span class="o">===</span> <span class="s1">&#39;@graph&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-353"><td class="docs"><div class="pilwrap"><a href="#section-353" class="pilcrow">&#182;</a></div><p>add graph subjects map entry</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">name</span> <span class="k">in</span> <span class="nx">graphs</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">graphs</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">g</span> <span class="o">=</span> <span class="p">(</span><span class="nx">graph</span> <span class="o">===</span> <span class="s1">&#39;@merged&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">graph</span> <span class="o">:</span> <span class="nx">name</span><span class="p">;</span>
      <span class="nx">_createNodeMap</span><span class="p">(</span><span class="nx">input</span><span class="p">[</span><span class="nx">property</span><span class="p">],</span> <span class="nx">graphs</span><span class="p">,</span> <span class="nx">g</span><span class="p">,</span> <span class="nx">namer</span><span class="p">);</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-354"><td class="docs"><div class="pilwrap"><a href="#section-354" class="pilcrow">&#182;</a></div><p>copy non-@type keywords</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">property</span> <span class="o">!==</span> <span class="s1">&#39;@type&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">_isKeyword</span><span class="p">(</span><span class="nx">property</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">property</span> <span class="o">===</span> <span class="s1">&#39;@index&#39;</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;@index&#39;</span> <span class="k">in</span> <span class="nx">subject</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
          <span class="s1">&#39;Invalid JSON-LD syntax; conflicting @index property detected.&#39;</span><span class="p">,</span>
          <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">subject</span><span class="o">:</span> <span class="nx">subject</span><span class="p">});</span>
      <span class="p">}</span>
      <span class="nx">subject</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">=</span> <span class="nx">input</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-355"><td class="docs"><div class="pilwrap"><a href="#section-355" class="pilcrow">&#182;</a></div><p>iterate over objects</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">objects</span> <span class="o">=</span> <span class="nx">input</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span></pre></div></td></tr><tr id="section-356"><td class="docs"><div class="pilwrap"><a href="#section-356" class="pilcrow">&#182;</a></div><p>if property is a bnode, assign it a new id</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">property</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;_:&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">property</span> <span class="o">=</span> <span class="nx">namer</span><span class="p">.</span><span class="nx">getName</span><span class="p">(</span><span class="nx">property</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-357"><td class="docs"><div class="pilwrap"><a href="#section-357" class="pilcrow">&#182;</a></div><p>ensure property is added for empty arrays</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">objects</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">jsonld</span><span class="p">.</span><span class="nx">addValue</span><span class="p">(</span><span class="nx">subject</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="p">[],</span> <span class="p">{</span><span class="nx">propertyIsArray</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">oi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">oi</span> <span class="o">&lt;</span> <span class="nx">objects</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">oi</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="nx">objects</span><span class="p">[</span><span class="nx">oi</span><span class="p">];</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">property</span> <span class="o">===</span> <span class="s1">&#39;@type&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-358"><td class="docs"><div class="pilwrap"><a href="#section-358" class="pilcrow">&#182;</a></div><p>rename @type blank nodes</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">o</span> <span class="o">=</span> <span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;_:&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="nx">namer</span><span class="p">.</span><span class="nx">getName</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="o">:</span> <span class="nx">o</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">o</span> <span class="k">in</span> <span class="nx">graphs</span><span class="p">[</span><span class="nx">graph</span><span class="p">]))</span> <span class="p">{</span>
          <span class="nx">graphs</span><span class="p">[</span><span class="nx">graph</span><span class="p">][</span><span class="nx">o</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@id&#39;</span><span class="o">:</span> <span class="nx">o</span><span class="p">};</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-359"><td class="docs"><div class="pilwrap"><a href="#section-359" class="pilcrow">&#182;</a></div><p>handle embedded subject or subject reference</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">_isSubject</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="o">||</span> <span class="nx">_isSubjectReference</span><span class="p">(</span><span class="nx">o</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-360"><td class="docs"><div class="pilwrap"><a href="#section-360" class="pilcrow">&#182;</a></div><p>rename blank node @id</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">_isBlankNode</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="o">?</span> <span class="nx">namer</span><span class="p">.</span><span class="nx">getName</span><span class="p">(</span><span class="nx">o</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">])</span> <span class="o">:</span> <span class="nx">o</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">];</span></pre></div></td></tr><tr id="section-361"><td class="docs"><div class="pilwrap"><a href="#section-361" class="pilcrow">&#182;</a></div><p>add reference and recurse</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">jsonld</span><span class="p">.</span><span class="nx">addValue</span><span class="p">(</span>
          <span class="nx">subject</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;@id&#39;</span><span class="o">:</span> <span class="nx">id</span><span class="p">},</span>
          <span class="p">{</span><span class="nx">propertyIsArray</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">allowDuplicate</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
        <span class="nx">_createNodeMap</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">graphs</span><span class="p">,</span> <span class="nx">graph</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-362"><td class="docs"><div class="pilwrap"><a href="#section-362" class="pilcrow">&#182;</a></div><p>handle @list</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">_isList</span><span class="p">(</span><span class="nx">o</span><span class="p">))</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_list</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nx">_createNodeMap</span><span class="p">(</span><span class="nx">o</span><span class="p">[</span><span class="s1">&#39;@list&#39;</span><span class="p">],</span> <span class="nx">graphs</span><span class="p">,</span> <span class="nx">graph</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">_list</span><span class="p">);</span>
        <span class="nx">o</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@list&#39;</span><span class="o">:</span> <span class="nx">_list</span><span class="p">};</span>
        <span class="nx">jsonld</span><span class="p">.</span><span class="nx">addValue</span><span class="p">(</span>
          <span class="nx">subject</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">o</span><span class="p">,</span>
          <span class="p">{</span><span class="nx">propertyIsArray</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">allowDuplicate</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-363"><td class="docs"><div class="pilwrap"><a href="#section-363" class="pilcrow">&#182;</a></div><p>handle @value</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">_createNodeMap</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">graphs</span><span class="p">,</span> <span class="nx">graph</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">jsonld</span><span class="p">.</span><span class="nx">addValue</span><span class="p">(</span>
          <span class="nx">subject</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">o</span><span class="p">,</span> <span class="p">{</span><span class="nx">propertyIsArray</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">allowDuplicate</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-364"><td class="docs"><div class="pilwrap"><a href="#section-364" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Frames subjects according to the given frame.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">state</span><span>- current framing state.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">subjects</span><span>- subjects to filter.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">frame</span><span>- frame.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">parent</span><span>- parent subject or top-level array.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">property</span><span>- parent property, initialized to null.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_frame</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">subjects</span><span class="p">,</span> <span class="nx">frame</span><span class="p">,</span> <span class="nx">parent</span><span class="p">,</span> <span class="nx">property</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-365"><td class="docs"><div class="pilwrap"><a href="#section-365" class="pilcrow">&#182;</a></div><p>validate the frame</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">_validateFrame</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">frame</span><span class="p">);</span>
  <span class="nx">frame</span> <span class="o">=</span> <span class="nx">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span></pre></div></td></tr><tr id="section-366"><td class="docs"><div class="pilwrap"><a href="#section-366" class="pilcrow">&#182;</a></div><p>filter out subjects that match the frame</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">matches</span> <span class="o">=</span> <span class="nx">_filterSubjects</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">subjects</span><span class="p">,</span> <span class="nx">frame</span><span class="p">);</span></pre></div></td></tr><tr id="section-367"><td class="docs"><div class="pilwrap"><a href="#section-367" class="pilcrow">&#182;</a></div><p>get flags for current frame</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">options</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">embedOn</span> <span class="o">=</span> <span class="nx">_getFrameFlag</span><span class="p">(</span><span class="nx">frame</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="s1">&#39;embed&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">explicitOn</span> <span class="o">=</span> <span class="nx">_getFrameFlag</span><span class="p">(</span><span class="nx">frame</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="s1">&#39;explicit&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-368"><td class="docs"><div class="pilwrap"><a href="#section-368" class="pilcrow">&#182;</a></div><p>add matches to output</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">ids</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">matches</span><span class="p">).</span><span class="nx">sort</span><span class="p">();</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">idx</span> <span class="k">in</span> <span class="nx">ids</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">ids</span><span class="p">[</span><span class="nx">idx</span><span class="p">];</span></pre></div></td></tr><tr id="section-369"><td class="docs"><div class="pilwrap"><a href="#section-369" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Note: In order to treat each top-level match as a compartmentalized<br />    result, create an independent copy of the embedded subjects map when the<br />    property is null, which only occurs at the top-level.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">property</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">embeds</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-370"><td class="docs"><div class="pilwrap"><a href="#section-370" class="pilcrow">&#182;</a></div><p>start output</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">output</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span></pre></div></td></tr><tr id="section-371"><td class="docs"><div class="pilwrap"><a href="#section-371" class="pilcrow">&#182;</a></div><p>prepare embed meta info</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">embed</span> <span class="o">=</span> <span class="p">{</span><span class="nx">parent</span><span class="o">:</span> <span class="nx">parent</span><span class="p">,</span> <span class="nx">property</span><span class="o">:</span> <span class="nx">property</span><span class="p">};</span></pre></div></td></tr><tr id="section-372"><td class="docs"><div class="pilwrap"><a href="#section-372" class="pilcrow">&#182;</a></div><p>if embed is on and there is an existing embed</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">embedOn</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">id</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">embeds</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-373"><td class="docs"><div class="pilwrap"><a href="#section-373" class="pilcrow">&#182;</a></div><p>only overwrite an existing embed if it has already been added to its
parent -- otherwise its parent is somewhere up the tree from this
embed and the embed would occur twice once the tree is added</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">embedOn</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div></td></tr><tr id="section-374"><td class="docs"><div class="pilwrap"><a href="#section-374" class="pilcrow">&#182;</a></div><p>existing embed's parent is an array</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">existing</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">embeds</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">existing</span><span class="p">.</span><span class="nx">parent</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">existing</span><span class="p">.</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">jsonld</span><span class="p">.</span><span class="nx">compareValues</span><span class="p">(</span><span class="nx">output</span><span class="p">,</span> <span class="nx">existing</span><span class="p">.</span><span class="nx">parent</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nx">embedOn</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-375"><td class="docs"><div class="pilwrap"><a href="#section-375" class="pilcrow">&#182;</a></div><p>existing embed's parent is an object</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">jsonld</span><span class="p">.</span><span class="nx">hasValue</span><span class="p">(</span><span class="nx">existing</span><span class="p">.</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">existing</span><span class="p">.</span><span class="nx">property</span><span class="p">,</span> <span class="nx">output</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">embedOn</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-376"><td class="docs"><div class="pilwrap"><a href="#section-376" class="pilcrow">&#182;</a></div><p>existing embed has already been added, so allow an overwrite</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">embedOn</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_removeEmbed</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-377"><td class="docs"><div class="pilwrap"><a href="#section-377" class="pilcrow">&#182;</a></div><p>not embedding, add output without any other properties</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">embedOn</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_addFrameOutput</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">parent</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">output</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-378"><td class="docs"><div class="pilwrap"><a href="#section-378" class="pilcrow">&#182;</a></div><p>add embed meta info</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">state</span><span class="p">.</span><span class="nx">embeds</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">embed</span><span class="p">;</span></pre></div></td></tr><tr id="section-379"><td class="docs"><div class="pilwrap"><a href="#section-379" class="pilcrow">&#182;</a></div><p>iterate over subject properties</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">subject</span> <span class="o">=</span> <span class="nx">matches</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">props</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">subject</span><span class="p">).</span><span class="nx">sort</span><span class="p">();</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">prop</span> <span class="o">=</span> <span class="nx">props</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span></pre></div></td></tr><tr id="section-380"><td class="docs"><div class="pilwrap"><a href="#section-380" class="pilcrow">&#182;</a></div><p>copy keywords to output</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">_isKeyword</span><span class="p">(</span><span class="nx">prop</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">output</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_clone</span><span class="p">(</span><span class="nx">subject</span><span class="p">[</span><span class="nx">prop</span><span class="p">]);</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-381"><td class="docs"><div class="pilwrap"><a href="#section-381" class="pilcrow">&#182;</a></div><p>if property isn't in the frame</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">prop</span> <span class="k">in</span> <span class="nx">frame</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-382"><td class="docs"><div class="pilwrap"><a href="#section-382" class="pilcrow">&#182;</a></div><p>if explicit is off, embed values</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">explicitOn</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">_embedValues</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">subject</span><span class="p">,</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">output</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-383"><td class="docs"><div class="pilwrap"><a href="#section-383" class="pilcrow">&#182;</a></div><p>add objects</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">objects</span> <span class="o">=</span> <span class="nx">subject</span><span class="p">[</span><span class="nx">prop</span><span class="p">];</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">objects</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="nx">objects</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span></pre></div></td></tr><tr id="section-384"><td class="docs"><div class="pilwrap"><a href="#section-384" class="pilcrow">&#182;</a></div><p>recurse into list</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">if</span><span class="p">(</span><span class="nx">_isList</span><span class="p">(</span><span class="nx">o</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-385"><td class="docs"><div class="pilwrap"><a href="#section-385" class="pilcrow">&#182;</a></div><p>add empty list</p>
</td><td class="code"><div class="highlight"><pre>            <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@list&#39;</span><span class="o">:</span> <span class="p">[]};</span>
            <span class="nx">_addFrameOutput</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">output</span><span class="p">,</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">list</span><span class="p">);</span></pre></div></td></tr><tr id="section-386"><td class="docs"><div class="pilwrap"><a href="#section-386" class="pilcrow">&#182;</a></div><p>add list objects</p>
</td><td class="code"><div class="highlight"><pre>            <span class="kd">var</span> <span class="nx">src</span> <span class="o">=</span> <span class="nx">o</span><span class="p">[</span><span class="s1">&#39;@list&#39;</span><span class="p">];</span>
            <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">n</span> <span class="k">in</span> <span class="nx">src</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">o</span> <span class="o">=</span> <span class="nx">src</span><span class="p">[</span><span class="nx">n</span><span class="p">];</span></pre></div></td></tr><tr id="section-387"><td class="docs"><div class="pilwrap"><a href="#section-387" class="pilcrow">&#182;</a></div><p>recurse into subject reference</p>
</td><td class="code"><div class="highlight"><pre>              <span class="k">if</span><span class="p">(</span><span class="nx">_isSubjectReference</span><span class="p">(</span><span class="nx">o</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">_frame</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="p">[</span><span class="nx">o</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">]],</span> <span class="nx">frame</span><span class="p">[</span><span class="nx">prop</span><span class="p">],</span> <span class="nx">list</span><span class="p">,</span> <span class="s1">&#39;@list&#39;</span><span class="p">);</span>
              <span class="p">}</span></pre></div></td></tr><tr id="section-388"><td class="docs"><div class="pilwrap"><a href="#section-388" class="pilcrow">&#182;</a></div><p>include other values automatically</p>
</td><td class="code"><div class="highlight"><pre>              <span class="k">else</span> <span class="p">{</span>
                <span class="nx">_addFrameOutput</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">list</span><span class="p">,</span> <span class="s1">&#39;@list&#39;</span><span class="p">,</span> <span class="nx">_clone</span><span class="p">(</span><span class="nx">o</span><span class="p">));</span>
              <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">continue</span><span class="p">;</span>
          <span class="p">}</span></pre></div></td></tr><tr id="section-389"><td class="docs"><div class="pilwrap"><a href="#section-389" class="pilcrow">&#182;</a></div><p>recurse into subject reference</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">if</span><span class="p">(</span><span class="nx">_isSubjectReference</span><span class="p">(</span><span class="nx">o</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">_frame</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="p">[</span><span class="nx">o</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">]],</span> <span class="nx">frame</span><span class="p">[</span><span class="nx">prop</span><span class="p">],</span> <span class="nx">output</span><span class="p">,</span> <span class="nx">prop</span><span class="p">);</span>
          <span class="p">}</span></pre></div></td></tr><tr id="section-390"><td class="docs"><div class="pilwrap"><a href="#section-390" class="pilcrow">&#182;</a></div><p>include other values automatically</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">else</span> <span class="p">{</span>
            <span class="nx">_addFrameOutput</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">output</span><span class="p">,</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">_clone</span><span class="p">(</span><span class="nx">o</span><span class="p">));</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-391"><td class="docs"><div class="pilwrap"><a href="#section-391" class="pilcrow">&#182;</a></div><p>handle defaults</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">props</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">frame</span><span class="p">).</span><span class="nx">sort</span><span class="p">();</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">prop</span> <span class="o">=</span> <span class="nx">props</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span></pre></div></td></tr><tr id="section-392"><td class="docs"><div class="pilwrap"><a href="#section-392" class="pilcrow">&#182;</a></div><p>skip keywords</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">_isKeyword</span><span class="p">(</span><span class="nx">prop</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-393"><td class="docs"><div class="pilwrap"><a href="#section-393" class="pilcrow">&#182;</a></div><p>if omit default is off, then include default values for properties
that appear in the next frame but are not in the matching subject</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">frame</span><span class="p">[</span><span class="nx">prop</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">omitDefaultOn</span> <span class="o">=</span> <span class="nx">_getFrameFlag</span><span class="p">(</span><span class="nx">next</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="s1">&#39;omitDefault&#39;</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">omitDefaultOn</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">prop</span> <span class="k">in</span> <span class="nx">output</span><span class="p">))</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">preserve</span> <span class="o">=</span> <span class="s1">&#39;@null&#39;</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@default&#39;</span> <span class="k">in</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">preserve</span> <span class="o">=</span> <span class="nx">_clone</span><span class="p">(</span><span class="nx">next</span><span class="p">[</span><span class="s1">&#39;@default&#39;</span><span class="p">]);</span>
          <span class="p">}</span>
          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">preserve</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">preserve</span> <span class="o">=</span> <span class="p">[</span><span class="nx">preserve</span><span class="p">];</span>
          <span class="p">}</span>
          <span class="nx">output</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;@preserve&#39;</span><span class="o">:</span> <span class="nx">preserve</span><span class="p">}];</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-394"><td class="docs"><div class="pilwrap"><a href="#section-394" class="pilcrow">&#182;</a></div><p>add output to parent</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">_addFrameOutput</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">parent</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">output</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-395"><td class="docs"><div class="pilwrap"><a href="#section-395" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Gets the frame flag value for the given flag name.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">frame</span><span>- frame.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">options</span><span>- framing options.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">name</span><span>- flag name.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>flag value.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_getFrameFlag</span><span class="p">(</span><span class="nx">frame</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">flag</span> <span class="o">=</span> <span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="nx">name</span><span class="p">;</span>
  <span class="k">return</span> <span class="p">(</span><span class="nx">flag</span> <span class="k">in</span> <span class="nx">frame</span><span class="p">)</span> <span class="o">?</span> <span class="nx">frame</span><span class="p">[</span><span class="nx">flag</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="nx">options</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-396"><td class="docs"><div class="pilwrap"><a href="#section-396" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Validates a JSON-LD frame, throwing an exception if the frame is invalid.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">state</span><span>- current frame state.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">frame</span><span>- frame to validate.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_validateFrame</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">frame</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">frame</span><span class="p">)</span> <span class="o">||</span> <span class="nx">frame</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mi">1</span> <span class="o">||</span> <span class="o">!</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
      <span class="s1">&#39;Invalid JSON-LD syntax; a JSON-LD frame must be a single object.&#39;</span><span class="p">,</span>
      <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">frame</span><span class="o">:</span> <span class="nx">frame</span><span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-397"><td class="docs"><div class="pilwrap"><a href="#section-397" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Returns a map of all of the subjects that match a parsed frame.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">state</span><span>- current framing state.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">subjects</span><span>- set of subjects to filter.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">frame</span><span>- parsed frame.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">all</span><span>of the matched subjects.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_filterSubjects</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">subjects</span><span class="p">,</span> <span class="nx">frame</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-398"><td class="docs"><div class="pilwrap"><a href="#section-398" class="pilcrow">&#182;</a></div><p>filter subjects in @id order</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">subjects</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">subjects</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">subject</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">subjects</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">_filterSubject</span><span class="p">(</span><span class="nx">subject</span><span class="p">,</span> <span class="nx">frame</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">rval</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">subject</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-399"><td class="docs"><div class="pilwrap"><a href="#section-399" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Returns true if the given subject matches the given frame.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">subject</span><span>- subject to check.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">frame</span><span>- frame to check.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">true</span><span>if the subject matches, false if not.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_filterSubject</span><span class="p">(</span><span class="nx">subject</span><span class="p">,</span> <span class="nx">frame</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-400"><td class="docs"><div class="pilwrap"><a href="#section-400" class="pilcrow">&#182;</a></div><p>check @type (object value means 'any' type, fall through to ducktyping)</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@type&#39;</span> <span class="k">in</span> <span class="nx">frame</span> <span class="o">&amp;&amp;</span>
    <span class="o">!</span><span class="p">(</span><span class="nx">frame</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">].</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">_isObject</span><span class="p">(</span><span class="nx">frame</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])))</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">types</span> <span class="o">=</span> <span class="nx">frame</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">];</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">types</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-401"><td class="docs"><div class="pilwrap"><a href="#section-401" class="pilcrow">&#182;</a></div><p>any matching @type is a match</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">jsonld</span><span class="p">.</span><span class="nx">hasValue</span><span class="p">(</span><span class="nx">subject</span><span class="p">,</span> <span class="s1">&#39;@type&#39;</span><span class="p">,</span> <span class="nx">types</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-402"><td class="docs"><div class="pilwrap"><a href="#section-402" class="pilcrow">&#182;</a></div><p>check ducktype</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">frame</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-403"><td class="docs"><div class="pilwrap"><a href="#section-403" class="pilcrow">&#182;</a></div><p>only not a duck if @id or non-keyword isn't in subject</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">((</span><span class="nx">key</span> <span class="o">===</span> <span class="s1">&#39;@id&#39;</span> <span class="o">||</span> <span class="o">!</span><span class="nx">_isKeyword</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">subject</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-404"><td class="docs"><div class="pilwrap"><a href="#section-404" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Embeds values for the given subject and property into the given output<br />during the framing algorithm.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">state</span><span>- current framing state.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">subject</span><span>- subject.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">property</span><span>- property.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">output</span><span>- output.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_embedValues</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">subject</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-405"><td class="docs"><div class="pilwrap"><a href="#section-405" class="pilcrow">&#182;</a></div><p>embed subject properties in output</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">objects</span> <span class="o">=</span> <span class="nx">subject</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">objects</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="nx">objects</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span></pre></div></td></tr><tr id="section-406"><td class="docs"><div class="pilwrap"><a href="#section-406" class="pilcrow">&#182;</a></div><p>recurse into @list</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">_isList</span><span class="p">(</span><span class="nx">o</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@list&#39;</span><span class="o">:</span> <span class="p">[]};</span>
      <span class="nx">_addFrameOutput</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">output</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">list</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">_embedValues</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">o</span><span class="p">,</span> <span class="s1">&#39;@list&#39;</span><span class="p">,</span> <span class="nx">list</span><span class="p">[</span><span class="s1">&#39;@list&#39;</span><span class="p">]);</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-407"><td class="docs"><div class="pilwrap"><a href="#section-407" class="pilcrow">&#182;</a></div><p>handle subject reference</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">_isSubjectReference</span><span class="p">(</span><span class="nx">o</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">o</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">];</span></pre></div></td></tr><tr id="section-408"><td class="docs"><div class="pilwrap"><a href="#section-408" class="pilcrow">&#182;</a></div><p>embed full subject if isn't already embedded</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">id</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">embeds</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-409"><td class="docs"><div class="pilwrap"><a href="#section-409" class="pilcrow">&#182;</a></div><p>add embed</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">embed</span> <span class="o">=</span> <span class="p">{</span><span class="nx">parent</span><span class="o">:</span> <span class="nx">output</span><span class="p">,</span> <span class="nx">property</span><span class="o">:</span> <span class="nx">property</span><span class="p">};</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">embeds</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">embed</span><span class="p">;</span></pre></div></td></tr><tr id="section-410"><td class="docs"><div class="pilwrap"><a href="#section-410" class="pilcrow">&#182;</a></div><p>recurse into subject</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">o</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">subjects</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">s</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-411"><td class="docs"><div class="pilwrap"><a href="#section-411" class="pilcrow">&#182;</a></div><p>copy keywords</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">if</span><span class="p">(</span><span class="nx">_isKeyword</span><span class="p">(</span><span class="nx">prop</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">o</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_clone</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">prop</span><span class="p">]);</span>
            <span class="k">continue</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">_embedValues</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">o</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">_addFrameOutput</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">output</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">o</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-412"><td class="docs"><div class="pilwrap"><a href="#section-412" class="pilcrow">&#182;</a></div><p>copy non-subject value</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">_addFrameOutput</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">output</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">_clone</span><span class="p">(</span><span class="nx">o</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-413"><td class="docs"><div class="pilwrap"><a href="#section-413" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Removes an existing embed.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">state</span><span>- current framing state.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">id</span><span>- @id of the embed to remove.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_removeEmbed</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-414"><td class="docs"><div class="pilwrap"><a href="#section-414" class="pilcrow">&#182;</a></div><p>get existing embed</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">embeds</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">embeds</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">embed</span> <span class="o">=</span> <span class="nx">embeds</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
  <span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">embed</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">property</span> <span class="o">=</span> <span class="nx">embed</span><span class="p">.</span><span class="nx">property</span><span class="p">;</span></pre></div></td></tr><tr id="section-415"><td class="docs"><div class="pilwrap"><a href="#section-415" class="pilcrow">&#182;</a></div><p>create reference to replace embed</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">subject</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@id&#39;</span><span class="o">:</span> <span class="nx">id</span><span class="p">};</span></pre></div></td></tr><tr id="section-416"><td class="docs"><div class="pilwrap"><a href="#section-416" class="pilcrow">&#182;</a></div><p>remove existing embed</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">parent</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-417"><td class="docs"><div class="pilwrap"><a href="#section-417" class="pilcrow">&#182;</a></div><p>replace subject with reference</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">jsonld</span><span class="p">.</span><span class="nx">compareValues</span><span class="p">(</span><span class="nx">parent</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">subject</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">parent</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">subject</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-418"><td class="docs"><div class="pilwrap"><a href="#section-418" class="pilcrow">&#182;</a></div><p>replace subject with reference</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">useArray</span> <span class="o">=</span> <span class="nx">_isArray</span><span class="p">(</span><span class="nx">parent</span><span class="p">[</span><span class="nx">property</span><span class="p">]);</span>
    <span class="nx">jsonld</span><span class="p">.</span><span class="nx">removeValue</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">subject</span><span class="p">,</span> <span class="p">{</span><span class="nx">propertyIsArray</span><span class="o">:</span> <span class="nx">useArray</span><span class="p">});</span>
    <span class="nx">jsonld</span><span class="p">.</span><span class="nx">addValue</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">subject</span><span class="p">,</span> <span class="p">{</span><span class="nx">propertyIsArray</span><span class="o">:</span> <span class="nx">useArray</span><span class="p">});</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-419"><td class="docs"><div class="pilwrap"><a href="#section-419" class="pilcrow">&#182;</a></div><p>recursively remove dependent dangling embeds</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">removeDependents</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-420"><td class="docs"><div class="pilwrap"><a href="#section-420" class="pilcrow">&#182;</a></div><p>get embed keys as a separate array to enable deleting keys in map</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">ids</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">embeds</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">ids</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">ids</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">next</span> <span class="k">in</span> <span class="nx">embeds</span> <span class="o">&amp;&amp;</span> <span class="nx">_isObject</span><span class="p">(</span><span class="nx">embeds</span><span class="p">[</span><span class="nx">next</span><span class="p">].</span><span class="nx">parent</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="nx">embeds</span><span class="p">[</span><span class="nx">next</span><span class="p">].</span><span class="nx">parent</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">delete</span> <span class="nx">embeds</span><span class="p">[</span><span class="nx">next</span><span class="p">];</span>
        <span class="nx">removeDependents</span><span class="p">(</span><span class="nx">next</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>
  <span class="nx">removeDependents</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-421"><td class="docs"><div class="pilwrap"><a href="#section-421" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Adds framing output to the given parent.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">state</span><span>- current framing state.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">parent</span><span>- parent to add to.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">property</span><span>- parent property.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">output</span><span>- output to add.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_addFrameOutput</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">parent</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">parent</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">jsonld</span><span class="p">.</span><span class="nx">addValue</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">output</span><span class="p">,</span> <span class="p">{</span><span class="nx">propertyIsArray</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">parent</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">output</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-422"><td class="docs"><div class="pilwrap"><a href="#section-422" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Removes the @preserve keywords as the last step of the framing algorithm.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">ctx</span><span>- active context used to compact the input.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">input</span><span>- framed, compacted output.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">options</span><span>- compaction options used.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>resulting output.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_removePreserve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">input</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-423"><td class="docs"><div class="pilwrap"><a href="#section-423" class="pilcrow">&#182;</a></div><p>recurse through arrays</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">input</span><span class="p">))</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">_removePreserve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">input</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">options</span><span class="p">);</span></pre></div></td></tr><tr id="section-424"><td class="docs"><div class="pilwrap"><a href="#section-424" class="pilcrow">&#182;</a></div><p>drop nulls from arrays</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">result</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">input</span> <span class="o">=</span> <span class="nx">output</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">input</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-425"><td class="docs"><div class="pilwrap"><a href="#section-425" class="pilcrow">&#182;</a></div><p>remove @preserve</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@preserve&#39;</span> <span class="k">in</span> <span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">input</span><span class="p">[</span><span class="s1">&#39;@preserve&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;@null&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">input</span><span class="p">[</span><span class="s1">&#39;@preserve&#39;</span><span class="p">];</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-426"><td class="docs"><div class="pilwrap"><a href="#section-426" class="pilcrow">&#182;</a></div><p>skip @values</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">_isValue</span><span class="p">(</span><span class="nx">input</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">input</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-427"><td class="docs"><div class="pilwrap"><a href="#section-427" class="pilcrow">&#182;</a></div><p>recurse through @lists</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">_isList</span><span class="p">(</span><span class="nx">input</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">input</span><span class="p">[</span><span class="s1">&#39;@list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_removePreserve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">input</span><span class="p">[</span><span class="s1">&#39;@list&#39;</span><span class="p">],</span> <span class="nx">options</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">input</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-428"><td class="docs"><div class="pilwrap"><a href="#section-428" class="pilcrow">&#182;</a></div><p>recurse through properties</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">_removePreserve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">input</span><span class="p">[</span><span class="nx">prop</span><span class="p">],</span> <span class="nx">options</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">container</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">getContextValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">prop</span><span class="p">,</span> <span class="s1">&#39;@container&#39;</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">compactArrays</span> <span class="o">&amp;&amp;</span> <span class="nx">_isArray</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">result</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
        <span class="nx">container</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="nx">input</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">input</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-429"><td class="docs"><div class="pilwrap"><a href="#section-429" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Compares two strings first based on length and then lexicographically.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">a</span><span>- first string.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">b</span><span>- second string.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">-1</span><span>if a &lt; b, 1 if a &gt; b, 0 if a == b.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_compareShortestLeast</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">(</span><span class="nx">a</span> <span class="o">&lt;</span> <span class="nx">b</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-430"><td class="docs"><div class="pilwrap"><a href="#section-430" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Picks the preferred compaction term from the given inverse context entry.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">activeCtx</span><span>- active context.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">iri</span><span>- IRI to pick the term for.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">value</span><span>- value to pick the term for.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">containers</span><span>- preferred containers.</span></div><div class="dox_tag_detail"><span>either </span><span class="dox_type">typeOrLanguage</span><span>- '@type' or '@language'.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">typeOrLanguageValue</span><span>- preferred value for '@type' or '@language'.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>preferred term.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_selectTerm</span><span class="p">(</span>
  <span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">iri</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">containers</span><span class="p">,</span> <span class="nx">typeOrLanguage</span><span class="p">,</span> <span class="nx">typeOrLanguageValue</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">typeOrLanguageValue</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">typeOrLanguageValue</span> <span class="o">=</span> <span class="s1">&#39;@null&#39;</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-431"><td class="docs"><div class="pilwrap"><a href="#section-431" class="pilcrow">&#182;</a></div><p>preferences for the value of @type or @language</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">prefs</span> <span class="o">=</span> <span class="p">[];</span></pre></div></td></tr><tr id="section-432"><td class="docs"><div class="pilwrap"><a href="#section-432" class="pilcrow">&#182;</a></div><p>determine prefs for @id based on whether or not value compacts to a term</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">((</span><span class="nx">typeOrLanguageValue</span> <span class="o">===</span> <span class="s1">&#39;@id&#39;</span> <span class="o">||</span> <span class="nx">typeOrLanguageValue</span> <span class="o">===</span> <span class="s1">&#39;@reverse&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
    <span class="nx">_isSubjectReference</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-433"><td class="docs"><div class="pilwrap"><a href="#section-433" class="pilcrow">&#182;</a></div><p>prefer @reverse first</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">typeOrLanguageValue</span> <span class="o">===</span> <span class="s1">&#39;@reverse&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">prefs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;@reverse&#39;</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-434"><td class="docs"><div class="pilwrap"><a href="#section-434" class="pilcrow">&#182;</a></div><p>try to compact value to a term</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">term</span> <span class="o">=</span> <span class="nx">_compactIri</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">value</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">],</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span><span class="nx">vocab</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">term</span> <span class="k">in</span> <span class="nx">activeCtx</span><span class="p">.</span><span class="nx">mappings</span> <span class="o">&amp;&amp;</span>
      <span class="nx">activeCtx</span><span class="p">.</span><span class="nx">mappings</span><span class="p">[</span><span class="nx">term</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
      <span class="nx">activeCtx</span><span class="p">.</span><span class="nx">mappings</span><span class="p">[</span><span class="nx">term</span><span class="p">][</span><span class="s1">&#39;@id&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="nx">value</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">])</span> <span class="p">{</span></pre></div></td></tr><tr id="section-435"><td class="docs"><div class="pilwrap"><a href="#section-435" class="pilcrow">&#182;</a></div><p>prefer @vocab</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">prefs</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">prefs</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;@vocab&#39;</span><span class="p">,</span> <span class="s1">&#39;@id&#39;</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-436"><td class="docs"><div class="pilwrap"><a href="#section-436" class="pilcrow">&#182;</a></div><p>prefer @id</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">prefs</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">prefs</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">,</span> <span class="s1">&#39;@vocab&#39;</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">prefs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">typeOrLanguageValue</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">prefs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;@none&#39;</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">containerMap</span> <span class="o">=</span> <span class="nx">activeCtx</span><span class="p">.</span><span class="nx">inverse</span><span class="p">[</span><span class="nx">iri</span><span class="p">];</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">ci</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ci</span> <span class="o">&lt;</span> <span class="nx">containers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">ci</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-437"><td class="docs"><div class="pilwrap"><a href="#section-437" class="pilcrow">&#182;</a></div><p>if container not available in the map, continue</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">container</span> <span class="o">=</span> <span class="nx">containers</span><span class="p">[</span><span class="nx">ci</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">container</span> <span class="k">in</span> <span class="nx">containerMap</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">typeOrLanguageValueMap</span> <span class="o">=</span> <span class="nx">containerMap</span><span class="p">[</span><span class="nx">container</span><span class="p">][</span><span class="nx">typeOrLanguage</span><span class="p">];</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">pi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">pi</span> <span class="o">&lt;</span> <span class="nx">prefs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">pi</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-438"><td class="docs"><div class="pilwrap"><a href="#section-438" class="pilcrow">&#182;</a></div><p>if type/language option not available in the map, continue</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">pref</span> <span class="o">=</span> <span class="nx">prefs</span><span class="p">[</span><span class="nx">pi</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">pref</span> <span class="k">in</span> <span class="nx">typeOrLanguageValueMap</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-439"><td class="docs"><div class="pilwrap"><a href="#section-439" class="pilcrow">&#182;</a></div><p>select term</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">return</span> <span class="nx">typeOrLanguageValueMap</span><span class="p">[</span><span class="nx">pref</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-440"><td class="docs"><div class="pilwrap"><a href="#section-440" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Compacts an IRI or keyword into a term or prefix if it can be. If the<br />IRI has an associated value it may be passed.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">activeCtx</span><span>- active context to use.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">iri</span><span>- IRI to compact.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">value</span><span>- value to check or null.</span></div><div class="dox_tag_detail"><span>options </span><span class="dox_type">relativeTo</span><span>- for how to compact IRIs:</span></div><div class="dox_tag_detail"><span>true </span><span class="dox_type">reverse</span><span>- if a reverse property is being compacted, false if not.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>compacted term, prefix, keyword alias, or the original IRI.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_compactIri</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">iri</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">relativeTo</span><span class="p">,</span> <span class="nx">reverse</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-441"><td class="docs"><div class="pilwrap"><a href="#section-441" class="pilcrow">&#182;</a></div><p>can't compact null</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">iri</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">iri</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-442"><td class="docs"><div class="pilwrap"><a href="#section-442" class="pilcrow">&#182;</a></div><p>default value and parent to null</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">_isUndefined</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-443"><td class="docs"><div class="pilwrap"><a href="#section-443" class="pilcrow">&#182;</a></div><p>default reverse to false</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">_isUndefined</span><span class="p">(</span><span class="nx">reverse</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">reverse</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">relativeTo</span> <span class="o">=</span> <span class="nx">relativeTo</span> <span class="o">||</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-444"><td class="docs"><div class="pilwrap"><a href="#section-444" class="pilcrow">&#182;</a></div><p>if term is a keyword, default vocab to true</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">_isKeyword</span><span class="p">(</span><span class="nx">iri</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">relativeTo</span><span class="p">.</span><span class="nx">vocab</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-445"><td class="docs"><div class="pilwrap"><a href="#section-445" class="pilcrow">&#182;</a></div><p>use inverse context to pick a term if iri is relative to vocab</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">relativeTo</span><span class="p">.</span><span class="nx">vocab</span> <span class="o">&amp;&amp;</span> <span class="nx">iri</span> <span class="k">in</span> <span class="nx">activeCtx</span><span class="p">.</span><span class="nx">getInverse</span><span class="p">())</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">defaultLanguage</span> <span class="o">=</span> <span class="nx">activeCtx</span><span class="p">[</span><span class="s1">&#39;@language&#39;</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;@none&#39;</span><span class="p">;</span></pre></div></td></tr><tr id="section-446"><td class="docs"><div class="pilwrap"><a href="#section-446" class="pilcrow">&#182;</a></div><p>prefer @index if available in value</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">containers</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;@index&#39;</span> <span class="k">in</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">containers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;@index&#39;</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-447"><td class="docs"><div class="pilwrap"><a href="#section-447" class="pilcrow">&#182;</a></div><p>defaults for term selection based on type/language</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">typeOrLanguage</span> <span class="o">=</span> <span class="s1">&#39;@language&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">typeOrLanguageValue</span> <span class="o">=</span> <span class="s1">&#39;@null&#39;</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">reverse</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">typeOrLanguage</span> <span class="o">=</span> <span class="s1">&#39;@type&#39;</span><span class="p">;</span>
      <span class="nx">typeOrLanguageValue</span> <span class="o">=</span> <span class="s1">&#39;@reverse&#39;</span><span class="p">;</span>
      <span class="nx">containers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;@set&#39;</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-448"><td class="docs"><div class="pilwrap"><a href="#section-448" class="pilcrow">&#182;</a></div><p>choose the most specific term that works for all elements in @list</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">_isList</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-449"><td class="docs"><div class="pilwrap"><a href="#section-449" class="pilcrow">&#182;</a></div><p>only select @list containers if @index is NOT in value</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;@index&#39;</span> <span class="k">in</span> <span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">containers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;@list&#39;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="s1">&#39;@list&#39;</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">commonLanguage</span> <span class="o">=</span> <span class="p">(</span><span class="nx">list</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="nx">defaultLanguage</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">commonType</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">itemLanguage</span> <span class="o">=</span> <span class="s1">&#39;@none&#39;</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">itemType</span> <span class="o">=</span> <span class="s1">&#39;@none&#39;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">_isValue</span><span class="p">(</span><span class="nx">item</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@language&#39;</span> <span class="k">in</span> <span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">itemLanguage</span> <span class="o">=</span> <span class="nx">item</span><span class="p">[</span><span class="s1">&#39;@language&#39;</span><span class="p">];</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@type&#39;</span> <span class="k">in</span> <span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">itemType</span> <span class="o">=</span> <span class="nx">item</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">];</span>
          <span class="p">}</span></pre></div></td></tr><tr id="section-450"><td class="docs"><div class="pilwrap"><a href="#section-450" class="pilcrow">&#182;</a></div><p>plain literal</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">else</span> <span class="p">{</span>
            <span class="nx">itemLanguage</span> <span class="o">=</span> <span class="s1">&#39;@null&#39;</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">itemType</span> <span class="o">=</span> <span class="s1">&#39;@id&#39;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">commonLanguage</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">commonLanguage</span> <span class="o">=</span> <span class="nx">itemLanguage</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">itemLanguage</span> <span class="o">!==</span> <span class="nx">commonLanguage</span> <span class="o">&amp;&amp;</span> <span class="nx">_isValue</span><span class="p">(</span><span class="nx">item</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">commonLanguage</span> <span class="o">=</span> <span class="s1">&#39;@none&#39;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">commonType</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">commonType</span> <span class="o">=</span> <span class="nx">itemType</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">itemType</span> <span class="o">!==</span> <span class="nx">commonType</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">commonType</span> <span class="o">=</span> <span class="s1">&#39;@none&#39;</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-451"><td class="docs"><div class="pilwrap"><a href="#section-451" class="pilcrow">&#182;</a></div><p>there are different languages and types in the list, so choose
the most generic term, no need to keep iterating the list</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">commonLanguage</span> <span class="o">===</span> <span class="s1">&#39;@none&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">commonType</span> <span class="o">===</span> <span class="s1">&#39;@none&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">commonLanguage</span> <span class="o">=</span> <span class="nx">commonLanguage</span> <span class="o">||</span> <span class="s1">&#39;@none&#39;</span><span class="p">;</span>
      <span class="nx">commonType</span> <span class="o">=</span> <span class="nx">commonType</span> <span class="o">||</span> <span class="s1">&#39;@none&#39;</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">commonType</span> <span class="o">!==</span> <span class="s1">&#39;@none&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">typeOrLanguage</span> <span class="o">=</span> <span class="s1">&#39;@type&#39;</span><span class="p">;</span>
        <span class="nx">typeOrLanguageValue</span> <span class="o">=</span> <span class="nx">commonType</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">typeOrLanguageValue</span> <span class="o">=</span> <span class="nx">commonLanguage</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">_isValue</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@language&#39;</span> <span class="k">in</span> <span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="s1">&#39;@index&#39;</span> <span class="k">in</span> <span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">containers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;@language&#39;</span><span class="p">);</span>
          <span class="nx">typeOrLanguageValue</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="s1">&#39;@language&#39;</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@type&#39;</span> <span class="k">in</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">typeOrLanguage</span> <span class="o">=</span> <span class="s1">&#39;@type&#39;</span><span class="p">;</span>
          <span class="nx">typeOrLanguageValue</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">typeOrLanguage</span> <span class="o">=</span> <span class="s1">&#39;@type&#39;</span><span class="p">;</span>
        <span class="nx">typeOrLanguageValue</span> <span class="o">=</span> <span class="s1">&#39;@id&#39;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">containers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;@set&#39;</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-452"><td class="docs"><div class="pilwrap"><a href="#section-452" class="pilcrow">&#182;</a></div><p>do term selection</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">containers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;@none&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">term</span> <span class="o">=</span> <span class="nx">_selectTerm</span><span class="p">(</span>
      <span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">iri</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">containers</span><span class="p">,</span> <span class="nx">typeOrLanguage</span><span class="p">,</span> <span class="nx">typeOrLanguageValue</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">term</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">term</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-453"><td class="docs"><div class="pilwrap"><a href="#section-453" class="pilcrow">&#182;</a></div><p>no term match, use @vocab if available</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">relativeTo</span><span class="p">.</span><span class="nx">vocab</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@vocab&#39;</span> <span class="k">in</span> <span class="nx">activeCtx</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-454"><td class="docs"><div class="pilwrap"><a href="#section-454" class="pilcrow">&#182;</a></div><p>determine if vocab is a prefix of the iri</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">vocab</span> <span class="o">=</span> <span class="nx">activeCtx</span><span class="p">[</span><span class="s1">&#39;@vocab&#39;</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">iri</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">vocab</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">iri</span> <span class="o">!==</span> <span class="nx">vocab</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-455"><td class="docs"><div class="pilwrap"><a href="#section-455" class="pilcrow">&#182;</a></div><p>use suffix as relative iri if it is not a term in the active context</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">suffix</span> <span class="o">=</span> <span class="nx">iri</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">vocab</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">suffix</span> <span class="k">in</span> <span class="nx">activeCtx</span><span class="p">.</span><span class="nx">mappings</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">suffix</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-456"><td class="docs"><div class="pilwrap"><a href="#section-456" class="pilcrow">&#182;</a></div><p>no term or @vocab match, check for possible CURIEs</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">choice</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">term</span> <span class="k">in</span> <span class="nx">activeCtx</span><span class="p">.</span><span class="nx">mappings</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-457"><td class="docs"><div class="pilwrap"><a href="#section-457" class="pilcrow">&#182;</a></div><p>skip terms with colons, they can't be prefixes</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">term</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-458"><td class="docs"><div class="pilwrap"><a href="#section-458" class="pilcrow">&#182;</a></div><p>skip entries with @ids that are not partial matches</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">definition</span> <span class="o">=</span> <span class="nx">activeCtx</span><span class="p">.</span><span class="nx">mappings</span><span class="p">[</span><span class="nx">term</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">definition</span> <span class="o">||</span>
      <span class="nx">definition</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="nx">iri</span> <span class="o">||</span> <span class="nx">iri</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">definition</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">])</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-459"><td class="docs"><div class="pilwrap"><a href="#section-459" class="pilcrow">&#182;</a></div><p>a CURIE is usable if:
1. it has no mapping, OR
2. value is null, which means we're not compacting an @value, AND
  the mapping matches the IRI)</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">curie</span> <span class="o">=</span> <span class="nx">term</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">iri</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">definition</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">].</span><span class="nx">length</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">isUsableCurie</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">curie</span> <span class="k">in</span> <span class="nx">activeCtx</span><span class="p">.</span><span class="nx">mappings</span><span class="p">)</span> <span class="o">||</span>
      <span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">activeCtx</span><span class="p">.</span><span class="nx">mappings</span><span class="p">[</span><span class="nx">curie</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
      <span class="nx">activeCtx</span><span class="p">.</span><span class="nx">mappings</span><span class="p">[</span><span class="nx">curie</span><span class="p">][</span><span class="s1">&#39;@id&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="nx">iri</span><span class="p">));</span></pre></div></td></tr><tr id="section-460"><td class="docs"><div class="pilwrap"><a href="#section-460" class="pilcrow">&#182;</a></div><p>select curie if it is shorter or the same length but lexicographically
less than the current choice</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">isUsableCurie</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">choice</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span>
      <span class="nx">_compareShortestLeast</span><span class="p">(</span><span class="nx">curie</span><span class="p">,</span> <span class="nx">choice</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">choice</span> <span class="o">=</span> <span class="nx">curie</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-461"><td class="docs"><div class="pilwrap"><a href="#section-461" class="pilcrow">&#182;</a></div><p>return chosen curie</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">choice</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">choice</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-462"><td class="docs"><div class="pilwrap"><a href="#section-462" class="pilcrow">&#182;</a></div><p>compact IRI relative to base</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">relativeTo</span><span class="p">.</span><span class="nx">vocab</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">_removeBase</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">[</span><span class="s1">&#39;@base&#39;</span><span class="p">],</span> <span class="nx">iri</span><span class="p">);</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-463"><td class="docs"><div class="pilwrap"><a href="#section-463" class="pilcrow">&#182;</a></div><p>return IRI as is</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">return</span> <span class="nx">iri</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-464"><td class="docs"><div class="pilwrap"><a href="#section-464" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Performs value compaction on an object with '@value' or '@id' as the only<br />property.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">activeCtx</span><span>- active context.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">activeProperty</span><span>- active property that points to the value.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">value</span><span>- value to compact.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>compaction result.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_compactValue</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">activeProperty</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-465"><td class="docs"><div class="pilwrap"><a href="#section-465" class="pilcrow">&#182;</a></div><p>value is a @value</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">_isValue</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-466"><td class="docs"><div class="pilwrap"><a href="#section-466" class="pilcrow">&#182;</a></div><p>get context rules</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">getContextValue</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">activeProperty</span><span class="p">,</span> <span class="s1">&#39;@type&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">language</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">getContextValue</span><span class="p">(</span>
      <span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">activeProperty</span><span class="p">,</span> <span class="s1">&#39;@language&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">container</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">getContextValue</span><span class="p">(</span>
      <span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">activeProperty</span><span class="p">,</span> <span class="s1">&#39;@container&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-467"><td class="docs"><div class="pilwrap"><a href="#section-467" class="pilcrow">&#182;</a></div><p>whether or not the value has an @index that must be preserved</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">preserveIndex</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;@index&#39;</span> <span class="k">in</span> <span class="nx">value</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="nx">container</span> <span class="o">!==</span> <span class="s1">&#39;@index&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-468"><td class="docs"><div class="pilwrap"><a href="#section-468" class="pilcrow">&#182;</a></div><p>if there's no @index to preserve ...</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">preserveIndex</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-469"><td class="docs"><div class="pilwrap"><a href="#section-469" class="pilcrow">&#182;</a></div><p>matching @type or @language specified in context, compact value</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">value</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="nx">type</span> <span class="o">||</span> <span class="nx">value</span><span class="p">[</span><span class="s1">&#39;@language&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="nx">language</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">value</span><span class="p">[</span><span class="s1">&#39;@value&#39;</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-470"><td class="docs"><div class="pilwrap"><a href="#section-470" class="pilcrow">&#182;</a></div><p>return just the value of @value if all are true:
1. @value is the only key or @index isn't being preserved
2. there is no default language or @value is not a string or
  the key has a mapping with a null @language</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">keyCount</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">value</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">isValueOnlyKey</span> <span class="o">=</span> <span class="p">(</span><span class="nx">keyCount</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">||</span>
      <span class="p">(</span><span class="nx">keyCount</span> <span class="o">===</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="s1">&#39;@index&#39;</span> <span class="k">in</span> <span class="nx">value</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">preserveIndex</span><span class="p">));</span>
    <span class="kd">var</span> <span class="nx">hasDefaultLanguage</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;@language&#39;</span> <span class="k">in</span> <span class="nx">activeCtx</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">isValueString</span> <span class="o">=</span> <span class="nx">_isString</span><span class="p">(</span><span class="nx">value</span><span class="p">[</span><span class="s1">&#39;@value&#39;</span><span class="p">]);</span>
    <span class="kd">var</span> <span class="nx">hasNullMapping</span> <span class="o">=</span> <span class="p">(</span><span class="nx">activeCtx</span><span class="p">.</span><span class="nx">mappings</span><span class="p">[</span><span class="nx">activeProperty</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
      <span class="nx">activeCtx</span><span class="p">.</span><span class="nx">mappings</span><span class="p">[</span><span class="nx">activeProperty</span><span class="p">][</span><span class="s1">&#39;@language&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="kc">null</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">isValueOnlyKey</span> <span class="o">&amp;&amp;</span>
      <span class="p">(</span><span class="o">!</span><span class="nx">hasDefaultLanguage</span> <span class="o">||</span> <span class="o">!</span><span class="nx">isValueString</span> <span class="o">||</span> <span class="nx">hasNullMapping</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">value</span><span class="p">[</span><span class="s1">&#39;@value&#39;</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-471"><td class="docs"><div class="pilwrap"><a href="#section-471" class="pilcrow">&#182;</a></div><p>preserve @index</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">preserveIndex</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">rval</span><span class="p">[</span><span class="nx">_compactIri</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="s1">&#39;@index&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="s1">&#39;@index&#39;</span><span class="p">];</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-472"><td class="docs"><div class="pilwrap"><a href="#section-472" class="pilcrow">&#182;</a></div><p>compact @type IRI</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@type&#39;</span> <span class="k">in</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">rval</span><span class="p">[</span><span class="nx">_compactIri</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="s1">&#39;@type&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">_compactIri</span><span class="p">(</span>
        <span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">value</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">],</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span><span class="nx">vocab</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-473"><td class="docs"><div class="pilwrap"><a href="#section-473" class="pilcrow">&#182;</a></div><p>alias @language</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@language&#39;</span> <span class="k">in</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">rval</span><span class="p">[</span><span class="nx">_compactIri</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="s1">&#39;@language&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="s1">&#39;@language&#39;</span><span class="p">];</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-474"><td class="docs"><div class="pilwrap"><a href="#section-474" class="pilcrow">&#182;</a></div><p>alias @value</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">rval</span><span class="p">[</span><span class="nx">_compactIri</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="s1">&#39;@value&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="s1">&#39;@value&#39;</span><span class="p">];</span>

    <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-475"><td class="docs"><div class="pilwrap"><a href="#section-475" class="pilcrow">&#182;</a></div><p>value is a subject reference</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">expandedProperty</span> <span class="o">=</span> <span class="nx">_expandIri</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">activeProperty</span><span class="p">,</span> <span class="p">{</span><span class="nx">vocab</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
  <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">getContextValue</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">activeProperty</span><span class="p">,</span> <span class="s1">&#39;@type&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">compacted</span> <span class="o">=</span> <span class="nx">_compactIri</span><span class="p">(</span>
    <span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">value</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">],</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span><span class="nx">vocab</span><span class="o">:</span> <span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;@vocab&#39;</span><span class="p">});</span></pre></div></td></tr><tr id="section-476"><td class="docs"><div class="pilwrap"><a href="#section-476" class="pilcrow">&#182;</a></div><p>compact to scalar</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;@id&#39;</span> <span class="o">||</span> <span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;@vocab&#39;</span> <span class="o">||</span> <span class="nx">expandedProperty</span> <span class="o">===</span> <span class="s1">&#39;@graph&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">compacted</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="nx">rval</span><span class="p">[</span><span class="nx">_compactIri</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="s1">&#39;@id&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">compacted</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-477"><td class="docs"><div class="pilwrap"><a href="#section-477" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Creates a term definition during context processing.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">activeCtx</span><span>- current active context.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">localCtx</span><span>- local context being processed.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">term</span><span>- term in the local context to define the mapping for.</span></div><div class="dox_tag_detail"><span>a </span><span class="dox_type">defined</span><span>- map of defining/defined keys to detect cycles and prevent</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_createTermDefinition</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">localCtx</span><span class="p">,</span> <span class="nx">term</span><span class="p">,</span> <span class="nx">defined</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">term</span> <span class="k">in</span> <span class="nx">defined</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-478"><td class="docs"><div class="pilwrap"><a href="#section-478" class="pilcrow">&#182;</a></div><p>term already defined</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">defined</span><span class="p">[</span><span class="nx">term</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-479"><td class="docs"><div class="pilwrap"><a href="#section-479" class="pilcrow">&#182;</a></div><p>cycle detected</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
      <span class="s1">&#39;Cyclical context definition detected.&#39;</span><span class="p">,</span>
      <span class="s1">&#39;jsonld.CyclicalContext&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">context</span><span class="o">:</span> <span class="nx">localCtx</span><span class="p">,</span> <span class="nx">term</span><span class="o">:</span> <span class="nx">term</span><span class="p">});</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-480"><td class="docs"><div class="pilwrap"><a href="#section-480" class="pilcrow">&#182;</a></div><p>now defining term</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">defined</span><span class="p">[</span><span class="nx">term</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">_isKeyword</span><span class="p">(</span><span class="nx">term</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
      <span class="s1">&#39;Invalid JSON-LD syntax; keywords cannot be overridden.&#39;</span><span class="p">,</span>
      <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">context</span><span class="o">:</span> <span class="nx">localCtx</span><span class="p">});</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-481"><td class="docs"><div class="pilwrap"><a href="#section-481" class="pilcrow">&#182;</a></div><p>remove old mapping</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">.</span><span class="nx">mappings</span><span class="p">[</span><span class="nx">term</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">delete</span> <span class="nx">activeCtx</span><span class="p">.</span><span class="nx">mappings</span><span class="p">[</span><span class="nx">term</span><span class="p">];</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-482"><td class="docs"><div class="pilwrap"><a href="#section-482" class="pilcrow">&#182;</a></div><p>get context term value</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">localCtx</span><span class="p">[</span><span class="nx">term</span><span class="p">];</span></pre></div></td></tr><tr id="section-483"><td class="docs"><div class="pilwrap"><a href="#section-483" class="pilcrow">&#182;</a></div><p>clear context entry</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="p">(</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="kc">null</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">activeCtx</span><span class="p">.</span><span class="nx">mappings</span><span class="p">[</span><span class="nx">term</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="nx">defined</span><span class="p">[</span><span class="nx">term</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-484"><td class="docs"><div class="pilwrap"><a href="#section-484" class="pilcrow">&#182;</a></div><p>convert short-hand value to object w/@id</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">_isString</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@id&#39;</span><span class="o">:</span> <span class="nx">value</span><span class="p">};</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
      <span class="s1">&#39;Invalid JSON-LD syntax; @context property values must be &#39;</span> <span class="o">+</span>
      <span class="s1">&#39;strings or objects.&#39;</span><span class="p">,</span>
      <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">context</span><span class="o">:</span> <span class="nx">localCtx</span><span class="p">});</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-485"><td class="docs"><div class="pilwrap"><a href="#section-485" class="pilcrow">&#182;</a></div><p>create new mapping</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">mapping</span> <span class="o">=</span> <span class="nx">activeCtx</span><span class="p">.</span><span class="nx">mappings</span><span class="p">[</span><span class="nx">term</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="nx">mapping</span><span class="p">.</span><span class="nx">reverse</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@reverse&#39;</span> <span class="k">in</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@id&#39;</span> <span class="k">in</span> <span class="nx">value</span> <span class="o">||</span> <span class="s1">&#39;@type&#39;</span> <span class="k">in</span> <span class="nx">value</span> <span class="o">||</span> <span class="s1">&#39;@language&#39;</span> <span class="k">in</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
        <span class="s1">&#39;Invalid JSON-LD syntax; a @reverse term definition must not &#39;</span> <span class="o">+</span>
        <span class="s1">&#39;contain @id, @type, or @language.&#39;</span><span class="p">,</span>
        <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">context</span><span class="o">:</span> <span class="nx">localCtx</span><span class="p">});</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">reverse</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="s1">&#39;@reverse&#39;</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isString</span><span class="p">(</span><span class="nx">reverse</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
        <span class="s1">&#39;Invalid JSON-LD syntax; a @context @reverse value must be a string.&#39;</span><span class="p">,</span>
        <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">context</span><span class="o">:</span> <span class="nx">localCtx</span><span class="p">});</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-486"><td class="docs"><div class="pilwrap"><a href="#section-486" class="pilcrow">&#182;</a></div><p>expand and add @id mapping, set @type to @id</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">mapping</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_expandIri</span><span class="p">(</span>
      <span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">reverse</span><span class="p">,</span> <span class="p">{</span><span class="nx">vocab</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">base</span><span class="o">:</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">localCtx</span><span class="p">,</span> <span class="nx">defined</span><span class="p">);</span>
    <span class="nx">mapping</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;@id&#39;</span><span class="p">;</span>
    <span class="nx">mapping</span><span class="p">.</span><span class="nx">reverse</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@id&#39;</span> <span class="k">in</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isString</span><span class="p">(</span><span class="nx">id</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
        <span class="s1">&#39;Invalid JSON-LD syntax; a @context @id value must be an array &#39;</span> <span class="o">+</span>
        <span class="s1">&#39;of strings or a string.&#39;</span><span class="p">,</span>
        <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">context</span><span class="o">:</span> <span class="nx">localCtx</span><span class="p">});</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">id</span> <span class="o">!==</span> <span class="nx">term</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-487"><td class="docs"><div class="pilwrap"><a href="#section-487" class="pilcrow">&#182;</a></div><p>expand and add @id mapping</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">mapping</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_expandIri</span><span class="p">(</span>
        <span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="p">{</span><span class="nx">vocab</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">base</span><span class="o">:</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">localCtx</span><span class="p">,</span> <span class="nx">defined</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;@id&#39;</span> <span class="k">in</span> <span class="nx">mapping</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-488"><td class="docs"><div class="pilwrap"><a href="#section-488" class="pilcrow">&#182;</a></div><p>see if the term has a prefix</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">colon</span> <span class="o">=</span> <span class="nx">term</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">colon</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">prefix</span> <span class="o">=</span> <span class="nx">term</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">colon</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">prefix</span> <span class="k">in</span> <span class="nx">localCtx</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-489"><td class="docs"><div class="pilwrap"><a href="#section-489" class="pilcrow">&#182;</a></div><p>define parent prefix</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">_createTermDefinition</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">localCtx</span><span class="p">,</span> <span class="nx">prefix</span><span class="p">,</span> <span class="nx">defined</span><span class="p">);</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-490"><td class="docs"><div class="pilwrap"><a href="#section-490" class="pilcrow">&#182;</a></div><p>set @id based on prefix parent</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">.</span><span class="nx">mappings</span><span class="p">[</span><span class="nx">prefix</span><span class="p">])</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">suffix</span> <span class="o">=</span> <span class="nx">term</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">colon</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="nx">mapping</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">activeCtx</span><span class="p">.</span><span class="nx">mappings</span><span class="p">[</span><span class="nx">prefix</span><span class="p">][</span><span class="s1">&#39;@id&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nx">suffix</span><span class="p">;</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-491"><td class="docs"><div class="pilwrap"><a href="#section-491" class="pilcrow">&#182;</a></div><p>term is an absolute IRI</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">mapping</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">term</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-492"><td class="docs"><div class="pilwrap"><a href="#section-492" class="pilcrow">&#182;</a></div><p>non-IRIs <em>must</em> define @ids if @vocab is not available</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;@vocab&#39;</span> <span class="k">in</span> <span class="nx">activeCtx</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
          <span class="s1">&#39;Invalid JSON-LD syntax; @context terms must define an @id.&#39;</span><span class="p">,</span>
          <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">context</span><span class="o">:</span> <span class="nx">localCtx</span><span class="p">,</span> <span class="nx">term</span><span class="o">:</span> <span class="nx">term</span><span class="p">});</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-493"><td class="docs"><div class="pilwrap"><a href="#section-493" class="pilcrow">&#182;</a></div><p>prepend vocab to term</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">mapping</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">activeCtx</span><span class="p">[</span><span class="s1">&#39;@vocab&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nx">term</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-494"><td class="docs"><div class="pilwrap"><a href="#section-494" class="pilcrow">&#182;</a></div><p>IRI mapping now defined</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">defined</span><span class="p">[</span><span class="nx">term</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@type&#39;</span> <span class="k">in</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isString</span><span class="p">(</span><span class="nx">type</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
        <span class="s1">&#39;Invalid JSON-LD syntax; @context @type values must be strings.&#39;</span><span class="p">,</span>
        <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">context</span><span class="o">:</span> <span class="nx">localCtx</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">type</span> <span class="o">!==</span> <span class="s1">&#39;@id&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-495"><td class="docs"><div class="pilwrap"><a href="#section-495" class="pilcrow">&#182;</a></div><p>expand @type to full IRI</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">type</span> <span class="o">=</span> <span class="nx">_expandIri</span><span class="p">(</span>
        <span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="p">{</span><span class="nx">vocab</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">base</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="nx">localCtx</span><span class="p">,</span> <span class="nx">defined</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-496"><td class="docs"><div class="pilwrap"><a href="#section-496" class="pilcrow">&#182;</a></div><p>add @type to mapping</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">mapping</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@container&#39;</span> <span class="k">in</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">container</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="s1">&#39;@container&#39;</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">container</span> <span class="o">!==</span> <span class="s1">&#39;@list&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">container</span> <span class="o">!==</span> <span class="s1">&#39;@set&#39;</span> <span class="o">&amp;&amp;</span>
      <span class="nx">container</span> <span class="o">!==</span> <span class="s1">&#39;@index&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">container</span> <span class="o">!==</span> <span class="s1">&#39;@language&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
        <span class="s1">&#39;Invalid JSON-LD syntax; @context @container value must be &#39;</span> <span class="o">+</span>
        <span class="s1">&#39;one of the following: @list, @set, @index, or @language.&#39;</span><span class="p">,</span>
        <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">context</span><span class="o">:</span> <span class="nx">localCtx</span><span class="p">});</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">mapping</span><span class="p">.</span><span class="nx">reverse</span> <span class="o">&amp;&amp;</span> <span class="nx">container</span> <span class="o">!==</span> <span class="s1">&#39;@index&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
        <span class="s1">&#39;Invalid JSON-LD syntax; @context @container value for a @reverse &#39;</span> <span class="o">+</span>
        <span class="s1">&#39;type definition must be @index.&#39;</span><span class="p">,</span>
        <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">context</span><span class="o">:</span> <span class="nx">localCtx</span><span class="p">});</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-497"><td class="docs"><div class="pilwrap"><a href="#section-497" class="pilcrow">&#182;</a></div><p>add @container to mapping</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">mapping</span><span class="p">[</span><span class="s1">&#39;@container&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">container</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@language&#39;</span> <span class="k">in</span> <span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="s1">&#39;@type&#39;</span> <span class="k">in</span> <span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">language</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="s1">&#39;@language&#39;</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">language</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_isString</span><span class="p">(</span><span class="nx">language</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
        <span class="s1">&#39;Invalid JSON-LD syntax; @context @language value must be &#39;</span> <span class="o">+</span>
        <span class="s1">&#39;a string or null.&#39;</span><span class="p">,</span>
        <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">context</span><span class="o">:</span> <span class="nx">localCtx</span><span class="p">});</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-498"><td class="docs"><div class="pilwrap"><a href="#section-498" class="pilcrow">&#182;</a></div><p>add @language to mapping</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">language</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">language</span> <span class="o">=</span> <span class="nx">language</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nx">mapping</span><span class="p">[</span><span class="s1">&#39;@language&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">language</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-499"><td class="docs"><div class="pilwrap"><a href="#section-499" class="pilcrow">&#182;</a></div><p>disallow aliasing @context and @preserve</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">mapping</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">];</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">id</span> <span class="o">===</span> <span class="s1">&#39;@context&#39;</span> <span class="o">||</span> <span class="nx">id</span> <span class="o">===</span> <span class="s1">&#39;@preserve&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
      <span class="s1">&#39;Invalid JSON-LD syntax; @context and @preserve cannot be aliased.&#39;</span><span class="p">,</span>
      <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-500"><td class="docs"><div class="pilwrap"><a href="#section-500" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Expands a string to a full IRI. The string may be a term, a prefix, a<br />relative IRI, or an absolute IRI. The associated absolute IRI will be<br />returned.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">activeCtx</span><span>- current active context.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">value</span><span>- string to expand.</span></div><div class="dox_tag_detail"><span>options </span><span class="dox_type">relativeTo</span><span>- for how to resolve relative IRIs:</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">localCtx</span><span>- local context being processed (only given if called</span></div><div class="dox_tag_detail"><span>a </span><span class="dox_type">defined</span><span>- map for tracking cycles in context definitions (only given</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>expanded value.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_expandIri</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">relativeTo</span><span class="p">,</span> <span class="nx">localCtx</span><span class="p">,</span> <span class="nx">defined</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-501"><td class="docs"><div class="pilwrap"><a href="#section-501" class="pilcrow">&#182;</a></div><p>already expanded</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">_isKeyword</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-502"><td class="docs"><div class="pilwrap"><a href="#section-502" class="pilcrow">&#182;</a></div><p>define term dependency if not defined</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">localCtx</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span> <span class="k">in</span> <span class="nx">localCtx</span> <span class="o">&amp;&amp;</span> <span class="nx">defined</span><span class="p">[</span><span class="nx">value</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">_createTermDefinition</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">localCtx</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">defined</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">relativeTo</span> <span class="o">=</span> <span class="nx">relativeTo</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">relativeTo</span><span class="p">.</span><span class="nx">vocab</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">mapping</span> <span class="o">=</span> <span class="nx">activeCtx</span><span class="p">.</span><span class="nx">mappings</span><span class="p">[</span><span class="nx">value</span><span class="p">];</span></pre></div></td></tr><tr id="section-503"><td class="docs"><div class="pilwrap"><a href="#section-503" class="pilcrow">&#182;</a></div><p>value is explicitly ignored with a null mapping</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">mapping</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">mapping</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-504"><td class="docs"><div class="pilwrap"><a href="#section-504" class="pilcrow">&#182;</a></div><p>value is a term</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">return</span> <span class="nx">mapping</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-505"><td class="docs"><div class="pilwrap"><a href="#section-505" class="pilcrow">&#182;</a></div><p>split value into prefix:suffix</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">colon</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">colon</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">prefix</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">colon</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">suffix</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">colon</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span></pre></div></td></tr><tr id="section-506"><td class="docs"><div class="pilwrap"><a href="#section-506" class="pilcrow">&#182;</a></div><p>do not expand blank nodes (prefix of '_') or already-absolute
IRIs (suffix of '//')</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">prefix</span> <span class="o">===</span> <span class="s1">&#39;_&#39;</span> <span class="o">||</span> <span class="nx">suffix</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;//&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-507"><td class="docs"><div class="pilwrap"><a href="#section-507" class="pilcrow">&#182;</a></div><p>prefix dependency not defined, define it</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">localCtx</span> <span class="o">&amp;&amp;</span> <span class="nx">prefix</span> <span class="k">in</span> <span class="nx">localCtx</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_createTermDefinition</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">,</span> <span class="nx">localCtx</span><span class="p">,</span> <span class="nx">prefix</span><span class="p">,</span> <span class="nx">defined</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-508"><td class="docs"><div class="pilwrap"><a href="#section-508" class="pilcrow">&#182;</a></div><p>use mapping if prefix is defined</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">mapping</span> <span class="o">=</span> <span class="nx">activeCtx</span><span class="p">.</span><span class="nx">mappings</span><span class="p">[</span><span class="nx">prefix</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">mapping</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">mapping</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nx">suffix</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-509"><td class="docs"><div class="pilwrap"><a href="#section-509" class="pilcrow">&#182;</a></div><p>already absolute IRI</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-510"><td class="docs"><div class="pilwrap"><a href="#section-510" class="pilcrow">&#182;</a></div><p>prepend vocab</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">relativeTo</span><span class="p">.</span><span class="nx">vocab</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;@vocab&#39;</span> <span class="k">in</span> <span class="nx">activeCtx</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">activeCtx</span><span class="p">[</span><span class="s1">&#39;@vocab&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-511"><td class="docs"><div class="pilwrap"><a href="#section-511" class="pilcrow">&#182;</a></div><p>prepend base</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">relativeTo</span><span class="p">.</span><span class="nx">base</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">rval</span> <span class="o">=</span> <span class="nx">_prependBase</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">[</span><span class="s1">&#39;@base&#39;</span><span class="p">],</span> <span class="nx">rval</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">localCtx</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-512"><td class="docs"><div class="pilwrap"><a href="#section-512" class="pilcrow">&#182;</a></div><p>value must now be an absolute IRI</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isAbsoluteIri</span><span class="p">(</span><span class="nx">rval</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
        <span class="s1">&#39;Invalid JSON-LD syntax; a @context value does not expand to &#39;</span> <span class="o">+</span>
        <span class="s1">&#39;an absolute IRI.&#39;</span><span class="p">,</span>
        <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">context</span><span class="o">:</span> <span class="nx">localCtx</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">value</span><span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-513"><td class="docs"><div class="pilwrap"><a href="#section-513" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Prepends a base IRI to the given relative IRI.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">base</span><span>- base IRI.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">iri</span><span>- relative IRI.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>absolute IRI.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_prependBase</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span> <span class="nx">iri</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-514"><td class="docs"><div class="pilwrap"><a href="#section-514" class="pilcrow">&#182;</a></div><p>already an absolute IRI</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">iri</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">iri</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-515"><td class="docs"><div class="pilwrap"><a href="#section-515" class="pilcrow">&#182;</a></div><p>parse base if it is a string</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">_isString</span><span class="p">(</span><span class="nx">base</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">base</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">base</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-516"><td class="docs"><div class="pilwrap"><a href="#section-516" class="pilcrow">&#182;</a></div><p>parse given IRI</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">rel</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">iri</span><span class="p">);</span></pre></div></td></tr><tr id="section-517"><td class="docs"><div class="pilwrap"><a href="#section-517" class="pilcrow">&#182;</a></div><p>start hierarchical part</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">hierPart</span> <span class="o">=</span> <span class="p">(</span><span class="nx">base</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">rel</span><span class="p">.</span><span class="nx">authority</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">hierPart</span> <span class="o">+=</span> <span class="s1">&#39;//&#39;</span> <span class="o">+</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">authority</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">base</span><span class="p">.</span><span class="nx">href</span> <span class="o">!==</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">hierPart</span> <span class="o">+=</span> <span class="s1">&#39;//&#39;</span> <span class="o">+</span> <span class="nx">base</span><span class="p">.</span><span class="nx">authority</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-518"><td class="docs"><div class="pilwrap"><a href="#section-518" class="pilcrow">&#182;</a></div><p>per RFC3986 normalize</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">path</span><span class="p">;</span></pre></div></td></tr><tr id="section-519"><td class="docs"><div class="pilwrap"><a href="#section-519" class="pilcrow">&#182;</a></div><p>IRI represents an absolute path</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">rel</span><span class="p">.</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">path</span> <span class="o">=</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">pathname</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">path</span> <span class="o">=</span> <span class="nx">base</span><span class="p">.</span><span class="nx">pathname</span><span class="p">;</span></pre></div></td></tr><tr id="section-520"><td class="docs"><div class="pilwrap"><a href="#section-520" class="pilcrow">&#182;</a></div><p>append relative path to the end of the last directory from base</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">rel</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">!==</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">path</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">path</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">path</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">path</span> <span class="o">+=</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">pathname</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-521"><td class="docs"><div class="pilwrap"><a href="#section-521" class="pilcrow">&#182;</a></div><p>remove slashes and dots in path</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">path</span> <span class="o">=</span> <span class="nx">_removeDotSegments</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">hierPart</span> <span class="o">!==</span> <span class="s1">&#39;&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-522"><td class="docs"><div class="pilwrap"><a href="#section-522" class="pilcrow">&#182;</a></div><p>add query and hash</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">rel</span><span class="p">.</span><span class="nx">query</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">path</span> <span class="o">+=</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">rel</span><span class="p">.</span><span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">path</span> <span class="o">+=</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">hash</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="nx">hierPart</span> <span class="o">+</span> <span class="nx">path</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">rval</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">rval</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-523"><td class="docs"><div class="pilwrap"><a href="#section-523" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Removes a base IRI from the given absolute IRI.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">base</span><span>- base IRI.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">iri</span><span>- absolute IRI.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>relative IRI if relative to base, otherwise the absolute IRI.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_removeBase</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span> <span class="nx">iri</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">_isString</span><span class="p">(</span><span class="nx">base</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">base</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">base</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-524"><td class="docs"><div class="pilwrap"><a href="#section-524" class="pilcrow">&#182;</a></div><p>establish base root</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">root</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">base</span><span class="p">.</span><span class="nx">href</span> <span class="o">!==</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">root</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">base</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;//&#39;</span> <span class="o">+</span> <span class="nx">base</span><span class="p">.</span><span class="nx">authority</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-525"><td class="docs"><div class="pilwrap"><a href="#section-525" class="pilcrow">&#182;</a></div><p>support network-path reference with empty base</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">iri</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;//&#39;</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">root</span> <span class="o">+=</span> <span class="s1">&#39;//&#39;</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-526"><td class="docs"><div class="pilwrap"><a href="#section-526" class="pilcrow">&#182;</a></div><p>IRI not relative to base</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">iri</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">root</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">iri</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-527"><td class="docs"><div class="pilwrap"><a href="#section-527" class="pilcrow">&#182;</a></div><p>remove root from IRI and parse remainder</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">rel</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">iri</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">root</span><span class="p">.</span><span class="nx">length</span><span class="p">));</span></pre></div></td></tr><tr id="section-528"><td class="docs"><div class="pilwrap"><a href="#section-528" class="pilcrow">&#182;</a></div><p>remove path segments that match</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">baseSegments</span> <span class="o">=</span> <span class="nx">base</span><span class="p">.</span><span class="nx">normalizedPath</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">iriSegments</span> <span class="o">=</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">normalizedPath</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>

  <span class="k">while</span><span class="p">(</span><span class="nx">baseSegments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">iriSegments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">baseSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">iriSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">baseSegments</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
    <span class="nx">iriSegments</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-529"><td class="docs"><div class="pilwrap"><a href="#section-529" class="pilcrow">&#182;</a></div><p>use '../' for each non-matching base segment</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">baseSegments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-530"><td class="docs"><div class="pilwrap"><a href="#section-530" class="pilcrow">&#182;</a></div><p>don't count the last segment if it isn't a path (doesn't end in '/')
don't count empty first segment, it means base began with '/'</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">base</span><span class="p">.</span><span class="nx">normalizedPath</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;/&#39;</span> <span class="o">||</span> <span class="nx">baseSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">baseSegments</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">baseSegments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">rval</span> <span class="o">+=</span> <span class="s1">&#39;../&#39;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-531"><td class="docs"><div class="pilwrap"><a href="#section-531" class="pilcrow">&#182;</a></div><p>prepend remaining segments</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">rval</span> <span class="o">+=</span> <span class="nx">iriSegments</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-532"><td class="docs"><div class="pilwrap"><a href="#section-532" class="pilcrow">&#182;</a></div><p>add query and hash</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">rel</span><span class="p">.</span><span class="nx">query</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">rval</span> <span class="o">+=</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">rel</span><span class="p">.</span><span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">rval</span> <span class="o">+=</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">hash</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">rval</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">rval</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-533"><td class="docs"><div class="pilwrap"><a href="#section-533" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Gets the initial context.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">options</span><span>- options to use.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>initial context.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_getInitialContext</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">base</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">base</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="s1">&#39;@base&#39;</span><span class="o">:</span> <span class="nx">base</span><span class="p">,</span>
    <span class="nx">mappings</span><span class="o">:</span> <span class="p">{},</span>
    <span class="nx">inverse</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">getInverse</span><span class="o">:</span> <span class="nx">_createInverseContext</span><span class="p">,</span>
    <span class="nx">clone</span><span class="o">:</span> <span class="nx">_cloneActiveContext</span>
  <span class="p">};</span></pre></div></td></tr><tr id="section-534"><td class="docs"><div class="pilwrap"><a href="#section-534" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Generates an inverse context for use in the compaction algorithm, if<br />not already generated for the given active context.</p></div><div class="details"><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>inverse context.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">_createInverseContext</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">activeCtx</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></pre></div></td></tr><tr id="section-535"><td class="docs"><div class="pilwrap"><a href="#section-535" class="pilcrow">&#182;</a></div><p>lazily create inverse</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">activeCtx</span><span class="p">.</span><span class="nx">inverse</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">activeCtx</span><span class="p">.</span><span class="nx">inverse</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">inverse</span> <span class="o">=</span> <span class="nx">activeCtx</span><span class="p">.</span><span class="nx">inverse</span> <span class="o">=</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-536"><td class="docs"><div class="pilwrap"><a href="#section-536" class="pilcrow">&#182;</a></div><p>handle default language</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">defaultLanguage</span> <span class="o">=</span> <span class="nx">activeCtx</span><span class="p">[</span><span class="s1">&#39;@language&#39;</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;@none&#39;</span><span class="p">;</span></pre></div></td></tr><tr id="section-537"><td class="docs"><div class="pilwrap"><a href="#section-537" class="pilcrow">&#182;</a></div><p>create term selections for each mapping in the context, ordered by
shortest and then lexicographically least</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">mappings</span> <span class="o">=</span> <span class="nx">activeCtx</span><span class="p">.</span><span class="nx">mappings</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">terms</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">mappings</span><span class="p">).</span><span class="nx">sort</span><span class="p">(</span><span class="nx">_compareShortestLeast</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">terms</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">term</span> <span class="o">=</span> <span class="nx">terms</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">mapping</span> <span class="o">=</span> <span class="nx">mappings</span><span class="p">[</span><span class="nx">term</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">mapping</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">container</span> <span class="o">=</span> <span class="nx">mapping</span><span class="p">[</span><span class="s1">&#39;@container&#39;</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;@none&#39;</span><span class="p">;</span></pre></div></td></tr><tr id="section-538"><td class="docs"><div class="pilwrap"><a href="#section-538" class="pilcrow">&#182;</a></div><p>iterate over every IRI in the mapping</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">ids</span> <span class="o">=</span> <span class="nx">mapping</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">ids</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nx">ids</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ii</span> <span class="o">&lt;</span> <span class="nx">ids</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">ii</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">iri</span> <span class="o">=</span> <span class="nx">ids</span><span class="p">[</span><span class="nx">ii</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">entry</span> <span class="o">=</span> <span class="nx">inverse</span><span class="p">[</span><span class="nx">iri</span><span class="p">];</span></pre></div></td></tr><tr id="section-539"><td class="docs"><div class="pilwrap"><a href="#section-539" class="pilcrow">&#182;</a></div><p>initialize entry</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">entry</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">inverse</span><span class="p">[</span><span class="nx">iri</span><span class="p">]</span> <span class="o">=</span> <span class="nx">entry</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-540"><td class="docs"><div class="pilwrap"><a href="#section-540" class="pilcrow">&#182;</a></div><p>add new entry</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">entry</span><span class="p">[</span><span class="nx">container</span><span class="p">])</span> <span class="p">{</span>
          <span class="nx">entry</span><span class="p">[</span><span class="nx">container</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;@language&#39;</span><span class="o">:</span> <span class="p">{},</span>
            <span class="s1">&#39;@type&#39;</span><span class="o">:</span> <span class="p">{}</span>
          <span class="p">};</span>
        <span class="p">}</span>
        <span class="nx">entry</span> <span class="o">=</span> <span class="nx">entry</span><span class="p">[</span><span class="nx">container</span><span class="p">];</span></pre></div></td></tr><tr id="section-541"><td class="docs"><div class="pilwrap"><a href="#section-541" class="pilcrow">&#182;</a></div><p>term is preferred for values using @reverse</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">mapping</span><span class="p">.</span><span class="nx">reverse</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">_addPreferredTerm</span><span class="p">(</span><span class="nx">mapping</span><span class="p">,</span> <span class="nx">term</span><span class="p">,</span> <span class="nx">entry</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">],</span> <span class="s1">&#39;@reverse&#39;</span><span class="p">);</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-542"><td class="docs"><div class="pilwrap"><a href="#section-542" class="pilcrow">&#182;</a></div><p>term is preferred for values using specific type</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@type&#39;</span> <span class="k">in</span> <span class="nx">mapping</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">_addPreferredTerm</span><span class="p">(</span><span class="nx">mapping</span><span class="p">,</span> <span class="nx">term</span><span class="p">,</span> <span class="nx">entry</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">],</span> <span class="nx">mapping</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">]);</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-543"><td class="docs"><div class="pilwrap"><a href="#section-543" class="pilcrow">&#182;</a></div><p>term is preferred for values using specific language</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@language&#39;</span> <span class="k">in</span> <span class="nx">mapping</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">language</span> <span class="o">=</span> <span class="nx">mapping</span><span class="p">[</span><span class="s1">&#39;@language&#39;</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;@null&#39;</span><span class="p">;</span>
          <span class="nx">_addPreferredTerm</span><span class="p">(</span><span class="nx">mapping</span><span class="p">,</span> <span class="nx">term</span><span class="p">,</span> <span class="nx">entry</span><span class="p">[</span><span class="s1">&#39;@language&#39;</span><span class="p">],</span> <span class="nx">language</span><span class="p">);</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-544"><td class="docs"><div class="pilwrap"><a href="#section-544" class="pilcrow">&#182;</a></div><p>term is preferred for values w/default language or no type and
no language</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-545"><td class="docs"><div class="pilwrap"><a href="#section-545" class="pilcrow">&#182;</a></div><p>add an entry for the default language</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">_addPreferredTerm</span><span class="p">(</span><span class="nx">mapping</span><span class="p">,</span> <span class="nx">term</span><span class="p">,</span> <span class="nx">entry</span><span class="p">[</span><span class="s1">&#39;@language&#39;</span><span class="p">],</span> <span class="nx">defaultLanguage</span><span class="p">);</span></pre></div></td></tr><tr id="section-546"><td class="docs"><div class="pilwrap"><a href="#section-546" class="pilcrow">&#182;</a></div><p>add entries for no type and no language</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">_addPreferredTerm</span><span class="p">(</span><span class="nx">mapping</span><span class="p">,</span> <span class="nx">term</span><span class="p">,</span> <span class="nx">entry</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">],</span> <span class="s1">&#39;@none&#39;</span><span class="p">);</span>
          <span class="nx">_addPreferredTerm</span><span class="p">(</span><span class="nx">mapping</span><span class="p">,</span> <span class="nx">term</span><span class="p">,</span> <span class="nx">entry</span><span class="p">[</span><span class="s1">&#39;@language&#39;</span><span class="p">],</span> <span class="s1">&#39;@none&#39;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">inverse</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-547"><td class="docs"><div class="pilwrap"><a href="#section-547" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Adds the term for the given entry if not already added.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">mapping</span><span>- term mapping.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">term</span><span>- term to add.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">entry</span><span>- inverse context typeOrLanguage entry to add to.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">typeOrLanguageValue</span><span>- key in the entry to add to.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">_addPreferredTerm</span><span class="p">(</span><span class="nx">mapping</span><span class="p">,</span> <span class="nx">term</span><span class="p">,</span> <span class="nx">entry</span><span class="p">,</span> <span class="nx">typeOrLanguageValue</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">typeOrLanguageValue</span> <span class="k">in</span> <span class="nx">entry</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">entry</span><span class="p">[</span><span class="nx">typeOrLanguageValue</span><span class="p">]</span> <span class="o">=</span> <span class="nx">term</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-548"><td class="docs"><div class="pilwrap"><a href="#section-548" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Clones an active context, creating a child active context.</p></div><div class="details"><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">a</span><span>clone (child) of the active context.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">_cloneActiveContext</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">child</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">child</span><span class="p">[</span><span class="s1">&#39;@base&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="s1">&#39;@base&#39;</span><span class="p">];</span>
    <span class="nx">child</span><span class="p">.</span><span class="nx">mappings</span> <span class="o">=</span> <span class="nx">_clone</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mappings</span><span class="p">);</span>
    <span class="nx">child</span><span class="p">.</span><span class="nx">clone</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">clone</span><span class="p">;</span>
    <span class="nx">child</span><span class="p">.</span><span class="nx">inverse</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="nx">child</span><span class="p">.</span><span class="nx">getInverse</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getInverse</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@language&#39;</span> <span class="k">in</span> <span class="k">this</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">child</span><span class="p">[</span><span class="s1">&#39;@language&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="s1">&#39;@language&#39;</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@vocab&#39;</span> <span class="k">in</span> <span class="k">this</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">child</span><span class="p">[</span><span class="s1">&#39;@vocab&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="s1">&#39;@vocab&#39;</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">child</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-549"><td class="docs"><div class="pilwrap"><a href="#section-549" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Returns whether or not the given value is a keyword.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">v</span><span>- value to check.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">true</span><span>if the value is a keyword, false if not.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_isKeyword</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isString</span><span class="p">(</span><span class="nx">v</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">switch</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">case</span> <span class="s1">&#39;@base&#39;</span><span class="o">:</span>
  <span class="k">case</span> <span class="s1">&#39;@context&#39;</span><span class="o">:</span>
  <span class="k">case</span> <span class="s1">&#39;@container&#39;</span><span class="o">:</span>
  <span class="k">case</span> <span class="s1">&#39;@default&#39;</span><span class="o">:</span>
  <span class="k">case</span> <span class="s1">&#39;@embed&#39;</span><span class="o">:</span>
  <span class="k">case</span> <span class="s1">&#39;@explicit&#39;</span><span class="o">:</span>
  <span class="k">case</span> <span class="s1">&#39;@graph&#39;</span><span class="o">:</span>
  <span class="k">case</span> <span class="s1">&#39;@id&#39;</span><span class="o">:</span>
  <span class="k">case</span> <span class="s1">&#39;@index&#39;</span><span class="o">:</span>
  <span class="k">case</span> <span class="s1">&#39;@language&#39;</span><span class="o">:</span>
  <span class="k">case</span> <span class="s1">&#39;@list&#39;</span><span class="o">:</span>
  <span class="k">case</span> <span class="s1">&#39;@omitDefault&#39;</span><span class="o">:</span>
  <span class="k">case</span> <span class="s1">&#39;@preserve&#39;</span><span class="o">:</span>
  <span class="k">case</span> <span class="s1">&#39;@reverse&#39;</span><span class="o">:</span>
  <span class="k">case</span> <span class="s1">&#39;@set&#39;</span><span class="o">:</span>
  <span class="k">case</span> <span class="s1">&#39;@type&#39;</span><span class="o">:</span>
  <span class="k">case</span> <span class="s1">&#39;@value&#39;</span><span class="o">:</span>
  <span class="k">case</span> <span class="s1">&#39;@vocab&#39;</span><span class="o">:</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-550"><td class="docs"><div class="pilwrap"><a href="#section-550" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Returns true if the given value is an Object.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">v</span><span>- value to check.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">true</span><span>if the value is an Object, false if not.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_isObject</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;[object Object]&#39;</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-551"><td class="docs"><div class="pilwrap"><a href="#section-551" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Returns true if the given value is an empty Object.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">v</span><span>- value to check.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">true</span><span>if the value is an empty Object, false if not.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_isEmptyObject</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">_isObject</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">v</span><span class="p">).</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-552"><td class="docs"><div class="pilwrap"><a href="#section-552" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Returns true if the given value is an Array.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">v</span><span>- value to check.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">true</span><span>if the value is an Array, false if not.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_isArray</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-553"><td class="docs"><div class="pilwrap"><a href="#section-553" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Throws an exception if the given value is not a valid @type value.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">v</span><span>- value to check.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_validateTypeValue</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-554"><td class="docs"><div class="pilwrap"><a href="#section-554" class="pilcrow">&#182;</a></div><p>can be a string or an empty object</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">_isString</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">||</span> <span class="nx">_isEmptyObject</span><span class="p">(</span><span class="nx">v</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-555"><td class="docs"><div class="pilwrap"><a href="#section-555" class="pilcrow">&#182;</a></div><p>must be an array</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">isValid</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">v</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-556"><td class="docs"><div class="pilwrap"><a href="#section-556" class="pilcrow">&#182;</a></div><p>must contain only strings</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">isValid</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">_isString</span><span class="p">(</span><span class="nx">v</span><span class="p">[</span><span class="nx">i</span><span class="p">])))</span> <span class="p">{</span>
        <span class="nx">isValid</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">isValid</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
      <span class="s1">&#39;Invalid JSON-LD syntax; &quot;@type&quot; value must a string, an array of &#39;</span> <span class="o">+</span>
      <span class="s1">&#39;strings, or an empty object.&#39;</span><span class="p">,</span> <span class="s1">&#39;jsonld.SyntaxError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="nx">v</span><span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-557"><td class="docs"><div class="pilwrap"><a href="#section-557" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Returns true if the given value is a String.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">v</span><span>- value to check.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">true</span><span>if the value is a String, false if not.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_isString</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">v</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">||</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;[object String]&#39;</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-558"><td class="docs"><div class="pilwrap"><a href="#section-558" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Returns true if the given value is a Number.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">v</span><span>- value to check.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">true</span><span>if the value is a Number, false if not.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_isNumber</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">v</span> <span class="o">===</span> <span class="s1">&#39;number&#39;</span> <span class="o">||</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;[object Number]&#39;</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-559"><td class="docs"><div class="pilwrap"><a href="#section-559" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Returns true if the given value is a double.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">v</span><span>- value to check.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">true</span><span>if the value is a double, false if not.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_isDouble</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">_isNumber</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">String</span><span class="p">(</span><span class="nx">v</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-560"><td class="docs"><div class="pilwrap"><a href="#section-560" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Returns true if the given value is numeric.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">v</span><span>- value to check.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">true</span><span>if the value is numeric, false if not.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_isNumeric</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">v</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="nb">isFinite</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-561"><td class="docs"><div class="pilwrap"><a href="#section-561" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Returns true if the given value is a Boolean.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">v</span><span>- value to check.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">true</span><span>if the value is a Boolean, false if not.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_isBoolean</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">v</span> <span class="o">===</span> <span class="s1">&#39;boolean&#39;</span> <span class="o">||</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;[object Boolean]&#39;</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-562"><td class="docs"><div class="pilwrap"><a href="#section-562" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Returns true if the given value is undefined.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">v</span><span>- value to check.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">true</span><span>if the value is undefined, false if not.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_isUndefined</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">v</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-563"><td class="docs"><div class="pilwrap"><a href="#section-563" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Returns true if the given value is a subject with properties.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">v</span><span>- value to check.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">true</span><span>if the value is a subject with properties, false if not.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_isSubject</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-564"><td class="docs"><div class="pilwrap"><a href="#section-564" class="pilcrow">&#182;</a></div><p>Note: A value is a subject if all of these hold true:
1. It is an Object.
2. It is not a @value, @set, or @list.
3. It has more than 1 key OR any existing key is not @id.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
    <span class="o">!</span><span class="p">((</span><span class="s1">&#39;@value&#39;</span> <span class="k">in</span> <span class="nx">v</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="s1">&#39;@set&#39;</span> <span class="k">in</span> <span class="nx">v</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="s1">&#39;@list&#39;</span> <span class="k">in</span> <span class="nx">v</span><span class="p">)))</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">keyCount</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">v</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
    <span class="nx">rval</span> <span class="o">=</span> <span class="p">(</span><span class="nx">keyCount</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="s1">&#39;@id&#39;</span> <span class="k">in</span> <span class="nx">v</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-565"><td class="docs"><div class="pilwrap"><a href="#section-565" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Returns true if the given value is a subject reference.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">v</span><span>- value to check.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">true</span><span>if the value is a subject reference, false if not.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_isSubjectReference</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-566"><td class="docs"><div class="pilwrap"><a href="#section-566" class="pilcrow">&#182;</a></div><p>Note: A value is a subject reference if all of these hold true:
1. It is an Object.
2. It has a single key: @id.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">return</span> <span class="p">(</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">v</span><span class="p">).</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="s1">&#39;@id&#39;</span> <span class="k">in</span> <span class="nx">v</span><span class="p">));</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-567"><td class="docs"><div class="pilwrap"><a href="#section-567" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Returns true if the given value is a @value.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">v</span><span>- value to check.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">true</span><span>if the value is a @value, false if not.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_isValue</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-568"><td class="docs"><div class="pilwrap"><a href="#section-568" class="pilcrow">&#182;</a></div><p>Note: A value is a @value if all of these hold true:
1. It is an Object.
2. It has the @value property.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">return</span> <span class="nx">_isObject</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="s1">&#39;@value&#39;</span> <span class="k">in</span> <span class="nx">v</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-569"><td class="docs"><div class="pilwrap"><a href="#section-569" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Returns true if the given value is a @list.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">v</span><span>- value to check.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">true</span><span>if the value is a @list, false if not.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_isList</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-570"><td class="docs"><div class="pilwrap"><a href="#section-570" class="pilcrow">&#182;</a></div><p>Note: A value is a @list if all of these hold true:
1. It is an Object.
2. It has the @list property.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">return</span> <span class="nx">_isObject</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="s1">&#39;@list&#39;</span> <span class="k">in</span> <span class="nx">v</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-571"><td class="docs"><div class="pilwrap"><a href="#section-571" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Returns true if the given value is a blank node.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">v</span><span>- value to check.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">true</span><span>if the value is a blank node, false if not.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_isBlankNode</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-572"><td class="docs"><div class="pilwrap"><a href="#section-572" class="pilcrow">&#182;</a></div><p>Note: A value is a blank node if all of these hold true:
1. It is an Object.
2. If it has an @id key its value begins with '_:'.
3. It has no keys OR is not a @value, @set, or @list.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">v</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="s1">&#39;@id&#39;</span> <span class="k">in</span> <span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">rval</span> <span class="o">=</span> <span class="p">(</span><span class="nx">v</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;_:&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">rval</span> <span class="o">=</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">v</span><span class="p">).</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">||</span>
        <span class="o">!</span><span class="p">((</span><span class="s1">&#39;@value&#39;</span> <span class="k">in</span> <span class="nx">v</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="s1">&#39;@set&#39;</span> <span class="k">in</span> <span class="nx">v</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="s1">&#39;@list&#39;</span> <span class="k">in</span> <span class="nx">v</span><span class="p">)));</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-573"><td class="docs"><div class="pilwrap"><a href="#section-573" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Returns true if the given value is an absolute IRI, false if not.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">v</span><span>- value to check.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">true</span><span>if the value is an absolute IRI, false if not.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_isAbsoluteIri</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">_isString</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">v</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-574"><td class="docs"><div class="pilwrap"><a href="#section-574" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Clones an object, array, or string/number.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">value</span><span>- value to clone.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>cloned value.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_clone</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="nx">_isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">?</span> <span class="p">[]</span> <span class="o">:</span> <span class="p">{};</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">rval</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_clone</span><span class="p">(</span><span class="nx">value</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-575"><td class="docs"><div class="pilwrap"><a href="#section-575" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Finds all @context URLs in the given JSON-LD input.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">input</span><span>- JSON-LD input.</span></div><div class="dox_tag_detail"><span>a </span><span class="dox_type">urls</span><span>- map of URLs (url =&gt; false/@contexts).</span></div><div class="dox_tag_detail"><span>true </span><span class="dox_type">replace</span><span>- to replace the URLs in the given input with the</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">base</span><span>- base IRI to use to resolve relative IRIs.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">true</span><span>if new URLs to retrieve were found, false if not.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_findContextUrls</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">urls</span><span class="p">,</span> <span class="nx">replace</span><span class="p">,</span> <span class="nx">base</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">urls</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">input</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_findContextUrls</span><span class="p">(</span><span class="nx">input</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">urls</span><span class="p">,</span> <span class="nx">replace</span><span class="p">,</span> <span class="nx">base</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">count</span> <span class="o">&lt;</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">urls</span><span class="p">).</span><span class="nx">length</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">input</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">key</span> <span class="o">!==</span> <span class="s1">&#39;@context&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_findContextUrls</span><span class="p">(</span><span class="nx">input</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">urls</span><span class="p">,</span> <span class="nx">replace</span><span class="p">,</span> <span class="nx">base</span><span class="p">);</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-576"><td class="docs"><div class="pilwrap"><a href="#section-576" class="pilcrow">&#182;</a></div><p>get @context</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">input</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span></pre></div></td></tr><tr id="section-577"><td class="docs"><div class="pilwrap"><a href="#section-577" class="pilcrow">&#182;</a></div><p>array @context</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">ctx</span><span class="p">))</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">_ctx</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">_isString</span><span class="p">(</span><span class="nx">_ctx</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">_ctx</span> <span class="o">=</span> <span class="nx">_prependBase</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span> <span class="nx">_ctx</span><span class="p">);</span></pre></div></td></tr><tr id="section-578"><td class="docs"><div class="pilwrap"><a href="#section-578" class="pilcrow">&#182;</a></div><p>replace w/@context if requested</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span><span class="p">(</span><span class="nx">replace</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">_ctx</span> <span class="o">=</span> <span class="nx">urls</span><span class="p">[</span><span class="nx">_ctx</span><span class="p">];</span>
              <span class="k">if</span><span class="p">(</span><span class="nx">_isArray</span><span class="p">(</span><span class="nx">_ctx</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-579"><td class="docs"><div class="pilwrap"><a href="#section-579" class="pilcrow">&#182;</a></div><p>add flattened context</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">splice</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="p">[</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">_ctx</span><span class="p">));</span>
                <span class="nx">i</span> <span class="o">+=</span> <span class="nx">_ctx</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
                <span class="nx">length</span> <span class="o">+=</span> <span class="nx">_ctx</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
              <span class="p">}</span>
              <span class="k">else</span> <span class="p">{</span>
                <span class="nx">ctx</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_ctx</span><span class="p">;</span>
              <span class="p">}</span>
            <span class="p">}</span></pre></div></td></tr><tr id="section-580"><td class="docs"><div class="pilwrap"><a href="#section-580" class="pilcrow">&#182;</a></div><p>@context URL found</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">_ctx</span> <span class="k">in</span> <span class="nx">urls</span><span class="p">))</span> <span class="p">{</span>
              <span class="nx">urls</span><span class="p">[</span><span class="nx">_ctx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-581"><td class="docs"><div class="pilwrap"><a href="#section-581" class="pilcrow">&#182;</a></div><p>string @context</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">_isString</span><span class="p">(</span><span class="nx">ctx</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">_prependBase</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">);</span></pre></div></td></tr><tr id="section-582"><td class="docs"><div class="pilwrap"><a href="#section-582" class="pilcrow">&#182;</a></div><p>replace w/@context if requested</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">replace</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">input</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">urls</span><span class="p">[</span><span class="nx">ctx</span><span class="p">];</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-583"><td class="docs"><div class="pilwrap"><a href="#section-583" class="pilcrow">&#182;</a></div><p>@context URL found</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">ctx</span> <span class="k">in</span> <span class="nx">urls</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">urls</span><span class="p">[</span><span class="nx">ctx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">count</span> <span class="o">&lt;</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">urls</span><span class="p">).</span><span class="nx">length</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-584"><td class="docs"><div class="pilwrap"><a href="#section-584" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Retrieves external @context URLs using the given context loader. Every<br />instance of @context in the input that refers to a URL will be replaced<br />with the JSON @context found at that URL.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">input</span><span>- JSON-LD input with possible contexts.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">options</span><span>- options to use:</span></div><div class="dox_tag_detail"><span>input) </span><span class="dox_type">callback(err</span><span class="dox_type"></span><span>- called once the operation completes.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_retrieveContextUrls</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-585"><td class="docs"><div class="pilwrap"><a href="#section-585" class="pilcrow">&#182;</a></div><p>if any error occurs during URL resolution, quit</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">regex</span> <span class="o">=</span> <span class="sr">/(http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&amp;%@!\-\/]))?/</span><span class="p">;</span></pre></div></td></tr><tr id="section-586"><td class="docs"><div class="pilwrap"><a href="#section-586" class="pilcrow">&#182;</a></div><p>recursive context loader</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">loadContext</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">loadContext</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">retrieve</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">cycles</span><span class="p">,</span> <span class="nx">loadContext</span><span class="p">,</span> <span class="nx">base</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">cycles</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">MAX_CONTEXT_URLS</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">error</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
        <span class="s1">&#39;Maximum number of @context URLs exceeded.&#39;</span><span class="p">,</span>
        <span class="s1">&#39;jsonld.ContextUrlError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">max</span><span class="o">:</span> <span class="nx">MAX_CONTEXT_URLS</span><span class="p">});</span>
      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-587"><td class="docs"><div class="pilwrap"><a href="#section-587" class="pilcrow">&#182;</a></div><p>for tracking the URLs to retrieve</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">urls</span> <span class="o">=</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-588"><td class="docs"><div class="pilwrap"><a href="#section-588" class="pilcrow">&#182;</a></div><p>finished will be called once the URL queue is empty</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">finished</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div></td></tr><tr id="section-589"><td class="docs"><div class="pilwrap"><a href="#section-589" class="pilcrow">&#182;</a></div><p>replace all URLs in the input</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">_findContextUrls</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">urls</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">base</span><span class="p">);</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">input</span><span class="p">);</span>
    <span class="p">};</span></pre></div></td></tr><tr id="section-590"><td class="docs"><div class="pilwrap"><a href="#section-590" class="pilcrow">&#182;</a></div><p>find all URLs in the given input</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_findContextUrls</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">urls</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">base</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-591"><td class="docs"><div class="pilwrap"><a href="#section-591" class="pilcrow">&#182;</a></div><p>no new URLs in input</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">finished</span><span class="p">();</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-592"><td class="docs"><div class="pilwrap"><a href="#section-592" class="pilcrow">&#182;</a></div><p>queue all unretrieved URLs</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">queue</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">url</span> <span class="k">in</span> <span class="nx">urls</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">urls</span><span class="p">[</span><span class="nx">url</span><span class="p">]</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-593"><td class="docs"><div class="pilwrap"><a href="#section-593" class="pilcrow">&#182;</a></div><p>validate URL</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">regex</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">url</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">error</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
            <span class="s1">&#39;Malformed URL.&#39;</span><span class="p">,</span> <span class="s1">&#39;jsonld.InvalidUrl&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">url</span><span class="o">:</span> <span class="nx">url</span><span class="p">});</span>
          <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">queue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-594"><td class="docs"><div class="pilwrap"><a href="#section-594" class="pilcrow">&#182;</a></div><p>retrieve URLs in queue</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">queue</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-595"><td class="docs"><div class="pilwrap"><a href="#section-595" class="pilcrow">&#182;</a></div><p>check for context URL cycle</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">url</span> <span class="k">in</span> <span class="nx">cycles</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">error</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
            <span class="s1">&#39;Cyclical @context URLs detected.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;jsonld.ContextUrlError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">url</span><span class="o">:</span> <span class="nx">url</span><span class="p">});</span>
          <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">_cycles</span> <span class="o">=</span> <span class="nx">_clone</span><span class="p">(</span><span class="nx">cycles</span><span class="p">);</span>
        <span class="nx">_cycles</span><span class="p">[</span><span class="nx">url</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

        <span class="nx">loadContext</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">finalUrl</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-596"><td class="docs"><div class="pilwrap"><a href="#section-596" class="pilcrow">&#182;</a></div><p>short-circuit if there was an error with another URL</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">if</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
          <span class="p">}</span></pre></div></td></tr><tr id="section-597"><td class="docs"><div class="pilwrap"><a href="#section-597" class="pilcrow">&#182;</a></div><p>parse string context as JSON</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">err</span> <span class="o">&amp;&amp;</span> <span class="nx">_isString</span><span class="p">(</span><span class="nx">ctx</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">try</span> <span class="p">{</span>
              <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span><span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">err</span> <span class="o">=</span> <span class="nx">ex</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span></pre></div></td></tr><tr id="section-598"><td class="docs"><div class="pilwrap"><a href="#section-598" class="pilcrow">&#182;</a></div><p>ensure ctx is an object</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">err</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
              <span class="s1">&#39;Derefencing a URL did not result in a valid JSON-LD object. &#39;</span> <span class="o">+</span>
              <span class="s1">&#39;Possible causes are an inaccessible URL perhaps due to &#39;</span> <span class="o">+</span>
              <span class="s1">&#39;a same-origin policy (ensure the server uses CORS if you are &#39;</span> <span class="o">+</span>
              <span class="s1">&#39;using client-side JavaScript), too many redirects, or a &#39;</span> <span class="o">+</span>
              <span class="s1">&#39;non-JSON response.&#39;</span><span class="p">,</span>
              <span class="s1">&#39;jsonld.InvalidUrl&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">url</span><span class="o">:</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">cause</span><span class="o">:</span> <span class="nx">err</span><span class="p">});</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">ctx</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">err</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
              <span class="s1">&#39;Derefencing a URL did not result in a JSON object. The &#39;</span> <span class="o">+</span>
              <span class="s1">&#39;response was valid JSON, but it was not a JSON object.&#39;</span><span class="p">,</span>
              <span class="s1">&#39;jsonld.InvalidUrl&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">url</span><span class="o">:</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">cause</span><span class="o">:</span> <span class="nx">err</span><span class="p">});</span>
          <span class="p">}</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">error</span> <span class="o">=</span> <span class="nx">err</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
          <span class="p">}</span></pre></div></td></tr><tr id="section-599"><td class="docs"><div class="pilwrap"><a href="#section-599" class="pilcrow">&#182;</a></div><p>use empty context if no @context key is present</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;@context&#39;</span> <span class="k">in</span> <span class="nx">ctx</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@context&#39;</span><span class="o">:</span> <span class="p">{}};</span>
          <span class="p">}</span></pre></div></td></tr><tr id="section-600"><td class="docs"><div class="pilwrap"><a href="#section-600" class="pilcrow">&#182;</a></div><p>recurse</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">retrieve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">_cycles</span><span class="p">,</span> <span class="nx">loadContext</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">urls</span><span class="p">[</span><span class="nx">url</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">[</span><span class="s1">&#39;@context&#39;</span><span class="p">];</span>
            <span class="nx">count</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">count</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">finished</span><span class="p">();</span>
            <span class="p">}</span>
          <span class="p">});</span>
        <span class="p">});</span>
      <span class="p">}(</span><span class="nx">queue</span><span class="p">[</span><span class="nx">i</span><span class="p">]));</span>
    <span class="p">}</span>
  <span class="p">};</span>
  <span class="nx">retrieve</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">loadContext</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">base</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-601"><td class="docs"><div class="pilwrap"><a href="#section-601" class="pilcrow">&#182;</a></div><p>define js 1.8.5 Object.keys method if not present</p>
</td><td class="code"><div class="highlight"><pre><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">o</span> <span class="o">!==</span> <span class="nb">Object</span><span class="p">(</span><span class="nx">o</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Object.keys called on non-object&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">p</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">rval</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-602"><td class="docs"><div class="pilwrap"><a href="#section-602" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Parses RDF in the form of N-Quads.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">input</span><span>- N-Quads input to parse.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">an</span><span>RDF dataset.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_parseNQuads</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-603"><td class="docs"><div class="pilwrap"><a href="#section-603" class="pilcrow">&#182;</a></div><p>define partial regexes</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">iri</span> <span class="o">=</span> <span class="s1">&#39;(?:&lt;([^:]+:[^&gt;]*)&gt;)&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">bnode</span> <span class="o">=</span> <span class="s1">&#39;(_:(?:[A-Za-z][A-Za-z0-9]*))&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">plain</span> <span class="o">=</span> <span class="s1">&#39;&quot;([^&quot;\\\\]*(?:\\\\.[^&quot;\\\\]*)*)&quot;&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">datatype</span> <span class="o">=</span> <span class="s1">&#39;(?:\\^\\^&#39;</span> <span class="o">+</span> <span class="nx">iri</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">language</span> <span class="o">=</span> <span class="s1">&#39;(?:@([a-z]+(?:-[a-z0-9]+)*))&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">literal</span> <span class="o">=</span> <span class="s1">&#39;(?:&#39;</span> <span class="o">+</span> <span class="nx">plain</span> <span class="o">+</span> <span class="s1">&#39;(?:&#39;</span> <span class="o">+</span> <span class="nx">datatype</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="nx">language</span> <span class="o">+</span> <span class="s1">&#39;)?)&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="s1">&#39;[ \\t]+&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">wso</span> <span class="o">=</span> <span class="s1">&#39;[ \\t]*&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">eoln</span> <span class="o">=</span> <span class="sr">/(?:\r\n)|(?:\n)|(?:\r)/g</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">empty</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="nx">wso</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-604"><td class="docs"><div class="pilwrap"><a href="#section-604" class="pilcrow">&#182;</a></div><p>define quad part regexes</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">subject</span> <span class="o">=</span> <span class="s1">&#39;(?:&#39;</span> <span class="o">+</span> <span class="nx">iri</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="nx">bnode</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span> <span class="nx">ws</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">property</span> <span class="o">=</span> <span class="nx">iri</span> <span class="o">+</span> <span class="nx">ws</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="s1">&#39;(?:&#39;</span> <span class="o">+</span> <span class="nx">iri</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="nx">bnode</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="nx">literal</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span> <span class="nx">wso</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">graphName</span> <span class="o">=</span> <span class="s1">&#39;(?:\\.|(?:(?:&#39;</span> <span class="o">+</span> <span class="nx">iri</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="nx">bnode</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span> <span class="nx">wso</span> <span class="o">+</span> <span class="s1">&#39;\\.))&#39;</span><span class="p">;</span></pre></div></td></tr><tr id="section-605"><td class="docs"><div class="pilwrap"><a href="#section-605" class="pilcrow">&#182;</a></div><p>full quad regex</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">quad</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span>
    <span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="nx">wso</span> <span class="o">+</span> <span class="nx">subject</span> <span class="o">+</span> <span class="nx">property</span> <span class="o">+</span> <span class="nx">object</span> <span class="o">+</span> <span class="nx">graphName</span> <span class="o">+</span> <span class="nx">wso</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-606"><td class="docs"><div class="pilwrap"><a href="#section-606" class="pilcrow">&#182;</a></div><p>build RDF dataset</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">dataset</span> <span class="o">=</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-607"><td class="docs"><div class="pilwrap"><a href="#section-607" class="pilcrow">&#182;</a></div><p>split N-Quad input into lines</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">lines</span> <span class="o">=</span> <span class="nx">input</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">eoln</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">lineNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">li</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">li</span> <span class="o">&lt;</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">li</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">[</span><span class="nx">li</span><span class="p">];</span>
    <span class="nx">lineNumber</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr><tr id="section-608"><td class="docs"><div class="pilwrap"><a href="#section-608" class="pilcrow">&#182;</a></div><p>skip empty lines</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">empty</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">line</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-609"><td class="docs"><div class="pilwrap"><a href="#section-609" class="pilcrow">&#182;</a></div><p>parse quad</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">quad</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">match</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
        <span class="s1">&#39;Error while parsing N-Quads; invalid quad.&#39;</span><span class="p">,</span>
        <span class="s1">&#39;jsonld.ParseError&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">lineNumber</span><span class="p">});</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-610"><td class="docs"><div class="pilwrap"><a href="#section-610" class="pilcrow">&#182;</a></div><p>create RDF triple</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">triple</span> <span class="o">=</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-611"><td class="docs"><div class="pilwrap"><a href="#section-611" class="pilcrow">&#182;</a></div><p>get subject</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isUndefined</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
      <span class="nx">triple</span><span class="p">.</span><span class="nx">subject</span> <span class="o">=</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;IRI&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]};</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">triple</span><span class="p">.</span><span class="nx">subject</span> <span class="o">=</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;blank node&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]};</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-612"><td class="docs"><div class="pilwrap"><a href="#section-612" class="pilcrow">&#182;</a></div><p>get predicate</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">triple</span><span class="p">.</span><span class="nx">predicate</span> <span class="o">=</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;IRI&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">]};</span></pre></div></td></tr><tr id="section-613"><td class="docs"><div class="pilwrap"><a href="#section-613" class="pilcrow">&#182;</a></div><p>get object</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isUndefined</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span> <span class="p">{</span>
      <span class="nx">triple</span><span class="p">.</span><span class="nx">object</span> <span class="o">=</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;IRI&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">match</span><span class="p">[</span><span class="mi">4</span><span class="p">]};</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isUndefined</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span> <span class="p">{</span>
      <span class="nx">triple</span><span class="p">.</span><span class="nx">object</span> <span class="o">=</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;blank node&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">match</span><span class="p">[</span><span class="mi">5</span><span class="p">]};</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">triple</span><span class="p">.</span><span class="nx">object</span> <span class="o">=</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;literal&#39;</span><span class="p">};</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isUndefined</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">7</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nx">triple</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">datatype</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isUndefined</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">8</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nx">triple</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">datatype</span> <span class="o">=</span> <span class="nx">RDF_LANGSTRING</span><span class="p">;</span>
        <span class="nx">triple</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">language</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">triple</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">datatype</span> <span class="o">=</span> <span class="nx">XSD_STRING</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">unescaped</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
        <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\&quot;/g</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\t/g</span><span class="p">,</span> <span class="s1">&#39;\t&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\n/g</span><span class="p">,</span> <span class="s1">&#39;\n&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\r/g</span><span class="p">,</span> <span class="s1">&#39;\r&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\\\/g</span><span class="p">,</span> <span class="s1">&#39;\\&#39;</span><span class="p">);</span>
      <span class="nx">triple</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">unescaped</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-614"><td class="docs"><div class="pilwrap"><a href="#section-614" class="pilcrow">&#182;</a></div><p>get graph name ('@default' is used for the default graph)</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;@default&#39;</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isUndefined</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">9</span><span class="p">]))</span> <span class="p">{</span>
      <span class="nx">name</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_isUndefined</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">10</span><span class="p">]))</span> <span class="p">{</span>
      <span class="nx">name</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-615"><td class="docs"><div class="pilwrap"><a href="#section-615" class="pilcrow">&#182;</a></div><p>initialize graph in dataset</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">name</span> <span class="k">in</span> <span class="nx">dataset</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">dataset</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">triple</span><span class="p">];</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-616"><td class="docs"><div class="pilwrap"><a href="#section-616" class="pilcrow">&#182;</a></div><p>add triple if unique to its graph</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">else</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">unique</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">triples</span> <span class="o">=</span> <span class="nx">dataset</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">ti</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">unique</span> <span class="o">&amp;&amp;</span> <span class="nx">ti</span> <span class="o">&lt;</span> <span class="nx">triples</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">ti</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">_compareRDFTriples</span><span class="p">(</span><span class="nx">triples</span><span class="p">[</span><span class="nx">ti</span><span class="p">],</span> <span class="nx">triple</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">unique</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">unique</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">triples</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">triple</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">dataset</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-617"><td class="docs"><div class="pilwrap"><a href="#section-617" class="pilcrow">&#182;</a></div><p>register the N-Quads RDF parser</p>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">registerRDFParser</span><span class="p">(</span><span class="s1">&#39;application/nquads&#39;</span><span class="p">,</span> <span class="nx">_parseNQuads</span><span class="p">);</span></pre></div></td></tr><tr id="section-618"><td class="docs"><div class="pilwrap"><a href="#section-618" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Converts an RDF dataset to N-Quads.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">dataset</span><span>- RDF dataset to convert.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>N-Quads string.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_toNQuads</span><span class="p">(</span><span class="nx">dataset</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">quads</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">graphName</span> <span class="k">in</span> <span class="nx">dataset</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">triples</span> <span class="o">=</span> <span class="nx">dataset</span><span class="p">[</span><span class="nx">graphName</span><span class="p">];</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">ti</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ti</span> <span class="o">&lt;</span> <span class="nx">triples</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">ti</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">triple</span> <span class="o">=</span> <span class="nx">triples</span><span class="p">[</span><span class="nx">ti</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">graphName</span> <span class="o">===</span> <span class="s1">&#39;@default&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">graphName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">quads</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">_toNQuad</span><span class="p">(</span><span class="nx">triple</span><span class="p">,</span> <span class="nx">graphName</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">quads</span><span class="p">.</span><span class="nx">sort</span><span class="p">();</span>
  <span class="k">return</span> <span class="nx">quads</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-619"><td class="docs"><div class="pilwrap"><a href="#section-619" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Converts an RDF triple and graph name to an N-Quad string (a single quad).</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">triple</span><span>- RDF triple to convert.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">graphName</span><span>- name of the graph containing the triple, null for</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">bnode</span><span>- bnode the quad is mapped to (optional, for use</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>N-Quad string.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_toNQuad</span><span class="p">(</span><span class="nx">triple</span><span class="p">,</span> <span class="nx">graphName</span><span class="p">,</span> <span class="nx">bnode</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">triple</span><span class="p">.</span><span class="nx">subject</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">triple</span><span class="p">.</span><span class="nx">predicate</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="nx">triple</span><span class="p">.</span><span class="nx">object</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">graphName</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">quad</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span></pre></div></td></tr><tr id="section-620"><td class="docs"><div class="pilwrap"><a href="#section-620" class="pilcrow">&#182;</a></div><p>subject is an IRI or bnode</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;IRI&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">quad</span> <span class="o">+=</span> <span class="s1">&#39;&lt;&#39;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">.</span><span class="nx">value</span> <span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-621"><td class="docs"><div class="pilwrap"><a href="#section-621" class="pilcrow">&#182;</a></div><p>normalization mode</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">bnode</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">quad</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">value</span> <span class="o">===</span> <span class="nx">bnode</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;_:a&#39;</span> <span class="o">:</span> <span class="s1">&#39;_:z&#39;</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-622"><td class="docs"><div class="pilwrap"><a href="#section-622" class="pilcrow">&#182;</a></div><p>normal mode</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">quad</span> <span class="o">+=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-623"><td class="docs"><div class="pilwrap"><a href="#section-623" class="pilcrow">&#182;</a></div><p>predicate is always an IRI</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">quad</span> <span class="o">+=</span> <span class="s1">&#39; &lt;&#39;</span> <span class="o">+</span> <span class="nx">p</span><span class="p">.</span><span class="nx">value</span> <span class="o">+</span> <span class="s1">&#39;&gt; &#39;</span><span class="p">;</span></pre></div></td></tr><tr id="section-624"><td class="docs"><div class="pilwrap"><a href="#section-624" class="pilcrow">&#182;</a></div><p>object is IRI, bnode, or literal</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;IRI&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">quad</span> <span class="o">+=</span> <span class="s1">&#39;&lt;&#39;</span> <span class="o">+</span> <span class="nx">o</span><span class="p">.</span><span class="nx">value</span> <span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;blank node&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-625"><td class="docs"><div class="pilwrap"><a href="#section-625" class="pilcrow">&#182;</a></div><p>normalization mode</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">bnode</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">quad</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">value</span> <span class="o">===</span> <span class="nx">bnode</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;_:a&#39;</span> <span class="o">:</span> <span class="s1">&#39;_:z&#39;</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-626"><td class="docs"><div class="pilwrap"><a href="#section-626" class="pilcrow">&#182;</a></div><p>normal mode</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">quad</span> <span class="o">+=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">escaped</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">value</span>
      <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\/g</span><span class="p">,</span> <span class="s1">&#39;\\\\&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\t/g</span><span class="p">,</span> <span class="s1">&#39;\\t&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\n/g</span><span class="p">,</span> <span class="s1">&#39;\\n&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\r/g</span><span class="p">,</span> <span class="s1">&#39;\\r&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\&quot;/g</span><span class="p">,</span> <span class="s1">&#39;\\&quot;&#39;</span><span class="p">);</span>
    <span class="nx">quad</span> <span class="o">+=</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="nx">escaped</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">datatype</span> <span class="o">===</span> <span class="nx">RDF_LANGSTRING</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">quad</span> <span class="o">+=</span> <span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="nx">o</span><span class="p">.</span><span class="nx">language</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">datatype</span> <span class="o">!==</span> <span class="nx">XSD_STRING</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">quad</span> <span class="o">+=</span> <span class="s1">&#39;^^&lt;&#39;</span> <span class="o">+</span> <span class="nx">o</span><span class="p">.</span><span class="nx">datatype</span> <span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-627"><td class="docs"><div class="pilwrap"><a href="#section-627" class="pilcrow">&#182;</a></div><p>graph</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">g</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;_:&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">quad</span> <span class="o">+=</span> <span class="s1">&#39; &lt;&#39;</span> <span class="o">+</span> <span class="nx">g</span> <span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">bnode</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">quad</span> <span class="o">+=</span> <span class="s1">&#39; _:g&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">quad</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">g</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">quad</span> <span class="o">+=</span> <span class="s1">&#39; .\n&#39;</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">quad</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-628"><td class="docs"><div class="pilwrap"><a href="#section-628" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Parses the RDF dataset found via the data object from the RDFa API.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">data</span><span>- RDFa API data object.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>RDF dataset.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_parseRdfaApiData</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">dataset</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="nx">dataset</span><span class="p">[</span><span class="s1">&#39;@default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>

  <span class="kd">var</span> <span class="nx">subjects</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">getSubjects</span><span class="p">();</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">si</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">si</span> <span class="o">&lt;</span> <span class="nx">subjects</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">si</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">subject</span> <span class="o">=</span> <span class="nx">subjects</span><span class="p">[</span><span class="nx">si</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">subject</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-629"><td class="docs"><div class="pilwrap"><a href="#section-629" class="pilcrow">&#182;</a></div><p>get all related triples</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">triples</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">getSubjectTriples</span><span class="p">(</span><span class="nx">subject</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">triples</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">predicates</span> <span class="o">=</span> <span class="nx">triples</span><span class="p">.</span><span class="nx">predicates</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">predicate</span> <span class="k">in</span> <span class="nx">predicates</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-630"><td class="docs"><div class="pilwrap"><a href="#section-630" class="pilcrow">&#182;</a></div><p>iterate over objects</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">objects</span> <span class="o">=</span> <span class="nx">predicates</span><span class="p">[</span><span class="nx">predicate</span><span class="p">].</span><span class="nx">objects</span><span class="p">;</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">oi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">oi</span> <span class="o">&lt;</span> <span class="nx">objects</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">oi</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="nx">objects</span><span class="p">[</span><span class="nx">oi</span><span class="p">];</span></pre></div></td></tr><tr id="section-631"><td class="docs"><div class="pilwrap"><a href="#section-631" class="pilcrow">&#182;</a></div><p>create RDF triple</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">triple</span> <span class="o">=</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-632"><td class="docs"><div class="pilwrap"><a href="#section-632" class="pilcrow">&#182;</a></div><p>add subject</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">subject</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;_:&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">triple</span><span class="p">.</span><span class="nx">subject</span> <span class="o">=</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;blank node&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">subject</span><span class="p">};</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">triple</span><span class="p">.</span><span class="nx">subject</span> <span class="o">=</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;IRI&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">subject</span><span class="p">};</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-633"><td class="docs"><div class="pilwrap"><a href="#section-633" class="pilcrow">&#182;</a></div><p>add predicate</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">triple</span><span class="p">.</span><span class="nx">predicate</span> <span class="o">=</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;IRI&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">predicate</span><span class="p">};</span></pre></div></td></tr><tr id="section-634"><td class="docs"><div class="pilwrap"><a href="#section-634" class="pilcrow">&#182;</a></div><p>serialize XML literal</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">RDF_XML_LITERAL</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-635"><td class="docs"><div class="pilwrap"><a href="#section-635" class="pilcrow">&#182;</a></div><p>initialize XMLSerializer</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">XMLSerializer</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">_defineXMLSerializer</span><span class="p">();</span>
          <span class="p">}</span>
          <span class="kd">var</span> <span class="nx">serializer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLSerializer</span><span class="p">();</span>
          <span class="nx">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
          <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">object</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="nx">x</span><span class="p">].</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="nx">Node</span><span class="p">.</span><span class="nx">ELEMENT_NODE</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">value</span> <span class="o">+=</span> <span class="nx">serializer</span><span class="p">.</span><span class="nx">serializeToString</span><span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="nx">x</span><span class="p">]);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="nx">x</span><span class="p">].</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="nx">Node</span><span class="p">.</span><span class="nx">TEXT_NODE</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">value</span> <span class="o">+=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="nx">x</span><span class="p">].</span><span class="nx">nodeValue</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-636"><td class="docs"><div class="pilwrap"><a href="#section-636" class="pilcrow">&#182;</a></div><p>add object</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">triple</span><span class="p">.</span><span class="nx">object</span> <span class="o">=</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-637"><td class="docs"><div class="pilwrap"><a href="#section-637" class="pilcrow">&#182;</a></div><p>object is an IRI</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">RDF_OBJECT</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;_:&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">triple</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;blank node&#39;</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span>
            <span class="nx">triple</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;IRI&#39;</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-638"><td class="docs"><div class="pilwrap"><a href="#section-638" class="pilcrow">&#182;</a></div><p>literal</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">triple</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;literal&#39;</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">RDF_PLAIN_LITERAL</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">language</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">triple</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">datatype</span> <span class="o">=</span> <span class="nx">RDF_LANGSTRING</span><span class="p">;</span>
              <span class="nx">triple</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">language</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">language</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
              <span class="nx">triple</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">datatype</span> <span class="o">=</span> <span class="nx">XSD_STRING</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span>
            <span class="nx">triple</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">datatype</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">triple</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span></pre></div></td></tr><tr id="section-639"><td class="docs"><div class="pilwrap"><a href="#section-639" class="pilcrow">&#182;</a></div><p>add triple to dataset in default graph</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">dataset</span><span class="p">[</span><span class="s1">&#39;@default&#39;</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">triple</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">dataset</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-640"><td class="docs"><div class="pilwrap"><a href="#section-640" class="pilcrow">&#182;</a></div><p>register the RDFa API RDF parser</p>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">registerRDFParser</span><span class="p">(</span><span class="s1">&#39;rdfa-api&#39;</span><span class="p">,</span> <span class="nx">_parseRdfaApiData</span><span class="p">);</span></pre></div></td></tr><tr id="section-641"><td class="docs"><div class="pilwrap"><a href="#section-641" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Creates a new UniqueNamer. A UniqueNamer issues unique names, keeping<br />track of any previously issued names.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">prefix</span><span>- prefix to use ('&lt;prefix&gt;&lt;counter&gt;').</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">UniqueNamer</span><span class="p">(</span><span class="nx">prefix</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">=</span> <span class="nx">prefix</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">existing</span> <span class="o">=</span> <span class="p">{};</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-642"><td class="docs"><div class="pilwrap"><a href="#section-642" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Copies this UniqueNamer.</p></div><div class="details"><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">a</span><span>copy of this UniqueNamer.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">UniqueNamer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clone</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">copy</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UniqueNamer</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">prefix</span><span class="p">);</span>
  <span class="nx">copy</span><span class="p">.</span><span class="nx">counter</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">counter</span><span class="p">;</span>
  <span class="nx">copy</span><span class="p">.</span><span class="nx">existing</span> <span class="o">=</span> <span class="nx">_clone</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">existing</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">copy</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-643"><td class="docs"><div class="pilwrap"><a href="#section-643" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Gets the new name for the given old name, where if no old name is given<br />a new name will be generated.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">[oldName]</span><span>- old name to get the new name for.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>new name.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">UniqueNamer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getName</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">oldName</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-644"><td class="docs"><div class="pilwrap"><a href="#section-644" class="pilcrow">&#182;</a></div><p>return existing old name</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">oldName</span> <span class="o">&amp;&amp;</span> <span class="nx">oldName</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">existing</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">existing</span><span class="p">[</span><span class="nx">oldName</span><span class="p">];</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-645"><td class="docs"><div class="pilwrap"><a href="#section-645" class="pilcrow">&#182;</a></div><p>get next name</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">counter</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">counter</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr><tr id="section-646"><td class="docs"><div class="pilwrap"><a href="#section-646" class="pilcrow">&#182;</a></div><p>save mapping</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">oldName</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">existing</span><span class="p">[</span><span class="nx">oldName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">name</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-647"><td class="docs"><div class="pilwrap"><a href="#section-647" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Returns true if the given oldName has already been assigned a new name.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">oldName</span><span>- oldName to check.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">true</span><span>if the oldName has been assigned a new name, false if not.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">UniqueNamer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isNamed</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">oldName</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="nx">oldName</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">existing</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-648"><td class="docs"><div class="pilwrap"><a href="#section-648" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>A Permutator iterates over all possible permutations of the given array<br />of elements.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">list</span><span>- array of elements to iterate over.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Permutator</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">list</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-649"><td class="docs"><div class="pilwrap"><a href="#section-649" class="pilcrow">&#182;</a></div><p>original array</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">list</span> <span class="o">=</span> <span class="nx">list</span><span class="p">.</span><span class="nx">sort</span><span class="p">();</span></pre></div></td></tr><tr id="section-650"><td class="docs"><div class="pilwrap"><a href="#section-650" class="pilcrow">&#182;</a></div><p>indicates whether there are more permutations</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">done</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div></td></tr><tr id="section-651"><td class="docs"><div class="pilwrap"><a href="#section-651" class="pilcrow">&#182;</a></div><p>directional info for permutation algorithm</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">left</span><span class="p">[</span><span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-652"><td class="docs"><div class="pilwrap"><a href="#section-652" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Returns true if there is another permutation.</p></div><div class="details"><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">true</span><span>if there is another permutation, false if not.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Permutator</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasNext</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">done</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-653"><td class="docs"><div class="pilwrap"><a href="#section-653" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Gets the next permutation. Call hasNext() to ensure there is another one<br />first.</p></div><div class="details"><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>next permutation.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">Permutator</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div></td></tr><tr id="section-654"><td class="docs"><div class="pilwrap"><a href="#section-654" class="pilcrow">&#182;</a></div><p>copy current permutation</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">slice</span><span class="p">();</span></pre></div></td></tr><tr id="section-655"><td class="docs"><div class="pilwrap"><a href="#section-655" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Calculate the next permutation using the Steinhaus-Johnson-Trotter<br />   permutation algorithm.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-656"><td class="docs"><div class="pilwrap"><a href="#section-656" class="pilcrow">&#182;</a></div><p>get largest mobile element k
(mobile: element is greater than the one it is looking at)</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">left</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">left</span><span class="p">[</span><span class="nx">element</span><span class="p">];</span>
    <span class="k">if</span><span class="p">((</span><span class="nx">k</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">element</span> <span class="o">&gt;</span> <span class="nx">k</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="p">((</span><span class="nx">left</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">element</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">||</span>
      <span class="p">(</span><span class="o">!</span><span class="nx">left</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">element</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])))</span> <span class="p">{</span>
      <span class="nx">k</span> <span class="o">=</span> <span class="nx">element</span><span class="p">;</span>
      <span class="nx">pos</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-657"><td class="docs"><div class="pilwrap"><a href="#section-657" class="pilcrow">&#182;</a></div><p>no more permutations</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">k</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">done</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-658"><td class="docs"><div class="pilwrap"><a href="#section-658" class="pilcrow">&#182;</a></div><p>swap k and the element it is looking at</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">swap</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">left</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">?</span> <span class="nx">pos</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="nx">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">[</span><span class="nx">pos</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">[</span><span class="nx">swap</span><span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">[</span><span class="nx">swap</span><span class="p">]</span> <span class="o">=</span> <span class="nx">k</span><span class="p">;</span></pre></div></td></tr><tr id="section-659"><td class="docs"><div class="pilwrap"><a href="#section-659" class="pilcrow">&#182;</a></div><p>reverse the direction of all elements larger than k</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">left</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">left</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-660"><td class="docs"><div class="pilwrap"><a href="#section-660" class="pilcrow">&#182;</a></div><p>SHA-1 API</p>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">sha1</span> <span class="o">=</span> <span class="nx">jsonld</span><span class="p">.</span><span class="nx">sha1</span> <span class="o">=</span> <span class="p">{};</span>

<span class="k">if</span><span class="p">(</span><span class="nx">_nodejs</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;crypto&#39;</span><span class="p">);</span>
  <span class="nx">sha1</span><span class="p">.</span><span class="nx">create</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">md</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="s1">&#39;sha1&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">md</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
      <span class="p">},</span>
      <span class="nx">digest</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">md</span><span class="p">.</span><span class="nx">digest</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">};</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
  <span class="nx">sha1</span><span class="p">.</span><span class="nx">create</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">sha1</span><span class="p">.</span><span class="nx">MessageDigest</span><span class="p">();</span>
  <span class="p">};</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-661"><td class="docs"><div class="pilwrap"><a href="#section-661" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Hashes the given array of quads and returns its hexadecimal SHA-1 message<br />digest.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">nquads</span><span>- list of serialized quads to hash.</span></div><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>hexadecimal SHA-1 message digest.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">sha1</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">nquads</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">md</span> <span class="o">=</span> <span class="nx">sha1</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">nquads</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">md</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">nquads</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">md</span><span class="p">.</span><span class="nx">digest</span><span class="p">();</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-662"><td class="docs"><div class="pilwrap"><a href="#section-662" class="pilcrow">&#182;</a></div><p>only define sha1 MessageDigest for non-nodejs</p>
</td><td class="code"><div class="highlight"><pre><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_nodejs</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-663"><td class="docs"><div class="pilwrap"><a href="#section-663" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Creates a simple byte buffer for message digest operations.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">sha1</span><span class="p">.</span><span class="nx">Buffer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-664"><td class="docs"><div class="pilwrap"><a href="#section-664" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Puts a 32-bit integer into this buffer in big-endian order.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">i</span><span>- 32-bit integer.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">sha1</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">putInt32</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">+=</span> <span class="p">(</span>
    <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">i</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">+</span>
    <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">i</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">+</span>
    <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">i</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">+</span>
    <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">i</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-665"><td class="docs"><div class="pilwrap"><a href="#section-665" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Gets a 32-bit integer from this buffer in big-endian order and<br />advances the read pointer by 4.</p></div><div class="details"><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>word.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">sha1</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getInt32</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="p">(</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">^</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">read</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">^</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">read</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">^</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">read</span> <span class="o">+</span> <span class="mi">3</span><span class="p">));</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">read</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-666"><td class="docs"><div class="pilwrap"><a href="#section-666" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Gets the bytes in this buffer.</p></div><div class="details"><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">a</span><span>string full of UTF-8 encoded characters.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">sha1</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">bytes</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-667"><td class="docs"><div class="pilwrap"><a href="#section-667" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Gets the number of bytes in this buffer.</p></div><div class="details"><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>number of bytes in this buffer.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">sha1</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-668"><td class="docs"><div class="pilwrap"><a href="#section-668" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Compacts this buffer.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">sha1</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">compact</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-669"><td class="docs"><div class="pilwrap"><a href="#section-669" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Converts this buffer to a hexadecimal string.</p></div><div class="details"><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">a</span><span>hexadecimal string.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">sha1</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toHex</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">b</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">rval</span> <span class="o">+=</span> <span class="s1">&#39;0&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">rval</span> <span class="o">+=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">rval</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-670"><td class="docs"><div class="pilwrap"><a href="#section-670" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Creates a SHA-1 message digest object.</p></div><div class="details"><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">a</span><span>message digest object.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">sha1</span><span class="p">.</span><span class="nx">MessageDigest</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div></td></tr><tr id="section-671"><td class="docs"><div class="pilwrap"><a href="#section-671" class="pilcrow">&#182;</a></div><p>do initialization as necessary</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_sha1</span><span class="p">.</span><span class="nx">initialized</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">_sha1</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">blockLength</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">digestLength</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span></pre></div></td></tr><tr id="section-672"><td class="docs"><div class="pilwrap"><a href="#section-672" class="pilcrow">&#182;</a></div><p>length of message so far (does not including padding)</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">messageLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr><tr id="section-673"><td class="docs"><div class="pilwrap"><a href="#section-673" class="pilcrow">&#182;</a></div><p>input buffer</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">sha1</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">();</span></pre></div></td></tr><tr id="section-674"><td class="docs"><div class="pilwrap"><a href="#section-674" class="pilcrow">&#182;</a></div><p>for storing words in the SHA-1 algorithm</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">words</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span></pre></div></td></tr><tr id="section-675"><td class="docs"><div class="pilwrap"><a href="#section-675" class="pilcrow">&#182;</a></div><p>SHA-1 state contains five 32-bit integers</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">h0</span><span class="o">:</span> <span class="mh">0x67452301</span><span class="p">,</span>
    <span class="nx">h1</span><span class="o">:</span> <span class="mh">0xEFCDAB89</span><span class="p">,</span>
    <span class="nx">h2</span><span class="o">:</span> <span class="mh">0x98BADCFE</span><span class="p">,</span>
    <span class="nx">h3</span><span class="o">:</span> <span class="mh">0x10325476</span><span class="p">,</span>
    <span class="nx">h4</span><span class="o">:</span> <span class="mh">0xC3D2E1F0</span>
  <span class="p">};</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-676"><td class="docs"><div class="pilwrap"><a href="#section-676" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Updates the digest with the given string input.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">msg</span><span>- message input to update with.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">sha1</span><span class="p">.</span><span class="nx">MessageDigest</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-677"><td class="docs"><div class="pilwrap"><a href="#section-677" class="pilcrow">&#182;</a></div><p>UTF-8 encode message</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">msg</span> <span class="o">=</span> <span class="nx">unescape</span><span class="p">(</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">msg</span><span class="p">));</span></pre></div></td></tr><tr id="section-678"><td class="docs"><div class="pilwrap"><a href="#section-678" class="pilcrow">&#182;</a></div><p>update message length and input buffer</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">messageLength</span> <span class="o">+=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">data</span> <span class="o">+=</span> <span class="nx">msg</span><span class="p">;</span></pre></div></td></tr><tr id="section-679"><td class="docs"><div class="pilwrap"><a href="#section-679" class="pilcrow">&#182;</a></div><p>process input</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">_sha1</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">words</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">);</span></pre></div></td></tr><tr id="section-680"><td class="docs"><div class="pilwrap"><a href="#section-680" class="pilcrow">&#182;</a></div><p>compact input buffer every 2K or if empty</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">read</span> <span class="o">&gt;</span> <span class="mi">2048</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">length</span><span class="p">()</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">compact</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-681"><td class="docs"><div class="pilwrap"><a href="#section-681" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Produces the digest.</p></div><div class="details"><div class="dox_tag_title">Returns</div><div class="dox_tag_detail"><span class="dox_type">the</span><span>digest as a hexadecimal string.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">sha1</span><span class="p">.</span><span class="nx">MessageDigest</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">digest</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div></td></tr><tr id="section-682"><td class="docs"><div class="pilwrap"><a href="#section-682" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Determine the number of bytes that must be added to the message<br />  to ensure its length is congruent to 448 mod 512. In other words,<br />  a 64-bit integer that gives the length of the message will be<br />  appended to the message and whatever the length of the message is<br />  plus 64 bits must be a multiple of 512. So the length of the<br />  message must be congruent to 448 mod 512 because 512 - 64 = 448.</p></div><div class="body"><p>In order to fill up the message length it must be filled with<br />  padding that begins with 1 bit followed by all 0 bits. Padding<br />  must <em>always</em> be present, so if the message length is already<br />  congruent to 448 mod 512, then 512 padding bits must be added.</p></div></div>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-683"><td class="docs"><div class="pilwrap"><a href="#section-683" class="pilcrow">&#182;</a></div><p>512 bits == 64 bytes, 448 bits == 56 bytes, 64 bits = 8 bytes
_padding starts with 1 byte with first bit is set in it which
is byte value 128, then there may be up to 63 other pad bytes</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">messageLength</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">padBytes</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">sha1</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">();</span>
  <span class="nx">padBytes</span><span class="p">.</span><span class="nx">data</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">bytes</span><span class="p">();</span>
  <span class="nx">padBytes</span><span class="p">.</span><span class="nx">data</span> <span class="o">+=</span> <span class="nx">_sha1</span><span class="p">.</span><span class="nx">padding</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="o">-</span> <span class="p">((</span><span class="nx">len</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">%</span> <span class="mi">64</span><span class="p">));</span></pre></div></td></tr><tr id="section-684"><td class="docs"><div class="pilwrap"><a href="#section-684" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Now append length of the message. The length is appended in bits<br />  as a 64-bit number in big-endian order. Since we store the length<br />  in bytes, we must multiply it by 8 (or left shift by 3). So here<br />  store the high 3 bits in the low end of the first 32-bits of the<br />  64-bit number and the lower 5 bits in the high end of the second<br />  32-bits.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">padBytes</span><span class="p">.</span><span class="nx">putInt32</span><span class="p">((</span><span class="nx">len</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">29</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
  <span class="nx">padBytes</span><span class="p">.</span><span class="nx">putInt32</span><span class="p">((</span><span class="nx">len</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
  <span class="nx">_sha1</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">words</span><span class="p">,</span> <span class="nx">padBytes</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">sha1</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">();</span>
  <span class="nx">rval</span><span class="p">.</span><span class="nx">putInt32</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">h0</span><span class="p">);</span>
  <span class="nx">rval</span><span class="p">.</span><span class="nx">putInt32</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">h1</span><span class="p">);</span>
  <span class="nx">rval</span><span class="p">.</span><span class="nx">putInt32</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">h2</span><span class="p">);</span>
  <span class="nx">rval</span><span class="p">.</span><span class="nx">putInt32</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">h3</span><span class="p">);</span>
  <span class="nx">rval</span><span class="p">.</span><span class="nx">putInt32</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">h4</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">rval</span><span class="p">.</span><span class="nx">toHex</span><span class="p">();</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-685"><td class="docs"><div class="pilwrap"><a href="#section-685" class="pilcrow">&#182;</a></div><p>private SHA-1 data</p>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">_sha1</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">padding</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">initialized</span><span class="o">:</span> <span class="kc">false</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-686"><td class="docs"><div class="pilwrap"><a href="#section-686" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Initializes the constant tables.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">_sha1</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div></td></tr><tr id="section-687"><td class="docs"><div class="pilwrap"><a href="#section-687" class="pilcrow">&#182;</a></div><p>create padding</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">_sha1</span><span class="p">.</span><span class="nx">padding</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="mh">0x00</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="nx">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">n</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_sha1</span><span class="p">.</span><span class="nx">padding</span> <span class="o">+=</span> <span class="nx">c</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">n</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">c</span> <span class="o">+=</span> <span class="nx">c</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-688"><td class="docs"><div class="pilwrap"><a href="#section-688" class="pilcrow">&#182;</a></div><p>now initialized</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">_sha1</span><span class="p">.</span><span class="nx">initialized</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-689"><td class="docs"><div class="pilwrap"><a href="#section-689" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Updates a SHA-1 state with the given byte buffer.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">s</span><span>- SHA-1 state to update.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">w</span><span>- array to use to store words.</span></div><div class="dox_tag_detail"><span>the </span><span class="dox_type">input</span><span>- input byte buffer.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">_sha1</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">input</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-690"><td class="docs"><div class="pilwrap"><a href="#section-690" class="pilcrow">&#182;</a></div><p>consume 512 bit (64 byte) chunks</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">i</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">input</span><span class="p">.</span><span class="nx">length</span><span class="p">();</span>
  <span class="k">while</span><span class="p">(</span><span class="nx">len</span> <span class="o">&gt;=</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-691"><td class="docs"><div class="pilwrap"><a href="#section-691" class="pilcrow">&#182;</a></div><p>the w array will be populated with sixteen 32-bit big-endian words
and then extended into 80 32-bit words according to SHA-1 algorithm
and for 32-79 using Max Locktyukhin's optimization</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-692"><td class="docs"><div class="pilwrap"><a href="#section-692" class="pilcrow">&#182;</a></div><p>initialize hash value for this chunk</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">a</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">h0</span><span class="p">;</span>
    <span class="nx">b</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">h1</span><span class="p">;</span>
    <span class="nx">c</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">h2</span><span class="p">;</span>
    <span class="nx">d</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">h3</span><span class="p">;</span>
    <span class="nx">e</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">h4</span><span class="p">;</span></pre></div></td></tr><tr id="section-693"><td class="docs"><div class="pilwrap"><a href="#section-693" class="pilcrow">&#182;</a></div><p>round 1</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="nx">input</span><span class="p">.</span><span class="nx">getInt32</span><span class="p">();</span>
      <span class="nx">w</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span>
      <span class="nx">f</span> <span class="o">=</span> <span class="nx">d</span> <span class="o">^</span> <span class="p">(</span><span class="nx">b</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nx">c</span> <span class="o">^</span> <span class="nx">d</span><span class="p">));</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="p">((</span><span class="nx">a</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">a</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">27</span><span class="p">))</span> <span class="o">+</span> <span class="nx">f</span> <span class="o">+</span> <span class="nx">e</span> <span class="o">+</span> <span class="mh">0x5A827999</span> <span class="o">+</span> <span class="nx">t</span><span class="p">;</span>
      <span class="nx">e</span> <span class="o">=</span> <span class="nx">d</span><span class="p">;</span>
      <span class="nx">d</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
      <span class="nx">c</span> <span class="o">=</span> <span class="p">(</span><span class="nx">b</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">b</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
      <span class="nx">b</span> <span class="o">=</span> <span class="nx">a</span><span class="p">;</span>
      <span class="nx">a</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span><span class="p">(;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="nx">w</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">^</span> <span class="nx">w</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">8</span><span class="p">]</span> <span class="o">^</span> <span class="nx">w</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">14</span><span class="p">]</span> <span class="o">^</span> <span class="nx">w</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">16</span><span class="p">]);</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="nx">t</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">t</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">31</span><span class="p">);</span>
      <span class="nx">w</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span>
      <span class="nx">f</span> <span class="o">=</span> <span class="nx">d</span> <span class="o">^</span> <span class="p">(</span><span class="nx">b</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nx">c</span> <span class="o">^</span> <span class="nx">d</span><span class="p">));</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="p">((</span><span class="nx">a</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">a</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">27</span><span class="p">))</span> <span class="o">+</span> <span class="nx">f</span> <span class="o">+</span> <span class="nx">e</span> <span class="o">+</span> <span class="mh">0x5A827999</span> <span class="o">+</span> <span class="nx">t</span><span class="p">;</span>
      <span class="nx">e</span> <span class="o">=</span> <span class="nx">d</span><span class="p">;</span>
      <span class="nx">d</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
      <span class="nx">c</span> <span class="o">=</span> <span class="p">(</span><span class="nx">b</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">b</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
      <span class="nx">b</span> <span class="o">=</span> <span class="nx">a</span><span class="p">;</span>
      <span class="nx">a</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-694"><td class="docs"><div class="pilwrap"><a href="#section-694" class="pilcrow">&#182;</a></div><p>round 2</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">for</span><span class="p">(;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="nx">w</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">^</span> <span class="nx">w</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">8</span><span class="p">]</span> <span class="o">^</span> <span class="nx">w</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">14</span><span class="p">]</span> <span class="o">^</span> <span class="nx">w</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">16</span><span class="p">]);</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="nx">t</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">t</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">31</span><span class="p">);</span>
      <span class="nx">w</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span>
      <span class="nx">f</span> <span class="o">=</span> <span class="nx">b</span> <span class="o">^</span> <span class="nx">c</span> <span class="o">^</span> <span class="nx">d</span><span class="p">;</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="p">((</span><span class="nx">a</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">a</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">27</span><span class="p">))</span> <span class="o">+</span> <span class="nx">f</span> <span class="o">+</span> <span class="nx">e</span> <span class="o">+</span> <span class="mh">0x6ED9EBA1</span> <span class="o">+</span> <span class="nx">t</span><span class="p">;</span>
      <span class="nx">e</span> <span class="o">=</span> <span class="nx">d</span><span class="p">;</span>
      <span class="nx">d</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
      <span class="nx">c</span> <span class="o">=</span> <span class="p">(</span><span class="nx">b</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">b</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
      <span class="nx">b</span> <span class="o">=</span> <span class="nx">a</span><span class="p">;</span>
      <span class="nx">a</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span><span class="p">(;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="nx">w</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">6</span><span class="p">]</span> <span class="o">^</span> <span class="nx">w</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">16</span><span class="p">]</span> <span class="o">^</span> <span class="nx">w</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">28</span><span class="p">]</span> <span class="o">^</span> <span class="nx">w</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">32</span><span class="p">]);</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="nx">t</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">t</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">30</span><span class="p">);</span>
      <span class="nx">w</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span>
      <span class="nx">f</span> <span class="o">=</span> <span class="nx">b</span> <span class="o">^</span> <span class="nx">c</span> <span class="o">^</span> <span class="nx">d</span><span class="p">;</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="p">((</span><span class="nx">a</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">a</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">27</span><span class="p">))</span> <span class="o">+</span> <span class="nx">f</span> <span class="o">+</span> <span class="nx">e</span> <span class="o">+</span> <span class="mh">0x6ED9EBA1</span> <span class="o">+</span> <span class="nx">t</span><span class="p">;</span>
      <span class="nx">e</span> <span class="o">=</span> <span class="nx">d</span><span class="p">;</span>
      <span class="nx">d</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
      <span class="nx">c</span> <span class="o">=</span> <span class="p">(</span><span class="nx">b</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">b</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
      <span class="nx">b</span> <span class="o">=</span> <span class="nx">a</span><span class="p">;</span>
      <span class="nx">a</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-695"><td class="docs"><div class="pilwrap"><a href="#section-695" class="pilcrow">&#182;</a></div><p>round 3</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">for</span><span class="p">(;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="nx">w</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">6</span><span class="p">]</span> <span class="o">^</span> <span class="nx">w</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">16</span><span class="p">]</span> <span class="o">^</span> <span class="nx">w</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">28</span><span class="p">]</span> <span class="o">^</span> <span class="nx">w</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">32</span><span class="p">]);</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="nx">t</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">t</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">30</span><span class="p">);</span>
      <span class="nx">w</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span>
      <span class="nx">f</span> <span class="o">=</span> <span class="p">(</span><span class="nx">b</span> <span class="o">&amp;</span> <span class="nx">c</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">d</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nx">b</span> <span class="o">^</span> <span class="nx">c</span><span class="p">));</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="p">((</span><span class="nx">a</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">a</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">27</span><span class="p">))</span> <span class="o">+</span> <span class="nx">f</span> <span class="o">+</span> <span class="nx">e</span> <span class="o">+</span> <span class="mh">0x8F1BBCDC</span> <span class="o">+</span> <span class="nx">t</span><span class="p">;</span>
      <span class="nx">e</span> <span class="o">=</span> <span class="nx">d</span><span class="p">;</span>
      <span class="nx">d</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
      <span class="nx">c</span> <span class="o">=</span> <span class="p">(</span><span class="nx">b</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">b</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
      <span class="nx">b</span> <span class="o">=</span> <span class="nx">a</span><span class="p">;</span>
      <span class="nx">a</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-696"><td class="docs"><div class="pilwrap"><a href="#section-696" class="pilcrow">&#182;</a></div><p>round 4</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">for</span><span class="p">(;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="nx">w</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">6</span><span class="p">]</span> <span class="o">^</span> <span class="nx">w</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">16</span><span class="p">]</span> <span class="o">^</span> <span class="nx">w</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">28</span><span class="p">]</span> <span class="o">^</span> <span class="nx">w</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">32</span><span class="p">]);</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="nx">t</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">t</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">30</span><span class="p">);</span>
      <span class="nx">w</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span>
      <span class="nx">f</span> <span class="o">=</span> <span class="nx">b</span> <span class="o">^</span> <span class="nx">c</span> <span class="o">^</span> <span class="nx">d</span><span class="p">;</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="p">((</span><span class="nx">a</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">a</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">27</span><span class="p">))</span> <span class="o">+</span> <span class="nx">f</span> <span class="o">+</span> <span class="nx">e</span> <span class="o">+</span> <span class="mh">0xCA62C1D6</span> <span class="o">+</span> <span class="nx">t</span><span class="p">;</span>
      <span class="nx">e</span> <span class="o">=</span> <span class="nx">d</span><span class="p">;</span>
      <span class="nx">d</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
      <span class="nx">c</span> <span class="o">=</span> <span class="p">(</span><span class="nx">b</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">b</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
      <span class="nx">b</span> <span class="o">=</span> <span class="nx">a</span><span class="p">;</span>
      <span class="nx">a</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-697"><td class="docs"><div class="pilwrap"><a href="#section-697" class="pilcrow">&#182;</a></div><p>update hash state</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">s</span><span class="p">.</span><span class="nx">h0</span> <span class="o">+=</span> <span class="nx">a</span><span class="p">;</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">h1</span> <span class="o">+=</span> <span class="nx">b</span><span class="p">;</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">h2</span> <span class="o">+=</span> <span class="nx">c</span><span class="p">;</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">h3</span> <span class="o">+=</span> <span class="nx">d</span><span class="p">;</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">h4</span> <span class="o">+=</span> <span class="nx">e</span><span class="p">;</span>

    <span class="nx">len</span> <span class="o">-=</span> <span class="mi">64</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="p">}</span> <span class="c1">// end non-nodejs</span>

<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">XMLSerializer</span><span class="p">)</span> <span class="p">{</span>

<span class="kd">function</span> <span class="nx">_defineXMLSerializer</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">XMLSerializer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;xmldom&#39;</span><span class="p">).</span><span class="nx">XMLSerializer</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">}</span> <span class="c1">// end _defineXMLSerializer</span></pre></div></td></tr><tr id="section-698"><td class="docs"><div class="pilwrap"><a href="#section-698" class="pilcrow">&#182;</a></div><p>define URL parser</p>
</td><td class="code"><div class="highlight"><pre><span class="nx">jsonld</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="p">{};</span>
<span class="k">if</span><span class="p">(</span><span class="nx">_nodejs</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">parse</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">).</span><span class="nx">parse</span><span class="p">;</span>
  <span class="nx">jsonld</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">parsed</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
    <span class="nx">parsed</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="nx">_parseAuthority</span><span class="p">(</span><span class="nx">parsed</span><span class="p">);</span>
    <span class="nx">parsed</span><span class="p">.</span><span class="nx">normalizedPath</span> <span class="o">=</span> <span class="nx">_removeDotSegments</span><span class="p">(</span>
      <span class="nx">parsed</span><span class="p">.</span><span class="nx">pathname</span><span class="p">,</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">authority</span> <span class="o">!==</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">parsed</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-699"><td class="docs"><div class="pilwrap"><a href="#section-699" class="pilcrow">&#182;</a></div><p>parseUri 1.2.2
(c) Steven Levithan <stevenlevithan.com>
MIT License</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">parseUri</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="nx">parseUri</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">key</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">,</span><span class="s1">&#39;protocol&#39;</span><span class="p">,</span><span class="s1">&#39;host&#39;</span><span class="p">,</span><span class="s1">&#39;auth&#39;</span><span class="p">,</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;password&#39;</span><span class="p">,</span><span class="s1">&#39;hostname&#39;</span><span class="p">,</span><span class="s1">&#39;port&#39;</span><span class="p">,</span><span class="s1">&#39;relative&#39;</span><span class="p">,</span><span class="s1">&#39;path&#39;</span><span class="p">,</span><span class="s1">&#39;directory&#39;</span><span class="p">,</span><span class="s1">&#39;file&#39;</span><span class="p">,</span><span class="s1">&#39;query&#39;</span><span class="p">,</span><span class="s1">&#39;hash&#39;</span><span class="p">],</span>
    <span class="nx">parser</span><span class="o">:</span> <span class="sr">/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/</span>
  <span class="p">};</span>
  <span class="nx">jsonld</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="nx">parseUri</span><span class="p">.</span><span class="nx">options</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">parser</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">uri</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">uri</span><span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">key</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">m</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-700"><td class="docs"><div class="pilwrap"><a href="#section-700" class="pilcrow">&#182;</a></div><p>normalize to node.js API</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">uri</span><span class="p">.</span><span class="nx">host</span> <span class="o">&amp;&amp;</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">path</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">uri</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">uri</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">path</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="nx">_parseAuthority</span><span class="p">(</span><span class="nx">uri</span><span class="p">);</span>
    <span class="nx">uri</span><span class="p">.</span><span class="nx">normalizedPath</span> <span class="o">=</span> <span class="nx">_removeDotSegments</span><span class="p">(</span><span class="nx">uri</span><span class="p">.</span><span class="nx">pathname</span><span class="p">,</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">authority</span> <span class="o">!==</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">uri</span><span class="p">.</span><span class="nx">query</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">uri</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">path</span> <span class="o">+</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">uri</span><span class="p">.</span><span class="nx">protocol</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">uri</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">+=</span> <span class="s1">&#39;:&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">uri</span><span class="p">.</span><span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">uri</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">hash</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">uri</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-701"><td class="docs"><div class="pilwrap"><a href="#section-701" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Parses the authority for the pre-parsed given URL.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">parsed</span><span>- pre-parsed URL.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_parseAuthority</span><span class="p">(</span><span class="nx">parsed</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-702"><td class="docs"><div class="pilwrap"><a href="#section-702" class="pilcrow">&#182;</a></div><p>parse authority for unparsed relative network-path reference</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;//&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
    <span class="o">!</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">host</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-703"><td class="docs"><div class="pilwrap"><a href="#section-703" class="pilcrow">&#182;</a></div><p>must parse authority from pathname</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">parsed</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">idx</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">idx</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">parsed</span><span class="p">.</span><span class="nx">authority</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">pathname</span><span class="p">;</span>
      <span class="nx">parsed</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">parsed</span><span class="p">.</span><span class="nx">authority</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">idx</span><span class="p">);</span>
      <span class="nx">parsed</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">idx</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-704"><td class="docs"><div class="pilwrap"><a href="#section-704" class="pilcrow">&#182;</a></div><p>construct authority</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">parsed</span><span class="p">.</span><span class="nx">authority</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">host</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">auth</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">parsed</span><span class="p">.</span><span class="nx">authority</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">auth</span> <span class="o">+</span> <span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">authority</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-705"><td class="docs"><div class="pilwrap"><a href="#section-705" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Removes dot segments from a URL path.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>the </span><span class="dox_type">path</span><span>- path to remove dot segments from.</span></div><div class="dox_tag_detail"><span>true </span><span class="dox_type">hasAuthority</span><span>- if the URL has an authority, false if not.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">_removeDotSegments</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">hasAuthority</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">rval</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">rval</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-706"><td class="docs"><div class="pilwrap"><a href="#section-706" class="pilcrow">&#182;</a></div><p>RFC 3986 5.2.4 (reworked)</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">input</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">while</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;.&#39;</span> <span class="o">||</span> <span class="p">(</span><span class="nx">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">input</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">input</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;..&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">input</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">hasAuthority</span> <span class="o">||</span>
        <span class="p">(</span><span class="nx">output</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">output</span><span class="p">[</span><span class="nx">output</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39;..&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">output</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-707"><td class="docs"><div class="pilwrap"><a href="#section-707" class="pilcrow">&#182;</a></div><p>leading relative URL '..'</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">shift</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">rval</span> <span class="o">+</span> <span class="nx">output</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="nx">_nodejs</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-708"><td class="docs"><div class="pilwrap"><a href="#section-708" class="pilcrow">&#182;</a></div><p>use node context loader by default</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">jsonld</span><span class="p">.</span><span class="nx">useContextLoader</span><span class="p">(</span><span class="s1">&#39;node&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="nx">_nodejs</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">jsonld</span><span class="p">.</span><span class="nx">use</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">extension</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span><span class="p">(</span><span class="nx">extension</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s1">&#39;request&#39;</span><span class="o">:</span></pre></div></td></tr><tr id="section-709"><td class="docs"><div class="pilwrap"><a href="#section-709" class="pilcrow">&#182;</a></div><p>use node JSON-LD request extension</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">jsonld</span><span class="p">.</span><span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./request&#39;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">default</span><span class="o">:</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">JsonLdError</span><span class="p">(</span>
          <span class="s1">&#39;Unknown extension.&#39;</span><span class="p">,</span>
          <span class="s1">&#39;jsonld.UnknownExtension&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">extension</span><span class="o">:</span> <span class="nx">extension</span><span class="p">});</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-710"><td class="docs"><div class="pilwrap"><a href="#section-710" class="pilcrow">&#182;</a></div><p>end of jsonld API factory</p>
</td><td class="code"><div class="highlight"><pre><span class="k">return</span> <span class="nx">jsonld</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-711"><td class="docs"><div class="pilwrap"><a href="#section-711" class="pilcrow">&#182;</a></div><p>external APIs:</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-712"><td class="docs"><div class="pilwrap"><a href="#section-712" class="pilcrow">&#182;</a></div><p>used to generate a new jsonld API instance</p>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">factory</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">wrapper</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">factory</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div></td></tr><tr id="section-713"><td class="docs"><div class="pilwrap"><a href="#section-713" class="pilcrow">&#182;</a></div><p>the shared global jsonld API instance</p>
</td><td class="code"><div class="highlight"><pre><span class="nx">wrapper</span><span class="p">(</span><span class="nx">factory</span><span class="p">);</span></pre></div></td></tr><tr id="section-714"><td class="docs"><div class="pilwrap"><a href="#section-714" class="pilcrow">&#182;</a></div><p>export nodejs API</p>
</td><td class="code"><div class="highlight"><pre><span class="k">if</span><span class="p">(</span><span class="nx">_nodejs</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">factory</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-715"><td class="docs"><div class="pilwrap"><a href="#section-715" class="pilcrow">&#182;</a></div><p>export AMD API</p>
</td><td class="code"><div class="highlight"><pre><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">define</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">define</span><span class="p">.</span><span class="nx">amd</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;jsonld&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">factory</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-716"><td class="docs"><div class="pilwrap"><a href="#section-716" class="pilcrow">&#182;</a></div><p>export simple browser API</p>
</td><td class="code"><div class="highlight"><pre><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">_browser</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">jsonld</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">jsonld</span> <span class="o">=</span> <span class="nx">jsonldjs</span> <span class="o">=</span> <span class="nx">factory</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">jsonldjs</span> <span class="o">=</span> <span class="nx">factory</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="p">})();</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Sun Oct 06 2013 18:12:28 GMT+0200 (CEST)  </div><div id="projectname"><a href="../../index.html">Seki</a></div></div></body></html>